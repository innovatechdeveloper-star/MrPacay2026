# ğŸ“Š ANÃLISIS COMPLETO DEL FLUJO DEL SISTEMA - MI-APP-ETIQUETAS

**Fecha de AnÃ¡lisis:** 16 de octubre de 2025  
**Sistema:** AplicaciÃ³n de GestiÃ³n de Etiquetas QR para ProducciÃ³n Textil  
**VersiÃ³n:** 2.1.0

---

## ğŸ¯ PROPÃ“SITO DEL SISTEMA

Sistema web de gestiÃ³n de etiquetas QR para industria textil que permite a costureras solicitar impresiÃ³n de etiquetas para productos, con aprobaciÃ³n supervisada o automÃ¡tica, e impresiÃ³n directa en impresoras Zebra.

---

## ğŸ—ï¸ ARQUITECTURA GENERAL

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ARQUITECTURA DEL SISTEMA                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   FRONTEND   â”‚ â”€â”€â”€â–º â”‚   BACKEND    â”‚â”€â”€â”€â–ºâ”‚ POSTGRESQL â”‚ â”‚
â”‚  â”‚  (HTML/CSS)  â”‚      â”‚  (Node.js/   â”‚    â”‚  DATABASE  â”‚ â”‚
â”‚  â”‚  JavaScript  â”‚ â—„â”€â”€â”€ â”‚   Express)   â”‚â—„â”€â”€â”€â”‚            â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                               â”‚                            â”‚
â”‚                               â–¼                            â”‚
â”‚                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚                        â”‚   IMPRESORA  â”‚                    â”‚
â”‚                        â”‚ ZEBRA ZD230  â”‚                    â”‚
â”‚                        â”‚ (TCP/IP ZPL) â”‚                    â”‚
â”‚                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### TecnologÃ­as Utilizadas:
- **Backend:** Node.js + Express.js
- **Base de Datos:** PostgreSQL 12+
- **AutenticaciÃ³n:** JWT (JSON Web Tokens)
- **Frontend:** HTML5, CSS3, JavaScript Vanilla
- **ImpresiÃ³n:** TCP/IP Socket a impresora Zebra (ZPL)
- **Seguridad:** bcrypt para contraseÃ±as, cookie-parser

---

## ğŸ‘¥ ROLES Y PERMISOS

### 1. **AdministraciÃ³n** 
- âœ… GestiÃ³n completa de productos
- âœ… GestiÃ³n de usuarios
- âœ… EstadÃ­sticas avanzadas
- âœ… ConfiguraciÃ³n del sistema
- âœ… Acceso a todas las funcionalidades

### 2. **Supervisor/Supervisor Embalaje**
- âœ… Aprobar/rechazar solicitudes de etiquetas
- âœ… Gestionar permisos de auto-services
- âœ… Ver historial completo
- âœ… Crear solicitudes para costureras
- âœ… Monitoreo de solicitudes recientes

### 3. **Costurera**
- âœ… Crear solicitudes de etiquetas (productos normales)
- âœ… Crear solicitudes de productos especiales (juegos/combos)
- âœ… Ver historial personal
- âœ… ReimpresiÃ³n de productos especiales
- âš™ï¸ Auto-services (si estÃ¡ habilitado): impresiÃ³n automÃ¡tica

---

## ğŸ”„ FLUJOS PRINCIPALES DEL SISTEMA

### ğŸ” FLUJO 1: AUTENTICACIÃ“N Y ACCESO

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. Usuario accede al sistema       â”‚
â”‚    URL: http://localhost:3010       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. Sistema muestra login_fixed.htmlâ”‚
â”‚    GET /                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. Carga lista de usuarios         â”‚
â”‚    GET /api/usuarios-lista          â”‚
â”‚    (Usuario selecciona de lista)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. Usuario ingresa contraseÃ±a      â”‚
â”‚    POST /api/auth/login             â”‚
â”‚    { email, password }              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â–¼
         â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”
         â”‚           â”‚
    âŒ   â–¼           â–¼   âœ…
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Credenciales â”‚  â”‚ ValidaciÃ³n   â”‚
â”‚ Incorrectas  â”‚  â”‚ Exitosa      â”‚
â”‚ Error 401    â”‚  â”‚ JWT generado â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                         â–¼
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚ Token JWT en     â”‚
                  â”‚ cookie httpOnly  â”‚
                  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚                     â”‚
     â–¼        â–¼                     â–¼         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Admin  â”‚ â”‚  Supervisor  â”‚ â”‚  Costurera   â”‚
â”‚Dashboardâ”‚ â”‚  Dashboard   â”‚ â”‚  Dashboard   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Archivos involucrados:**
- `public/login_fixed.html` - Interfaz de login
- `server.js` lÃ­nea ~1746 - `POST /api/auth/login`
- `server.js` lÃ­nea ~1845 - `GET /api/auth/me`

---

### ğŸ“¦ FLUJO 2: SOLICITUD DE ETIQUETAS (PRODUCTO NORMAL)

#### A) **Costurera CON auto_services = TRUE** (Auto-aprobaciÃ³n)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. Costurera crea solicitud                    â”‚
â”‚    - Selecciona producto del catÃ¡logo           â”‚
â”‚    - Indica cantidad de etiquetas               â”‚
â”‚    - Agrega observaciones (opcional)            â”‚
â”‚    BotÃ³n: "Solicitar Etiquetas"                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. Frontend envÃ­a solicitud                    â”‚
â”‚    POST /api/crear-solicitud                    â”‚
â”‚    {                                            â”‚
â”‚      id_producto: 123,                          â”‚
â”‚      cantidad_productos: 50,                    â”‚
â”‚      prioridad: 'normal',                       â”‚
â”‚      observaciones: '...'                       â”‚
â”‚    }                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. Backend verifica usuario                    â”‚
â”‚    SELECT * FROM usuarios                       â”‚
â”‚    WHERE email = [user-email]                   â”‚
â”‚    â†’ auto_services = TRUE âœ…                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. Estado inicial = 'proceso'                  â”‚
â”‚    (NO 'pendiente' porque es auto-aprobado)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. Insertar en base de datos                   â”‚
â”‚    INSERT INTO solicitudes_etiquetas            â”‚
â”‚    estado = 'proceso'  â† AUTO-APROBADO          â”‚
â”‚    numero_solicitud = 'SOL-1728945623456'       â”‚
â”‚    qr_code = generado automÃ¡ticamente           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. Registrar en historial                      â”‚
â”‚    INSERT INTO historial_solicitudes            â”‚
â”‚    "Solicitud AUTO-APROBADA"                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 7. ğŸ–¨ï¸ Enviar a cola de impresiÃ³n automÃ¡tica   â”‚
â”‚    addToPrintQueue(solicitudData)               â”‚
â”‚    INSERT INTO cola_impresion                   â”‚
â”‚    estado = 'pendiente'                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 8. Procesador de cola detecta nueva entrada    â”‚
â”‚    processPrintQueue() - Timer cada 10s         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                   â”‚
         â–¼                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Impresora ON     â”‚  â”‚ Impresora OFF    â”‚
â”‚ âœ… Conecta TCP   â”‚  â”‚ âŒ Error conexiÃ³nâ”‚
â”‚ EnvÃ­a ZPL        â”‚  â”‚ â³ Reintenta en  â”‚
â”‚ Imprime etiquetasâ”‚  â”‚ prÃ³ximo ciclo    â”‚
â”‚ estado =         â”‚  â”‚ estado =         â”‚
â”‚ 'completada'     â”‚  â”‚ 'pendiente'      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Resultado:**
- âœ… **NO** aparece en Dashboard Supervisor como "pendiente"
- âœ… Aparece en Dashboard Costurera como "En Proceso"
- âœ… Se imprime automÃ¡ticamente (o queda en cola)
- âœ… Supervisor solo la ve en "Solicitudes Recientes (24h)"

---

#### B) **Costurera SIN auto_services** (Requiere aprobaciÃ³n)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1-2. Igual que flujo anterior                  â”‚
â”‚    (Costurera crea solicitud)                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. Backend verifica usuario                    â”‚
â”‚    auto_services = FALSE (o NULL) âŒ            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. Estado inicial = 'pendiente'                â”‚
â”‚    (Espera aprobaciÃ³n del supervisor)           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. Insertar en BD con estado 'pendiente'       â”‚
â”‚    INSERT INTO solicitudes_etiquetas            â”‚
â”‚    estado = 'pendiente'                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. NO se envÃ­a a impresiÃ³n                     â”‚
â”‚    (espera aprobaciÃ³n)                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 7. ğŸ“‹ Aparece en Dashboard Supervisor          â”‚
â”‚    GET /api/supervisor/pendientes               â”‚
â”‚    SecciÃ³n: "Solicitudes Pendientes"            â”‚
â”‚    Botones: [âœ… Aprobar] [âŒ Rechazar]          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                   â”‚
         â–¼                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âœ… SUPERVISOR    â”‚  â”‚ âŒ SUPERVISOR    â”‚
â”‚ APRUEBA          â”‚  â”‚ RECHAZA          â”‚
â”‚ POST /api/       â”‚  â”‚ POST /api/       â”‚
â”‚ supervisor/      â”‚  â”‚ supervisor/      â”‚
â”‚ aprobar/:id      â”‚  â”‚ rechazar/:id     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                     â”‚
         â–¼                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ UPDATE estado =  â”‚  â”‚ UPDATE estado =  â”‚
â”‚ 'proceso'        â”‚  â”‚ 'rechazada'      â”‚
â”‚ + Comentarios    â”‚  â”‚ + RazÃ³n          â”‚
â”‚ supervisor       â”‚  â”‚                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ–¨ï¸ Enviar a     â”‚
â”‚ cola impresiÃ³n   â”‚
â”‚ (igual que auto) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Archivos involucrados:**
- `public/costurera-dashboard.html` - Interfaz creaciÃ³n solicitud
- `server.js` lÃ­nea ~4243 - `POST /api/crear-solicitud`
- `server.js` lÃ­nea ~4945 - `GET /api/supervisor/pendientes`
- `public/supervisor-dashboard.html` - Interfaz aprobaciÃ³n

---

### ğŸ® FLUJO 3: PRODUCTOS ESPECIALES (JUEGOS/COMBOS)

Los productos especiales son **conjuntos de varios productos** (ej: "JUEGO DE SÃBANAS" = SÃ¡bana + Cobertor + 2 Fundas).

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. Costurera selecciona "Productos Especiales" â”‚
â”‚    Click en botÃ³n en dashboard                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. Modal carga productos especiales            â”‚
â”‚    GET /api/productos-especiales                â”‚
â”‚    Muestra lista de JUEGOS disponibles          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. Usuario selecciona JUEGO                    â”‚
â”‚    Ej: "JUEGO DE SABANAS BP 1.5P"               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. Sistema carga componentes del JUEGO         â”‚
â”‚    GET /api/productos-especiales/:id/componentesâ”‚
â”‚    Retorna:                                     â”‚
â”‚    - Componente 1: SABANA BP 1.5P               â”‚
â”‚    - Componente 2: COBERTOR BP 1.5P             â”‚
â”‚    - Componente 3: FUNDA 50x70                  â”‚
â”‚    - Componente 4: FUNDA 50x70                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. Usuario indica:                             â”‚
â”‚    - Cantidad de JUEGOS: 10 juegos              â”‚
â”‚    - Cantidades por componente (auto-calc):     â”‚
â”‚      * SABANA: 10 etiquetas                     â”‚
â”‚      * COBERTOR: 10 etiquetas                   â”‚
â”‚      * FUNDA 1: 10 etiquetas                    â”‚
â”‚      * FUNDA 2: 10 etiquetas                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. Click "Solicitar"                           â”‚
â”‚    POST /api/crear-solicitud-especial           â”‚
â”‚    {                                            â”‚
â”‚      id_producto_especial: 5,                   â”‚
â”‚      cantidad_juego: 10,                        â”‚
â”‚      cantidades: {                              â”‚
â”‚        producto_1: 10,                          â”‚
â”‚        producto_2: 10,                          â”‚
â”‚        producto_3: 10,                          â”‚
â”‚        producto_4: 10                           â”‚
â”‚      }                                          â”‚
â”‚    }                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 7. Backend crea registro en tabla             â”‚
â”‚    INSERT INTO registros_productos_especiales   â”‚
â”‚    - id_producto_especial                       â”‚
â”‚    - cantidad_juego                             â”‚
â”‚    - cantidad_producto_1_solicitada             â”‚
â”‚    - cantidad_producto_2_solicitada             â”‚
â”‚    - ...                                        â”‚
â”‚    - estado = 'parcial' (auto-calculado)        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 8. ğŸ–¨ï¸ Enviar a cola de impresiÃ³n               â”‚
â”‚    POR CADA COMPONENTE:                         â”‚
â”‚      addToPrintQueue({                          â”‚
â”‚        id_producto: [componente],               â”‚
â”‚        cantidad: [cantidad],                    â”‚
â”‚        es_producto_especial: true,              â”‚
â”‚        nombre_producto_especial: 'JUEGO...'     â”‚
â”‚      })                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 9. Procesador de cola detecta producto especialâ”‚
â”‚    if (es_producto_especial && es_primero) {    â”‚
â”‚      imprimirEtiquetaJuego() // 1 etiqueta      â”‚
â”‚    }                                            â”‚
â”‚    imprimirEtiquetaNormal() // componentes      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 10. Resultado impreso:                         â”‚
â”‚    [PRODUCTO ESPECIAL]  â† 1 etiqueta JUEGO      â”‚
â”‚    [JUEGO DE SABANAS BP 1.5P]                   â”‚
â”‚                                                 â”‚
â”‚    [SABANA BP 1.5P] â† 10 etiquetas normales     â”‚
â”‚    [QR] [Nombre] [Modelo]                       â”‚
â”‚                                                 â”‚
â”‚    [COBERTOR BP 1.5P] â† 10 etiquetas            â”‚
â”‚    ...                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 11. Update registro                            â”‚
â”‚    UPDATE registros_productos_especiales        â”‚
â”‚    cantidad_producto_1_impresa = 10             â”‚
â”‚    ...                                          â”‚
â”‚    TRIGGER actualiza estado â†’ 'completado'      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### ğŸ”„ ReimpresiÃ³n de Productos Especiales

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. Usuario abre "Historial Productos Esp."     â”‚
â”‚    GET /api/registros-productos-especiales      â”‚
â”‚    ?id_usuario=[id]&filtro=parciales            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. Muestra registros con barras de progreso    â”‚
â”‚    JUEGO DE SABANAS BP 1.5P                     â”‚
â”‚    Estado: âš ï¸ Parcial                           â”‚
â”‚    Componente 1: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘ 8/10                â”‚
â”‚    Componente 2: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 10/10 âœ…            â”‚
â”‚    Componente 3: â–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘ 4/10                â”‚
â”‚    [Re-imprimir]                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. Click "Re-imprimir"                         â”‚
â”‚    Modal muestra componentes PENDIENTES         â”‚
â”‚    Componente 1: [2] (mÃ¡x: 2 pendientes)        â”‚
â”‚    Componente 3: [6] (mÃ¡x: 6 pendientes)        â”‚
â”‚    [Confirmar ReimpresiÃ³n]                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. PUT /api/registros-productos-especiales/:id/ â”‚
â”‚    reimprimir                                   â”‚
â”‚    { cantidades: { producto_1: 2, producto_3:6}}â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. Backend valida y actualiza                  â”‚
â”‚    - Valida: cantidad â‰¤ pendiente               â”‚
â”‚    - UPDATE cantidad_impresa += cantidad        â”‚
â”‚    - EnvÃ­a a cola de impresiÃ³n                  â”‚
â”‚    - TRIGGER actualiza estado                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Archivos involucrados:**
- `server.js` lÃ­nea ~2427 - `GET /api/productos-especiales`
- `server.js` lÃ­nea ~4467 - `POST /api/crear-solicitud-especial`
- `server.js` lÃ­nea ~2755 - APIs registros productos especiales
- `server.js` lÃ­nea ~238 - `generateJuegoZPL()` generaciÃ³n etiqueta
- `migrations/crear_productos_especiales.sql`
- `migrations/crear_tabla_registros_productos_especiales.sql`

---

### ğŸ–¨ï¸ FLUJO 4: SISTEMA DE IMPRESIÃ“N

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ COLA DE IMPRESIÃ“N (Tabla: cola_impresion)      â”‚
â”‚ Timer: Procesa cada 10 segundos                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. processPrintQueue() se ejecuta              â”‚
â”‚    Consulta: SELECT * FROM cola_impresion       â”‚
â”‚    WHERE estado = 'pendiente'                   â”‚
â”‚    ORDER BY fecha_creacion ASC LIMIT 10         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. Por cada solicitud en cola:                 â”‚
â”‚    - Obtener datos del producto                 â”‚
â”‚    - Calcular cantidad par (si impar, +1)       â”‚
â”‚    - Generar cÃ³digo QR Ãºnico                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                   â”‚
         â–¼                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Producto Especialâ”‚  â”‚ Producto Normal  â”‚
â”‚ es_producto_     â”‚  â”‚ es_producto_     â”‚
â”‚ especial = true  â”‚  â”‚ especial = false â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                     â”‚
         â–¼                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚ Â¿Es primer       â”‚           â”‚
â”‚ componente?      â”‚           â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
     â”‚YES  â”‚NO                 â”‚
     â–¼     â”‚                   â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”              â”‚
â”‚ Imprimir 1    â”‚              â”‚
â”‚ etiqueta JUEGOâ”‚              â”‚
â”‚ (DOBLE)       â”‚              â”‚
â”‚ "PRODUCTO     â”‚              â”‚
â”‚  ESPECIAL"    â”‚              â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
       â”‚                       â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. Generar ZPL para etiqueta DOBLE             â”‚
â”‚    generateDoubleZPL(data, config)              â”‚
â”‚    ConfiguraciÃ³n dinÃ¡mica de campos:            â”‚
â”‚    - mostrar_qr (default: true)                 â”‚
â”‚    - mostrar_nombre (default: true)             â”‚
â”‚    - mostrar_id (default: true)                 â”‚
â”‚    - mostrar_unidad (default: true)             â”‚
â”‚    - mostrar_modelo (default: true)             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. Formato ZPL Zebra (Etiqueta DOBLE)          â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚    â”‚ ETIQUETA IZQ      â”‚ ETIQUETA DER      â”‚   â”‚
â”‚    â”‚ â”Œâ”€â”€â”€â”€â”            â”‚ â”Œâ”€â”€â”€â”€â”            â”‚   â”‚
â”‚    â”‚ â”‚ QR â”‚ NOMBRE     â”‚ â”‚ QR â”‚ NOMBRE     â”‚   â”‚
â”‚    â”‚ â””â”€â”€â”€â”€â”˜ PRODUCTO   â”‚ â””â”€â”€â”€â”€â”˜ PRODUCTO   â”‚   â”‚
â”‚    â”‚        MODELO     â”‚        MODELO     â”‚   â”‚
â”‚    â”‚        UM: UNIDAD â”‚        UM: UNIDAD â”‚   â”‚
â”‚    â”‚        ID: 000123 â”‚        ID: 000123 â”‚   â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. Enviar ZPL a impresora Zebra                â”‚
â”‚    Protocolo: TCP/IP Socket                     â”‚
â”‚    IP: 192.168.1.34 (configurable)              â”‚
â”‚    Puerto: 9100                                 â”‚
â”‚    Modelo: ZD230-203dpi                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â–¼
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                   â”‚
    âœ…   â–¼                   â–¼   âŒ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ConexiÃ³n exitosa â”‚  â”‚ Error de conexiÃ³nâ”‚
â”‚ ZPL enviado      â”‚  â”‚ (impresora OFF)  â”‚
â”‚                  â”‚  â”‚                  â”‚
â”‚ UPDATE cola:     â”‚  â”‚ UPDATE cola:     â”‚
â”‚ estado =         â”‚  â”‚ estado =         â”‚
â”‚ 'completada'     â”‚  â”‚ 'pendiente'      â”‚
â”‚ fecha_impresion  â”‚  â”‚ error_mensaje    â”‚
â”‚                  â”‚  â”‚                  â”‚
â”‚ UPDATE solicitud:â”‚  â”‚ Reintenta en     â”‚
â”‚ estado =         â”‚  â”‚ prÃ³ximo ciclo    â”‚
â”‚ 'completada'     â”‚  â”‚ (10 segundos)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Detalles TÃ©cnicos:**

1. **GeneraciÃ³n de CÃ³digo QR:**
   - Formato: `SOL-[numeroSolicitud]-QR-[timestamp][random]`
   - Ejemplo: `SOL-123-QR-ABCD1234EFG`

2. **Cantidad Par:**
   - Etiquetas DOBLES â†’ Se imprime de 2 en 2
   - Si solicitan 5, se imprimen 6 (ajuste automÃ¡tico)

3. **Lenguaje ZPL:**
   - `^XA` / `^XZ` - Inicio/fin de etiqueta
   - `^FO` - Field Origin (posiciÃ³n)
   - `^BQN` - QR Code
   - `^CF0` - Change Font
   - Adaptado dinÃ¡micamente segÃºn DPI de impresora

**Archivos involucrados:**
- `server.js` lÃ­nea ~540 - `processPrintQueue()`
- `server.js` lÃ­nea ~332 - `generateDoubleZPL()`
- `server.js` lÃ­nea ~238 - `generateJuegoZPL()`
- `server.js` lÃ­nea ~830 - `addToPrintQueue()`

---

### ğŸ‘¥ FLUJO 5: GESTIÃ“N DE USUARIOS (AUTO-SERVICES)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. Supervisor abre Dashboard                   â”‚
â”‚    URL: /supervisor-dashboard.html              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. Click en botÃ³n "ğŸ‘¥ GestiÃ³n de Costureras"   â”‚
â”‚    Modal se abre                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. Carga lista de costureras                   â”‚
â”‚    GET /api/admin/costureras-lista              â”‚
â”‚    WHERE nivel_acceso IN                        â”‚
â”‚      ('costurera', 'supervisor_embalaje')       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. Muestra tabla con toggle de auto-services   â”‚
â”‚    ID â”‚ NOMBRE      â”‚ ROL       â”‚ ACCIONES      â”‚
â”‚    â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚    1  â”‚ DORIS       â”‚ Costurera â”‚ ğŸŸ¢ Auto       â”‚
â”‚    3  â”‚ MARIA LUISA â”‚ Costurera â”‚ ğŸ”´ Manual     â”‚
â”‚    4  â”‚ RUTH        â”‚ Costurera â”‚ ğŸŸ¢ Auto       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. Supervisor hace click en toggle             â”‚
â”‚    Cambia de ğŸ”´ Manual â†’ ğŸŸ¢ Auto                â”‚
â”‚    (o viceversa)                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. JavaScript actualiza BD                     â”‚
â”‚    PUT /api/usuarios/:id/auto-services          â”‚
â”‚    { auto_services: !currentValue }             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 7. Backend actualiza en PostgreSQL             â”‚
â”‚    UPDATE usuarios                              â”‚
â”‚    SET auto_services = $1                       â”‚
â”‚    WHERE id_usuario = $2                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 8. Efecto inmediato:                           â”‚
â”‚    - Si TRUE: prÃ³ximas solicitudes auto-apruebanâ”‚
â”‚    - Si FALSE: solicitudes requieren aprobaciÃ³n â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Visual de Toggle:**

```css
/* Estado INACTIVO (Manual) */
.toggle-inactive {
  filter: grayscale(100%);
  transform: scale(0.85);
  opacity: 0.5;
}

/* Estado ACTIVO (Auto) */
.toggle-active {
  filter: none;
  transform: scale(1.15);
  opacity: 1;
  box-shadow: 0 0 20px color;
}
```

---

## ğŸ—„ï¸ ESTRUCTURA DE BASE DE DATOS

### Tablas Principales:

#### 1. **usuarios**
```sql
Campos clave:
- id_usuario (PK)
- codigo_empleado (UNIQUE)
- nombre_completo
- email (UNIQUE)
- nivel_acceso (administracion|supervisor|costurera)
- auto_services (BOOLEAN) â† Permiso auto-aprobaciÃ³n
- password_hash (bcrypt)
- activo
```

#### 2. **productos**
```sql
Campos clave:
- id_producto (PK)
- nombre_producto
- descripcion_corta
- categoria, subcategoria
- marca, modelo
- unidad_medida
- mostrar_qr, mostrar_nombre, mostrar_id... (configuraciÃ³n)
- activo
```

#### 3. **productos_especiales** (JUEGOS)
```sql
Campos clave:
- id_producto_especial (PK)
- nombre_juego
- descripcion
- id_producto_1, id_producto_2, id_producto_3, id_producto_4 (FK)
- activo
```

#### 4. **solicitudes_etiquetas**
```sql
Campos clave:
- id_solicitud (PK)
- numero_solicitud (UNIQUE)
- id_usuario (FK)
- id_producto (FK)
- cantidad_solicitada
- estado ('pendiente'|'proceso'|'completada'|'rechazada')
- qr_code
- observaciones
- observaciones_supervisor
- supervisor_id (FK)
```

#### 5. **cola_impresion**
```sql
Campos clave:
- id (PK)
- id_solicitud (FK)
- numero_solicitud
- qr_code
- nombre_producto
- cantidad_a_imprimir
- estado ('pendiente'|'completada'|'error')
- es_producto_especial (BOOLEAN)
- nombre_producto_especial
- error_mensaje
- fecha_impresion
```

#### 6. **registros_productos_especiales**
```sql
Campos clave:
- id_registro (PK)
- id_producto_especial (FK)
- id_usuario (FK)
- cantidad_juego
- cantidad_producto_1_solicitada
- cantidad_producto_1_impresa
- ... (hasta producto_4)
- estado (auto-calculado: 'parcial'|'pendiente'|'completado')
```

#### 7. **historial_solicitudes**
```sql
Campos clave:
- id_historial (PK)
- id_solicitud (FK)
- estado_anterior
- estado_nuevo
- usuario_cambio (FK)
- comentarios
- fecha_cambio
```

---

## ğŸ”Œ API ENDPOINTS PRINCIPALES

### AutenticaciÃ³n
```
POST   /api/auth/login              - Login con JWT
POST   /api/auth/logout             - Cerrar sesiÃ³n
GET    /api/auth/me                 - Datos del usuario actual
GET    /api/usuarios-lista          - Lista usuarios para login
```

### Productos
```
GET    /api/productos               - Lista productos normales
GET    /api/productos/:id           - Detalle de producto
PUT    /api/productos/:id           - Actualizar producto
PUT    /api/productos/:id/configuracion-etiqueta  - Config campos etiqueta
GET    /api/productos-especiales    - Lista JUEGOS
GET    /api/productos-especiales/:id/componentes  - Componentes de JUEGO
POST   /api/productos-especiales    - Crear JUEGO
PUT    /api/productos-especiales/:id - Actualizar JUEGO
```

### Solicitudes
```
POST   /api/crear-solicitud         - Crear solicitud normal
POST   /api/crear-solicitud-especial - Crear solicitud JUEGO
GET    /api/mis-solicitudes         - Historial personal
GET    /api/solicitudes             - Todas las solicitudes (admin)
```

### Supervisor
```
GET    /api/supervisor/pendientes   - Solicitudes pendientes aprobaciÃ³n
POST   /api/supervisor/aprobar/:id  - Aprobar solicitud
POST   /api/supervisor/rechazar/:id - Rechazar solicitud
GET    /api/supervisor/solicitudes-recientes - Ãšltimas 24h (todos estados)
```

### GestiÃ³n de Usuarios
```
GET    /api/admin/costureras-lista  - Lista costureras
PUT    /api/usuarios/:id/auto-services - Toggle auto-aprobaciÃ³n
```

### Productos Especiales - Historial
```
GET    /api/registros-productos-especiales  - Historial con filtros
GET    /api/registros-productos-especiales/:id - Detalle registro
POST   /api/registros-productos-especiales  - Crear registro (1ra impresiÃ³n)
PUT    /api/registros-productos-especiales/:id/reimprimir - ReimpresiÃ³n
GET    /api/registros-productos-especiales/stats/:id_usuario - EstadÃ­sticas
```

### Sistema
```
GET    /api/test-db                 - Test conexiÃ³n DB
GET    /api/server/session          - ID sesiÃ³n servidor
GET    /api/admin/stats             - EstadÃ­sticas generales
```

---

## ğŸ¨ INTERFAZ DE USUARIO (FRONTEND)

### PÃ¡ginas Principales:

#### 1. **login_fixed.html**
- Login con lista desplegable de usuarios
- ValidaciÃ³n de contraseÃ±a
- Redireccionamiento por rol
- JWT almacenado en cookie httpOnly

#### 2. **costurera-dashboard.html**
Funcionalidades:
- âœ… Solicitar etiquetas (productos normales)
- âœ… Solicitar productos especiales (JUEGOS)
- âœ… Ver historial personal ("Mis Registros")
- âœ… Historial productos especiales con re-impresiÃ³n
- âœ… Filtros por estado
- âœ… Indicador de auto-services activo

#### 3. **supervisor-dashboard.html**
Funcionalidades:
- âœ… Ver solicitudes pendientes de aprobaciÃ³n
- âœ… Aprobar/Rechazar solicitudes
- âœ… Ver solicitudes recientes (24h) con filtros por estado
- âœ… GestiÃ³n de costureras (toggle auto-services)
- âœ… Crear solicitudes para costureras
- âœ… Indicadores visuales (badges "ğŸ¤– AUTO")

#### 4. **administracion-mejorado.html**
Funcionalidades:
- âœ… CRUD completo de productos
- âœ… CRUD de usuarios
- âœ… GestiÃ³n de productos especiales (JUEGOS)
- âœ… EstadÃ­sticas avanzadas
- âœ… EdiciÃ³n de tablas dinÃ¡micas
- âœ… ConfiguraciÃ³n de campos de etiqueta

### Sistema de Temas:
- ğŸŒ¿ **Natural** - Verde salvia + Terracota
- âœ¨ **Elegant** - Malva + Rosa empolvado
- ğŸ’¼ **Professional** - Azul Teal + Coral
- Cambio en tiempo real
- Persistencia en localStorage
- Accesibilidad WCAG 2.1 AAA

---

## âš™ï¸ CONFIGURACIÃ“N DEL SISTEMA

### Archivo: `config/system.config`

```ini
[ZEBRA_CONFIG]
MODEL=ZD230
PRINTER_IP=192.168.1.34
PORT_NUMBER=9100
DPI=203
WIDTH_MM=100
HEIGHT_MM=150

[SERVER_CONFIG]
PORT=3010
JWT_SECRET=tu_clave_secreta_super_segura_2025

[DATABASE_CONFIG]
HOST=localhost
PORT=5432
DATABASE=postgres
USER=postgres
PASSWORD=alsimtex

[COMPANY_CONFIG]
NAME=PRODUCTO PERUANO
WEBSITE=www.alsimtex.com
PHONE=Tel: 958003536
ADDRESS=HECHO EN PERU
```

**Carga dinÃ¡mica:** El servidor lee este archivo al iniciar y aplica la configuraciÃ³n.

---

## ğŸ”’ SEGURIDAD

### Implementadas:
- âœ… **JWT Authentication** - Tokens firmados
- âœ… **bcrypt** - Hash de contraseÃ±as (10 rounds)
- âœ… **httpOnly Cookies** - ProtecciÃ³n XSS
- âœ… **ValidaciÃ³n de roles** - Middleware verificarToken
- âœ… **SQL Injection Protection** - Parametrized queries
- âœ… **IP Whitelisting** (opcional)

### Middleware de AutenticaciÃ³n:
```javascript
function verificarToken(req, res, next) {
    const token = req.cookies.token;
    if (!token) return res.status(401).json({ error: 'No autorizado' });
    
    jwt.verify(token, JWT_SECRET, (err, decoded) => {
        if (err) return res.status(403).json({ error: 'Token invÃ¡lido' });
        req.usuario = decoded;
        next();
    });
}
```

---

## ğŸ“Š MONITOREO Y LOGS

### Heartbeat System:
- â±ï¸ Cada 30 segundos: log de estado
- ğŸ“Š MÃ©tricas: memoria, uptime
- âš ï¸ Alertas si servidor colgado (>45s sin heartbeat)
- ğŸ§¹ Garbage collection automÃ¡tico si >300MB

### Logs en Consola:
```
ğŸ’“ [18:30:15] Heartbeat - Servidor activo
   ğŸ“Š Memoria: 127MB
   ğŸ”Œ Uptime: 3600 segundos

ğŸ–¨ï¸ [generateDoubleZPL] Generando ZPL para ZD230: SABANA BP 1.5P
âœ… [addToPrintQueue] Agregado a cola: SOL-123-QR-ABC

âš ï¸ [ALERTA] Alto uso de memoria: 512MB
ğŸ§¹ Ejecutando garbage collection...
```

---

## ğŸš€ INSTALACIÃ“N Y DESPLIEGUE

### Requisitos:
- Node.js 16+
- PostgreSQL 12+
- Windows 10/11
- Impresora Zebra ZD230 (red TCP/IP)

### InstalaciÃ³n AutomÃ¡tica:
```bash
# 1. Ejecutar instalador
INSTALAR.bat

# 2. Crear base de datos
psql -U postgres
CREATE DATABASE mi_app_etiquetas;
\c mi_app_etiquetas
\i crear_base_datos.sql

# 3. Iniciar servidor
iniciar_servidor.bat
# o con PM2 (auto-restart)
iniciar_con_pm2.bat
```

### InstalaciÃ³n Manual:
```bash
npm install
node server.js
```

### Acceso:
- Local: http://localhost:3010
- Red: http://192.168.1.35:3010
- Usuario default: admin@empresa.com / admin123

---

## ğŸ“ ESTRUCTURA DE ARCHIVOS CLAVE

```
mi-app-etiquetas/
â”œâ”€â”€ server.js (8800 lÃ­neas) â­ BACKEND PRINCIPAL
â”œâ”€â”€ package.json
â”œâ”€â”€ config/
â”‚   â””â”€â”€ system.config (ConfiguraciÃ³n dinÃ¡mica)
â”œâ”€â”€ public/
â”‚   â”œâ”€â”€ login_fixed.html (Login mejorado)
â”‚   â”œâ”€â”€ costurera-dashboard.html (Dashboard costurera)
â”‚   â”œâ”€â”€ supervisor-dashboard.html (Dashboard supervisor)
â”‚   â”œâ”€â”€ administracion-mejorado.html (Panel admin)
â”‚   â”œâ”€â”€ css/
â”‚   â”‚   â”œâ”€â”€ base/design-system.css
â”‚   â”‚   â”œâ”€â”€ components/buttons.css
â”‚   â”‚   â””â”€â”€ themes/ (natural, elegant, professional)
â”‚   â””â”€â”€ theme-system.js
â”œâ”€â”€ migrations/ (Migraciones SQL)
â”‚   â”œâ”€â”€ crear_productos_especiales.sql
â”‚   â”œâ”€â”€ crear_tabla_registros_productos_especiales.sql
â”‚   â”œâ”€â”€ add_auto_services_column.sql
â”‚   â”œâ”€â”€ add_label_config_columns.sql
â”‚   â””â”€â”€ fix_estado_check_constraint.sql
â””â”€â”€ crear_base_datos.sql (Setup inicial BD)
```

---

## ğŸ¯ CARACTERÃSTICAS DESTACADAS

### âœ… Auto-Services
Sistema inteligente que permite a costureras de confianza imprimir sin aprobaciÃ³n supervisor.

### âœ… Productos Especiales
GestiÃ³n completa de JUEGOS/COMBOS con tracking individual de componentes.

### âœ… Sistema de Cola
Procesamiento robusto con reintentos automÃ¡ticos si impresora no disponible.

### âœ… Etiquetas Dobles
OptimizaciÃ³n: 2 etiquetas por hoja (50mm x 150mm).

### âœ… ConfiguraciÃ³n DinÃ¡mica
Sistema adaptable a diferentes modelos de impresora Zebra.

### âœ… Historial Completo
Tracking de todos los cambios de estado con usuario y timestamp.

### âœ… ReimpresiÃ³n Inteligente
Para productos especiales: reimprime solo componentes faltantes.

### âœ… Temas Accesibles
3 paletas profesionales con contraste WCAG AAA.

---

## ğŸ”§ MIGRACIÃ“N Y ACTUALIZACIONES

### Migraciones Disponibles:

1. **add_auto_services_column.sql**
   - Agrega columna `auto_services` a tabla usuarios

2. **add_label_config_columns.sql**
   - Agrega configuraciÃ³n de campos de etiqueta a productos

3. **add_producto_especial_to_cola.sql**
   - Agrega soporte para productos especiales en cola

4. **crear_productos_especiales.sql**
   - Crea tabla y vista de productos especiales

5. **crear_tabla_registros_productos_especiales.sql**
   - Sistema completo de tracking de JUEGOS

6. **fix_estado_check_constraint.sql**
   - Corrige constraint de estados permitidos

---

## ğŸ“ˆ ESTADÃSTICAS DEL SISTEMA

### MÃ©tricas Tracking:
- Total solicitudes creadas
- Solicitudes por estado
- Solicitudes por usuario
- Productos mÃ¡s solicitados
- Tasa de aprobaciÃ³n/rechazo
- Productos especiales impresos
- Etiquetas totales impresas

### VisualizaciÃ³n:
- GrÃ¡ficos de barras (Chart.js)
- Tablas interactivas
- Filtros por fecha
- Export a Excel (excelJS)

---

## ğŸ› SOLUCIÃ“N DE PROBLEMAS

### Error: "viola la restricciÃ³n check estado"
**SoluciÃ³n:** Ejecutar `fix_estado_check_constraint.sql`

### Error: "Impresora no responde"
**Verificar:**
- IP correcta en `system.config`
- Impresora encendida
- Misma red que el servidor
- Puerto 9100 abierto

### Error: "Token invÃ¡lido"
**SoluciÃ³n:** 
- Logout y login nuevamente
- Verificar JWT_SECRET no cambiÃ³

### Error: "No existe la columna auto_services"
**SoluciÃ³n:** Ejecutar `add_auto_services_column.sql`

---

## ğŸ“ CONCLUSIÃ“N

**MI-APP-ETIQUETAS** es un sistema robusto y completo para gestiÃ³n de etiquetas QR en producciÃ³n textil, con:

- âœ… Arquitectura modular y escalable
- âœ… Flujos automatizados inteligentes
- âœ… Interfaz intuitiva por roles
- âœ… Sistema de impresiÃ³n robusto con reintentos
- âœ… GestiÃ³n avanzada de productos especiales
- âœ… Seguridad implementada (JWT, bcrypt)
- âœ… Monitoreo y logging completo
- âœ… ConfiguraciÃ³n dinÃ¡mica
- âœ… DocumentaciÃ³n exhaustiva

El sistema estÃ¡ **listo para producciÃ³n** y soporta operaciones 24/7 con auto-restart mediante PM2.

---

**DocumentaciÃ³n generada:** 16 de octubre de 2025  
**Autor del anÃ¡lisis:** GitHub Copilot  
**VersiÃ³n del sistema:** 2.1.0
