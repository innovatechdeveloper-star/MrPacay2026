const net = require('net');

// ===== IMPORTAR LOGOS (IGUAL QUE SERVER.JS) =====
const LOGO_CAMITEX_ZPL = `^GFA,4920,4920,40,000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003FFF0000000000000000000000000000000000000000000000000000000000000000000000000007FFFFF00000000000000000000000000000000000000000000000000000000000000000000000001FFFFFFE0000000000000000000000000000000000000000000000000000000000000000000000007FFFFFFF000000000000000000000000000000000000000000000000000000000000000000000001FFFFFFFFC00000000000000000000000000000000000000000000000000000000000000000000007FFFFFFFFE0000000000000000000000000000000000000000000000000000000000000000000000FFFFFFFFFE0000000000000000000000000000000000000000000000000000000000000000000001FFFFFFFFFE0000000000000000000000000000000000000000000000000000000000000000000007FFFFFFFFFE000000000000000000000000000000000000000000000000000000000000000000000FFFFF003FFE000000000000000000000000000000000000000000000000000000000000000000001FFFF80007FC000000000000000000000000000000000000000000000000000000000000000000001FFFC00001F8000006000000004000000100000000000000000000000000003000000C00000000003FFF8000000000003FE0000007FC00001FE0000FC03FFFFFFFF00FFFFFFE00FC00003F00000000007FFE000000000000FFF000000FFE00007FF8001FE07FFFFFFFF83FFFFFFF01FE00007F80000000007FFC000000000001FFF800001FFF0000FFF8003FF07FFFFFFFF87FFFFFFF83FF0000FFC000000000FFF8000000000003FFFC00003FFF8000FFFC003FF0FFFFFFFFF8FFFFFFFF83FF8001FFC000000001FFF0000000000003FFFE00003FFF8001FFFC003FF07FFFFFFFF8FFFFFFFF83FFC003FFC000000001FFE0000000000007FFFF00003FFFC001FFFE003FF07FFFFFFFF8FFFFFFFF81FFE007FFC000000003FFE0000000000007FFFF00007FFFC003FFFE003FF03FFFFFFFF07FFFFFFF00FFF00FFF8000000003FFC000000000000FFFFF80007FFFE003FFFE003FF00FFFFFFFE03FFFFFFE00FFF80FFF0000000003FF8000000000000FFFFF80007FFFE007FFFE003FF00003FF000007FE0000007FFC1FFE0000000007FF8000000000001FFDFFC0007FFFF007FFFE003FF00003FF00000FFC0000003FFC3FFC0000000007FF0000000000001FF8FFC0007FFFF007FFFF003FF00003FF00000FF80000001FFE7FF80000000007FF0000000000003FF8FFE000FFFFF00FFFFF003FF00003FF00001FF80000000FFFFFF80000000007FF0000000000003FF07FE000FFFFF80FFFFF003FF00003FF00001FF800000007FFFFF00000000007FE0000000000007FF07FF000FFCFF81FFBFF003FF00003FF00001FF000000003FFFFE0000000000FFE0000000000007FE03FF000FFCFFC1FF3FF803FF00003FF00003FFFFFF80001FFFFC0000000000FFE000000000000FFE03FF800FFC7FC1FF1FF803FF00003FF0000FFFFFFFE0000FFFF80000000000FFE200000000000FFC01FF800FFC7FE3FE1FF803FF00003FF0001FFFFFFFE0000FFFF00000000000FFE200000000000FFC01FF801FFC3FE3FE1FF803FF00003FF0001FFFFFFFE00007FFE00000000000FFE300000000001FFC01FFC01FFC3FE7FE1FF803FF00003FF0001FFFFFFFE00007FFE00000000000FFE100000000001FF800FFC01FFC3FF7FC1FF803FF00003FF0001FFFFFFFE0000FFFF000000000007FE180000000001FF800FFE01FF81FFFFC1FFC03FF00003FF0001FFFFFFFE0001FFFF800000000007FE180000000003FFFFFFFE01FF81FFFF80FFC03FF00003FF0000FFFFFFF80003FFFFC00000000007FE1C0000000003FFFFFFFE01FF80FFFF80FFC03FF00003FF00003FF000000007FFFFE00000000007FE1E0000000007FFFFFFFF01FF80FFFF80FFC03FF00003FF00003FF00000000FFFFFF00000000007FF0F800000000FFFFFFFFF01FF807FFF00FFC03FF00003FF00003FF00000001FFFFFF80000000007FF0FC00000780FFFFFFFFF81FF807FFF00FFC03FF00003FF00003FF00000001FFE7FFC0000000003FF07F00003FE0FFFFFFFFF81FF807FFE00FFC03FF00003FF00003FF00000003FFC3FFE0000000003FF87FE000FFE0FFFFFFFFF83FF803FFE00FFC03FF00003FF00003FF00000007FF81FFF0000000001FF83FFFFFFFF1FFC0001FFC3FF803FFC00FFE03FF00003FF00003FFFFFFF00FFF00FFF8000000001FFC3FFFFFFFF1FF80001FFC3FF801FFC00FFE03FF00003FF00003FFFFFFF81FFE007FF8000000000FFE1FFFFFFFF1FF80000FFC3FF800FF800FFE03FF00003FF00001FFFFFFF83FFC003FFC000000000FFE0FFFFFFFE1FF80000FFC3FF0007F0007FE03FF00003FF00001FFFFFFF83FFC003FFC0000000007FF07FFFFFFE1FF00000FFC3FF0001C0007FE03FF00003FF00000FFFFFFF87FF8001FFC0000000007FF83FFFFFF81FF000007FC1FF000000007FC03FF00003FF000007FFFFFF83FF0000FFC0000000003FFC1FFFFFE01FF000007F81FE000000007FC01FE00001FF000003FFFFFF03FE00007F80000000001FFE07FFFF800FC000001F007C000000001F000FC00000FC0000007FFFFE01FC00003F00000000000FFF01FFF80000000000000000000000000000000000000000000003FF00007000000000000000000FFFC00000000000000000000000000000000000000000000000000000000000000000000000000007FFF00000000000000000000000000000000000000000000000000000000000000000000000000003FFF8000000000000000003FFFFFFFFFFF80000000000000000000000000000000000000000000001FFFE000000000000001FFFFFFFFFFFFFFFFF80000000000000000000000000000000000000000000FFFFC000000000001FFFFFFFFFFFFFFFFFFFFFC000000000000000000000000000000000000000003FFFF8000000003FFFFFFFFFFFFFFFFFFFFFFFFFC0000000000000000000000000000C00000000001FFFFFC000001FFFFFFFFFFFFFFFFFFFFFFFFFFFFF8000000000000000000000000070000000000007FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF800000000000000000000003C0000000000003FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFE000000000000000000001F00000000000000FFFFFFFFFFFFFFFFFFFFF0000001FFFFFFFFFFFFFFFFFE000000000000000001FC000000000000001FFFFFFFFFFFFFFFFC00000000000000FFFFFFFFFFFFFFFC000000000000001FE00000000000000007FFFFFFFFFFFFFC0000000000000000007FFFFFFFFFFFFFFF00000000000FFF800000000000000000FFFFFFFFFFFC00000000000000000000001FFFFFFFFFFFFFFFF00000FFFFFC0000000000000000000FFFFFFFFF000000000000000000000000003FFFFFFFFFFFFFFFFFFFFFFFE0000000000000000000001FFFFC0000000000000000000000000000003FFFFFFFFFFFFFFFFFFFFE0000000000000000000000000000000000000000000000000000000000003FFFFFFFFFFFFFFFFFF0000000000000000000000000000000000000000000000000000000000000007FFFFFFFFFFFFFFE0000000000000000000000000000000000000000000000000000000000000000003FFFFFFFFFFF00000000000000000000000000000000000000000000000000000000000000000000000FFFFFFC0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000FF000000000000000C0000007E000000000000000000000000000000000000000000000000000000C7C00000000000000C000001C380000000000000000000000000000000000000000000000000000080600000000000000C0000030080000000000000000000000000000000000000000000000000000080300000000000000C000006000000000000000000000000000000000000000000000000000000008030FC0BF03F8003EC0F80040007E07F3F07F00000000000000000000000000000000000000000008021870E1C20C00E1C38600C00003071E1841800000000000000000000000000000000000000000080E3010C040040080C20200C00001840C18008000000000000000000000000000000000000000000FFC20188060040180C60300C00001840C08008000000000000000000000000000000000000000000C3060188063FC0180C7FF0040007B8408087F800000000000000000000000000000000000000000081820188066040180C600006000C1840808C08000000000000000000000000000000000000000000C0C3030C0C6040080C20000300081840808C08000000000000000000000000000000000000000000C0C1830E1C60C00C1C306001818C3840808C18000000000000000000000000000000000000000000C060FE09F83FC003FC0FC0007F07D8408087F80000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000^FS`;

const { LOGO_MISTI_ZPL } = require('./logo-misti-zpl-generado.js');
const { ICONO_LAVADO_30_ZPL } = require('./icono-lavado-30-zpl.js');
const { ICONO_NO_LEJIA_ZPL } = require('./icono-no-lejia-zpl.js');
const { ICONO_PLANCHAR_BAJA_ZPL } = require('./icono-planchar-baja-zpl.js');
const { ICONO_SECADORA_BAJA_ZPL } = require('./icono-secadora-baja-zpl.js');

// ===== DATOS DE PRUEBA (PRODUCTO REAL) =====
const datosProducto = {
    subcategoria: 'SABANA',
    marca: 'BP',
    modelo: 'KING SIZE',
    codigo_producto: '010002',
    unidad_medida: 'UNIDAD',
    id_solicitud: 999
};

// ===== FUNCI√ìN ORIGINAL DE SERVER.JS (CON GUILLOTINA) =====
function generarRotuladoZPL(data) {
    console.log(`üè∑Ô∏è Generando ZPL para Godex G530`);
    
    const { subcategoria, marca, modelo, codigo_producto, id_solicitud } = data;
    
    const tipoProducto = (subcategoria || 'PRODUCTO').toUpperCase();
    const telaTipo = (marca || '').toUpperCase();
    const tamano = (modelo || '').toUpperCase();
    
    let codigoBarras = codigo_producto || 'SIN-CODIGO';
    if (codigoBarras.startsWith('0') && codigoBarras.length > 1) {
        codigoBarras = codigoBarras.substring(1);
    }
    if (id_solicitud) {
        codigoBarras = `${codigoBarras}-${id_solicitud}`;
    }
    
    let productoLinea1 = tipoProducto;
    let productoLinea2 = '';
    
    if (tipoProducto.length > 18) {
        const corte = tipoProducto.lastIndexOf(' ', 18);
        if (corte > 0) {
            productoLinea1 = tipoProducto.substring(0, corte);
            productoLinea2 = tipoProducto.substring(corte + 1);
        }
    }
    
    // ‚≠ê ESTRATEGIA GUILLOTINA - FASE 1: CORTE AUTOM√ÅTICO
    // Layout 55mm total (650 dots @ 300 DPI):
    //   Y=0 a Y=59: VAC√çO (5mm = 59 dots) - buffer reutilizable
    //   Y=59: ‚Üê GUILLOTINA CORTA AQU√ç
    //   Y=60 a Y=650: DATOS (50mm = 590 dots) - etiqueta √∫til
    // 
    // ^MMC = Media Mode Cutter (modo cortador)
    // ^MNM = Media Mode Manual (sin corte autom√°tico - para probar primero)
    // Probando con ^MMC para activar el cortador
    const zpl = `^XA
^MMC
^PW354
^LL650
^LH0,0
^LS0
^FO20,70${LOGO_CAMITEX_ZPL}
^CF0,35
^FO20,210^FD${productoLinea1}^FS
${productoLinea2 ? `^CF0,30\n^FO20,250^FD${productoLinea2}^FS` : ''}
^CF0,25
^FO20,${productoLinea2 ? '290' : '255'}^FDTELA: ${telaTipo}^FS
^FO20,${productoLinea2 ? '320' : '285'}^FDMODELO: ${tamano}^FS
^CF0,22
^FO20,${productoLinea2 ? '350' : '315'}^FDHECHO EN PERU^FS
^FO10,375${ICONO_LAVADO_30_ZPL}
^FO100,375${ICONO_NO_LEJIA_ZPL}
^FO10,475${ICONO_PLANCHAR_BAJA_ZPL}
^FO100,475${ICONO_SECADORA_BAJA_ZPL}
^FO190,390${LOGO_MISTI_ZPL}
^FO20,580^BY1.5^BCN,55,N,N^FD${codigoBarras}^FS
^XZ`;
    
    console.log(`‚úÖ ZPL generado con guillotina: ${zpl.length} caracteres`);
    console.log(`üì¶ ${productoLinea1} | Tela: ${telaTipo} | Modelo: ${tamano}`);
    return zpl;
}

// ===== ENVIAR A GODEX =====
function enviarAGodex(zplData) {
    const GODEX_IP = '192.168.1.35';
    const GODEX_PORT = 9100;
    
    return new Promise((resolve, reject) => {
        const socket = new net.Socket();
        socket.setTimeout(20000);
        
        socket.connect(GODEX_PORT, GODEX_IP, () => {
            console.log(`üîó Conectado a ${GODEX_IP}:${GODEX_PORT}`);
            console.log(`üì§ Enviando ${zplData.length} caracteres...`);
            socket.write(zplData);
            socket.end();
        });
        
        socket.on('close', () => {
            console.log(`‚úÖ Impresi√≥n enviada`);
            resolve(true);
        });
        
        socket.on('error', (error) => {
            console.error(`‚ùå Error: ${error.message}`);
            reject(error);
        });
        
        socket.on('timeout', () => {
            console.error(`‚è±Ô∏è Timeout`);
            socket.destroy();
            reject(new Error('Timeout'));
        });
    });
}

// ===== EJECUTAR =====
console.log('üî™ TEST GUILLOTINA CON C√ìDIGO REAL DE SERVER.JS\n');
console.log('üìã Producto de prueba:', datosProducto);
console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n');

const zpl = generarRotuladoZPL(datosProducto);

enviarAGodex(zpl)
    .then(() => {
        console.log('\nüéâ ¬°√âXITO! Verifica la etiqueta impresa\n');
        console.log('‚úì ¬øSali√≥ completa con todos los datos?');
        console.log('‚úì ¬øCort√≥ autom√°ticamente?');
        console.log('‚úì ¬øRetrocedi√≥ 30mm?');
        console.log('‚úì ¬øQued√≥ lista para siguiente?');
        process.exit(0);
    })
    .catch((error) => {
        console.error('\n‚ùå ERROR:', error.message);
        process.exit(1);
    });
