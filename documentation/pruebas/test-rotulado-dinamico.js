const net = require('net');
const path = require('path');

// ===== IMPORTAR LOGOS Y ICONOS =====
const LOGO_CAMITEX_ZPL = `^GFA,4920,4920,40,000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003FFF0000000000000000000000000000000000000000000000000000000000000000000000000007FFFFF00000000000000000000000000000000000000000000000000000000000000000000000001FFFFFFE0000000000000000000000000000000000000000000000000000000000000000000000007FFFFFFF000000000000000000000000000000000000000000000000000000000000000000000001FFFFFFFFC00000000000000000000000000000000000000000000000000000000000000000000007FFFFFFFFE0000000000000000000000000000000000000000000000000000000000000000000000FFFFFFFFFE0000000000000000000000000000000000000000000000000000000000000000000001FFFFFFFFFE0000000000000000000000000000000000000000000000000000000000000000000007FFFFFFFFFE000000000000000000000000000000000000000000000000000000000000000000000FFFFF003FFE000000000000000000000000000000000000000000000000000000000000000000001FFFF80007FC000000000000000000000000000000000000000000000000000000000000000000001FFFC00001F8000006000000004000000100000000000000000000000000003000000C00000000003FFF8000000000003FE0000007FC00001FE0000FC03FFFFFFFF00FFFFFFE00FC00003F00000000007FFE000000000000FFF000000FFE00007FF8001FE07FFFFFFFF83FFFFFFF01FE00007F80000000007FFC000000000001FFF800001FFF0000FFF8003FF07FFFFFFFF87FFFFFFF83FF0000FFC000000000FFF8000000000003FFFC00003FFF8000FFFC003FF0FFFFFFFFF8FFFFFFFF83FF8001FFC000000001FFF0000000000003FFFE00003FFF8001FFFC003FF07FFFFFFFF8FFFFFFFF83FFC003FFC000000001FFE0000000000007FFFF00003FFFC001FFFE003FF07FFFFFFFF8FFFFFFFF81FFE007FFC000000003FFE0000000000007FFFF00007FFFC003FFFE003FF03FFFFFFFF07FFFFFFF00FFF00FFF8000000003FFC000000000000FFFFF80007FFFE003FFFE003FF00FFFFFFFE03FFFFFFE00FFF80FFF0000000003FF8000000000000FFFFF80007FFFE007FFFE003FF00003FF000007FE0000007FFC1FFE0000000007FF8000000000001FFDFFC0007FFFF007FFFE003FF00003FF00000FFC0000003FFC3FFC0000000007FF0000000000001FF8FFC0007FFFF007FFFF003FF00003FF00000FF80000001FFE7FF80000000007FF0000000000003FF8FFE000FFFFF00FFFFF003FF00003FF00001FF80000000FFFFFF80000000007FF0000000000003FF07FE000FFFFF80FFFFF003FF00003FF00001FF800000007FFFFF00000000007FE0000000000007FF07FF000FFCFF81FFBFF003FF00003FF00001FF000000003FFFFE0000000000FFE0000000000007FE03FF000FFCFFC1FF3FF803FF00003FF00003FFFFFF80001FFFFC0000000000FFE000000000000FFE03FF800FFC7FC1FF1FF803FF00003FF0000FFFFFFFE0000FFFF80000000000FFE200000000000FFC01FF800FFC7FE3FE1FF803FF00003FF0001FFFFFFFE0000FFFF00000000000FFE200000000000FFC01FF801FFC3FE3FE1FF803FF00003FF0001FFFFFFFE00007FFE00000000000FFE300000000001FFC01FFC01FFC3FE7FE1FF803FF00003FF0001FFFFFFFE00007FFE00000000000FFE100000000001FF800FFC01FFC3FF7FC1FF803FF00003FF0001FFFFFFFE0000FFFF000000000007FE180000000001FF800FFE01FF81FFFFC1FFC03FF00003FF0001FFFFFFFE0001FFFF800000000007FE180000000003FFFFFFFE01FF81FFFF80FFC03FF00003FF0000FFFFFFF80003FFFFC00000000007FE1C0000000003FFFFFFFE01FF80FFFF80FFC03FF00003FF00003FF000000007FFFFE00000000007FE1E0000000007FFFFFFFF01FF80FFFF80FFC03FF00003FF00003FF00000000FFFFFF00000000007FF0F800000000FFFFFFFFF01FF807FFF00FFC03FF00003FF00003FF00000001FFFFFF80000000007FF0FC00000780FFFFFFFFF81FF807FFF00FFC03FF00003FF00003FF00000001FFE7FFC0000000003FF07F00003FE0FFFFFFFFF81FF807FFE00FFC03FF00003FF00003FF00000003FFC3FFE0000000003FF87FE000FFE0FFFFFFFFF83FF803FFE00FFC03FF00003FF00003FF00000007FF81FFF0000000001FF83FFFFFFFF1FFC0001FFC3FF803FFC00FFE03FF00003FF00003FFFFFFF00FFF00FFF8000000001FFC3FFFFFFFF1FF80001FFC3FF801FFC00FFE03FF00003FF00003FFFFFFF81FFE007FF8000000000FFE1FFFFFFFF1FF80000FFC3FF800FF800FFE03FF00003FF00001FFFFFFF83FFC003FFC000000000FFE0FFFFFFFE1FF80000FFC3FF0007F0007FE03FF00003FF00001FFFFFFF83FFC003FFC0000000007FF07FFFFFFE1FF00000FFC3FF0001C0007FE03FF00003FF00000FFFFFFF87FF8001FFC0000000007FF83FFFFFF81FF000007FC1FF000000007FC03FF00003FF000007FFFFFF83FF0000FFC0000000003FFC1FFFFFE01FF000007F81FE000000007FC01FE00001FF000003FFFFFF03FE00007F80000000001FFE07FFFF800FC000001F007C000000001F000FC00000FC0000007FFFFE01FC00003F00000000000FFF01FFF80000000000000000000000000000000000000000000003FF00007000000000000000000FFFC00000000000000000000000000000000000000000000000000000000000000000000000000007FFF00000000000000000000000000000000000000000000000000000000000000000000000000003FFF8000000000000000003FFFFFFFFFFF80000000000000000000000000000000000000000000001FFFE000000000000001FFFFFFFFFFFFFFFFF80000000000000000000000000000000000000000000FFFFC000000000001FFFFFFFFFFFFFFFFFFFFFC000000000000000000000000000000000000000003FFFF8000000003FFFFFFFFFFFFFFFFFFFFFFFFFC0000000000000000000000000000C00000000001FFFFFC000001FFFFFFFFFFFFFFFFFFFFFFFFFFFFF8000000000000000000000000070000000000007FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF800000000000000000000003C0000000000003FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFE000000000000000000001F00000000000000FFFFFFFFFFFFFFFFFFFFF0000001FFFFFFFFFFFFFFFFFE000000000000000001FC000000000000001FFFFFFFFFFFFFFFFC00000000000000FFFFFFFFFFFFFFFC000000000000001FE00000000000000007FFFFFFFFFFFFFC0000000000000000007FFFFFFFFFFFFFFF00000000000FFF800000000000000000FFFFFFFFFFFC00000000000000000000001FFFFFFFFFFFFFFFF00000FFFFFC0000000000000000000FFFFFFFFF000000000000000000000000003FFFFFFFFFFFFFFFFFFFFFFFFE0000000000000000000001FFFFC0000000000000000000000000000003FFFFFFFFFFFFFFFFFFFFE0000000000000000000000000000000000000000000000000000000000003FFFFFFFFFFFFFFFFFF0000000000000000000000000000000000000000000000000000000000000007FFFFFFFFFFFFFFE0000000000000000000000000000000000000000000000000000000000000000003FFFFFFFFFFF00000000000000000000000000000000000000000000000000000000000000000000000FFFFFFC0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000FF000000000000000C0000007E000000000000000000000000000000000000000000000000000000C7C00000000000000C000001C380000000000000000000000000000000000000000000000000000080600000000000000C0000030080000000000000000000000000000000000000000000000000000080300000000000000C000006000000000000000000000000000000000000000000000000000000008030FC0BF03F8003EC0F80040007E07F3F07F00000000000000000000000000000000000000000008021870E1C20C00E1C38600C00003071E1841800000000000000000000000000000000000000000080E3010C040040080C20200C00001840C18008000000000000000000000000000000000000000000FFC20188060040180C60300C00001840C08008000000000000000000000000000000000000000000C3060188063FC0180C7FF0040007B8408087F800000000000000000000000000000000000000000081820188066040180C600006000C1840808C08000000000000000000000000000000000000000000C0C3030C0C6040080C20000300081840808C08000000000000000000000000000000000000000000C0C1830E1C60C00C1C306001818C3840808C18000000000000000000000000000000000000000000C060FE09F83FC003FC0FC0007F07D8408087F80000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000^FS`;

const { LOGO_MISTI_ZPL } = require(path.join(__dirname, 'logo-misti-zpl-generado.js'));
const { ICONO_LAVADO_30_ZPL } = require(path.join(__dirname, 'icono-lavado-30-zpl.js'));
const { ICONO_NO_LEJIA_ZPL } = require(path.join(__dirname, 'icono-no-lejia-zpl.js'));
const { ICONO_PLANCHAR_BAJA_ZPL } = require(path.join(__dirname, 'icono-planchar-baja-zpl.js'));
const { ICONO_SECADORA_BAJA_ZPL } = require(path.join(__dirname, 'icono-secadora-baja-zpl.js'));

// ===== FUNCIÃ“N DINÃMICA DE ROTULADO (COPIA DE SERVER.JS) =====
function generarRotuladoZPL(data, opciones = {}) {
    // ğŸ¨ OPCIONES DINÃMICAS (valores por defecto = true)
    const {
        conLogoCamitex = true,    // Mostrar logo CAMITEX arriba
        conIconos = true,          // Mostrar iconos de advertencia
        conLogoMisti = true,       // Mostrar logo MISTI
        conCorte = false           // Activar corte automÃ¡tico con guillotina
    } = opciones;
    
    console.log(`ğŸ·ï¸ [generarRotuladoZPL] Generando ZPL para Godex G530`);
    console.log(`ğŸ“‹ Datos:`, JSON.stringify(data, null, 2));
    console.log(`âš™ï¸  Opciones: Logo=${conLogoCamitex}, Iconos=${conIconos}, Misti=${conLogoMisti}, Corte=${conCorte}`);
    
    const { 
        subcategoria,
        marca,
        modelo,
        codigo_producto,
        unidad_medida,
        id_solicitud
    } = data;
    
    const tipoProducto = (subcategoria || 'PRODUCTO').toUpperCase();
    const telaTipo = (marca || '').toUpperCase();
    const tamano = (modelo || '').toUpperCase();
    
    // CÃ³digo de barras
    let codigoBarras = codigo_producto || 'SIN-CODIGO';
    if (codigoBarras.startsWith('0') && codigoBarras.length > 1) {
        codigoBarras = codigoBarras.substring(1);
    }
    if (id_solicitud) {
        codigoBarras = `${codigoBarras}-${id_solicitud}`;
    }
    
    // Dividir producto en 2 lÃ­neas si es muy largo
    let productoLinea1 = tipoProducto;
    let productoLinea2 = '';
    
    if (tipoProducto.length > 18) {
        const corte = tipoProducto.lastIndexOf(' ', 18);
        if (corte > 0) {
            productoLinea1 = tipoProducto.substring(0, corte);
            productoLinea2 = tipoProducto.substring(corte + 1);
        }
    }
    
    // ğŸ”ª CONFIGURACIÃ“N DE CORTE
    const OFFSET_CORTE = conCorte ? 60 : 0;
    const ALTURA_LABEL = conCorte ? 650 : 590;
    const MODO_MEDIA = conCorte ? '^MMC' : '^MNN';
    
    // ğŸ“ POSICIONES DINÃMICAS
    const Y_LOGO = 10 + OFFSET_CORTE;
    const Y_PRODUCTO_1 = 150 + OFFSET_CORTE;
    const Y_PRODUCTO_2 = 190 + OFFSET_CORTE;
    const Y_TELA = (productoLinea2 ? 230 : 195) + OFFSET_CORTE;
    const Y_MODELO = (productoLinea2 ? 260 : 225) + OFFSET_CORTE;
    const Y_HECHO_PERU = (productoLinea2 ? 290 : 255) + OFFSET_CORTE;
    const Y_ICONOS_1 = 315 + OFFSET_CORTE;
    const Y_ICONOS_2 = 415 + OFFSET_CORTE;
    const Y_MISTI = 330 + OFFSET_CORTE;
    const Y_BARCODE = 520 + OFFSET_CORTE;
    
    // ğŸ·ï¸ CONSTRUCCIÃ“N DEL ZPL
    let zpl = `^XA
${MODO_MEDIA}
^PW354
^LL${ALTURA_LABEL}
^LH0,0
^LS0
`;
    
    // Logo CAMITEX (opcional)
    if (conLogoCamitex) {
        zpl += `^FO20,${Y_LOGO}${LOGO_CAMITEX_ZPL}\n`;
    }
    
    // Textos del producto
    zpl += `^CF0,35
^FO20,${Y_PRODUCTO_1}^FD${productoLinea1}^FS
`;
    
    if (productoLinea2) {
        zpl += `^CF0,30\n^FO20,${Y_PRODUCTO_2}^FD${productoLinea2}^FS\n`;
    }
    
    zpl += `^CF0,25
^FO20,${Y_TELA}^FDTELA: ${telaTipo}^FS
^FO20,${Y_MODELO}^FDMODELO: ${tamano}^FS
^CF0,22
^FO20,${Y_HECHO_PERU}^FDHECHO EN PERU^FS
`;
    
    // Iconos de advertencia (opcional)
    if (conIconos) {
        zpl += `^FO10,${Y_ICONOS_1}${ICONO_LAVADO_30_ZPL}
^FO100,${Y_ICONOS_1}${ICONO_NO_LEJIA_ZPL}
^FO10,${Y_ICONOS_2}${ICONO_PLANCHAR_BAJA_ZPL}
^FO100,${Y_ICONOS_2}${ICONO_SECADORA_BAJA_ZPL}
`;
    }
    
    // Logo MISTI (opcional)
    if (conLogoMisti) {
        zpl += `^FO190,${Y_MISTI}${LOGO_MISTI_ZPL}\n`;
    }
    
    // CÃ³digo de barras (siempre presente)
    zpl += `^FO20,${Y_BARCODE}^BY1.5^BCN,55,N,N^FD${codigoBarras}^FS
^XZ`;
    
    console.log(`âœ… ZPL generado: ${zpl.length} caracteres (Corte: ${conCorte ? 'SÃ' : 'NO'})`);
    return zpl;
}

// ===== FUNCIÃ“N ENVIAR A GODEX =====
function enviarAGodex(zplData, ip = '192.168.1.35', puerto = 9100) {
    return new Promise((resolve, reject) => {
        const socket = new net.Socket();
        socket.setTimeout(20000);
        
        socket.connect(puerto, ip, () => {
            console.log(`ğŸ”— Conectado a ${ip}:${puerto}`);
            console.log(`ğŸ“¤ Enviando ${zplData.length} caracteres...`);
            socket.write(zplData);
            socket.end();
        });
        
        socket.on('close', () => {
            console.log(`âœ… ImpresiÃ³n enviada correctamente`);
            resolve(true);
        });
        
        socket.on('error', (error) => {
            console.error(`âŒ Error de conexiÃ³n: ${error.message}`);
            reject(error);
        });
        
        socket.on('timeout', () => {
            console.error(`â±ï¸ Timeout de conexiÃ³n`);
            socket.destroy();
            reject(new Error('Timeout de conexiÃ³n'));
        });
    });
}

// ===== CONFIGURACIONES DE PRUEBA =====
const DATOS_PRODUCTO = {
    subcategoria: 'SABANA',
    marca: 'BP',
    modelo: 'KING SIZE',
    codigo_producto: '010002',
    unidad_medida: 'UNIDAD',
    id_solicitud: 999
};

// ğŸ¯ PRUEBAS DISPONIBLES
const PRUEBAS = {
    1: { nombre: 'COMPLETO CON CORTE', opciones: { conLogoCamitex: true, conIconos: true, conLogoMisti: true, conCorte: true } },
    2: { nombre: 'COMPLETO SIN CORTE', opciones: { conLogoCamitex: true, conIconos: true, conLogoMisti: true, conCorte: false } },
    3: { nombre: 'SIN LOGO CAMITEX', opciones: { conLogoCamitex: false, conIconos: true, conLogoMisti: true, conCorte: false } },
    4: { nombre: 'SIN ICONOS', opciones: { conLogoCamitex: true, conIconos: false, conLogoMisti: true, conCorte: false } },
    5: { nombre: 'SIN LOGO MISTI', opciones: { conLogoCamitex: true, conIconos: true, conLogoMisti: false, conCorte: false } },
    6: { nombre: 'SOLO TEXTO (sin logos ni iconos)', opciones: { conLogoCamitex: false, conIconos: false, conLogoMisti: false, conCorte: false } },
    7: { nombre: 'SOLO TEXTO CON CORTE', opciones: { conLogoCamitex: false, conIconos: false, conLogoMisti: false, conCorte: true } },
};

// ===== EJECUTAR PRUEBA =====
function ejecutarPrueba(numeroPrueba = 1, cantidad = 1) {
    const prueba = PRUEBAS[numeroPrueba];
    
    if (!prueba) {
        console.error('âŒ Prueba no vÃ¡lida. Opciones: 1-7');
        console.log('\nğŸ“‹ PRUEBAS DISPONIBLES:');
        Object.entries(PRUEBAS).forEach(([num, p]) => {
            console.log(`   ${num}. ${p.nombre}`);
        });
        return;
    }
    
    console.log('â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—');
    console.log(`â•‘  TEST ROTULADO DINÃMICO - ${prueba.nombre.padEnd(26)} â•‘`);
    console.log('â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n');
    
    console.log(`ğŸ“¦ Producto: ${DATOS_PRODUCTO.subcategoria} - ${DATOS_PRODUCTO.marca} ${DATOS_PRODUCTO.modelo}`);
    console.log(`ğŸ–¨ï¸  Godex G530 @ 192.168.1.35:9100`);
    console.log(`ğŸ“Š Cantidad: ${cantidad} etiqueta(s)`);
    console.log(`âš™ï¸  Opciones:`);
    console.log(`   - Logo CAMITEX: ${prueba.opciones.conLogoCamitex ? 'âœ…' : 'âŒ'}`);
    console.log(`   - Iconos advertencia: ${prueba.opciones.conIconos ? 'âœ…' : 'âŒ'}`);
    console.log(`   - Logo MISTI: ${prueba.opciones.conLogoMisti ? 'âœ…' : 'âŒ'}`);
    console.log(`   - Corte automÃ¡tico: ${prueba.opciones.conCorte ? 'âœ…' : 'âŒ'}`);
    console.log('\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n');
    
    // Generar ZPL
    const zpl = generarRotuladoZPL(DATOS_PRODUCTO, prueba.opciones);
    
    // Enviar N veces
    const promesas = [];
    for (let i = 0; i < cantidad; i++) {
        promesas.push(
            enviarAGodex(zpl)
                .then(() => console.log(`   âœ… Etiqueta ${i + 1}/${cantidad} enviada`))
                .catch(() => console.error(`   âŒ Etiqueta ${i + 1}/${cantidad} fallÃ³`))
        );
    }
    
    Promise.all(promesas)
        .then(() => {
            console.log('\nğŸ‰ Â¡PRUEBA COMPLETADA!\n');
            console.log('âœ“ Verifica que las etiquetas salieron correctamente');
            console.log('âœ“ Revisa logos, iconos y texto');
            if (prueba.opciones.conCorte) {
                console.log('âœ“ Verifica que cortÃ³ automÃ¡ticamente');
            }
            process.exit(0);
        })
        .catch((error) => {
            console.error('\nâŒ ERROR EN PRUEBA:', error.message);
            process.exit(1);
        });
}

// ===== ARGUMENTOS DE LÃNEA DE COMANDOS =====
const args = process.argv.slice(2);
const numeroPrueba = parseInt(args[0]) || 1;
const cantidad = parseInt(args[1]) || 1;

// Mostrar ayuda si se pide
if (args.includes('--help') || args.includes('-h')) {
    console.log('\nğŸ”§ USO: node test-rotulado-dinamico.js [numero_prueba] [cantidad]\n');
    console.log('ğŸ“‹ PRUEBAS DISPONIBLES:');
    Object.entries(PRUEBAS).forEach(([num, p]) => {
        console.log(`   ${num}. ${p.nombre}`);
    });
    console.log('\nğŸ“ EJEMPLOS:');
    console.log('   node test-rotulado-dinamico.js 1       # Prueba 1, 1 etiqueta');
    console.log('   node test-rotulado-dinamico.js 2 5     # Prueba 2, 5 etiquetas');
    console.log('   node test-rotulado-dinamico.js 7 10    # Prueba 7, 10 etiquetas\n');
    process.exit(0);
}

// Ejecutar prueba
ejecutarPrueba(numeroPrueba, cantidad);
