<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administraci√≥n Avanzado - Sistema de Etiquetas QR</title>
    <link rel="icon" type="image/x-icon" href="logo-icon.ico">
    <link rel="stylesheet" href="gender-themes.css">
    <script src="theme-system.js" defer></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #2563eb;
            --secondary-color: #1e40af;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --error-color: #ef4444;
            --bg-primary: #f8fafc;
            --bg-secondary: #e2e8f0;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --border-color: #e2e8f0;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
            --radius: 0.5rem;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab);
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite;
            color: var(--text-primary);
            line-height: 1.6;
            position: relative;
            min-height: 100vh;
        }

        /* Animated Gradient Background */
        @keyframes gradientShift {
            0% {
                background-position: 0% 50%;
            }
            50% {
                background-position: 100% 50%;
            }
            100% {
                background-position: 0% 50%;
            }
        }

        /* Overlay para mejorar legibilidad */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(10px);
            z-index: -1;
            pointer-events: none;
        }

        /* Part√≠culas flotantes */
        body::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(circle at 20% 50%, rgba(255, 255, 255, 0.3) 1px, transparent 1px),
                radial-gradient(circle at 60% 70%, rgba(255, 255, 255, 0.3) 1px, transparent 1px),
                radial-gradient(circle at 80% 30%, rgba(255, 255, 255, 0.3) 1px, transparent 1px);
            background-size: 200px 200px, 300px 300px, 250px 250px;
            animation: floatParticles 20s linear infinite;
            z-index: -1;
            pointer-events: none;
        }

        @keyframes floatParticles {
            0% {
                transform: translateY(0) translateX(0);
            }
            100% {
                transform: translateY(-100vh) translateX(50px);
            }
        }

        /* Capa de ondas animadas */
        .waves-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -2;
            opacity: 0.3;
            background: 
                radial-gradient(ellipse at 50% 0%, rgba(255, 255, 255, 0.5), transparent 50%),
                radial-gradient(ellipse at 0% 50%, rgba(37, 99, 235, 0.3), transparent 50%),
                radial-gradient(ellipse at 100% 50%, rgba(236, 72, 153, 0.3), transparent 50%),
                repeating-linear-gradient(
                    0deg,
                    transparent,
                    transparent 50px,
                    rgba(255, 255, 255, 0.05) 50px,
                    rgba(255, 255, 255, 0.05) 51px
                ),
                repeating-linear-gradient(
                    90deg,
                    transparent,
                    transparent 50px,
                    rgba(255, 255, 255, 0.05) 50px,
                    rgba(255, 255, 255, 0.05) 51px
                );
            animation: wavesPulse 8s ease-in-out infinite;
        }

        @keyframes wavesPulse {
            0%, 100% {
                transform: scale(1);
                opacity: 0.3;
            }
            50% {
                transform: scale(1.1);
                opacity: 0.5;
            }
        }

        /* Estrellas brillantes */
        .stars {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            pointer-events: none;
        }

        .star {
            position: absolute;
            width: 3px;
            height: 3px;
            background: white;
            border-radius: 50%;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.8);
            animation: twinkle 3s ease-in-out infinite;
        }

        @keyframes twinkle {
            0%, 100% {
                opacity: 0.3;
                transform: scale(1);
            }
            50% {
                opacity: 1;
                transform: scale(1.5);
            }
        }

        .star:nth-child(1) { top: 10%; left: 20%; animation-delay: 0s; }
        .star:nth-child(2) { top: 20%; left: 80%; animation-delay: 0.5s; }
        .star:nth-child(3) { top: 60%; left: 10%; animation-delay: 1s; }
        .star:nth-child(4) { top: 80%; left: 70%; animation-delay: 1.5s; }
        .star:nth-child(5) { top: 30%; left: 50%; animation-delay: 2s; }
        .star:nth-child(6) { top: 70%; left: 40%; animation-delay: 2.5s; }
        .star:nth-child(7) { top: 15%; left: 60%; animation-delay: 0.3s; }
        .star:nth-child(8) { top: 50%; left: 90%; animation-delay: 1.2s; }
        .star:nth-child(9) { top: 85%; left: 25%; animation-delay: 1.8s; }
        .star:nth-child(10) { top: 40%; left: 75%; animation-delay: 0.8s; }

        /* Burbujas flotantes */
        .bubbles {
            position: fixed;
            bottom: -100px;
            width: 100%;
            height: 100%;
            z-index: -1;
            pointer-events: none;
        }

        .bubble {
            position: absolute;
            bottom: -100px;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.4), rgba(255, 255, 255, 0.1));
            border-radius: 50%;
            animation: riseBubble 10s ease-in infinite;
        }

        @keyframes riseBubble {
            0% {
                bottom: -100px;
                opacity: 0;
            }
            10% {
                opacity: 1;
            }
            90% {
                opacity: 1;
            }
            100% {
                bottom: 110vh;
                opacity: 0;
            }
        }

        .bubble:nth-child(1) { width: 60px; height: 60px; left: 10%; animation-delay: 0s; animation-duration: 12s; }
        .bubble:nth-child(2) { width: 40px; height: 40px; left: 25%; animation-delay: 2s; animation-duration: 14s; }
        .bubble:nth-child(3) { width: 80px; height: 80px; left: 50%; animation-delay: 4s; animation-duration: 10s; }
        .bubble:nth-child(4) { width: 50px; height: 50px; left: 70%; animation-delay: 1s; animation-duration: 13s; }
        .bubble:nth-child(5) { width: 70px; height: 70px; left: 85%; animation-delay: 3s; animation-duration: 11s; }

        /* Header */
        .admin-header {
            background: linear-gradient(
                135deg,
                rgba(200, 210, 220, 0.95),
                rgba(230, 235, 240, 0.95),
                rgba(210, 220, 230, 0.95)
            );
            background-size: 200% 200%;
            color: #1a202c;
            padding: 1.5rem;
            box-shadow: 
                var(--shadow-lg),
                0 0 10px rgba(255, 255, 255, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.8),
                inset 0 -1px 0 rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.6);
            animation: chromeShift 8s ease infinite;
        }

        @keyframes chromeShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .admin-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                90deg,
                transparent,
                rgba(255, 255, 255, 0.4),
                transparent
            );
            animation: headerShine 4s infinite;
        }

        @keyframes headerShine {
            0% {
                left: -100%;
            }
            100% {
                left: 100%;
            }
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1400px;
            margin: 0 auto;
        }

        .admin-title {
            font-size: 1.875rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            text-shadow: 
                0 1px 0 rgba(255, 255, 255, 0.8),
                0 -1px 0 rgba(0, 0, 0, 0.2);
            color: #2d3748;
        }

        @keyframes glowPulse {
            0%, 100% {
                text-shadow: 
                    0 1px 0 rgba(255, 255, 255, 0.8),
                    0 -1px 0 rgba(0, 0, 0, 0.2);
            }
            50% {
                text-shadow: 
                    0 1px 0 rgba(255, 255, 255, 0.9),
                    0 -1px 0 rgba(0, 0, 0, 0.25);
            }
        }

        /* Luces flotantes adicionales */
        .floating-lights {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
            overflow: hidden;
        }
        
        .light {
            position: absolute;
            width: 200px;
            height: 200px;
            border-radius: 50%;
            filter: blur(60px);
            opacity: 0.4;
            animation: floatLight 12s ease-in-out infinite;
        }
        
        .light:nth-child(1) {
            background: radial-gradient(circle, rgba(255, 0, 255, 0.6), transparent);
            top: 10%;
            left: 20%;
            animation-delay: 0s;
            animation-duration: 15s;
        }
        
        .light:nth-child(2) {
            background: radial-gradient(circle, rgba(0, 255, 255, 0.6), transparent);
            top: 60%;
            left: 70%;
            animation-delay: 3s;
            animation-duration: 18s;
        }
        
        .light:nth-child(3) {
            background: radial-gradient(circle, rgba(255, 255, 0, 0.5), transparent);
            top: 80%;
            left: 30%;
            animation-delay: 6s;
            animation-duration: 20s;
        }
        
        @keyframes floatLight {
            0%, 100% {
                transform: translate(0, 0) scale(1);
            }
            33% {
                transform: translate(50px, -50px) scale(1.2);
            }
            66% {
                transform: translate(-30px, 30px) scale(0.8);
            }
        }

        /* Part√≠culas de confeti */
        .confetti-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
            overflow: hidden;
        }
        
        .confetti {
            position: absolute;
            width: 8px;
            height: 8px;
            top: -10px;
            opacity: 0.7;
            animation: fallConfetti 8s linear infinite;
        }
        
        .confetti:nth-child(1) {
            left: 10%;
            background: #ff6b6b;
            animation-delay: 0s;
            animation-duration: 7s;
        }
        
        .confetti:nth-child(2) {
            left: 25%;
            background: #4ecdc4;
            animation-delay: 1.5s;
            animation-duration: 9s;
        }
        
        .confetti:nth-child(3) {
            left: 40%;
            background: #ffe66d;
            animation-delay: 3s;
            animation-duration: 8s;
        }
        
        .confetti:nth-child(4) {
            left: 55%;
            background: #a8e6cf;
            animation-delay: 0.5s;
            animation-duration: 10s;
        }
        
        .confetti:nth-child(5) {
            left: 70%;
            background: #ff8b94;
            animation-delay: 2s;
            animation-duration: 7.5s;
        }
        
        .confetti:nth-child(6) {
            left: 85%;
            background: #c7ceea;
            animation-delay: 4s;
            animation-duration: 9.5s;
        }
        
        @keyframes fallConfetti {
            0% {
                top: -10px;
                transform: rotate(0deg);
                opacity: 0.7;
            }
            100% {
                top: 110vh;
                transform: rotate(720deg);
                opacity: 0;
            }
        }

        .admin-header-logo {
            height: 50px;
            width: auto;
            background: rgba(255, 255, 255, 0.9);
            padding: 5px 10px;
            border-radius: 6px;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
            transition: all 0.3s ease;
        }

        .admin-header-logo:hover {
            transform: scale(1.05);
            background: rgba(255, 255, 255, 0.95);
            filter: drop-shadow(0 2px 6px rgba(0,0,0,0.4));
        }

        .admin-info {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        /* Dark Mode Toggle */
        .dark-mode-toggle {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 30px;
        }

        .dark-mode-toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .dark-mode-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 30px;
        }

        .dark-mode-slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .dark-mode-slider {
            background-color: #2196F3;
        }

        input:checked + .dark-mode-slider:before {
            transform: translateX(30px);
        }

        /* Dark Mode Styles */
        body.dark-mode {
            background: #1a1a1a;
            color: #e0e0e0;
        }

        .dark-mode .header {
            background: linear-gradient(135deg, #2d3748 0%, #1a202c 100%);
        }

        .dark-mode .main-container {
            background: #1a1a1a;
        }

        .dark-mode .dashboard-card,
        .dark-mode .table-container,
        .dark-mode .chart-container,
        .dark-mode .status-card,
        .dark-mode .analytics-filters {
            background: #2d3748;
            border: 1px solid #4a5568;
            color: #e0e0e0;
        }

        .dark-mode .nav-tab {
            background: #2d3748;
            color: #e0e0e0;
            border: 1px solid #4a5568;
        }

        .dark-mode .nav-tab.active {
            background: #4a5568;
            color: #ffffff;
        }

        .dark-mode .nav-tab:hover {
            background: #4a5568;
        }

        .dark-mode table {
            background: #2d3748;
        }

        .dark-mode th {
            background: #4a5568 !important;
            color: #e0e0e0;
        }

        .dark-mode td {
            color: #e0e0e0;
            border-bottom: 1px solid #4a5568 !important;
        }

        .dark-mode .btn-primary {
            background: #3182ce;
        }

        .dark-mode .btn-secondary {
            background: #4a5568;
            color: #e0e0e0;
        }

        .dark-mode input, 
        .dark-mode select, 
        .dark-mode textarea {
            background: #2d3748;
            color: #e0e0e0;
            border: 1px solid #4a5568;
        }

        .dark-mode .modal {
            background: rgba(0, 0, 0, 0.8);
        }

        .dark-mode .modal-content {
            background: #2d3748;
            color: #e0e0e0;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: rgba(255, 255, 255, 0.6);
            padding: 0.5rem 1rem;
            border-radius: var(--radius);
            font-size: 0.875rem;
            box-shadow: 
                0 2px 8px rgba(0, 0, 0, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.5);
            color: #2d3748;
            font-weight: 500;
        }

        /* Main Layout */
        .main-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Dashboard Cards */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .dashboard-card {
            background: rgba(255, 255, 255, 0.75);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border-radius: var(--radius);
            padding: 1.5rem;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.18);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .dashboard-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(
                45deg,
                transparent,
                rgba(255, 255, 255, 0.1),
                transparent
            );
            transform: rotate(45deg);
            transition: all 0.6s ease;
        }

        .dashboard-card:hover::before {
            left: 100%;
        }

        .dashboard-card:hover {
            box-shadow: 0 12px 40px 0 rgba(31, 38, 135, 0.25);
            transform: translateY(-5px) scale(1.02);
            border-color: rgba(255, 255, 255, 0.3);
        }

        .card-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .card-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .card-action {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: var(--radius);
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.2s ease;
        }

        .card-action:hover {
            background: var(--secondary-color);
        }

        /* Navigation Tabs */
        .nav-tabs {
            display: flex;
            background: white;
            border-radius: var(--radius);
            padding: 0.25rem;
            box-shadow: var(--shadow-sm);
            margin-bottom: 2rem;
            overflow-x: auto;
        }

        .nav-tab {
            flex: 1;
            min-width: 120px;
            padding: 0.75rem 1rem;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-weight: 500;
            border-radius: calc(var(--radius) - 0.125rem);
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .nav-tab:hover {
            color: var(--text-primary);
            background: var(--bg-secondary);
        }

        .nav-tab.active {
            background: var(--primary-color);
            color: white;
            box-shadow: var(--shadow-sm);
        }

        /* Content Sections */
        .content-section {
            display: none;
        }

        .content-section.active {
            display: block;
        }

        /* Tables */
        .table-container {
            background: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow-md);
            overflow: hidden;
        }

        .table-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .table-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .table-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: var(--radius);
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: linear-gradient(
                135deg, 
                var(--primary-color), 
                var(--secondary-color),
                #ec4899,
                var(--primary-color)
            );
            background-size: 300% 300%;
            color: white;
            position: relative;
            overflow: hidden;
            box-shadow: 
                0 4px 15px rgba(37, 99, 235, 0.3),
                0 0 20px rgba(236, 72, 153, 0.2);
            animation: buttonGradient 4s ease infinite;
        }

        @keyframes buttonGradient {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .btn-primary::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn-primary::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(
                45deg,
                transparent,
                rgba(255, 255, 255, 0.1),
                transparent
            );
            transform: rotate(45deg);
            animation: buttonShine 3s linear infinite;
        }

        @keyframes buttonShine {
            0% { transform: translateX(-100%) rotate(45deg); }
            100% { transform: translateX(100%) rotate(45deg); }
        }

        .btn-primary:hover::before {
            width: 300px;
            height: 300px;
        }

        .btn-primary:hover {
            box-shadow: 
                0 6px 20px rgba(37, 99, 235, 0.4),
                0 0 30px rgba(236, 72, 153, 0.4);
            transform: translateY(-2px) scale(1.02);
        }

        .btn-success {
            background: var(--success-color);
            color: white;
        }

        .btn-warning {
            background: var(--warning-color);
            color: white;
        }

        .btn-error {
            background: var(--error-color);
            color: white;
        }

        .btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        /* Search and Filters */
        .search-filters {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .search-input {
            flex: 1;
            min-width: 300px;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            font-size: 0.875rem;
        }

        .filter-select {
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            background: white;
            min-width: 120px;
        }

        /* Data Table */
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th {
            background: var(--bg-primary);
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            color: var(--text-primary);
            border-bottom: 2px solid var(--border-color);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .data-table td {
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-secondary);
        }

        .data-table tr:hover {
            background: var(--bg-primary);
        }

        /* Action Buttons in Table */
        .table-actions-cell {
            display: flex;
            gap: 0.25rem;
        }

        .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            border-radius: 0.25rem;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            backdrop-filter: blur(4px);
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: var(--radius);
            padding: 2rem;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
        }

        .modal-header {
            margin-bottom: 1.5rem;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .modal-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-secondary);
        }

        /* Form */
        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text-primary);
        }

        .form-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            font-size: 0.875rem;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .form-actions {
            display: flex;
            gap: 0.5rem;
            justify-content: end;
            margin-top: 1.5rem;
        }

        /* Checkboxes */
        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 0.75rem;
            margin-top: 0.5rem;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            transition: all 0.2s ease;
        }

        .checkbox-label:hover {
            background: var(--bg-secondary);
            border-color: var(--primary-color);
        }

        .checkbox-label input[type="checkbox"] {
            margin: 0;
            cursor: pointer;
        }

        .checkbox-label span {
            font-size: 0.875rem;
            color: var(--text-primary);
        }

        /* Loading */
        .loading {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .spinner {
            width: 1rem;
            height: 1rem;
            border: 2px solid var(--border-color);
            border-top: 2px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .main-container {
                padding: 1rem;
            }
            
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .table-header {
                flex-direction: column;
                align-items: start;
            }
            
            .search-filters {
                flex-direction: column;
            }
            
            .search-input {
                min-width: 100%;
            }
        }

        /* Maintenance Tools Styles */
        .maintenance-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 1.5rem;
            margin-top: 1rem;
        }

        .maintenance-card {
            background: white;
            border-radius: var(--radius);
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-md);
            transition: all 0.2s ease;
        }

        .maintenance-card:hover {
            box-shadow: var(--shadow-lg);
            transform: translateY(-2px);
        }

        .maintenance-header {
            padding: 1.5rem 1.5rem 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .maintenance-header h3 {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .maintenance-header p {
            color: var(--text-secondary);
            font-size: 0.875rem;
            margin: 0;
        }

        .maintenance-content {
            padding: 1.5rem;
        }

        .maintenance-stats {
            background: var(--bg-primary);
            border-radius: var(--radius);
            padding: 1rem;
            margin-bottom: 1rem;
            border: 1px solid var(--border-color);
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--border-color);
        }

        .stat-item:last-child {
            border-bottom: none;
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .stat-value {
            font-weight: 600;
            color: var(--text-primary);
        }

        .maintenance-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .maintenance-actions .btn {
            flex: 1;
            min-width: 120px;
        }

        .date-range {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .date-range span {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .date-range input {
            flex: 1;
        }

        /* Dark mode support for maintenance tools */
        [data-theme="dark"] .maintenance-card {
            background: var(--bg-secondary);
            border-color: #374151;
        }

        [data-theme="dark"] .maintenance-header {
            border-bottom-color: #374151;
        }

        [data-theme="dark"] .maintenance-stats {
            background: #1f2937;
            border-color: #374151;
        }

        [data-theme="dark"] .stat-item {
            border-bottom-color: #374151;
        }

        /* Chat System Styles */
        .chat-container {
            display: flex;
            height: 70vh;
            background: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow-md);
            overflow: hidden;
        }

        .chat-sidebar {
            width: 300px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
        }

        .chat-header {
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
            background: white;
        }

        .chat-header h3 {
            margin: 0 0 0.5rem;
            font-size: 1.1rem;
        }

        .user-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
        }

        .status-online { background: #10b981; }
        .status-away { background: #f59e0b; }
        .status-busy { background: #ef4444; }
        .status-offline { background: #6b7280; }

        .status-select {
            padding: 0.25rem;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 0.75rem;
            background: white;
        }

        .chat-channels, .online-users {
            flex: 1;
            overflow-y: auto;
        }

        .channels-header, .users-header {
            padding: 0.75rem 1rem;
            background: var(--bg-primary);
            font-weight: 600;
            font-size: 0.875rem;
            color: var(--text-secondary);
            border-bottom: 1px solid var(--border-color);
        }

        .channels-list, .users-list {
            padding: 0.5rem 0;
        }

        .channel-item, .user-item {
            padding: 0.5rem 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 0.875rem;
            transition: background-color 0.2s;
        }

        .channel-item:hover, .user-item:hover {
            background: rgba(37, 99, 235, 0.1);
        }

        .channel-item.active {
            background: var(--primary-color);
            color: white;
        }

        .channel-name {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .notification-badge {
            background: var(--error-color);
            color: white;
            font-size: 0.75rem;
            padding: 0.125rem 0.375rem;
            border-radius: 10px;
            min-width: 18px;
            text-align: center;
        }

        .chat-main {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .chat-messages-header {
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: white;
        }

        .chat-messages-header h3 {
            margin: 0;
            font-size: 1.1rem;
        }

        .chat-actions {
            display: flex;
            gap: 0.5rem;
        }

        .chat-messages {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
            background: var(--bg-primary);
            display: flex;
            flex-direction: column;
        }

        .welcome-message {
            text-align: center;
            margin: auto;
            color: var(--text-secondary);
        }

        .message {
            margin-bottom: 1rem;
            padding: 0.75rem;
            background: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow-sm);
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .message-author {
            font-weight: 600;
            color: var(--primary-color);
            font-size: 0.875rem;
        }

        .message-time {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .message-content {
            color: var(--text-primary);
            line-height: 1.5;
            white-space: pre-wrap;
        }

        .message.own {
            background: var(--primary-color);
            color: white;
            align-self: flex-end;
            max-width: 70%;
        }

        .message.own .message-author {
            color: white;
        }

        .message.own .message-time {
            color: rgba(255, 255, 255, 0.8);
        }

        .message.system {
            background: var(--bg-secondary);
            color: var(--text-secondary);
            font-style: italic;
            text-align: center;
        }

        .chat-input-container {
            padding: 1rem;
            border-top: 1px solid var(--border-color);
            background: white;
        }

        .chat-input-wrapper {
            display: flex;
            gap: 0.5rem;
            align-items: flex-end;
        }

        .message-input {
            flex: 1;
            min-height: 40px;
            max-height: 100px;
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            resize: none;
            font-family: inherit;
            font-size: 0.875rem;
        }

        .send-button {
            padding: 0.5rem 0.75rem;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--radius);
            cursor: pointer;
            font-size: 1rem;
        }

        .send-button:hover {
            background: var(--secondary-color);
        }

        .chat-input-actions {
            margin-top: 0.5rem;
        }

        /* Dark mode support for chat */
        [data-theme="dark"] .chat-container {
            background: var(--bg-secondary);
        }

        [data-theme="dark"] .chat-sidebar {
            background: #1f2937;
            border-right-color: #374151;
        }

        [data-theme="dark"] .chat-header {
            background: var(--bg-secondary);
            border-bottom-color: #374151;
        }

        [data-theme="dark"] .channels-header,
        [data-theme="dark"] .users-header {
            background: #111827;
            border-bottom-color: #374151;
        }

        [data-theme="dark"] .chat-messages-header {
            background: var(--bg-secondary);
            border-bottom-color: #374151;
        }

        [data-theme="dark"] .chat-messages {
            background: #111827;
        }

        [data-theme="dark"] .message {
            background: var(--bg-secondary);
        }

        [data-theme="dark"] .chat-input-container {
            background: var(--bg-secondary);
            border-top-color: #374151;
        }

        /* Responsive design for chat */
        @media (max-width: 768px) {
            .chat-container {
                flex-direction: column;
                height: auto;
            }
            
            .chat-sidebar {
                width: 100%;
                max-height: 200px;
            }
        }
    </style>
</head>
<body>
    <!-- Efectos visuales de fondo -->
    <div class="waves-background"></div>
    
    <!-- Estrellas brillantes -->
    <div class="stars">
        <div class="star"></div>
        <div class="star"></div>
        <div class="star"></div>
        <div class="star"></div>
        <div class="star"></div>
        <div class="star"></div>
        <div class="star"></div>
        <div class="star"></div>
        <div class="star"></div>
        <div class="star"></div>
    </div>

    <!-- Burbujas flotantes -->
    <div class="bubbles">
        <div class="bubble"></div>
        <div class="bubble"></div>
        <div class="bubble"></div>
        <div class="bubble"></div>
        <div class="bubble"></div>
    </div>

    <!-- Luces flotantes grandes -->
    <div class="floating-lights">
        <div class="light"></div>
        <div class="light"></div>
        <div class="light"></div>
    </div>

    <!-- Confeti cayendo -->
    <div class="confetti-container">
        <div class="confetti"></div>
        <div class="confetti"></div>
        <div class="confetti"></div>
        <div class="confetti"></div>
        <div class="confetti"></div>
        <div class="confetti"></div>
    </div>

    <!-- Header -->
    <div class="admin-header">
        <div class="header-content">
            <div class="admin-title">
                <!--LOGO_START<img src="assets/logoicon.png" alt="Logo de la Empresa" class="admin-header-logo">LOGO_END-->
                Panel de Administraci√≥n
            </div>
            <div class="admin-info">
                <div class="status-indicator">
                    <span id="db-status">PostgreSQL Conectado</span>
                </div>
                <div class="status-indicator">
                    <span id="print-status">Impresora Lista</span>
                </div>
                <div class="status-indicator">
                    <span id="sync-status">Sincronizaci√≥n Activa</span>
                </div>
                <button class="btn btn-secondary" onclick="forceSyncAll()" title="Forzar sincronizaci√≥n completa" 
                        style="padding: 0.5rem; margin-left: 0.5rem;">
                    Sync
                </button>
                <div style="display: flex; align-items: center; gap: 0.5rem; margin-left: 1rem;">
                    <label class="dark-mode-toggle">
                        <input type="checkbox" id="darkModeToggle" onchange="toggleDarkMode()">
                        <span class="dark-mode-slider"></span>
                    </label>
                </div>
                <div class="decorations-toggle" onclick="toggleDecorations()" title="Activar/Desactivar decoraciones">
                    <span id="decorations-toggle-icon">DEC</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Dashboard Cards -->
        <div class="dashboard-grid" id="dashboard-grid">
            <!-- Loaded dynamically -->
        </div>

        <!-- Advanced Analytics Section -->
        <div class="analytics-container" style="margin: 2rem 0;">
            <!-- Filtros de Analytics -->
            <div class="analytics-filters" style="background: white; border-radius: 8px; padding: 1rem; margin-bottom: 1rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                    <label style="font-weight: 600;">Per√≠odo de an√°lisis:</label>
                    <select id="analytics-period" onchange="updateAnalytics()" style="padding: 0.5rem; border-radius: 4px; border: 1px solid #ddd;">
                        <option value="7">√öltimos 7 d√≠as</option>
                        <option value="15">√öltimos 15 d√≠as</option>
                        <option value="30">√öltimo mes</option>
                    </select>
                    <button onclick="refreshAnalytics()" class="btn btn-secondary" style="padding: 0.5rem 1rem;">üîÑ Actualizar</button>
                </div>
            </div>
            
            <!-- Charts Grid -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 2rem;">
                <!-- Productividad por Usuario -->
                <div class="chart-container" style="background: white; border-radius: 8px; padding: 1.5rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <h3 style="margin: 0 0 1rem 0; color: #333; display: flex; align-items: center; gap: 0.5rem;">
                        üèÜ Top Productividad (Etiquetas Completadas)
                    </h3>
                    <canvas id="productivity-chart" width="400" height="300"></canvas>
                    <div id="productivity-tooltip" style="position: absolute; background: rgba(0,0,0,0.8); color: white; padding: 8px; border-radius: 4px; font-size: 12px; pointer-events: none; opacity: 0; transition: opacity 0.2s;"></div>
                </div>
                
                <!-- Tendencias Temporales -->
                <div class="chart-container" style="background: white; border-radius: 8px; padding: 1.5rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1); position: relative;">
                    <h3 style="margin: 0 0 1rem 0; color: #333; display: flex; align-items: center; gap: 0.5rem;">
                        Tendencia Solicitudes (√öltimos 15 d√≠as)
                    </h3>
                    <canvas id="trends-chart" width="400" height="300"></canvas>
                    <div id="trends-tooltip" style="position: absolute; background: rgba(0,0,0,0.8); color: white; padding: 8px; border-radius: 4px; font-size: 12px; pointer-events: none; opacity: 0; transition: opacity 0.2s;"></div>
                </div>
            </div>
            
            <!-- Stats por Departamento -->
            <div class="department-stats" style="background: white; border-radius: 8px; padding: 1.5rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                <h3 style="margin: 0 0 1rem 0; color: #333; display: flex; align-items: center; gap: 0.5rem;">
                    Estad√≠sticas por Departamento
                </h3>
                <div id="department-stats-table">
                    <!-- Loaded dynamically -->
                </div>
            </div>
        </div>

        <!-- Navigation Tabs -->
        <div class="nav-tabs" id="nav-tabs">
            <button class="nav-tab active" onclick="showSection('usuarios')">
                Usuarios
            </button>
            <button class="nav-tab" onclick="showSection('productos')">
                Productos
            </button>
            <button class="nav-tab" onclick="showSection('solicitudes')">
                Solicitudes
            </button>
            <button class="nav-tab" onclick="showSection('productos-especiales')">
                Productos Especiales
            </button>
            <button class="nav-tab" onclick="showSection('solicitudes-especiales')">
                Solicitudes Especiales
            </button>
            <button class="nav-tab" onclick="showSection('departamentos')">
                Departamentos
            </button>
            <button class="nav-tab" onclick="showSection('estadisticas')">
                Estad√≠sticas
            </button>
            <button class="nav-tab" onclick="showSection('impresora')">
                Gesti√≥n Impresora
            </button>
            <button class="nav-tab" onclick="showSection('mantenimiento')">
                Mantenimiento
            </button>
            <button class="nav-tab" onclick="showSection('bitacora')">
                Bit√°cora de Producci√≥n
            </button>
            <button class="nav-tab" onclick="showSection('chat')">
                Chat <span id="chat-badge" class="notification-badge" style="display: none;">0</span>
            </button>
            <button class="nav-tab" onclick="showSection('configuracion')">
                Configuraci√≥n
            </button>
        </div>

        <!-- Content Sections -->
        
        <!-- Usuarios Section -->
        <div id="section-usuarios" class="content-section active">
            <div class="table-container">
                <div class="table-header">
                    <h2 class="table-title">Gesti√≥n de Usuarios</h2>
                    <div class="table-actions">
                        <button class="btn btn-primary" onclick="showCreateUserModal()">
                            ‚ûï Nuevo Usuario
                        </button>
                        <button class="btn btn-secondary" onclick="exportUsers()">
                            üì§ Exportar
                        </button>
                    </div>
                </div>
                
                <div class="search-filters">
                    <input type="text" class="search-input" placeholder="Buscar usuarios..." 
                           onkeyup="searchUsers(this.value)">
                    <select class="filter-select" onchange="filterUsers(this.value)">
                        <option value="">Todos los roles</option>
                        <option value="administracion">Administraci√≥n</option>
                        <option value="supervisor">Supervisor</option>
                        <option value="costurera">Costurera</option>
                        <option value="encargada_embalaje">Encargada Embalaje</option>
                    </select>
                    <select class="filter-select" onchange="filterUserStatus(this.value)">
                        <option value="">Todos los estados</option>
                        <option value="true">Activos</option>
                        <option value="false">Inactivos</option>
                    </select>
                </div>

                <div style="overflow-x: auto;">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>C√≥digo</th>
                                <th>Nombre Completo</th>
                                <th>Email</th>
                                <th>Rol</th>
                                <th>Departamento</th>
                                <th>Estado</th>
                                <th>√öltimo Login</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="users-table-body">
                            <!-- Loaded dynamically -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Productos Section -->
        <div id="section-productos" class="content-section">
            <div class="table-container">
                <div class="table-header">
                    <h2 class="table-title">Gesti√≥n de Productos</h2>
                    <div class="table-actions">
                        <button class="btn btn-primary" onclick="showCreateProductModal()">
                            ‚ûï Nuevo Producto
                        </button>
                        <button class="btn btn-secondary" onclick="importProducts()">
                            üì• Importar
                        </button>
                        <button class="btn btn-secondary" onclick="exportProducts()">
                            üì§ Exportar
                        </button>
                    </div>
                </div>
                
                <div class="search-filters">
                    <input type="text" class="search-input" placeholder="Buscar productos..." 
                           onkeyup="searchProducts(this.value)">
                    <select class="filter-select" onchange="filterProductStatus(this.value)">
                        <option value="">Todos los estados</option>
                        <option value="true">Activos</option>
                        <option value="false">Inactivos</option>
                    </select>
                </div>

                <div style="overflow-x: auto;">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nombre</th>
                                <th>Modelo</th>
                                <th>Descripci√≥n</th>
                                <th>Unidad</th>
                                <th>Estado</th>
                                <th>Fecha Creaci√≥n</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="products-table-body">
                            <!-- Loaded dynamically -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Solicitudes Section -->
        <div id="section-solicitudes" class="content-section">
            <div class="table-container">
                <div class="table-header">
                    <h2 class="table-title">Gesti√≥n de Solicitudes</h2>
                    <div class="table-actions">
                        <button class="btn btn-secondary" onclick="exportSolicitudes()">
                            üì§ Exportar
                        </button>
                    </div>
                </div>
                
                <div class="search-filters">
                    <input type="text" class="search-input" placeholder="Buscar solicitudes..." 
                           onkeyup="searchSolicitudes(this.value)">
                    <select class="filter-select" onchange="filterSolicitudStatus(this.value)">
                        <option value="">Todos los estados</option>
                        <option value="pendiente">Pendiente</option>
                        <option value="proceso">En Proceso</option>
                        <option value="completada">Completada</option>
                        <option value="cancelada">Cancelada</option>
                    </select>
                    <input type="date" class="filter-select" onchange="filterSolicitudDate(this.value)">
                </div>

                <div style="overflow-x: auto;">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>N√∫mero</th>
                                <th>Producto</th>
                                <th>Costurera</th>
                                <th>Cantidad</th>
                                <th>Estado</th>
                                <th>QR Code</th>
                                <th>Fecha</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="solicitudes-table-body">
                            <!-- Loaded dynamically -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Productos Especiales Section -->
        <div id="section-productos-especiales" class="content-section">
            <div class="table-container">
                <div class="table-header">
                    <h2 class="table-title">Gesti√≥n de Productos Especiales (Juegos/Combos)</h2>
                    <div class="table-actions">
                        <button class="btn btn-primary" onclick="refreshProductosEspeciales()">
                            üîÑ Actualizar
                        </button>
                        <button class="btn btn-success" onclick="exportProductosEspeciales()">
                            üì• Exportar Excel
                        </button>
                    </div>
                </div>
                
                <!-- Filtros -->
                <div style="padding: 1.5rem; background: var(--bg-primary); border-bottom: 1px solid var(--border-color); display: flex; gap: 1rem; flex-wrap: wrap;">
                    <input type="text" class="search-input" placeholder="Buscar por c√≥digo o nombre..." 
                           onkeyup="searchProductosEspeciales(this.value)" style="flex: 1; min-width: 300px;">
                    <select class="filter-select" onchange="filterProductosEspecialesByEstado(this.value)" style="padding: 0.75rem; border: 1px solid var(--border-color); border-radius: var(--radius);">
                        <option value="">üè∑Ô∏è Todos los estados</option>
                        <option value="activo">Activos</option>
                        <option value="inactivo">Inactivos</option>
                    </select>
                </div>

                <!-- Tabla -->
                <div class="table-wrapper">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>C√≥digo</th>
                                <th>Nombre Producto Especial</th>
                                <th>Componentes</th>
                                <th>Tipo</th>
                                <th>Estado</th>
                                <th>Fecha Creaci√≥n</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="productos-especiales-table-body">
                            <tr>
                                <td colspan="8" style="text-align: center; padding: 3rem; color: var(--text-secondary);">
                                    <div class="spinner" style="margin: 0 auto 1rem;"></div>
                                    <p>Cargando productos especiales...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Estad√≠sticas r√°pidas -->
                <div style="padding: 1.5rem; background: var(--bg-primary); border-top: 1px solid var(--border-color); display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                    <div style="text-align: center; padding: 1rem; background: white; border-radius: var(--radius); box-shadow: var(--shadow-sm);">
                        <div style="font-size: 2rem; font-weight: 700; color: var(--primary-color);" id="stat-total-especiales">0</div>
                        <div style="color: var(--text-secondary); font-size: 0.875rem;">Total Productos Especiales</div>
                    </div>
                    <div style="text-align: center; padding: 1rem; background: white; border-radius: var(--radius); box-shadow: var(--shadow-sm);">
                        <div style="font-size: 2rem; font-weight: 700; color: var(--success-color);" id="stat-especiales-activos">0</div>
                        <div style="color: var(--text-secondary); font-size: 0.875rem;">Activos</div>
                    </div>
                    <div style="text-align: center; padding: 1rem; background: white; border-radius: var(--radius); box-shadow: var(--shadow-sm);">
                        <div style="font-size: 2rem; font-weight: 700; color: var(--error-color);" id="stat-especiales-inactivos">0</div>
                        <div style="color: var(--text-secondary); font-size: 0.875rem;">Inactivos</div>
                    </div>
                    <div style="text-align: center; padding: 1rem; background: white; border-radius: var(--radius); box-shadow: var(--shadow-sm);">
                        <div style="font-size: 2rem; font-weight: 700; color: var(--warning-color);" id="stat-especiales-componentes">0</div>
                        <div style="color: var(--text-secondary); font-size: 0.875rem;">Total Componentes</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Solicitudes Especiales Section -->
        <div id="section-solicitudes-especiales" class="content-section">
            <div class="table-container">
                <div class="table-header">
                    <h2 class="table-title">Gesti√≥n de Solicitudes Especiales</h2>
                    <div class="table-actions">
                        <button class="btn btn-primary" onclick="refreshSolicitudesEspeciales()">
                            üîÑ Actualizar
                        </button>
                        <button class="btn btn-success" onclick="exportSolicitudesEspeciales()">
                            üì• Exportar Excel
                        </button>
                    </div>
                </div>
                
                <!-- Filtros -->
                <div style="padding: 1.5rem; background: var(--bg-primary); border-bottom: 1px solid var(--border-color); display: flex; gap: 1rem; flex-wrap: wrap;">
                    <input type="text" class="search-input" placeholder="Buscar por producto o costurera..." 
                           onkeyup="searchSolicitudesEspeciales(this.value)" style="flex: 1; min-width: 300px;">
                    <select class="filter-select" onchange="filterSolicitudesEspecialesByEstado(this.value)" style="padding: 0.75rem; border: 1px solid var(--border-color); border-radius: var(--radius);">
                        <option value="">Todos los estados</option>
                        <option value="pendiente">‚è≥ Pendientes</option>
                        <option value="proceso">üîÑ En Proceso</option>
                        <option value="completada">Completadas</option>
                        <option value="cancelada">Canceladas</option>
                    </select>
                    <input type="date" id="filter-fecha-desde" class="filter-select" style="padding: 0.75rem; border: 1px solid var(--border-color); border-radius: var(--radius);">
                    <input type="date" id="filter-fecha-hasta" class="filter-select" style="padding: 0.75rem; border: 1px solid var(--border-color); border-radius: var(--radius);">
                    <button class="btn btn-secondary" onclick="applyDateFilterSolicitudesEspeciales()">
                        Filtrar Fechas
                    </button>
                </div>

                <!-- Tabla -->
                <div class="table-wrapper">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Producto Especial</th>
                                <th>C√≥digo</th>
                                <th>Costurera</th>
                                <th>Cantidad</th>
                                <th>Progreso Impresi√≥n</th>
                                <th>Estado</th>
                                <th>Prioridad</th>
                                <th>Fecha Solicitud</th>
                                <th>Observaciones</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="solicitudes-especiales-table-body">
                            <tr>
                                <td colspan="11" style="text-align: center; padding: 3rem; color: var(--text-secondary);">
                                    <div class="spinner" style="margin: 0 auto 1rem;"></div>
                                    <p>Cargando solicitudes especiales...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Estad√≠sticas r√°pidas -->
                <div style="padding: 1.5rem; background: var(--bg-primary); border-top: 1px solid var(--border-color); display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem;">
                    <div style="text-align: center; padding: 1rem; background: white; border-radius: var(--radius); box-shadow: var(--shadow-sm);">
                        <div style="font-size: 2rem; font-weight: 700; color: var(--primary-color);" id="stat-total-sol-especiales">0</div>
                        <div style="color: var(--text-secondary); font-size: 0.875rem;">Total Solicitudes</div>
                    </div>
                    <div style="text-align: center; padding: 1rem; background: white; border-radius: var(--radius); box-shadow: var(--shadow-sm);">
                        <div style="font-size: 2rem; font-weight: 700; color: var(--warning-color);" id="stat-sol-esp-pendientes">0</div>
                        <div style="color: var(--text-secondary); font-size: 0.875rem;">Pendientes</div>
                    </div>
                    <div style="text-align: center; padding: 1rem; background: white; border-radius: var(--radius); box-shadow: var(--shadow-sm);">
                        <div style="font-size: 2rem; font-weight: 700; color: #3b82f6;" id="stat-sol-esp-proceso">0</div>
                        <div style="color: var(--text-secondary); font-size: 0.875rem;">En Proceso</div>
                    </div>
                    <div style="text-align: center; padding: 1rem; background: white; border-radius: var(--radius); box-shadow: var(--shadow-sm);">
                        <div style="font-size: 2rem; font-weight: 700; color: var(--success-color);" id="stat-sol-esp-completadas">0</div>
                        <div style="color: var(--text-secondary); font-size: 0.875rem;">Completadas</div>
                    </div>
                    <div style="text-align: center; padding: 1rem; background: white; border-radius: var(--radius); box-shadow: var(--shadow-sm);">
                        <div style="font-size: 2rem; font-weight: 700; color: var(--error-color);" id="stat-sol-esp-canceladas">0</div>
                        <div style="color: var(--text-secondary); font-size: 0.875rem;">Canceladas</div>
                    </div>
                    <div style="text-align: center; padding: 1rem; background: white; border-radius: var(--radius); box-shadow: var(--shadow-sm);">
                        <div style="font-size: 2rem; font-weight: 700; color: #8b5cf6;" id="stat-sol-esp-etiquetas">0</div>
                        <div style="color: var(--text-secondary); font-size: 0.875rem;">Etiquetas Solicitadas</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Estad√≠sticas Section -->
        <div id="section-estadisticas" class="content-section">
            <div class="table-container">
                <div class="table-header">
                    <h2 class="table-title">Estad√≠sticas y An√°lisis</h2>
                    <div class="table-actions">
                        <button class="btn btn-primary" onclick="refreshStats()">
                            üîÑ Actualizar
                        </button>
                        <button class="btn btn-secondary" onclick="exportStatsReport()">
                            Exportar Reporte
                        </button>
                    </div>
                </div>
                
                <!-- Filtros de Estad√≠sticas -->
                <div class="stats-filters-container" style="padding: 1.5rem; background: var(--bg-primary); border-bottom: 1px solid var(--border-color);">
                    <div class="stats-filter-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                        <div class="form-group">
                            <label class="form-label">Per√≠odo</label>
                            <select class="form-input" id="stats-period" onchange="updateStatsFilters()">
                                <option value="today">Hoy</option>
                                <option value="week">Esta Semana</option>
                                <option value="month" selected>Este Mes</option>
                                <option value="quarter">Este Trimestre</option>
                                <option value="year">Este A√±o</option>
                                <option value="custom">Personalizado</option>
                            </select>
                        </div>
                        
                        <div class="form-group" id="custom-date-group" style="display: none;">
                            <label class="form-label">Desde</label>
                            <input type="date" class="form-input" id="stats-date-from" onchange="updateStatsFilters()">
                        </div>
                        
                        <div class="form-group" id="custom-date-to-group" style="display: none;">
                            <label class="form-label">Hasta</label>
                            <input type="date" class="form-input" id="stats-date-to" onchange="updateStatsFilters()">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Costurera</label>
                            <select class="form-input" id="stats-costurera" onchange="updateStatsFilters()">
                                <option value="">Todas</option>
                                <!-- Loaded dynamically -->
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Producto</label>
                            <select class="form-input" id="stats-producto" onchange="updateStatsFilters()">
                                <option value="">Todos</option>
                                <!-- Loaded dynamically -->
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Estado</label>
                            <select class="form-input" id="stats-estado" onchange="updateStatsFilters()">
                                <option value="">Todos</option>
                                <option value="pendiente">Pendiente</option>
                                <option value="proceso">En Proceso</option>
                                <option value="completada">Completada</option>
                                <option value="cancelada">Cancelada</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- KPIs Dashboard -->
                <div class="kpi-dashboard" style="padding: 1.5rem; display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                    <div class="kpi-card" style="background: white; padding: 1.5rem; border-radius: var(--radius); box-shadow: var(--shadow-md); text-align: center;">
                        <div style="font-size: 2.5rem; font-weight: 700; color: var(--primary-color);" id="kpi-total-solicitudes">-</div>
                        <div style="color: var(--text-secondary); margin-top: 0.5rem;">Total Solicitudes</div>
                        <div style="font-size: 0.75rem; color: var(--success-color); margin-top: 0.25rem;" id="kpi-solicitudes-trend">-</div>
                    </div>
                    
                    <div class="kpi-card" style="background: white; padding: 1.5rem; border-radius: var(--radius); box-shadow: var(--shadow-md); text-align: center;">
                        <div style="font-size: 2.5rem; font-weight: 700; color: var(--success-color);" id="kpi-etiquetas-impresas">-</div>
                        <div style="color: var(--text-secondary); margin-top: 0.5rem;">Etiquetas Impresas</div>
                        <div style="font-size: 0.75rem; color: var(--success-color); margin-top: 0.25rem;" id="kpi-etiquetas-trend">-</div>
                    </div>
                    
                    <div class="kpi-card" style="background: white; padding: 1.5rem; border-radius: var(--radius); box-shadow: var(--shadow-md); text-align: center;">
                        <div style="font-size: 2.5rem; font-weight: 700; color: var(--warning-color);" id="kpi-tiempo-promedio">-</div>
                        <div style="color: var(--text-secondary); margin-top: 0.5rem;">Tiempo Prom. (horas)</div>
                        <div style="font-size: 0.75rem; color: var(--warning-color); margin-top: 0.25rem;" id="kpi-tiempo-trend">-</div>
                    </div>
                    
                    <div class="kpi-card" style="background: white; padding: 1.5rem; border-radius: var(--radius); box-shadow: var(--shadow-md); text-align: center;">
                        <div style="font-size: 2.5rem; font-weight: 700; color: var(--error-color);" id="kpi-tasa-completado">-</div>
                        <div style="color: var(--text-secondary); margin-top: 0.5rem;">% Completadas</div>
                        <div style="font-size: 0.75rem; color: var(--error-color); margin-top: 0.25rem;" id="kpi-completado-trend">-</div>
                    </div>
                </div>

                <!-- Charts Container -->
                <div class="charts-container" style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
                    <!-- Gr√°fico de Solicitudes por D√≠a -->
                    <div class="chart-card" style="background: white; padding: 1.5rem; border-radius: var(--radius); box-shadow: var(--shadow-md);">
                        <h3 style="margin-bottom: 1rem; color: var(--text-primary);">Solicitudes por D√≠a</h3>
                        <canvas id="chart-solicitudes-dia" width="400" height="200"></canvas>
                    </div>
                    
                    <!-- Gr√°fico de Top Costureras -->
                    <div class="chart-card" style="background: white; padding: 1.5rem; border-radius: var(--radius); box-shadow: var(--shadow-md);">
                        <h3 style="margin-bottom: 1rem; color: var(--text-primary);">Top Costureras</h3>
                        <canvas id="chart-top-costureras" width="400" height="200"></canvas>
                    </div>
                </div>
                
                <div class="charts-container" style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
                    <!-- Gr√°fico de Productos M√°s Solicitados -->
                    <div class="chart-card" style="background: white; padding: 1.5rem; border-radius: var(--radius); box-shadow: var(--shadow-md);">
                        <h3 style="margin-bottom: 1rem; color: var(--text-primary);">Productos M√°s Solicitados</h3>
                        <canvas id="chart-productos-populares" width="400" height="200"></canvas>
                    </div>
                    
                    <!-- Gr√°fico de Estados -->
                    <div class="chart-card" style="background: white; padding: 1.5rem; border-radius: var(--radius); box-shadow: var(--shadow-md);">
                        <h3 style="margin-bottom: 1rem; color: var(--text-primary);">Distribuci√≥n por Estado</h3>
                        <canvas id="chart-estados" width="400" height="200"></canvas>
                    </div>
                </div>

                <!-- Tablas de An√°lisis Detallado -->
                <div class="analysis-tables" style="display: grid; gap: 2rem;">
                    <!-- An√°lisis por Costurera -->
                    <div class="analysis-card" style="background: white; border-radius: var(--radius); box-shadow: var(--shadow-md); overflow: hidden;">
                        <div style="padding: 1.5rem; border-bottom: 1px solid var(--border-color);">
                            <h3 style="color: var(--text-primary);">An√°lisis Detallado por Costurera</h3>
                        </div>
                        <div style="overflow-x: auto;">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Costurera</th>
                                        <th>Total Solicitudes</th>
                                        <th>Completadas</th>
                                        <th>Pendientes</th>
                                        <th>% √âxito</th>
                                        <th>Etiquetas Impresas</th>
                                        <th>Tiempo Prom.</th>
                                        <th>Rendimiento</th>
                                    </tr>
                                </thead>
                                <tbody id="analysis-costureras-body">
                                    <!-- Loaded dynamically -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- An√°lisis por Producto -->
                    <div class="analysis-card" style="background: white; border-radius: var(--radius); box-shadow: var(--shadow-md); overflow: hidden;">
                        <div style="padding: 1.5rem; border-bottom: 1px solid var(--border-color);">
                            <h3 style="color: var(--text-primary);">An√°lisis Detallado por Producto</h3>
                        </div>
                        <div style="overflow-x: auto;">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Producto</th>
                                        <th>Total Solicitudes</th>
                                        <th>Cantidad Total</th>
                                        <th>Promedio por Solicitud</th>
                                        <th>Costureras Distintas</th>
                                        <th>√öltima Solicitud</th>
                                        <th>Popularidad</th>
                                    </tr>
                                </thead>
                                <tbody id="analysis-productos-body">
                                    <!-- Loaded dynamically -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Departamentos Section -->
        <div id="section-departamentos" class="content-section">
            <div class="table-container">
                <div class="table-header">
                    <h2 class="table-title">Gesti√≥n de Departamentos</h2>
                    <div class="table-actions">
                        <button class="btn btn-primary" onclick="showCreateDepartmentModal()">
                            ‚ûï Nuevo Departamento
                        </button>
                    </div>
                </div>
                
                <div style="overflow-x: auto;">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nombre Departamento</th>
                                <th>Usuarios Asignados</th>
                                <th>Fecha Creaci√≥n</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="departments-table-body">
                            <!-- Loaded dynamically -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Gesti√≥n Impresora Section -->
        <div id="section-impresora" class="content-section">
            <div class="table-container">
                <div class="table-header">
                    <h2 class="table-title">Gesti√≥n Avanzada de Impresora</h2>
                    <div class="table-actions">
                        <button class="btn btn-secondary" onclick="verificarEstadoImpresora()">
                            üîç Diagnosticar
                        </button>
                        <button class="btn btn-primary" onclick="procesarColaManual()">
                            Procesar Cola
                        </button>
                    </div>
                </div>
                
                <!-- Estado Actual -->
                <div class="printer-status" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                    <div class="status-card" style="background: white; padding: 1rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <h3 style="margin: 0 0 0.5rem 0; color: #333; font-size: 0.9rem;">üîå Estado Conexi√≥n</h3>
                        <div id="printer-connection-status" style="font-size: 1.2rem; font-weight: 600;">
                            <span style="color: #10b981;">‚óè Verificando...</span>
                        </div>
                    </div>
                    
                    <div class="status-card" style="background: white; padding: 1rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <h3 style="margin: 0 0 0.5rem 0; color: #333; font-size: 0.9rem;">üìä Cola de Impresi√≥n</h3>
                        <div id="printer-queue-status" style="font-size: 1.2rem; font-weight: 600; color: #3b82f6;">
                            0 pendientes
                        </div>
                    </div>
                    
                    <div class="status-card" style="background: white; padding: 1rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <h3 style="margin: 0 0 0.5rem 0; color: #333; font-size: 0.9rem;">Prioridad Alta</h3>
                        <div id="printer-urgent-count" style="font-size: 1.2rem; font-weight: 600; color: #ef4444;">
                            0 urgentes
                        </div>
                    </div>
                    
                    <div class="status-card" style="background: white; padding: 1rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <h3 style="margin: 0 0 0.5rem 0; color: #333; font-size: 0.9rem;">Etiquetas Hoy</h3>
                        <div id="printer-labels-today" style="font-size: 1.2rem; font-weight: 600; color: #10b981;">
                            0 impresas
                        </div>
                    </div>
                </div>
                
                <!-- Estad√≠sticas Detalladas -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 2rem;">
                    <!-- Gr√°fico de Actividad -->
                    <div class="chart-container" style="background: white; border-radius: 8px; padding: 1.5rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <h3 style="margin: 0 0 1rem 0; color: #333;">üìä Actividad de Impresi√≥n (7 d√≠as)</h3>
                        <canvas id="printer-activity-chart" width="400" height="200"></canvas>
                    </div>
                    
                    <!-- Cola de Prioridades -->
                    <div class="queue-container" style="background: white; border-radius: 8px; padding: 1.5rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <h3 style="margin: 0 0 1rem 0; color: #333;">Cola Priorizada</h3>
                        <div id="printer-priority-queue">
                            <!-- Loaded dynamically -->
                        </div>
                    </div>
                </div>
                
                <!-- Diagn√≥stico y Errores -->
                <div style="background: white; border-radius: 8px; padding: 1.5rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 2rem;">
                    <h3 style="margin: 0 0 1rem 0; color: #333;">Diagn√≥stico y Recomendaciones</h3>
                    <div id="printer-diagnostics">
                        <div style="text-align: center; color: #666; padding: 2rem;">
                            <p>Haz clic en "Diagnosticar" para verificar el estado de la impresora</p>
                        </div>
                    </div>
                </div>
                
                <!-- Historial de Eventos -->
                <div style="background: white; border-radius: 8px; padding: 1.5rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <h3 style="margin: 0 0 1rem 0; color: #333;">üìã Historial de Eventos</h3>
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: #f8f9fa;">
                                    <th style="padding: 8px; text-align: left; border-bottom: 2px solid #dee2e6;">Timestamp</th>
                                    <th style="padding: 8px; text-align: left; border-bottom: 2px solid #dee2e6;">Evento</th>
                                    <th style="padding: 8px; text-align: left; border-bottom: 2px solid #dee2e6;">Detalles</th>
                                    <th style="padding: 8px; text-align: center; border-bottom: 2px solid #dee2e6;">Duraci√≥n</th>
                                    <th style="padding: 8px; text-align: center; border-bottom: 2px solid #dee2e6;">Estado</th>
                                </tr>
                            </thead>
                            <tbody id="printer-events-table">
                                <!-- Loaded dynamically -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Mantenimiento Section -->
        <div id="section-mantenimiento" class="content-section">
            <div class="table-container">
                <div class="table-header">
                    <h2 class="table-title">Herramientas de Mantenimiento</h2>
                </div>
                
                <div style="padding: 2rem;">
                    <div class="maintenance-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 2rem;">
                        
                        <!-- Limpieza de Documentos -->
                        <div class="maintenance-card" style="background: white; padding: 2rem; border-radius: var(--radius); box-shadow: var(--shadow-md); border-left: 4px solid var(--warning-color);">
                            <h3 style="margin-bottom: 1.5rem; color: var(--text-primary); display: flex; align-items: center; gap: 0.5rem;">
                                Limpieza de Documentos
                            </h3>
                            <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">
                                Eliminar solicitudes de etiquetas y registros de impresi√≥n por rango de fechas.
                            </p>
                            
                            <div class="form-group" style="margin-bottom: 1rem;">
                                <label class="form-label">Fecha Inicio</label>
                                <input type="date" class="form-input" id="cleanup-fecha-inicio">
                            </div>
                            
                            <div class="form-group" style="margin-bottom: 1rem;">
                                <label class="form-label">Fecha Fin</label>
                                <input type="date" class="form-input" id="cleanup-fecha-fin">
                            </div>
                            
                            <div class="form-group" style="margin-bottom: 1.5rem;">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="cleanup-incluir-cola">
                                    <span>Incluir registros de cola de impresi√≥n</span>
                                </label>
                            </div>
                            
                            <button class="btn btn-warning" onclick="executeMaintenance('cleanup')" style="width: 100%;">
                                Ejecutar Limpieza
                            </button>
                            
                            <div id="cleanup-result" class="maintenance-result" style="margin-top: 1rem; display: none;"></div>
                        </div>

                        <!-- Optimizaci√≥n de Base de Datos -->
                        <div class="maintenance-card" style="background: white; padding: 2rem; border-radius: var(--radius); box-shadow: var(--shadow-md); border-left: 4px solid var(--success-color);">
                            <h3 style="margin-bottom: 1.5rem; color: var(--text-primary); display: flex; align-items: center; gap: 0.5rem;">
                                Optimizaci√≥n de BD
                            </h3>
                            <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">
                                Ejecutar mantenimiento autom√°tico de la base de datos.
                            </p>
                            
                            <div class="optimization-info" style="background: var(--bg-secondary); padding: 1rem; border-radius: var(--radius); margin-bottom: 1.5rem;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                    <span>√öltima optimizaci√≥n:</span>
                                    <span id="last-optimization">Calculando...</span>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span>Estado de √≠ndices:</span>
                                    <span id="index-status" class="status-badge">Verificando...</span>
                                </div>
                            </div>
                            
                            <button class="btn btn-success" onclick="executeMaintenance('optimize')" style="width: 100%;">
                                ‚ö° Optimizar Base de Datos
                            </button>
                            
                            <div id="optimize-result" class="maintenance-result" style="margin-top: 1rem; display: none;"></div>
                        </div>

                        <!-- An√°lisis de Sistema -->
                        <div class="maintenance-card" style="background: white; padding: 2rem; border-radius: var(--radius); box-shadow: var(--shadow-md); border-left: 4px solid var(--primary-color);">
                            <h3 style="margin-bottom: 1.5rem; color: var(--text-primary); display: flex; align-items: center; gap: 0.5rem;">
                                üìä An√°lisis de Sistema
                            </h3>
                            <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">
                                Generar reporte completo del estado del sistema.
                            </p>
                            
                            <div class="system-metrics" id="system-metrics" style="margin-bottom: 1.5rem;">
                                <div class="metric-item" style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid var(--border-color);">
                                    <span>Usuarios activos:</span>
                                    <span id="metric-users">-</span>
                                </div>
                                <div class="metric-item" style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid var(--border-color);">
                                    <span>Productos registrados:</span>
                                    <span id="metric-products">-</span>
                                </div>
                                <div class="metric-item" style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid var(--border-color);">
                                    <span>Solicitudes pendientes:</span>
                                    <span id="metric-pending">-</span>
                                </div>
                                <div class="metric-item" style="display: flex; justify-content: space-between; padding: 0.5rem 0;">
                                    <span>Espacio de BD:</span>
                                    <span id="metric-space">-</span>
                                </div>
                            </div>
                            
                            <button class="btn btn-primary" onclick="executeMaintenance('analyze')" style="width: 100%;">
                                üìä Generar An√°lisis
                            </button>
                            
                            <div id="analyze-result" class="maintenance-result" style="margin-top: 1rem; display: none;"></div>
                        </div>

                        <!-- Backup y Exportaci√≥n -->
                        <div class="maintenance-card" style="background: white; padding: 2rem; border-radius: var(--radius); box-shadow: var(--shadow-md); border-left: 4px solid var(--error-color);">
                            <h3 style="margin-bottom: 1.5rem; color: var(--text-primary); display: flex; align-items: center; gap: 0.5rem;">
                                Backup y Exportaci√≥n
                            </h3>
                            <p style="color: var(--text-secondary); margin-bottom: 1.5rem;">
                                Crear respaldos y exportar datos del sistema.
                            </p>
                            
                            <div class="backup-options" style="margin-bottom: 1.5rem;">
                                <label class="checkbox-label" style="display: block; margin-bottom: 0.5rem;">
                                    <input type="checkbox" id="backup-usuarios" checked>
                                    <span>Usuarios y configuraciones</span>
                                </label>
                                <label class="checkbox-label" style="display: block; margin-bottom: 0.5rem;">
                                    <input type="checkbox" id="backup-productos" checked>
                                    <span>Cat√°logo de productos</span>
                                </label>
                                <label class="checkbox-label" style="display: block; margin-bottom: 0.5rem;">
                                    <input type="checkbox" id="backup-solicitudes">
                                    <span>Historial de solicitudes</span>
                                </label>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-bottom: 1rem;">
                                <button class="btn btn-secondary" onclick="showExportDatabaseModal()" style="font-size: 0.875rem;">
                                    üóÑÔ∏è Exportar Base de Datos
                                </button>
                                <button class="btn btn-primary" onclick="showExportExcelModal()" style="font-size: 0.875rem;">
                                    ÔøΩ Exportar Excel
                                </button>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                                <button class="btn btn-info" onclick="showExportReportModal()" style="font-size: 0.875rem;">
                                    Exportar Informe
                                </button>
                                <button class="btn btn-success" onclick="showImportDatabaseModal()" style="font-size: 0.875rem;">
                                    ÔøΩ Importar Base de Datos
                                </button>
                            </div>
                            
                            <div id="backup-result" class="maintenance-result" style="margin-top: 1rem; display: none;"></div>
                        </div>

                    </div>
                </div>
            </div>
        </div>

        <!-- Configuraci√≥n Section -->
        <div id="section-configuracion" class="content-section">
            <div class="table-container">
                <div class="table-header">
                    <h2 class="table-title">‚öôÔ∏è Configuraci√≥n del Sistema</h2>
                </div>
                
                <div style="padding: 2rem;">
                    <div class="config-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2rem;">
                        <div class="config-card" style="background: white; padding: 1.5rem; border-radius: var(--radius); box-shadow: var(--shadow-md);">
                            <h4 style="margin-bottom: 1rem; color: var(--text-primary);">üñ®Ô∏è Configuraci√≥n de Impresora</h4>
                            <div class="form-group">
                                <label class="form-label">IP de Impresora</label>
                                <input type="text" class="form-input" id="printer-ip" value="Configurar en system.config" readonly>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Puerto</label>
                                <input type="text" class="form-input" id="printer-port" value="9100" readonly>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Estado</label>
                                <span id="printer-status-config" class="badge">Verificando...</span>
                            </div>
                        </div>

                        <div class="config-card" style="background: white; padding: 1.5rem; border-radius: var(--radius); box-shadow: var(--shadow-md);">
                            <h4 style="margin-bottom: 1rem; color: var(--text-primary);">üóÑÔ∏è Base de Datos</h4>
                            <div class="form-group">
                                <label class="form-label">Host</label>
                                <input type="text" class="form-input" value="localhost" readonly>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Base de Datos</label>
                                <input type="text" class="form-input" value="postgres" readonly>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Estado</label>
                                <span id="db-status-config" class="badge">Conectado</span>
                            </div>
                        </div>

                        <div class="config-card" style="background: white; padding: 1.5rem; border-radius: var(--radius); box-shadow: var(--shadow-md);">
                            <h4 style="margin-bottom: 1rem; color: var(--text-primary);">üìä Configuraci√≥n de Reportes</h4>
                            <div class="form-group">
                                <button class="btn btn-primary" onclick="backupDatabase()">
                                    Respaldar Base de Datos
                                </button>
                            </div>
                            <div class="form-group">
                                <button class="btn btn-secondary" onclick="clearOldLogs()">
                                    üßπ Limpiar Logs Antiguos
                                </button>
                            </div>
                            <div class="form-group">
                                <button class="btn btn-warning" onclick="optimizeDatabase()">
                                    Optimizar Base de Datos
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    
    </div>

    <!-- Bit√°cora de Producci√≥n Section -->
    <div id="section-bitacora" class="content-section">
        <div id="bitacora-admin-container"></div>
    </div>

    <!-- Chat Section -->
    <div id="section-chat" class="content-section">
        <div class="chat-container">
            <div class="chat-sidebar">
                <div class="chat-header">
                    <h3>Chat Interno</h3>
                    <div class="user-status">
                        <span id="current-user-status" class="status-indicator status-online"></span>
                        <span id="current-user-name">Usuario</span>
                        <select id="status-selector" class="status-select">
                            <option value="en_linea">üü¢ En l√≠nea</option>
                            <option value="ausente">üü° Ausente</option>
                            <option value="ocupado">üî¥ Ocupado</option>
                            <option value="desconectado">‚ö´ Desconectado</option>
                        </select>
                    </div>
                </div>
                
                <div class="chat-channels">
                    <div class="channels-header">
                        <h4>Canales</h4>
                    </div>
                    <div id="channels-list" class="channels-list">
                        <!-- Los canales se cargan din√°micamente -->
                    </div>
                </div>
                
                <div class="online-users">
                    <div class="users-header">
                        <h4>En l√≠nea <span id="online-count">0</span></h4>
                    </div>
                    <div id="online-users-list" class="users-list">
                        <!-- Usuarios en l√≠nea se cargan din√°micamente -->
                    </div>
                </div>
            </div>
            
            <div class="chat-main">
                <div class="chat-messages-header">
                    <h3 id="current-channel-name">Selecciona un canal</h3>
                    <div class="chat-actions">
                        <button class="btn btn-secondary" onclick="loadChatMessages()" title="Actualizar">
                            Actualizar
                        </button>
                        <button class="btn btn-secondary" onclick="markAllAsRead()" title="Marcar todo como le√≠do">
                            Leer
                        </button>
                    </div>
                </div>
                
                <div id="chat-messages" class="chat-messages">
                    <div class="welcome-message">
                        <h3>¬°Bienvenido al Chat Interno!</h3>
                        <p>Selecciona un canal de la barra lateral para comenzar a chatear con tu equipo.</p>
                    </div>
                </div>
                
                <div id="chat-input-container" class="chat-input-container" style="display: none;">
                    <div class="chat-input-wrapper">
                        <textarea id="message-input" class="message-input" 
                                placeholder="Escribe tu mensaje..." 
                                onkeypress="handleMessageKeypress(event)"></textarea>
                        <button class="send-button" onclick="sendMessage()">
                            Enviar
                        </button>
                    </div>
                    <div class="chat-input-actions">
                        <small class="text-muted">Presiona Enter para enviar, Shift+Enter para nueva l√≠nea</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- User Modal -->
    <div id="user-modal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal('user-modal')">&times;</button>
            <div class="modal-header">
                <h3 class="modal-title" id="user-modal-title">Nuevo Usuario</h3>
            </div>
            
            <form id="user-form" onsubmit="saveUser(event)">
                <input type="hidden" id="user-id" name="id">
                
                <div class="form-group">
                    <label class="form-label">C√≥digo de Empleado *</label>
                    <input type="text" class="form-input" id="user-codigo" name="codigo_empleado" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Nombre Completo *</label>
                    <input type="text" class="form-input" id="user-nombre" name="nombre_completo" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Email *</label>
                    <input type="email" class="form-input" id="user-email" name="email" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Tel√©fono</label>
                    <input type="tel" class="form-input" id="user-telefono" name="telefono">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Puesto *</label>
                    <input type="text" class="form-input" id="user-puesto" name="puesto" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Nivel de Acceso *</label>
                    <select class="form-input" id="user-nivel" name="nivel_acceso" required>
                        <option value="">Seleccionar...</option>
                        <option value="administracion">Administraci√≥n</option>
                        <option value="supervisor">Supervisor</option>
                        <option value="costurera">Costurera</option>
                        <option value="encargada_embalaje">Encargada Embalaje</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">G√©nero *</label>
                    <select class="form-input" id="user-genero" name="genero" required>
                        <option value="femenino">Femenino</option>
                        <option value="masculino">Masculino</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Departamento</label>
                    <select class="form-input" id="user-departamento" name="id_departamento">
                        <!-- Loaded dynamically -->
                    </select>
                </div>
                
                <div class="form-group" id="password-group">
                    <label class="form-label">Contrase√±a *</label>
                    <input type="password" class="form-input" id="user-password" name="password">
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('user-modal')">
                        Cancelar
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <span id="user-save-text">Guardar Usuario</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Product Modal -->
    <div id="product-modal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal('product-modal')">&times;</button>
            <div class="modal-header">
                <h3 class="modal-title" id="product-modal-title">Nuevo Producto</h3>
            </div>
            
            <form id="product-form" onsubmit="saveProduct(event)">
                <input type="hidden" id="product-id" name="id">
                
                <div class="form-group">
                    <label class="form-label">Nombre del Producto *</label>
                    <input type="text" class="form-input" id="product-nombre" name="nombre_producto" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Modelo/Talla</label>
                    <input type="text" class="form-input" id="product-modelo" name="modelo" placeholder="ej: QUEEN, 1.5P, XL">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Descripci√≥n Corta</label>
                    <textarea class="form-input" id="product-descripcion" name="descripcion_corta" rows="3"></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Unidad de Medida *</label>
                    <select class="form-input" id="product-unidad" name="unidad_medida" required>
                        <option value="">Seleccionar...</option>
                        <option value="UNIDAD">Unidad</option>
                        <option value="PIEZA">Pieza</option>
                        <option value="JUEGO">Juego</option>
                        <option value="PAR">Par</option>
                        <option value="SET">Set</option>
                        <option value="KIT">Kit</option>
                    </select>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('product-modal')">
                        Cancelar
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <span id="product-save-text">Guardar Producto</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Global variables
        let currentUsers = [];
        let currentProducts = [];
        let currentSolicitudes = [];
        let filteredUsers = [];
        let filteredProducts = [];
        let filteredSolicitudes = [];

        // Helper function for consistent authentication headers
        function getAuthHeaders() {
            const token = localStorage.getItem('token');
            if (!token) {
                throw new Error('Token de autenticaci√≥n no encontrado');
            }
            return {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            };
        }

        // Sistema de sincronizaci√≥n autom√°tica
        let syncInterval = null;
        let lastDataHash = {
            users: '',
            products: '', 
            solicitudes: ''
        };

        // Control de sesi√≥n del servidor
        let currentServerSessionId = null;
        let serverCheckInterval = null;

        // Configuraci√≥n de intervalos (en milisegundos)
        const SYNC_CONFIG = {
            DATA_SYNC_INTERVAL: 30000,    // 30 segundos para sincronizaci√≥n de datos
            SERVER_CHECK_INTERVAL: 10000  // 10 segundos para verificar sesi√≥n del servidor
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadDashboard();
            loadUsers();
            loadProducts();
            loadSolicitudes();
            loadDepartments();
            checkSystemStatus();
            startServerSessionCheck(); // Verificar sesi√≥n del servidor
            startAutoSync(); // Iniciar sincronizaci√≥n autom√°tica
            loadStatsFiltersData();
            loadStatistics();
            loadAnalytics(); // Cargar analytics avanzados
            initializeDarkMode(); // Inicializar modo oscuro
        });

        // Navigation
        function showSection(sectionName) {
            // Hide all sections
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Remove active from all tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected section
            const targetSection = document.getElementById('section-' + sectionName);
            if (targetSection) {
                targetSection.classList.add('active');
            }
            
            // Load specific section data
            if (sectionName === 'impresora') {
                loadPrinterManagement();
            } else if (sectionName === 'productos-especiales') {
                loadProductosEspeciales();
            } else if (sectionName === 'solicitudes-especiales') {
                loadSolicitudesEspeciales();
            } else if (sectionName === 'bitacora') {
                loadBitacoraAdmin();
            }
            
            // Activate selected tab
            if (window.event && window.event.target) {
                window.event.target.classList.add('active');
            }
        }
        
        // Cargar componente de bit√°cora para administraci√≥n
        async function loadBitacoraAdmin() {
            const container = document.getElementById('bitacora-admin-container');
            if (container.innerHTML.trim() !== '') {
                // Ya est√° cargado, solo refrescar
                if (typeof window.cargarBitacoraAdmin === 'function') {
                    window.cargarBitacoraAdmin();
                }
                return;
            }
            
            try {
                const response = await fetch('/components/bitacora-admin.html');
                const html = await response.text();
                
                // Separar HTML y scripts
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = html;
                
                // Extraer scripts
                const scripts = Array.from(tempDiv.querySelectorAll('script'));
                
                // Remover scripts del HTML
                scripts.forEach(script => script.remove());
                
                // Insertar HTML
                container.innerHTML = tempDiv.innerHTML;
                
                // Ejecutar scripts
                scripts.forEach(script => {
                    const newScript = document.createElement('script');
                    if (script.src) {
                        newScript.src = script.src;
                    } else {
                        newScript.textContent = script.textContent;
                    }
                    document.body.appendChild(newScript);
                });
                
                console.log('‚úÖ Componente de bit√°cora admin cargado');
            } catch (error) {
                console.error('‚ùå Error cargando bit√°cora admin:', error);
                container.innerHTML = `
                    <div style="padding: 40px; text-align: center; color: #ef4444;">
                        <h3>Error cargando bit√°cora</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        // ====================================
        // SISTEMA DE SINCRONIZACI√ìN AUTOM√ÅTICA
        // ====================================
        
        // Iniciar sincronizaci√≥n autom√°tica
        function startAutoSync() {
            console.log(`üîÑ Iniciando sincronizaci√≥n autom√°tica cada ${SYNC_CONFIG.DATA_SYNC_INTERVAL/1000} segundos...`);
            syncInterval = setInterval(checkForDataChanges, SYNC_CONFIG.DATA_SYNC_INTERVAL);
        }

        // Detener sincronizaci√≥n autom√°tica
        function stopAutoSync() {
            if (syncInterval) {
                clearInterval(syncInterval);
                syncInterval = null;
                console.log('‚è∏Ô∏è Sincronizaci√≥n autom√°tica detenida');
            }
        }

        // Verificar cambios en los datos
        async function checkForDataChanges() {
            try {
                const currentHashes = await getDataHashes();
                let hasChanges = false;
                
                // Verificar si hay cambios en usuarios
                if (currentHashes.users !== lastDataHash.users) {
                    console.log('üîÑ Cambio en usuarios detectado');
                    updateSyncStatus('üîÑ Usuarios...', 'warning');
                    await loadUsers();
                    lastDataHash.users = currentHashes.users;
                    hasChanges = true;
                }

                // Verificar si hay cambios en productos
                if (currentHashes.products !== lastDataHash.products) {
                    console.log('üîÑ Cambio en productos detectado');
                    updateSyncStatus('üîÑ Productos...', 'warning');
                    await loadProducts();
                    lastDataHash.products = currentHashes.products;
                    hasChanges = true;
                }

                // Verificar si hay cambios en solicitudes
                if (currentHashes.solicitudes !== lastDataHash.solicitudes) {
                    console.log('üîÑ Cambio en solicitudes detectado');
                    updateSyncStatus('üîÑ Solicitudes...', 'warning');
                    await loadSolicitudes();
                    lastDataHash.solicitudes = currentHashes.solicitudes;
                    hasChanges = true;
                }

                // Si hubo cambios, actualizar dashboard y mostrar estado final
                if (hasChanges) {
                    await loadDashboard();
                    updateSyncStatus('‚úÖ Actualizado', 'success');
                    console.log('‚úÖ Sincronizaci√≥n autom√°tica completada');
                } else {
                    updateSyncStatus('üîÑ Sincronizaci√≥n Activa', 'info');
                }

            } catch (error) {
                console.error('Error en sincronizaci√≥n autom√°tica:', error);
                updateSyncStatus('‚ùå Error Auto-Sync', 'error');
            }
        }

        // Obtener hashes de los datos actuales
        async function getDataHashes() {
            try {
                const response = await fetch('/api/admin/data-hashes', {
                    headers: getAuthHeaders()
                });
                
                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status}`);
                }
                
                return await response.json();
            } catch (error) {
                console.error('Error obteniendo hashes de datos:', error);
                return { users: '', products: '', solicitudes: '' };
            }
        }

        // Forzar sincronizaci√≥n manual
        async function forceSyncAll() {
            console.log('üîÑ Forzando sincronizaci√≥n completa...');
            updateSyncStatus('üîÑ Sincronizando...', 'warning');
            showNotification('Sincronizando datos...', 'info');
            
            try {
                await Promise.all([
                    loadUsers(),
                    loadProducts(), 
                    loadSolicitudes(),
                    loadDashboard()
                ]);
                
                // Actualizar hashes
                lastDataHash = await getDataHashes();
                updateSyncStatus('‚úÖ Sincronizado', 'success');
                showNotification('Sincronizaci√≥n completada ‚úÖ', 'success');
            } catch (error) {
                console.error('Error en sincronizaci√≥n:', error);
                updateSyncStatus('‚ùå Error Sync', 'error');
                showNotification('Error en sincronizaci√≥n ‚ùå', 'error');
            }
        }

        // Actualizar estado visual de sincronizaci√≥n
        function updateSyncStatus(message, type = 'info') {
            const syncStatus = document.getElementById('sync-status');
            if (syncStatus) {
                syncStatus.textContent = message;
                
                // Cambiar color seg√∫n el tipo
                syncStatus.style.color = type === 'success' ? '#28a745' : 
                                         type === 'error' ? '#dc3545' : 
                                         type === 'warning' ? '#ffc107' : '#6c757d';
            }
        }

        // ====================================
        // DETECCI√ìN DE REINICIO DEL SERVIDOR
        // ====================================
        
        // Iniciar verificaci√≥n de sesi√≥n del servidor
        function startServerSessionCheck() {
            console.log(`üöÄ Iniciando verificaci√≥n de sesi√≥n del servidor cada ${SYNC_CONFIG.SERVER_CHECK_INTERVAL/1000} segundos...`);
            
            // Obtener sesi√≥n inicial
            getServerSession().then(sessionId => {
                currentServerSessionId = sessionId;
                console.log(`üìã Sesi√≥n actual del servidor: ${sessionId}`);
            });
            
            // Verificar seg√∫n configuraci√≥n
            serverCheckInterval = setInterval(checkServerSession, SYNC_CONFIG.SERVER_CHECK_INTERVAL);
        }

        // Detener verificaci√≥n de sesi√≥n del servidor
        function stopServerSessionCheck() {
            if (serverCheckInterval) {
                clearInterval(serverCheckInterval);
                serverCheckInterval = null;
                console.log('‚è∏Ô∏è Verificaci√≥n de sesi√≥n del servidor detenida');
            }
        }

        // Verificar si el servidor se ha reiniciado
        async function checkServerSession() {
            try {
                const newSessionId = await getServerSession();
                
                if (currentServerSessionId && newSessionId !== currentServerSessionId) {
                    console.log('üö® SERVIDOR REINICIADO DETECTADO!');
                    console.log(`üìã Sesi√≥n anterior: ${currentServerSessionId}`);
                    console.log(`üìã Nueva sesi√≥n: ${newSessionId}`);
                    
                    currentServerSessionId = newSessionId;
                    
                    // Mostrar notificaci√≥n de reinicio
                    showNotification('üö® Servidor reiniciado - Actualizando datos...', 'warning');
                    updateSyncStatus('üö® Servidor reiniciado', 'warning');
                    
                    // Esperar un momento para que el servidor se estabilice
                    setTimeout(async () => {
                        await forceFullReload();
                    }, 1000);
                }
            } catch (error) {
                console.warn('Error verificando sesi√≥n del servidor:', error);
                // No mostrar error al usuario para no ser molesto
            }
        }

        // Obtener ID de sesi√≥n del servidor
        async function getServerSession() {
            try {
                const response = await fetch('/api/server/session');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                const data = await response.json();
                return data.sessionId;
            } catch (error) {
                throw error;
            }
        }

        // Forzar recarga completa de todos los datos
        async function forceFullReload() {
            console.log('üîÑ Forzando recarga completa tras reinicio del servidor...');
            
            try {
                updateSyncStatus('üîÑ Recargando todo...', 'warning');
                
                // Recargar todos los datos
                await Promise.all([
                    loadDashboard(),
                    loadUsers(),
                    loadProducts(), 
                    loadSolicitudes(),
                    loadDepartments()
                ]);
                
                // Actualizar hashes
                lastDataHash = await getDataHashes();
                
                updateSyncStatus('‚úÖ Actualizado', 'success');
                showNotification('‚úÖ Datos actualizados tras reinicio del servidor', 'success');
                
                console.log('‚úÖ Recarga completa exitosa');
            } catch (error) {
                console.error('Error en recarga completa:', error);
                updateSyncStatus('‚ùå Error recarga', 'error');
                showNotification('‚ùå Error actualizando datos tras reinicio', 'error');
            }
        }

        // Dashboard
        async function loadDashboard() {
            try {
                // Cargar stats del dashboard
                const statsResponse = await fetch('/api/admin/dashboard-stats');
                const data = await statsResponse.json();
                
                // Cargar control de stock
                const stockResponse = await fetch('/api/admin/stock-etiquetas', {
                    headers: getAuthHeaders()
                });
                const stockData = await stockResponse.json();
                
                if (!data || typeof data !== 'object') {
                    console.error('Invalid dashboard data:', data);
                    return;
                }
                
                const dashboardGrid = document.getElementById('dashboard-grid');
                dashboardGrid.innerHTML = `
                    <!-- Cards originales -->
                    <div class="dashboard-card">
                        <div class="card-header">
                            <div class="card-title">üë• Usuarios Total</div>
                            <button class="card-action" onclick="showSection('usuarios')">Ver</button>
                        </div>
                        <div style="font-size: 2rem; font-weight: 700; color: var(--primary-color);">
                            ${data.total_users || 0}
                        </div>
                        <div style="color: var(--text-secondary); margin-top: 0.5rem;">
                            ${data.active_users || 0} activos ‚Ä¢ ${data.usuarios_activos_hoy || 0} hoy
                        </div>
                        <button class="btn btn-sm btn-success" onclick="exportarUsuariosExcel()" style="margin-top: 1rem; width: 100%;">
                            üìä Exportar Excel
                        </button>
                    </div>
                    
                    <div class="dashboard-card">
                        <div class="card-header">
                            <div class="card-title">üì¶ Productos Total</div>
                            <button class="card-action" onclick="showSection('productos')">Ver</button>
                        </div>
                        <div style="font-size: 2rem; font-weight: 700; color: var(--success-color);">
                            ${data.total_products || 0}
                        </div>
                        <div style="color: var(--text-secondary); margin-top: 0.5rem;">
                            ${data.active_products || 0} activos
                        </div>
                        <button class="btn btn-sm btn-success" onclick="exportarProductosExcel()" style="margin-top: 1rem; width: 100%;">
                            üìä Exportar Excel
                        </button>
                    </div>
                    
                    <div class="dashboard-card">
                        <div class="card-header">
                            <div class="card-title">üìã Solicitudes Hoy</div>
                            <button class="card-action" onclick="showSection('solicitudes')">Ver</button>
                        </div>
                        <div style="font-size: 2rem; font-weight: 700; color: var(--warning-color);">
                            ${data.solicitudes_today || 0}
                        </div>
                        <div style="color: var(--text-secondary); margin-top: 0.5rem;">
                            ${data.solicitudes_pendientes || 0} pendientes ${data.solicitudes_atrasadas ? ' ‚Ä¢ ‚ö†Ô∏è ' + data.solicitudes_atrasadas + ' atrasadas' : ''}
                        </div>
                        <button class="btn btn-sm btn-success" onclick="exportarSolicitudesExcel()" style="margin-top: 1rem; width: 100%;">
                            üìä Exportar Excel
                        </button>
                    </div>
                    
                    <div class="dashboard-card">
                        <div class="card-header">
                            <div class="card-title">üñ®Ô∏è Etiquetas Hoy</div>
                            <button class="card-action" onclick="showSection('estadisticas')">Ver</button>
                        </div>
                        <div style="font-size: 2rem; font-weight: 700; color: var(--error-color);">
                            ${data.etiquetas_today || 0}
                        </div>
                        <div style="color: var(--text-secondary); margin-top: 0.5rem;">
                            ${data.solicitudes_completadas_today || 0} solicitudes ‚Ä¢ ${Math.round(data.promedio_etiquetas_solicitud || 0)} promedio
                        </div>
                    </div>
                    
                    <!-- NUEVAS CARDS DE STOCK -->
                    <div class="dashboard-card" style="border-left: 4px solid #10b981;">
                        <div class="card-header">
                            <div class="card-title">üìä Stock Total Etiquetas</div>
                            <button class="card-action" onclick="mostrarDetalleStock()">üìà</button>
                        </div>
                        <div style="font-size: 2rem; font-weight: 700; color: #10b981;">
                            ${Number(stockData?.etiquetas?.total_solicitadas || 0).toLocaleString()}
                        </div>
                        <div style="color: var(--text-secondary); margin-top: 0.5rem; font-size: 0.875rem;">
                            ‚úÖ ${Number(stockData?.etiquetas?.total_completadas || 0).toLocaleString()} completadas<br>
                            ‚è≥ ${Number(stockData?.etiquetas?.total_pendientes || 0).toLocaleString()} pendientes
                        </div>
                    </div>
                    
                    <div class="dashboard-card" style="border-left: 4px solid #3b82f6;">
                        <div class="card-header">
                            <div class="card-title">üìÖ Stock Esta Semana</div>
                            <button class="card-action" onclick="mostrarDetalleStock()">üìä</button>
                        </div>
                        <div style="font-size: 2rem; font-weight: 700; color: #3b82f6;">
                            ${Number(stockData?.etiquetas?.total_semana || 0).toLocaleString()}
                        </div>
                        <div style="color: var(--text-secondary); margin-top: 0.5rem; font-size: 0.875rem;">
                            üìÜ Hoy: ${Number(stockData?.etiquetas?.total_hoy || 0).toLocaleString()}<br>
                            üìà Promedio/d√≠a: ${Number(stockData?.etiquetas?.promedio_diario || 0).toFixed(0)}
                        </div>
                    </div>
                    
                    <div class="dashboard-card" style="border-left: 4px solid #f59e0b;">
                        <div class="card-header">
                            <div class="card-title">üìÖ Stock Este Mes</div>
                            <button class="card-action" onclick="mostrarDetalleStock()">üìä</button>
                        </div>
                        <div style="font-size: 2rem; font-weight: 700; color: #f59e0b;">
                            ${Number(stockData?.etiquetas?.total_mes || 0).toLocaleString()}
                        </div>
                        <div style="color: var(--text-secondary); margin-top: 0.5rem; font-size: 0.875rem;">
                            üé® Rotulados: ${Number(stockData?.rotulados?.total_rotulados || 0).toLocaleString()}<br>
                            ‚úÖ Completados: ${Number(stockData?.rotulados?.rotulados_completados || 0).toLocaleString()}
                        </div>
                    </div>
                    
                    <div class="dashboard-card" style="border-left: 4px solid #ec4899;">
                        <div class="card-header">
                            <div class="card-title">üé® Rotulados Hoy</div>
                            <button class="card-action" onclick="showSection('solicitudes')">Ver</button>
                        </div>
                        <div style="font-size: 2rem; font-weight: 700; color: #ec4899;">
                            ${Number(stockData?.rotulados?.rotulados_hoy || 0).toLocaleString()}
                        </div>
                        <div style="color: var(--text-secondary); margin-top: 0.5rem; font-size: 0.875rem;">
                            Total general: ${Number(stockData?.rotulados?.total_rotulados || 0).toLocaleString()}
                        </div>
                    </div>
                `;
            } catch (error) {
                console.error('Error loading dashboard:', error);
            }
        }
        
        // üìä Funci√≥n para exportar Solicitudes a Excel
        async function exportarSolicitudesExcel() {
            try {
                const btn = event.target;
                btn.disabled = true;
                btn.innerHTML = '‚è≥ Exportando...';
                
                const response = await fetch('/api/admin/exportar/solicitudes-excel?estado=todas', {
                    headers: getAuthHeaders()
                });
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `solicitudes_${new Date().toISOString().split('T')[0]}.xlsx`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                    
                    alert('‚úÖ Reporte exportado correctamente');
                } else {
                    throw new Error('Error en la exportaci√≥n');
                }
            } catch (error) {
                console.error('Error exportando solicitudes:', error);
                alert('‚ùå Error al exportar: ' + error.message);
            } finally {
                event.target.disabled = false;
                event.target.innerHTML = 'üìä Exportar Excel';
            }
        }
        
        // üìä Funci√≥n para exportar Productos a Excel
        async function exportarProductosExcel() {
            try {
                const btn = event.target;
                btn.disabled = true;
                btn.innerHTML = '‚è≥ Exportando...';
                
                const response = await fetch('/api/admin/exportar/productos-excel', {
                    headers: getAuthHeaders()
                });
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `productos_${new Date().toISOString().split('T')[0]}.xlsx`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                    
                    alert('‚úÖ Reporte exportado correctamente');
                } else {
                    throw new Error('Error en la exportaci√≥n');
                }
            } catch (error) {
                console.error('Error exportando productos:', error);
                alert('‚ùå Error al exportar: ' + error.message);
            } finally {
                event.target.disabled = false;
                event.target.innerHTML = 'üìä Exportar Excel';
            }
        }
        
        // üìä Funci√≥n para exportar Usuarios a Excel
        async function exportarUsuariosExcel() {
            try {
                const btn = event.target;
                btn.disabled = true;
                btn.innerHTML = '‚è≥ Exportando...';
                
                const response = await fetch('/api/admin/exportar/usuarios-excel', {
                    headers: getAuthHeaders()
                });
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `usuarios_productividad_${new Date().toISOString().split('T')[0]}.xlsx`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                    
                    alert('‚úÖ Reporte exportado correctamente');
                } else {
                    throw new Error('Error en la exportaci√≥n');
                }
            } catch (error) {
                console.error('Error exportando usuarios:', error);
                alert('‚ùå Error al exportar: ' + error.message);
            } finally {
                event.target.disabled = false;
                event.target.innerHTML = 'üìä Exportar Excel';
            }
        }
        
        // üìà Funci√≥n para mostrar detalle de stock
        function mostrarDetalleStock() {
            fetch('/api/admin/stock-etiquetas', {
                headers: getAuthHeaders()
            })
                .then(res => res.json())
                .then(data => {
                    const stockInfo = `
=== CONTROL DE STOCK DE ETIQUETAS ===

üìä ETIQUETAS:
- Total Solicitadas: ${Number(data.etiquetas.total_solicitadas || 0).toLocaleString()}
- Completadas: ${Number(data.etiquetas.total_completadas || 0).toLocaleString()}
- Pendientes: ${Number(data.etiquetas.total_pendientes || 0).toLocaleString()}
- En Proceso: ${Number(data.etiquetas.total_en_proceso || 0).toLocaleString()}
- Hoy: ${Number(data.etiquetas.total_hoy || 0).toLocaleString()}
- Esta Semana: ${Number(data.etiquetas.total_semana || 0).toLocaleString()}
- Este Mes: ${Number(data.etiquetas.total_mes || 0).toLocaleString()}
- Promedio Diario: ${Number(data.etiquetas.promedio_diario || 0).toFixed(2)}

üé® ROTULADOS:
- Total Rotulados: ${Number(data.rotulados.total_rotulados || 0).toLocaleString()}
- Completados: ${Number(data.rotulados.rotulados_completados || 0).toLocaleString()}
- Hoy: ${Number(data.rotulados.rotulados_hoy || 0).toLocaleString()}

√öltima actualizaci√≥n: ${new Date(data.timestamp).toLocaleString('es-PE')}
                    `;
                    alert(stockInfo);
                })
                .catch(err => {
                    console.error('Error cargando stock:', err);
                    alert('‚ùå Error cargando datos de stock');
                });
        }

        // Users Management
        function loadUsers() {
            showLoading('users-table-body');
            fetch('/api/admin/users')
                .then(response => response.json())
                .then(data => {
                    if (Array.isArray(data)) {
                        currentUsers = data;
                        filteredUsers = data;
                        renderUsers(filteredUsers);
                    } else {
                        console.error('Expected array, got:', data);
                        showError('users-table-body', 'Error en formato de datos');
                    }
                })
                .catch(error => {
                    console.error('Error loading users:', error);
                    showError('users-table-body', 'Error cargando usuarios');
                });
        }

        function renderUsers(users) {
            const tbody = document.getElementById('users-table-body');
            if (users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; color: var(--text-secondary);">No hay usuarios para mostrar</td></tr>';
                return;
            }
            
            tbody.innerHTML = users.map(user => `
                <tr>
                    <td>${user.id_usuario}</td>
                    <td><strong>${user.codigo_empleado}</strong></td>
                    <td>${user.nombre_completo}</td>
                    <td>${user.email}</td>
                    <td><span class="badge badge-${user.nivel_acceso}">${user.nivel_acceso}</span></td>
                    <td>${user.departamento_nombre || 'Sin asignar'}</td>
                    <td>
                        <span class="badge ${user.activo ? 'badge-success' : 'badge-error'}">
                            ${user.activo ? '‚úÖ Activo' : '‚ùå Inactivo'}
                        </span>
                    </td>
                    <td>${formatDate(user.ultimo_login)}</td>
                    <td>
                        <div class="table-actions-cell">
                            <button class="btn btn-sm btn-primary" onclick="editUser(${user.id_usuario})" title="Editar">
                                ‚úèÔ∏è
                            </button>
                            <button class="btn btn-sm ${user.activo ? 'btn-warning' : 'btn-success'}" 
                                    onclick="toggleUserStatus(${user.id_usuario}, ${!user.activo})" 
                                    title="${user.activo ? 'Desactivar' : 'Activar'}">
                                ${user.activo ? 'üö´' : '‚úÖ'}
                            </button>
                            <button class="btn btn-sm btn-secondary" onclick="resetUserPassword(${user.id_usuario})" title="Reset Password">
                                üîë
                            </button>
                            ${!user.activo ? `
                                <button class="btn btn-sm btn-error" onclick="deleteUser(${user.id_usuario})" title="Eliminar">
                                    üóëÔ∏è
                                </button>
                            ` : ''}
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function searchUsers(query) {
            if (!query.trim()) {
                filteredUsers = currentUsers;
            } else {
                filteredUsers = currentUsers.filter(user => 
                    user.nombre_completo.toLowerCase().includes(query.toLowerCase()) ||
                    user.email.toLowerCase().includes(query.toLowerCase()) ||
                    user.codigo_empleado.toLowerCase().includes(query.toLowerCase())
                );
            }
            renderUsers(filteredUsers);
        }

        function filterUsers(role) {
            if (!role) {
                filteredUsers = currentUsers;
            } else {
                filteredUsers = currentUsers.filter(user => user.nivel_acceso === role);
            }
            renderUsers(filteredUsers);
        }

        function filterUserStatus(status) {
            if (status === '') {
                filteredUsers = currentUsers;
            } else {
                const isActive = status === 'true';
                filteredUsers = currentUsers.filter(user => user.activo === isActive);
            }
            renderUsers(filteredUsers);
        }

        // User Modal Functions
        function showCreateUserModal() {
            document.getElementById('user-modal-title').textContent = 'Nuevo Usuario';
            document.getElementById('user-form').reset();
            document.getElementById('user-id').value = '';
            document.getElementById('password-group').style.display = 'block';
            document.getElementById('user-password').required = true;
            document.getElementById('user-save-text').textContent = 'Crear Usuario';
            showModal('user-modal');
        }

        function editUser(userId) {
            const user = currentUsers.find(u => u.id_usuario === userId);
            if (!user) return;
            
            document.getElementById('user-modal-title').textContent = 'Editar Usuario';
            document.getElementById('user-id').value = user.id_usuario;
            document.getElementById('user-codigo').value = user.codigo_empleado;
            document.getElementById('user-nombre').value = user.nombre_completo;
            document.getElementById('user-email').value = user.email;
            document.getElementById('user-telefono').value = user.telefono || '';
            document.getElementById('user-puesto').value = user.puesto;
            document.getElementById('user-nivel').value = user.nivel_acceso;
            document.getElementById('user-departamento').value = user.id_departamento || '';
            document.getElementById('user-genero').value = user.genero || 'femenino';
            document.getElementById('password-group').style.display = 'none';
            document.getElementById('user-password').required = false;
            document.getElementById('user-save-text').textContent = 'Actualizar Usuario';
            showModal('user-modal');
        }

        function saveUser(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const userData = Object.fromEntries(formData.entries());
            
            const isEdit = userData.id;
            const url = isEdit ? `/api/admin/users/${userData.id}` : '/api/admin/users';
            const method = isEdit ? 'PUT' : 'POST';
            
            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(userData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    closeModal('user-modal');
                    loadUsers();
                    showNotification(isEdit ? 'Usuario actualizado exitosamente' : 'Usuario creado exitosamente', 'success');
                } else {
                    showNotification('Error: ' + data.error, 'error');
                }
            })
            .catch(error => {
                console.error('Error saving user:', error);
                showNotification('Error al guardar usuario', 'error');
            });
        }

        function toggleUserStatus(userId, newStatus) {
            if (!confirm(`¬øEst√° seguro de ${newStatus ? 'activar' : 'desactivar'} este usuario?`)) return;
            
            fetch(`/api/admin/users/${userId}/toggle-status`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ activo: newStatus })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadUsers();
                    showNotification(`Usuario ${newStatus ? 'activado' : 'desactivado'} exitosamente`, 'success');
                } else {
                    showNotification('Error: ' + data.error, 'error');
                }
            })
            .catch(error => {
                console.error('Error toggling user status:', error);
                showNotification('Error al cambiar estado del usuario', 'error');
            });
        }

        function resetUserPassword(userId) {
            if (!confirm('¬øEst√° seguro de resetear la contrase√±a de este usuario?')) return;
            
            fetch(`/api/admin/users/${userId}/reset-password`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification(`Contrase√±a reseteada. Nueva contrase√±a: ${data.new_password}`, 'success');
                } else {
                    showNotification('Error: ' + data.error, 'error');
                }
            })
            .catch(error => {
                console.error('Error resetting password:', error);
                showNotification('Error al resetear contrase√±a', 'error');
            });
        }

        function deleteUser(userId) {
            if (!confirm('¬øEst√° seguro de eliminar permanentemente este usuario? Esta acci√≥n no se puede deshacer.')) return;
            
            fetch(`/api/admin/users/${userId}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadUsers();
                    showNotification('Usuario eliminado exitosamente', 'success');
                } else {
                    showNotification('Error: ' + data.error, 'error');
                }
            })
            .catch(error => {
                console.error('Error deleting user:', error);
                showNotification('Error al eliminar usuario', 'error');
            });
        }

        // Delete individual solicitud
        function deleteSolicitud(solicitudId, numeroSolicitud) {
            if (!confirm(`¬øEst√° seguro de eliminar la solicitud #${numeroSolicitud}?\n\n‚ö†Ô∏è Esta acci√≥n no se puede deshacer.`)) {
                return;
            }

            // Segunda confirmaci√≥n para solicitudes
            if (!confirm(`CONFIRMACI√ìN FINAL:\n\nEliminar solicitud #${numeroSolicitud} (ID: ${solicitudId})\n\n¬øContinuar?`)) {
                return;
            }

            fetch(`/api/admin/solicitudes/${solicitudId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${localStorage.getItem('token')}`
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification(`‚úÖ Solicitud #${numeroSolicitud} eliminada exitosamente`, 'success');
                    // Actualizar datos y forzar sincronizaci√≥n
                    loadSolicitudes(); // Recargar la lista
                    loadRequestsStats(); // Actualizar estad√≠sticas si existe la funci√≥n
                    loadDashboard(); // Actualizar dashboard
                    // Disparar actualizaci√≥n de hash para sincronizaci√≥n
                    setTimeout(() => {
                        getDataHashes().then(newHashes => {
                            lastDataHash.solicitudes = newHashes.solicitudes;
                        });
                    }, 1000);
                } else {
                    showNotification('Error: ' + (data.error || 'Error desconocido'), 'error');
                }
            })
            .catch(error => {
                console.error('Error deleting solicitud:', error);
                showNotification('Error de conexi√≥n al eliminar solicitud', 'error');
            });
        }

        // View solicitud function (placeholder if not exists)
        function viewSolicitud(solicitudId) {
            // TODO: Implementar vista detallada de solicitud
            showNotification(`Vista de solicitud ID: ${solicitudId} - Funci√≥n por implementar`, 'info');
        }

        // Products Management
        function loadProducts() {
            showLoading('products-table-body');
            fetch('/api/productos')
                .then(response => response.json())
                .then(result => {
                    // Manejar nueva estructura de respuesta con paginaci√≥n
                    const data = result.data || result || [];
                    if (Array.isArray(data)) {
                        currentProducts = data;
                        filteredProducts = data;
                        renderProducts(filteredProducts);
                    } else {
                        console.error('Expected array, got:', data);
                        showError('products-table-body', 'Error en formato de datos');
                    }
                })
                .catch(error => {
                    console.error('Error loading products:', error);
                    showError('products-table-body', 'Error cargando productos');
                });
        }

        function renderProducts(products) {
            const tbody = document.getElementById('products-table-body');
            if (products.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: var(--text-secondary);">No hay productos para mostrar</td></tr>';
                return;
            }
            
            tbody.innerHTML = products.map(product => `
                <tr>
                    <td>${product.id_producto}</td>
                    <td><strong>${product.nombre_producto}</strong></td>
                    <td>${product.modelo || '-'}</td>
                    <td>${product.descripcion_corta || '-'}</td>
                    <td><span class="badge badge-secondary">${product.unidad_medida}</span></td>
                    <td>
                        <span class="badge ${product.activo ? 'badge-success' : 'badge-error'}">
                            ${product.activo ? '‚úÖ Activo' : '‚ùå Inactivo'}
                        </span>
                    </td>
                    <td>${formatDate(product.fecha_creacion)}</td>
                    <td>
                        <div class="table-actions-cell">
                            <button class="btn btn-sm btn-primary" onclick="editProduct(${product.id_producto})" title="Editar">
                                ‚úèÔ∏è
                            </button>
                            <button class="btn btn-sm ${product.activo ? 'btn-warning' : 'btn-success'}" 
                                    onclick="toggleProductStatus(${product.id_producto}, ${!product.activo})" 
                                    title="${product.activo ? 'Desactivar' : 'Activar'}">
                                ${product.activo ? 'üö´' : '‚úÖ'}
                            </button>
                            ${!product.activo ? `
                                <button class="btn btn-sm btn-error" onclick="deleteProduct(${product.id_producto})" title="Eliminar">
                                    üóëÔ∏è
                                </button>
                            ` : ''}
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function showCreateProductModal() {
            document.getElementById('product-modal-title').textContent = 'Nuevo Producto';
            document.getElementById('product-form').reset();
            document.getElementById('product-id').value = '';
            document.getElementById('product-save-text').textContent = 'Crear Producto';
            showModal('product-modal');
        }

        function editProduct(productId) {
            const product = currentProducts.find(p => p.id_producto === productId);
            if (!product) return;
            
            document.getElementById('product-modal-title').textContent = 'Editar Producto';
            document.getElementById('product-id').value = product.id_producto;
            document.getElementById('product-nombre').value = product.nombre_producto;
            document.getElementById('product-modelo').value = product.modelo || '';
            document.getElementById('product-descripcion').value = product.descripcion_corta || '';
            document.getElementById('product-unidad').value = product.unidad_medida;
            document.getElementById('product-save-text').textContent = 'Actualizar Producto';
            showModal('product-modal');
        }

        function saveProduct(event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const productData = Object.fromEntries(formData.entries());
            
            const isEdit = productData.id;
            const url = isEdit ? `/api/admin/products/${productData.id}` : '/api/admin/products';
            const method = isEdit ? 'PUT' : 'POST';
            
            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(productData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    closeModal('product-modal');
                    loadProducts();
                    showNotification(isEdit ? 'Producto actualizado exitosamente' : 'Producto creado exitosamente', 'success');
                } else {
                    showNotification('Error: ' + data.error, 'error');
                }
            })
            .catch(error => {
                console.error('Error saving product:', error);
                showNotification('Error al guardar producto', 'error');
            });
        }

        // Utility Functions
        function loadDepartments() {
            fetch('/api/admin/departments')
                .then(response => response.json())
                .then(data => {
                    const select = document.getElementById('user-departamento');
                    if (Array.isArray(data)) {
                        select.innerHTML = '<option value="">Sin departamento</option>' +
                            data.map(dept => `<option value="${dept.id_departamento}">${dept.nombre_departamento}</option>`).join('');
                    } else {
                        select.innerHTML = '<option value="">Sin departamento</option>';
                    }
                })
                .catch(error => {
                    console.error('Error loading departments:', error);
                    const select = document.getElementById('user-departamento');
                    select.innerHTML = '<option value="">Sin departamento</option>';
                });
        }

        function checkSystemStatus() {
            fetch('/api/admin/system-status')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('db-status').textContent = data.database ? 'üü¢ PostgreSQL Conectado' : 'üî¥ PostgreSQL Desconectado';
                    document.getElementById('print-status').textContent = data.printer ? 'üü¢ Impresora Lista' : 'üü° Impresora Desconectada';
                })
                .catch(error => {
                    console.error('Error checking system status:', error);
                });
        }

        function showModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function showLoading(elementId) {
            document.getElementById(elementId).innerHTML = '<tr><td colspan="10" style="text-align: center;"><div class="loading"><div class="spinner"></div> Cargando...</div></td></tr>';
        }

        function showError(elementId, message) {
            document.getElementById(elementId).innerHTML = `<tr><td colspan="10" style="text-align: center; color: var(--error-color);">‚ùå ${message}</td></tr>`;
        }

        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('es-ES') + ' ' + date.toLocaleTimeString('es-ES', {hour: '2-digit', minute: '2-digit'});
        }

        function showNotification(message, type = 'info') {
            // Simple notification - could be enhanced with a proper notification system
            alert(message);
        }

        // Export functions (placeholders)
        function exportUsers() {
            window.open('/api/admin/export/users', '_blank');
        }

        function exportProducts() {
            window.open('/api/admin/export/products', '_blank');
        }

        function exportSolicitudes() {
            window.open('/api/admin/export/solicitudes', '_blank');
        }

        // Statistics Management
        let currentStatsFilters = {
            period: 'month',
            dateFrom: null,
            dateTo: null,
            costurera: '',
            producto: '',
            estado: ''
        };

        function updateStatsFilters() {
            const period = document.getElementById('stats-period').value;
            currentStatsFilters.period = period;
            
            // Show/hide custom date fields
            const customDateGroup = document.getElementById('custom-date-group');
            const customDateToGroup = document.getElementById('custom-date-to-group');
            
            if (period === 'custom') {
                customDateGroup.style.display = 'block';
                customDateToGroup.style.display = 'block';
                currentStatsFilters.dateFrom = document.getElementById('stats-date-from').value;
                currentStatsFilters.dateTo = document.getElementById('stats-date-to').value;
            } else {
                customDateGroup.style.display = 'none';
                customDateToGroup.style.display = 'none';
                currentStatsFilters.dateFrom = null;
                currentStatsFilters.dateTo = null;
            }
            
            currentStatsFilters.costurera = document.getElementById('stats-costurera').value;
            currentStatsFilters.producto = document.getElementById('stats-producto').value;
            currentStatsFilters.estado = document.getElementById('stats-estado').value;
            
            loadStatistics();
        }

        function loadStatistics() {
            // Load KPIs
            loadKPIs();
            
            // Load Charts
            loadChartsData();
            
            // Load Analysis Tables
            loadAnalysisData();
        }

        // Funciones para tooltips de gr√°ficos
        let chartTooltip = null;

        function showChartTooltip(event, label, value, percentage) {
            hideChartTooltip(); // Remove existing tooltip
            
            chartTooltip = document.createElement('div');
            chartTooltip.className = 'chart-tooltip';
            chartTooltip.innerHTML = `
                <strong>${label}</strong><br>
                Cantidad: ${value}<br>
                Porcentaje: ${percentage}%
            `;
            chartTooltip.style.cssText = `
                position: absolute;
                background: rgba(0, 0, 0, 0.8);
                color: white;
                padding: 8px 12px;
                border-radius: 4px;
                font-size: 12px;
                line-height: 1.4;
                pointer-events: none;
                z-index: 1000;
                box-shadow: 0 2px 8px rgba(0,0,0,0.3);
                left: ${event.pageX + 10}px;
                top: ${event.pageY - 10}px;
            `;
            
            document.body.appendChild(chartTooltip);
        }

        function hideChartTooltip() {
            if (chartTooltip) {
                chartTooltip.remove();
                chartTooltip = null;
            }
        }

        function loadKPIs() {
            fetch('/api/admin/stats/kpis', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(currentStatsFilters)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('kpi-total-solicitudes').textContent = data.kpis.totalSolicitudes || 0;
                    document.getElementById('kpi-etiquetas-impresas').textContent = data.kpis.etiquetasImpresas || 0;
                    document.getElementById('kpi-tiempo-promedio').textContent = (data.kpis.tiempoPromedio || 0).toFixed(1);
                    document.getElementById('kpi-tasa-completado').textContent = (data.kpis.tasaCompletado || 0).toFixed(1) + '%';
                    
                    // Trends
                    document.getElementById('kpi-solicitudes-trend').textContent = data.kpis.solicitudesTrend || '';
                    document.getElementById('kpi-etiquetas-trend').textContent = data.kpis.etiquetasTrend || '';
                    document.getElementById('kpi-tiempo-trend').textContent = data.kpis.tiempoTrend || '';
                    document.getElementById('kpi-completado-trend').textContent = data.kpis.completadoTrend || '';
                }
            })
            .catch(error => {
                console.error('Error loading KPIs:', error);
            });
        }

        function loadChartsData() {
            fetch('/api/admin/stats/charts', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(currentStatsFilters)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    drawSolicitudesPorDia(data.charts.solicitudesPorDia);
                    drawTopCostureras(data.charts.topCostureras);
                    drawProductosPopulares(data.charts.productosPopulares);
                    drawDistribucionEstados(data.charts.distribucionEstados);
                }
            })
            .catch(error => {
                console.error('Error loading charts:', error);
            });
        }

        function loadAnalysisData() {
            // Load costureras analysis
            fetch('/api/admin/stats/analysis-costureras', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(currentStatsFilters)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    renderCosturerasAnalysis(data.analysis);
                }
            });
            
            // Load productos analysis
            fetch('/api/admin/stats/analysis-productos', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(currentStatsFilters)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    renderProductosAnalysis(data.analysis);
                }
            });
        }

        function renderCosturerasAnalysis(data) {
            const tbody = document.getElementById('analysis-costureras-body');
            tbody.innerHTML = data.map(item => `
                <tr>
                    <td><strong>${item.costurera}</strong></td>
                    <td>${item.totalSolicitudes}</td>
                    <td><span class="badge badge-success">${item.completadas}</span></td>
                    <td><span class="badge badge-warning">${item.pendientes}</span></td>
                    <td>
                        <span class="badge ${item.porcentajeExito >= 80 ? 'badge-success' : item.porcentajeExito >= 60 ? 'badge-warning' : 'badge-error'}">
                            ${item.porcentajeExito.toFixed(1)}%
                        </span>
                    </td>
                    <td>${item.etiquetasImpresas}</td>
                    <td>${item.tiempoPromedio.toFixed(1)}h</td>
                    <td>
                        <span class="badge ${item.rendimiento >= 85 ? 'badge-success' : item.rendimiento >= 70 ? 'badge-warning' : 'badge-error'}">
                            ${item.rendimiento >= 85 ? 'üèÜ Excelente' : item.rendimiento >= 70 ? 'üëç Bueno' : 'üìà Mejorar'}
                        </span>
                    </td>
                </tr>
            `).join('');
        }

        function renderProductosAnalysis(data) {
            const tbody = document.getElementById('analysis-productos-body');
            tbody.innerHTML = data.map(item => `
                <tr>
                    <td><strong>${item.producto}</strong></td>
                    <td>${item.totalSolicitudes}</td>
                    <td><strong>${item.cantidadTotal}</strong></td>
                    <td>${item.promedioSolicitud.toFixed(1)}</td>
                    <td>${item.costurerasDistintas}</td>
                    <td>${formatDate(item.ultimaSolicitud)}</td>
                    <td>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <div style="width: 50px; height: 6px; background: var(--bg-secondary); border-radius: 3px; overflow: hidden;">
                                <div style="width: ${item.popularidad}%; height: 100%; background: var(--primary-color);"></div>
                            </div>
                            <span>${item.popularidad.toFixed(1)}%</span>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        // Simple chart functions (using basic Canvas API)
        function drawSolicitudesPorDia(data) {
            const canvas = document.getElementById('chart-solicitudes-dia');
            const ctx = canvas.getContext('2d');
            
            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            if (!data || data.length === 0) {
                ctx.fillStyle = '#64748b';
                ctx.font = '14px Inter';
                ctx.textAlign = 'center';
                ctx.fillText('No hay datos para mostrar', canvas.width/2, canvas.height/2);
                return;
            }
            
            // Store data for tooltip
            canvas.chartData = data;
            
            // Simple bar chart
            const maxValue = Math.max(...data.map(d => d.count));
            const barWidth = canvas.width / data.length * 0.8;
            const barSpacing = canvas.width / data.length * 0.2;
            const total = data.reduce((sum, item) => sum + item.count, 0);
            
            // Store bars info for hover detection
            canvas.bars = [];
            
            data.forEach((item, index) => {
                const barHeight = (item.count / maxValue) * (canvas.height - 40);
                const x = index * (barWidth + barSpacing) + barSpacing/2;
                const y = canvas.height - barHeight - 20;
                const percentage = ((item.count / total) * 100).toFixed(1);
                
                // Store bar information
                canvas.bars.push({
                    x: x,
                    y: y,
                    width: barWidth,
                    height: barHeight,
                    label: item.date,
                    value: item.count,
                    percentage: percentage
                });
                
                // Draw bar
                ctx.fillStyle = '#2563eb';
                ctx.fillRect(x, y, barWidth, barHeight);
                
                // Draw value
                ctx.fillStyle = '#1e293b';
                ctx.font = '12px Inter';
                ctx.textAlign = 'center';
                ctx.fillText(item.count.toString(), x + barWidth/2, y - 5);
                
                // Draw date
                ctx.fillText(item.date, x + barWidth/2, canvas.height - 5);
            });
            
            // Add mouse move event listener for tooltips
            canvas.onmousemove = function(e) {
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                // Find which bar the mouse is over
                const hoveredBar = canvas.bars.find(bar => 
                    x >= bar.x && x <= bar.x + bar.width && 
                    y >= bar.y && y <= bar.y + bar.height
                );
                
                if (hoveredBar) {
                    showChartTooltip(e, hoveredBar.label, hoveredBar.value, hoveredBar.percentage);
                    canvas.style.cursor = 'pointer';
                } else {
                    hideChartTooltip();
                    canvas.style.cursor = 'default';
                }
            };
            
            canvas.onmouseleave = function() {
                hideChartTooltip();
                canvas.style.cursor = 'default';
            };
        }

        function drawTopCostureras(data) {
            const canvas = document.getElementById('chart-top-costureras');
            const ctx = canvas.getContext('2d');
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            if (!data || data.length === 0) {
                ctx.fillStyle = '#64748b';
                ctx.font = '14px Inter';
                ctx.textAlign = 'center';
                ctx.fillText('No hay datos para mostrar', canvas.width/2, canvas.height/2);
                return;
            }
            
            // Store data for tooltip
            canvas.chartData = data;
            
            // Horizontal bar chart
            const maxValue = Math.max(...data.map(d => d.count));
            const barHeight = (canvas.height - 20) / data.length * 0.8;
            const barSpacing = (canvas.height - 20) / data.length * 0.2;
            const total = data.reduce((sum, item) => sum + item.count, 0);
            
            // Store bars info for hover detection
            canvas.bars = [];
            
            data.forEach((item, index) => {
                const barWidth = (item.count / maxValue) * (canvas.width - 120);
                const x = 100;
                const y = index * (barHeight + barSpacing) + barSpacing/2;
                const percentage = ((item.count / total) * 100).toFixed(1);
                
                // Store bar information
                canvas.bars.push({
                    x: x,
                    y: y,
                    width: barWidth,
                    height: barHeight,
                    label: item.name,
                    value: item.count,
                    percentage: percentage
                });
                
                // Draw bar
                ctx.fillStyle = '#10b981';
                ctx.fillRect(x, y, barWidth, barHeight);
                
                // Draw name
                ctx.fillStyle = '#1e293b';
                ctx.font = '12px Inter';
                ctx.textAlign = 'right';
                ctx.fillText(item.name, 95, y + barHeight/2 + 4);
                
                // Draw value
                ctx.textAlign = 'left';
                ctx.fillText(item.count.toString(), x + barWidth + 5, y + barHeight/2 + 4);
            });
            
            // Add mouse move event listener for tooltips
            canvas.onmousemove = function(e) {
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                // Find which bar the mouse is over
                const hoveredBar = canvas.bars.find(bar => 
                    x >= bar.x && x <= bar.x + bar.width && 
                    y >= bar.y && y <= bar.y + bar.height
                );
                
                if (hoveredBar) {
                    showChartTooltip(e, hoveredBar.label, hoveredBar.value, hoveredBar.percentage);
                    canvas.style.cursor = 'pointer';
                } else {
                    hideChartTooltip();
                    canvas.style.cursor = 'default';
                }
            };
            
            canvas.onmouseleave = function() {
                hideChartTooltip();
                canvas.style.cursor = 'default';
            };
        }

        function drawProductosPopulares(data) {
            const canvas = document.getElementById('chart-productos-populares');
            const ctx = canvas.getContext('2d');
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            if (!data || data.length === 0) {
                ctx.fillStyle = '#64748b';
                ctx.font = '14px Inter';
                ctx.textAlign = 'center';
                ctx.fillText('No hay datos para mostrar', canvas.width/2, canvas.height/2);
                return;
            }
            
            // Store data for tooltip
            canvas.chartData = data;
            
            // Simple pie chart
            const total = data.reduce((sum, item) => sum + item.count, 0);
            let currentAngle = 0;
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const radius = Math.min(centerX, centerY) - 20;
            
            const colors = ['#2563eb', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#06b6d4'];
            
            // Store slice info for hover detection
            canvas.slices = [];
            
            data.forEach((item, index) => {
                const sliceAngle = (item.count / total) * 2 * Math.PI;
                const percentage = ((item.count / total) * 100).toFixed(1);
                
                ctx.beginPath();
                ctx.moveTo(centerX, centerY);
                ctx.arc(centerX, centerY, radius, currentAngle, currentAngle + sliceAngle);
                ctx.closePath();
                ctx.fillStyle = colors[index % colors.length];
                ctx.fill();
                
                // Store slice information
                canvas.slices.push({
                    startAngle: currentAngle,
                    endAngle: currentAngle + sliceAngle,
                    color: colors[index % colors.length],
                    label: item.name,
                    value: item.count,
                    percentage: percentage
                });
                
                currentAngle += sliceAngle;
            });
            
            // Add mouse move event listener for tooltips
            canvas.onmousemove = function(e) {
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                // Calculate angle from center
                const dx = x - centerX;
                const dy = y - centerY;
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                if (distance <= radius) {
                    let angle = Math.atan2(dy, dx);
                    if (angle < 0) angle += 2 * Math.PI;
                    
                    // Find which slice the mouse is over
                    const hoveredSlice = canvas.slices.find(slice => 
                        angle >= slice.startAngle && angle <= slice.endAngle
                    );
                    
                    if (hoveredSlice) {
                        showChartTooltip(e, hoveredSlice.label, hoveredSlice.value, hoveredSlice.percentage);
                        canvas.style.cursor = 'pointer';
                    } else {
                        hideChartTooltip();
                        canvas.style.cursor = 'default';
                    }
                } else {
                    hideChartTooltip();
                    canvas.style.cursor = 'default';
                }
            };
            
            canvas.onmouseleave = function() {
                hideChartTooltip();
                canvas.style.cursor = 'default';
            };
        }

        function drawDistribucionEstados(data) {
            const canvas = document.getElementById('chart-estados');
            const ctx = canvas.getContext('2d');
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            if (!data || data.length === 0) {
                ctx.fillStyle = '#64748b';
                ctx.font = '14px Inter';
                ctx.textAlign = 'center';
                ctx.fillText('No hay datos para mostrar', canvas.width/2, canvas.height/2);
                return;
            }
            
            // Store data for tooltip
            canvas.chartData = data;
            
            // Donut chart
            const total = data.reduce((sum, item) => sum + item.count, 0);
            let currentAngle = 0;
            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;
            const outerRadius = Math.min(centerX, centerY) - 20;
            const innerRadius = outerRadius * 0.6;
            
            const stateColors = {
                'completada': '#10b981',
                'proceso': '#f59e0b', 
                'pendiente': '#64748b',
                'cancelada': '#ef4444'
            };
            
            // Store slice info for hover detection
            canvas.slices = [];
            
            data.forEach((item, index) => {
                const sliceAngle = (item.count / total) * 2 * Math.PI;
                const percentage = ((item.count / total) * 100).toFixed(1);
                
                ctx.beginPath();
                ctx.arc(centerX, centerY, outerRadius, currentAngle, currentAngle + sliceAngle);
                ctx.arc(centerX, centerY, innerRadius, currentAngle + sliceAngle, currentAngle, true);
                ctx.closePath();
                ctx.fillStyle = stateColors[item.estado] || '#64748b';
                ctx.fill();
                
                // Store slice information
                canvas.slices.push({
                    startAngle: currentAngle,
                    endAngle: currentAngle + sliceAngle,
                    color: stateColors[item.estado] || '#64748b',
                    label: item.estado.charAt(0).toUpperCase() + item.estado.slice(1),
                    value: item.count,
                    percentage: percentage,
                    innerRadius: innerRadius,
                    outerRadius: outerRadius
                });
                
                currentAngle += sliceAngle;
            });
            
            // Add mouse move event listener for tooltips
            canvas.onmousemove = function(e) {
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                // Calculate angle from center
                const dx = x - centerX;
                const dy = y - centerY;
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                // Check if mouse is within donut area
                if (distance >= innerRadius && distance <= outerRadius) {
                    let angle = Math.atan2(dy, dx);
                    if (angle < 0) angle += 2 * Math.PI;
                    
                    // Find which slice the mouse is over
                    const hoveredSlice = canvas.slices.find(slice => 
                        angle >= slice.startAngle && angle <= slice.endAngle
                    );
                    
                    if (hoveredSlice) {
                        showChartTooltip(e, hoveredSlice.label, hoveredSlice.value, hoveredSlice.percentage);
                        canvas.style.cursor = 'pointer';
                    } else {
                        hideChartTooltip();
                        canvas.style.cursor = 'default';
                    }
                } else {
                    hideChartTooltip();
                    canvas.style.cursor = 'default';
                }
            };
            
            canvas.onmouseleave = function() {
                hideChartTooltip();
                canvas.style.cursor = 'default';
            };
        }

        function refreshStats() {
            loadStatistics();
            showNotification('Estad√≠sticas actualizadas', 'success');
        }

        function exportStatsReport() {
            const params = new URLSearchParams(currentStatsFilters);
            window.open(`/api/admin/export/stats-report?${params.toString()}`, '_blank');
        }

        function loadStatsFiltersData() {
            // Load costureras for filter
            fetch('/api/admin/users')
                .then(response => response.json())
                .then(data => {
                    if (Array.isArray(data)) {
                        const costurerasSelect = document.getElementById('stats-costurera');
                        const costureras = data.filter(u => u.nivel_acceso === 'costurera');
                        costurerasSelect.innerHTML = '<option value="">Todas</option>' +
                            costureras.map(c => `<option value="${c.id_usuario}">${c.nombre_completo}</option>`).join('');
                    }
                });
            
            // Load products for filter
            fetch('/api/productos')
                .then(response => response.json())
                .then(result => {
                    // Manejar nueva estructura de respuesta con paginaci√≥n
                    const data = result.data || result || [];
                    if (Array.isArray(data)) {
                        const productosSelect = document.getElementById('stats-producto');
                        productosSelect.innerHTML = '<option value="">Todos</option>' +
                            data.map(p => `<option value="${p.id_producto}">${p.nombre_producto}</option>`).join('');
                    }
                });
        }

        // Other placeholder functions
        function loadSolicitudes() {
            showLoading('solicitudes-table-body');
            fetch('/api/solicitudes')
                .then(response => response.json())
                .then(data => {
                    if (Array.isArray(data)) {
                        currentSolicitudes = data;
                        filteredSolicitudes = data;
                        renderSolicitudes(filteredSolicitudes);
                    } else {
                        showError('solicitudes-table-body', 'Error en formato de datos');
                    }
                })
                .catch(error => {
                    console.error('Error loading solicitudes:', error);
                    showError('solicitudes-table-body', 'Error cargando solicitudes');
                });
        }

        function renderSolicitudes(solicitudes) {
            const tbody = document.getElementById('solicitudes-table-body');
            if (solicitudes.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; color: var(--text-secondary);">No hay solicitudes para mostrar</td></tr>';
                return;
            }
            
            tbody.innerHTML = solicitudes.map(sol => `
                <tr>
                    <td>${sol.id_solicitud}</td>
                    <td><strong>${sol.numero_solicitud}</strong></td>
                    <td>${sol.nombre_producto || '-'}</td>
                    <td>${sol.costurera_nombre || '-'}</td>
                    <td>${sol.cantidad_solicitada}</td>
                    <td>
                        <span class="badge badge-${sol.estado}">
                            ${sol.estado}
                        </span>
                    </td>
                    <td>${sol.qr_code || '-'}</td>
                    <td>${formatDate(sol.fecha_solicitud)}</td>
                    <td>
                        <div class="table-actions-cell">
                            <button class="btn btn-sm btn-primary" onclick="viewSolicitud(${sol.id_solicitud})" title="Ver">
                                üëÅÔ∏è
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteSolicitud(${sol.id_solicitud}, '${sol.numero_solicitud}')" title="Eliminar">
                                üóëÔ∏è
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function searchProducts(query) {
            if (!query.trim()) {
                filteredProducts = currentProducts;
            } else {
                filteredProducts = currentProducts.filter(product => 
                    product.nombre_producto.toLowerCase().includes(query.toLowerCase()) ||
                    (product.modelo && product.modelo.toLowerCase().includes(query.toLowerCase()))
                );
            }
            renderProducts(filteredProducts);
        }

        function filterProductStatus(status) {
            if (status === '') {
                filteredProducts = currentProducts;
            } else {
                const isActive = status === 'true';
                filteredProducts = currentProducts.filter(product => product.activo === isActive);
            }
            renderProducts(filteredProducts);
        }

        function toggleProductStatus(productId, newStatus) {
            if (!confirm(`¬øEst√° seguro de ${newStatus ? 'activar' : 'desactivar'} este producto?`)) return;
            
            fetch(`/api/admin/products/${productId}/toggle-status`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ activo: newStatus })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadProducts();
                    showNotification(`Producto ${newStatus ? 'activado' : 'desactivado'} exitosamente`, 'success');
                } else {
                    showNotification('Error: ' + data.error, 'error');
                }
            })
            .catch(error => {
                console.error('Error toggling product status:', error);
                showNotification('Error al cambiar estado del producto', 'error');
            });
        }

        function deleteProduct(productId) {
            if (!confirm('¬øEst√° seguro de eliminar permanentemente este producto? Esta acci√≥n no se puede deshacer.')) return;
            
            fetch(`/api/admin/products/${productId}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadProducts();
                    showNotification('Producto eliminado exitosamente', 'success');
                } else {
                    showNotification('Error: ' + data.error, 'error');
                }
            })
            .catch(error => {
                console.error('Error deleting product:', error);
                showNotification('Error al eliminar producto', 'error');
            });
        }

        // =============================================
        // ANALYTICS AVANZADOS
        // =============================================
        function loadAnalytics() {
            loadProductivityChart();
            loadTrendsChart();
            loadDepartmentStats();
        }

        function updateAnalytics() {
            loadProductivityChart();
            loadTrendsChart();
        }

        function refreshAnalytics() {
            loadAnalytics();
        }

        // Gr√°fico de productividad por usuario
        function loadProductivityChart() {
            const period = document.getElementById('analytics-period')?.value || '7';
            
            fetch(`/api/admin/productivity-stats?periodo=${period}`)
                .then(response => response.json())
                .then(data => {
                    if (data.length === 0) {
                        document.getElementById('productivity-chart').style.display = 'none';
                        return;
                    }
                    
                    const canvas = document.getElementById('productivity-chart');
                    const ctx = canvas.getContext('2d');
                    
                    // Tomar los top 10 usuarios
                    const topUsers = data.slice(0, 10);
                    
                    // Limpiar canvas
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    
                    const maxValue = Math.max(...topUsers.map(u => u.etiquetas_completadas));
                    const barWidth = canvas.width / topUsers.length;
                    const barMaxHeight = canvas.height - 60;
                    
                    topUsers.forEach((user, index) => {
                        const barHeight = (user.etiquetas_completadas / maxValue) * barMaxHeight;
                        const x = index * barWidth;
                        const y = canvas.height - barHeight - 20;
                        
                        // Color degradado basado en productividad
                        const intensity = user.etiquetas_completadas / maxValue;
                        ctx.fillStyle = `hsl(${120 * intensity}, 70%, 50%)`;
                        
                        // Dibujar barra
                        ctx.fillRect(x + 5, y, barWidth - 10, barHeight);
                        
                        // Texto del valor
                        ctx.fillStyle = '#333';
                        ctx.font = '12px Arial';
                        ctx.textAlign = 'center';
                        ctx.fillText(user.etiquetas_completadas, x + barWidth/2, y - 5);
                        
                        // Nombre del usuario (rotado)
                        ctx.save();
                        ctx.translate(x + barWidth/2, canvas.height - 5);
                        ctx.rotate(-Math.PI/4);
                        ctx.fillText(user.nombre_completo.split(' ')[0], 0, 0);
                        ctx.restore();
                    });
                })
                .catch(error => console.error('Error loading productivity chart:', error));
        }

        // Gr√°fico de tendencias temporales
        function loadTrendsChart() {
            fetch('/api/admin/trends')
                .then(response => response.json())
                .then(data => {
                    if (data.length === 0) return;
                    
                    const canvas = document.getElementById('trends-chart');
                    const ctx = canvas.getContext('2d');
                    
                    // Tomar los √∫ltimos 15 d√≠as
                    const recentData = data.slice(0, 15).reverse();
                    
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    
                    const maxSolicitudes = Math.max(...recentData.map(d => d.total_solicitudes));
                    const maxEtiquetas = Math.max(...recentData.map(d => d.total_etiquetas));
                    const pointWidth = canvas.width / recentData.length;
                    const chartHeight = canvas.height - 60;
                    
                    // L√≠nea de solicitudes (azul)
                    ctx.strokeStyle = '#3b82f6';
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    recentData.forEach((day, index) => {
                        const x = index * pointWidth + pointWidth/2;
                        const y = canvas.height - 40 - (day.total_solicitudes / maxSolicitudes) * chartHeight;
                        if (index === 0) ctx.moveTo(x, y);
                        else ctx.lineTo(x, y);
                    });
                    ctx.stroke();
                    
                    // Puntos de solicitudes
                    ctx.fillStyle = '#3b82f6';
                    recentData.forEach((day, index) => {
                        const x = index * pointWidth + pointWidth/2;
                        const y = canvas.height - 40 - (day.total_solicitudes / maxSolicitudes) * chartHeight;
                        ctx.beginPath();
                        ctx.arc(x, y, 4, 0, 2 * Math.PI);
                        ctx.fill();
                    });
                    
                    // Etiquetas en el eje derecho (verde)
                    const etiquetasScale = maxEtiquetas > 0 ? chartHeight / maxEtiquetas : 0;
                    ctx.strokeStyle = '#10b981';
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    recentData.forEach((day, index) => {
                        const x = index * pointWidth + pointWidth/2;
                        const y = canvas.height - 40 - (day.total_etiquetas * etiquetasScale);
                        if (index === 0) ctx.moveTo(x, y);
                        else ctx.lineTo(x, y);
                    });
                    ctx.stroke();
                    
                    // Leyenda
                    ctx.fillStyle = '#3b82f6';
                    ctx.fillRect(10, 10, 15, 10);
                    ctx.fillStyle = '#333';
                    ctx.font = '12px Arial';
                    ctx.fillText('Solicitudes', 30, 20);
                    
                    ctx.fillStyle = '#10b981';
                    ctx.fillRect(110, 10, 15, 10);
                    ctx.fillStyle = '#333';
                    ctx.fillText('Etiquetas', 130, 20);
                })
                .catch(error => console.error('Error loading trends chart:', error));
        }

        // Estad√≠sticas por departamento
        function loadDepartmentStats() {
            fetch('/api/admin/department-stats')
                .then(response => response.json())
                .then(data => {
                    const container = document.getElementById('department-stats-table');
                    
                    if (data.length === 0) {
                        container.innerHTML = '<p style="text-align: center; color: #666;">No hay datos disponibles</p>';
                        return;
                    }
                    
                    container.innerHTML = `
                        <div style="overflow-x: auto;">
                            <table style="width: 100%; border-collapse: collapse;">
                                <thead>
                                    <tr style="background: #f8f9fa;">
                                        <th style="padding: 12px; text-align: left; border-bottom: 2px solid #dee2e6;">Departamento</th>
                                        <th style="padding: 12px; text-align: center; border-bottom: 2px solid #dee2e6;">Usuarios</th>
                                        <th style="padding: 12px; text-align: center; border-bottom: 2px solid #dee2e6;">Activos</th>
                                        <th style="padding: 12px; text-align: center; border-bottom: 2px solid #dee2e6;">Solicitudes (7d)</th>
                                        <th style="padding: 12px; text-align: center; border-bottom: 2px solid #dee2e6;">Etiquetas (7d)</th>
                                        <th style="padding: 12px; text-align: center; border-bottom: 2px solid #dee2e6;">Promedio</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${data.map(dept => `
                                        <tr style="border-bottom: 1px solid #dee2e6;">
                                            <td style="padding: 12px; font-weight: 600;">${dept.nombre_departamento}</td>
                                            <td style="padding: 12px; text-align: center;">${dept.total_usuarios}</td>
                                            <td style="padding: 12px; text-align: center;">
                                                <span style="color: ${dept.usuarios_activos > 0 ? '#10b981' : '#ef4444'};">
                                                    ${dept.usuarios_activos}
                                                </span>
                                            </td>
                                            <td style="padding: 12px; text-align: center;">${dept.total_solicitudes_7d}</td>
                                            <td style="padding: 12px; text-align: center; font-weight: 600; color: #3b82f6;">
                                                ${dept.total_etiquetas_7d}
                                            </td>
                                            <td style="padding: 12px; text-align: center;">${Math.round(dept.promedio_por_solicitud * 10) / 10}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                })
                .catch(error => console.error('Error loading department stats:', error));
        }

        // =============================================
        // GESTI√ìN AVANZADA DE IMPRESORA
        // =============================================
        function loadPrinterManagement() {
            loadPrinterStats();
            loadPrinterQueue();
            loadPrinterEvents();
        }

        // Cargar estad√≠sticas de impresora
        function loadPrinterStats() {
            fetch('/api/impresora/stats?dias=7')
                .then(response => response.json())
                .then(data => {
                    // Actualizar estado de conexi√≥n
                    const connectionStatus = document.getElementById('printer-connection-status');
                    const estado = data.estado_actual?.estado_impresora || 'desconocido';
                    
                    let statusColor = '#10b981';
                    let statusText = '‚óè Conectada';
                    
                    if (estado === 'error' || estado === 'desconectada') {
                        statusColor = '#ef4444';
                        statusText = '‚óè Desconectada';
                    } else if (estado === 'timeout') {
                        statusColor = '#f59e0b';
                        statusText = '‚óè Timeout';
                    }
                    
                    connectionStatus.innerHTML = `<span style="color: ${statusColor};">${statusText}</span>`;
                    
                    // Actualizar estad√≠sticas
                    const stats = data.estadisticas;
                    document.getElementById('printer-queue-status').textContent = 
                        `${data.cola_pendiente?.length || 0} pendientes`;
                    
                    document.getElementById('printer-urgent-count').textContent = 
                        `${stats.solicitudes_urgentes || 0} urgentes`;
                    
                    document.getElementById('printer-labels-today').textContent = 
                        `${stats.etiquetas_impresas || 0} impresas`;
                    
                    // Renderizar gr√°fico de actividad
                    renderPrinterActivityChart(stats);
                    
                    // Mostrar cola de prioridades
                    renderPriorityQueue(data.cola_pendiente || []);
                })
                .catch(error => {
                    console.error('Error loading printer stats:', error);
                    document.getElementById('printer-connection-status').innerHTML = 
                        '<span style="color: #ef4444;">‚óè Error</span>';
                });
        }

        // Verificar estado de impresora
        function verificarEstadoImpresora() {
            showNotification('Ejecutando diagn√≥stico...', 'info');
            
            fetch('/api/impresora/diagnostico')
                .then(response => response.json())
                .then(data => {
                    const diagnosticsContainer = document.getElementById('printer-diagnostics');
                    
                    diagnosticsContainer.innerHTML = `
                        <div style="margin-bottom: 1rem;">
                            <strong>Estado Actual:</strong> 
                            <span style="color: ${data.estado_actual === 'conectada' ? '#10b981' : '#ef4444'};">
                                ${data.estado_actual.toUpperCase()}
                            </span>
                        </div>
                        
                        ${data.ultimo_error ? `
                            <div style="margin-bottom: 1rem; padding: 0.5rem; background: #fef2f2; border-radius: 4px;">
                                <strong>√öltimo Error:</strong> ${data.ultimo_error}
                            </div>
                        ` : ''}
                        
                        <div style="margin-bottom: 1rem;">
                            <strong>Recomendaciones:</strong>
                            <ul style="margin: 0.5rem 0; padding-left: 1.5rem;">
                                ${data.recomendaciones.map(rec => `<li>${rec}</li>`).join('')}
                            </ul>
                        </div>
                        
                        ${data.errores_recientes.length > 0 ? `
                            <details style="margin-top: 1rem;">
                                <summary style="cursor: pointer; font-weight: 600;">Errores Recientes (${data.errores_recientes.length})</summary>
                                <div style="margin-top: 0.5rem;">
                                    ${data.errores_recientes.map(error => `
                                        <div style="padding: 0.5rem; border-bottom: 1px solid #eee;">
                                            <small>${new Date(error.timestamp).toLocaleString()}</small><br>
                                            <strong>${error.codigo_error || 'ERROR'}</strong>: ${error.mensaje_detalle}
                                        </div>
                                    `).join('')}
                                </div>
                            </details>
                        ` : ''}
                    `;
                    
                    showNotification('Diagn√≥stico completado', 'success');
                })
                .catch(error => {
                    console.error('Error in diagnostics:', error);
                    showNotification('Error en diagn√≥stico', 'error');
                });
        }

        // Procesar cola manualmente
        function procesarColaManual() {
            if (!confirm('¬øProcesar la cola de impresi√≥n manualmente?')) return;
            
            showNotification('Procesando cola...', 'info');
            
            fetch('/api/impresora/cola')
                .then(response => response.json())
                .then(data => {
                    if (data.solicitudes_cola.length === 0) {
                        showNotification('No hay solicitudes en cola', 'warning');
                        return;
                    }
                    
                    showNotification(`${data.solicitudes_cola.length} solicitudes en cola`, 'success');
                    loadPrinterStats(); // Recargar estad√≠sticas
                })
                .catch(error => {
                    console.error('Error processing queue:', error);
                    showNotification('Error procesando cola', 'error');
                });
        }

        // Renderizar gr√°fico de actividad
        function renderPrinterActivityChart(stats) {
            const canvas = document.getElementById('printer-activity-chart');
            const ctx = canvas.getContext('2d');
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Datos simulados - en producci√≥n vendr√≠a de la API
            const etiquetas = stats.etiquetas_impresas || 0;
            const errores = stats.errores_totales || 0;
            const total = etiquetas + errores;
            
            if (total === 0) {
                ctx.fillStyle = '#666';
                ctx.font = '14px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('Sin datos de actividad', canvas.width/2, canvas.height/2);
                return;
            }
            
            // Gr√°fico de barras simple
            const barWidth = canvas.width / 3;
            const maxHeight = canvas.height - 40;
            
            // Barra de etiquetas exitosas
            ctx.fillStyle = '#10b981';
            const sucessHeight = (etiquetas / total) * maxHeight;
            ctx.fillRect(barWidth * 0.5, canvas.height - sucessHeight - 20, barWidth * 0.8, sucessHeight);
            
            // Barra de errores
            ctx.fillStyle = '#ef4444';
            const errorHeight = (errores / total) * maxHeight;
            ctx.fillRect(barWidth * 1.5, canvas.height - errorHeight - 20, barWidth * 0.8, errorHeight);
            
            // Etiquetas
            ctx.fillStyle = '#333';
            ctx.font = '12px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('Exitosas', barWidth * 0.9, canvas.height - 5);
            ctx.fillText('Errores', barWidth * 1.9, canvas.height - 5);
            ctx.fillText(etiquetas, barWidth * 0.9, canvas.height - sucessHeight - 25);
            ctx.fillText(errores, barWidth * 1.9, canvas.height - errorHeight - 25);
        }

        // Mostrar cola de prioridades
        function renderPriorityQueue(queue) {
            const container = document.getElementById('printer-priority-queue');
            
            if (queue.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666;">Cola vac√≠a</p>';
                return;
            }
            
            container.innerHTML = queue.slice(0, 5).map((item, index) => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; border-bottom: 1px solid #eee;">
                    <div>
                        <strong>#${index + 1}</strong>
                        <span style="margin-left: 0.5rem;">Sol. ${item.id_solicitud}</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <span class="badge badge-${item.prioridad}" style="font-size: 0.7rem;">
                            ${item.prioridad?.toUpperCase()}
                        </span>
                        <small>${item.tiempo_espera_minutos}min</small>
                    </div>
                </div>
            `).join('') + (queue.length > 5 ? 
                `<div style="text-align: center; padding: 0.5rem; color: #666;">
                    +${queue.length - 5} m√°s en cola
                </div>` : ''
            );
        }

        // Cargar cola de impresi√≥n
        function loadPrinterQueue() {
            fetch('/api/impresora/cola')
                .then(response => response.json())
                .then(data => {
                    renderPriorityQueue(data.solicitudes_cola || []);
                })
                .catch(error => console.error('Error loading printer queue:', error));
        }

        // Cargar eventos de impresora
        function loadPrinterEvents() {
            // Simular eventos - en producci√≥n ser√≠a una API real
            const events = [
                { timestamp: new Date(), tipo_evento: 'conexion', mensaje_detalle: 'Sistema iniciado', duracion_segundos: 0, estado_impresora: 'conectada' },
                { timestamp: new Date(Date.now() - 300000), tipo_evento: 'estado_verificado', mensaje_detalle: 'Verificaci√≥n autom√°tica', duracion_segundos: 0, estado_impresora: 'conectada' }
            ];
            
            const tbody = document.getElementById('printer-events-table');
            tbody.innerHTML = events.map(event => `
                <tr style="border-bottom: 1px solid #dee2e6;">
                    <td style="padding: 8px;">${event.timestamp.toLocaleString()}</td>
                    <td style="padding: 8px;">
                        <span class="badge badge-${event.tipo_evento === 'impresion_error' ? 'error' : 'success'}">
                            ${event.tipo_evento}
                        </span>
                    </td>
                    <td style="padding: 8px;">${event.mensaje_detalle}</td>
                    <td style="padding: 8px; text-align: center;">${event.duracion_segundos}s</td>
                    <td style="padding: 8px; text-align: center;">
                        <span style="color: ${event.estado_impresora === 'conectada' ? '#10b981' : '#ef4444'};">
                            ${event.estado_impresora}
                        </span>
                    </td>
                </tr>
            `).join('');
        }

        // =============================================
        // MODO OSCURO
        // =============================================
        function initializeDarkMode() {
            const darkMode = localStorage.getItem('darkMode') === 'enabled';
            const toggle = document.getElementById('darkModeToggle');
            
            if (darkMode) {
                document.body.classList.add('dark-mode');
                toggle.checked = true;
            }
        }

        function toggleDarkMode() {
            const toggle = document.getElementById('darkModeToggle');
            
            if (toggle.checked) {
                document.body.classList.add('dark-mode');
                localStorage.setItem('darkMode', 'enabled');
                showNotification('üåô Modo oscuro activado', 'info');
            } else {
                document.body.classList.remove('dark-mode');
                localStorage.setItem('darkMode', 'disabled');
                showNotification('‚òÄÔ∏è Modo claro activado', 'info');
            }
        }

        // === FUNCIONES DE MANTENIMIENTO ===

        // Ejecutar herramientas de mantenimiento
        async function executeMaintenance(type) {
            let resultElement;
            
            switch(type) {
                case 'cleanup':
                    await executeCleanup();
                    break;
                case 'optimize':
                    await executeOptimization();
                    break;
                case 'analyze':
                    await executeAnalysis();
                    break;
                case 'export':
                    await executeExport();
                    break;
                case 'backup':
                    await executeBackup();
                    break;
            }
        }

        // Limpieza de documentos
        async function executeCleanup() {
            const fechaInicio = document.getElementById('cleanup-fecha-inicio').value;
            const fechaFin = document.getElementById('cleanup-fecha-fin').value;
            const incluirCola = document.getElementById('cleanup-incluir-cola').checked;
            const resultElement = document.getElementById('cleanup-result');

            if (!fechaInicio || !fechaFin) {
                showNotification('‚ùå Por favor selecciona ambas fechas', 'error');
                return;
            }

            if (new Date(fechaInicio) >= new Date(fechaFin)) {
                showNotification('‚ùå La fecha de inicio debe ser anterior a la fecha fin', 'error');
                return;
            }

            // Mostrar confirmaci√≥n
            if (!confirm(`¬øEst√°s seguro de eliminar los registros desde ${fechaInicio} hasta ${fechaFin}?`)) {
                return;
            }

            try {
                resultElement.style.display = 'block';
                resultElement.innerHTML = 'üîÑ Ejecutando limpieza...';

                const response = await fetch('/api/mantenimiento/cleanup', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        fechaInicio,
                        fechaFin,
                        incluirCola
                    })
                });

                const result = await response.json();
                
                if (response.ok) {
                    resultElement.innerHTML = `
                        <div style="color: var(--success-color); padding: 1rem; background: #f0f9ff; border-radius: var(--radius);">
                            ‚úÖ Limpieza completada exitosamente<br>
                            üìã Solicitudes eliminadas: ${result.solicitudesEliminadas}<br>
                            ${result.colaEliminada ? `üñ®Ô∏è Registros de cola eliminados: ${result.colaEliminada}<br>` : ''}
                            üíæ Espacio liberado: ~${result.espacioLiberado}
                        </div>
                    `;
                    showNotification('üóëÔ∏è Limpieza ejecutada correctamente', 'success');
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                resultElement.innerHTML = `
                    <div style="color: var(--error-color); padding: 1rem; background: #fef2f2; border-radius: var(--radius);">
                        ‚ùå Error: ${error.message}
                    </div>
                `;
                showNotification('‚ùå Error en limpieza', 'error');
            }
        }

        // Optimizaci√≥n de base de datos
        async function executeOptimization() {
            const resultElement = document.getElementById('optimize-result');
            
            try {
                resultElement.style.display = 'block';
                resultElement.innerHTML = '‚ö° Optimizando base de datos...';

                const response = await fetch('/api/mantenimiento/optimize', {
                    method: 'POST'
                });

                const result = await response.json();
                
                if (response.ok) {
                    resultElement.innerHTML = `
                        <div style="color: var(--success-color); padding: 1rem; background: #f0f9ff; border-radius: var(--radius);">
                            ‚ö° Optimizaci√≥n completada<br>
                            üìä √çndices actualizados: ${result.indicesActualizados}<br>
                            üßπ Registros limpiados: ${result.registrosLimpiados}<br>
                            ‚è±Ô∏è Tiempo: ${result.tiempoEjecucion}s
                        </div>
                    `;
                    document.getElementById('last-optimization').textContent = new Date().toLocaleString();
                    document.getElementById('index-status').textContent = '√ìptimo';
                    document.getElementById('index-status').className = 'status-badge success';
                    showNotification('‚ö° Optimizaci√≥n completada', 'success');
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                resultElement.innerHTML = `
                    <div style="color: var(--error-color); padding: 1rem; background: #fef2f2; border-radius: var(--radius);">
                        ‚ùå Error: ${error.message}
                    </div>
                `;
                showNotification('‚ùå Error en optimizaci√≥n', 'error');
            }
        }

        // An√°lisis de sistema
        async function executeAnalysis() {
            const resultElement = document.getElementById('analyze-result');
            
            try {
                resultElement.style.display = 'block';
                resultElement.innerHTML = 'üìä Generando an√°lisis...';

                const response = await fetch('/api/mantenimiento/analyze', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                const result = await response.json();
                
                if (response.ok) {
                    // Actualizar m√©tricas
                    document.getElementById('metric-users').textContent = result.usuarios;
                    document.getElementById('metric-products').textContent = result.productos;
                    document.getElementById('metric-pending').textContent = result.pendientes;
                    document.getElementById('metric-space').textContent = result.espacioBD;

                    resultElement.innerHTML = `
                        <div style="color: var(--primary-color); padding: 1rem; background: #f8fafc; border-radius: var(--radius);">
                            üìä An√°lisis completado<br>
                            üèÜ Rendimiento general: ${result.rendimiento}<br>
                            üíæ Uso de memoria: ${result.usoMemoria}<br>
                            üìà Sugerencias: ${result.sugerencias}
                        </div>
                    `;
                    showNotification('üìä An√°lisis generado', 'info');
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                resultElement.innerHTML = `
                    <div style="color: var(--error-color); padding: 1rem; background: #fef2f2; border-radius: var(--radius);">
                        ‚ùå Error: ${error.message}
                    </div>
                `;
                showNotification('‚ùå Error en an√°lisis', 'error');
            }
        }

        // Exportaci√≥n de datos
        async function executeExport() {
            const incluirUsuarios = document.getElementById('backup-usuarios').checked;
            const incluirProductos = document.getElementById('backup-productos').checked;
            const incluirSolicitudes = document.getElementById('backup-solicitudes').checked;
            const resultElement = document.getElementById('backup-result');

            try {
                resultElement.style.display = 'block';
                resultElement.innerHTML = 'üì§ Preparando exportaci√≥n...';

                const response = await fetch('/api/mantenimiento/export', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        usuarios: incluirUsuarios,
                        productos: incluirProductos,
                        solicitudes: incluirSolicitudes
                    })
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `export_sistema_${new Date().toISOString().split('T')[0]}.zip`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);

                    resultElement.innerHTML = `
                        <div style="color: var(--success-color); padding: 1rem; background: #f0f9ff; border-radius: var(--radius);">
                            üì§ Exportaci√≥n completada<br>
                            ‚¨áÔ∏è Archivo descargado exitosamente
                        </div>
                    `;
                    showNotification('üì§ Exportaci√≥n completada', 'success');
                } else {
                    const result = await response.json();
                    throw new Error(result.error);
                }
            } catch (error) {
                resultElement.innerHTML = `
                    <div style="color: var(--error-color); padding: 1rem; background: #fef2f2; border-radius: var(--radius);">
                        ‚ùå Error: ${error.message}
                    </div>
                `;
                showNotification('‚ùå Error en exportaci√≥n', 'error');
            }
        }

        // Backup del sistema
        async function executeBackup() {
            const incluirUsuarios = document.getElementById('backup-usuarios').checked;
            const incluirProductos = document.getElementById('backup-productos').checked;
            const incluirSolicitudes = document.getElementById('backup-solicitudes').checked;
            const resultElement = document.getElementById('backup-result');

            if (!confirm('¬øCrear backup completo del sistema? Esto puede tomar varios minutos.')) {
                return;
            }

            try {
                resultElement.style.display = 'block';
                resultElement.innerHTML = 'üíæ Creando backup...';

                const response = await fetch('/api/mantenimiento/backup', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        usuarios: incluirUsuarios,
                        productos: incluirProductos,
                        solicitudes: incluirSolicitudes
                    })
                });

                const result = await response.json();
                
                if (response.ok) {
                    resultElement.innerHTML = `
                        <div style="color: var(--success-color); padding: 1rem; background: #f0f9ff; border-radius: var(--radius);">
                            üíæ Backup creado exitosamente<br>
                            üìÇ Archivo: ${result.archivo}<br>
                            üì¶ Tama√±o: ${result.tama√±o}<br>
                            üìÖ Fecha: ${result.fecha}
                        </div>
                    `;
                    showNotification('üíæ Backup creado', 'success');
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                resultElement.innerHTML = `
                    <div style="color: var(--error-color); padding: 1rem; background: #fef2f2; border-radius: var(--radius);">
                        ‚ùå Error: ${error.message}
                    </div>
                `;
                showNotification('‚ùå Error en backup', 'error');
            }
        }

        // Cargar informaci√≥n de mantenimiento al mostrar la secci√≥n
        function loadMaintenanceInfo() {
            // Cargar m√©tricas del sistema
            executeAnalysis();
            
            // Verificar estado de optimizaci√≥n
            fetch('/api/mantenimiento/status', {
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('token')}`
                }
            })
                .then(response => response.json())
                .then(data => {
                    document.getElementById('last-optimization').textContent = 
                        data.lastOptimization ? new Date(data.lastOptimization).toLocaleString() : 'Nunca';
                    
                    document.getElementById('index-status').textContent = data.indexStatus || 'Desconocido';
                    document.getElementById('index-status').className = 
                        `status-badge ${data.indexStatus === '√ìptimo' ? 'success' : 'warning'}`;
                })
                .catch(error => {
                    console.error('Error loading maintenance status:', error);
                });
        }

        // Agregar la carga de informaci√≥n de mantenimiento y chat al mostrar la secci√≥n
        const originalShowSection = showSection;
        showSection = function(section) {
            originalShowSection(section);
            if (section === 'mantenimiento') {
                loadMaintenanceInfo();
            } else if (section === 'chat') {
                if (!chatRefreshInterval) {
                    initializeChat();
                }
            }
        };

        // === MAINTENANCE TOOLS FUNCTIONS ===

        // Load maintenance information on page load
        function loadMaintenanceInfo() {
            loadDatabaseStats();
            loadBackupInfo();
            loadRequestsStats();
            updateCleanupStats();
        }

        // Database Statistics
        async function loadDatabaseStats() {
            try {
                const response = await fetch('/api/mantenimiento/analyze', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('total-docs').textContent = data.stats.totalDocuments || 0;
                    document.getElementById('db-size').textContent = data.stats.databaseSize || 'N/A';
                    document.getElementById('db-indexes').textContent = data.stats.indexCount || 0;
                    document.getElementById('last-optimization').textContent = 
                        data.stats.lastOptimization || 'Nunca';
                }
            } catch (error) {
                console.error('Error loading database stats:', error);
            }
        }

        // Backup Information
        async function loadBackupInfo() {
            try {
                // Simulate backup info - you can implement actual backup tracking
                const lastBackup = localStorage.getItem('lastBackup');
                const backupSize = localStorage.getItem('backupSize');
                
                document.getElementById('last-backup').textContent = 
                    lastBackup ? new Date(lastBackup).toLocaleString() : 'Nunca';
                document.getElementById('backup-size').textContent = backupSize || '-';
            } catch (error) {
                console.error('Error loading backup info:', error);
            }
        }

        // Load requests statistics
        async function loadRequestsStats() {
            try {
                const response = await fetch('/api/admin/solicitudes/stats', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('total-requests').textContent = data.stats.total || 0;
                    
                    // Auto-preview with current settings
                    previewRequestsCleanup();
                }
            } catch (error) {
                console.error('Error loading requests stats:', error);
                document.getElementById('total-requests').textContent = 'Error';
            }
        }

        // Update cleanup statistics
        function updateCleanupStats() {
            const cleanupDate = document.getElementById('cleanup-date');
            
            cleanupDate.addEventListener('change', async () => {
                if (!cleanupDate.value) {
                    document.getElementById('docs-to-delete').textContent = '0';
                    return;
                }

                try {
                    const response = await fetch('/api/mantenimiento/analyze', {
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        }
                    });
                    const data = await response.json();
                    
                    if (data.success) {
                        // Calculate documents older than selected date
                        const selectedDate = new Date(cleanupDate.value);
                        const currentDate = new Date();
                        const totalDocs = data.stats.totalDocuments || 0;
                        
                        // Estimate based on date range (you can improve this with actual query)
                        const daysDiff = Math.floor((currentDate - selectedDate) / (1000 * 60 * 60 * 24));
                        const estimatedOld = Math.min(Math.floor(totalDocs * (daysDiff / 365)), totalDocs);
                        
                        document.getElementById('docs-to-delete').textContent = estimatedOld;
                    }
                } catch (error) {
                    console.error('Error calculating cleanup stats:', error);
                }
            });

            // Set default date to 1 year ago
            const oneYearAgo = new Date();
            oneYearAgo.setFullYear(oneYearAgo.getFullYear() - 1);
            cleanupDate.value = oneYearAgo.toISOString().split('T')[0];
        }

        // Preview solicitudes cleanup
        async function previewRequestsCleanup() {
            const cleanupDate = document.getElementById('cleanup-date').value;
            
            if (!cleanupDate) {
                showNotification('Selecciona una fecha para la limpieza', 'error');
                return;
            }

            const selectedStates = getSelectedStates();
            if (selectedStates.length === 0) {
                showNotification('Selecciona al menos un estado de solicitud', 'error');
                return;
            }

            try {
                const response = await fetch('/api/admin/solicitudes/cleanup/preview', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({ 
                        beforeDate: cleanupDate,
                        estados: selectedStates
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    document.getElementById('requests-to-delete').textContent = result.count;
                    showNotification(`Vista previa: Se eliminar√≠an ${result.count} solicitudes de ${selectedStates.join(', ')} anteriores a ${cleanupDate}`, 'info');
                } else {
                    showNotification('Error en vista previa: ' + result.error, 'error');
                }
            } catch (error) {
                showNotification('Error de conexi√≥n en vista previa', 'error');
            }
        }

        // Get selected states for cleanup
        function getSelectedStates() {
            const states = [];
            if (document.getElementById('cleanup-completadas').checked) states.push('completada');
            if (document.getElementById('cleanup-proceso').checked) states.push('en_proceso');
            if (document.getElementById('cleanup-pendientes').checked) states.push('pendiente');
            if (document.getElementById('cleanup-rechazadas').checked) states.push('rechazada');
            return states;
        }

        // Execute solicitudes cleanup
        async function executeRequestsCleanup() {
            const cleanupDate = document.getElementById('cleanup-date').value;
            
            if (!cleanupDate) {
                showNotification('Selecciona una fecha para la limpieza', 'error');
                return;
            }

            const selectedStates = getSelectedStates();
            if (selectedStates.length === 0) {
                showNotification('Selecciona al menos un estado de solicitud', 'error');
                return;
            }

            const requestsToDelete = document.getElementById('requests-to-delete').textContent;
            
            if (!confirm(`¬øCONFIRMAS que quieres eliminar ${requestsToDelete} solicitudes de estados: ${selectedStates.join(', ')} anteriores a ${cleanupDate}?\n\n‚ö†Ô∏è ESTA ACCI√ìN NO SE PUEDE DESHACER ‚ö†Ô∏è\n\nSe conservar√°n: usuarios, productos y dise√±os`)) {
                return;
            }

            try {
                showNotification('Ejecutando limpieza de solicitudes...', 'info');
                
                const response = await fetch('/api/admin/solicitudes/cleanup', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({ 
                        beforeDate: cleanupDate,
                        estados: selectedStates
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    showNotification(`‚úÖ Limpieza completada: ${result.deletedCount} solicitudes eliminadas`, 'success');
                    // Actualizar datos y sincronizaci√≥n
                    loadMaintenanceInfo(); // Refresh stats
                    loadRequestsStats(); // Refresh request stats
                    loadSolicitudes(); // Refresh solicitudes list
                    loadDashboard(); // Refresh dashboard
                    // Forzar actualizaci√≥n de sincronizaci√≥n
                    setTimeout(() => {
                        forceSyncAll();
                    }, 1000);
                } else {
                    showNotification('Error en la limpieza: ' + result.error, 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showNotification('Error de conexi√≥n durante la limpieza', 'error');
            }
        }

        // Clear ALL requests (emergency function)
        async function clearAllRequests() {
            if (!confirm(`üö® ¬øEST√ÅS COMPLETAMENTE SEGURO?\n\nEsto eliminar√° TODAS las solicitudes de etiquetas del sistema.\n\nEsta acci√≥n es IRREVERSIBLE.`)) {
                return;
            }

            if (!confirm(`üö® √öLTIMA CONFIRMACI√ìN üö®\n\n¬øRealmente quieres eliminar TODAS las solicitudes?\n\nEscribe "ELIMINAR TODO" en la siguiente ventana para confirmar.`)) {
                return;
            }

            const confirmation = prompt('Escribe exactamente "ELIMINAR TODO" para continuar:');
            if (confirmation !== 'ELIMINAR TODO') {
                showNotification('Operaci√≥n cancelada - confirmaci√≥n incorrecta', 'info');
                return;
            }

            try {
                showNotification('Eliminando TODAS las solicitudes...', 'info');
                
                const response = await fetch('/api/admin/solicitudes/clear-all', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                const result = await response.json();
                
                if (result.success) {
                    showNotification(`üóëÔ∏è Eliminaci√≥n masiva completada: ${result.deletedCount} solicitudes eliminadas`, 'success');
                    loadMaintenanceInfo(); // Refresh stats
                    loadRequestsStats(); // Refresh request stats
                } else {
                    showNotification('Error en eliminaci√≥n masiva: ' + result.error, 'error');
                }
            } catch (error) {
                console.error('Error executing cleanup:', error);
                showNotification('Error ejecutando la limpieza', 'error');
            }
        }

        // Analyze database
        async function analyzeDatabase() {
            try {
                showNotification('Analizando base de datos...', 'info');
                
                const response = await fetch('/api/mantenimiento/analyze', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                const result = await response.json();
                
                if (result.success) {
                    showNotification('An√°lisis completado', 'success');
                    loadDatabaseStats(); // Refresh stats
                } else {
                    showNotification('Error en el an√°lisis: ' + result.error, 'error');
                }
            } catch (error) {
                console.error('Error analyzing database:', error);
                showNotification('Error analizando la base de datos', 'error');
            }
        }

        // Optimize database
        async function optimizeDatabase() {
            if (!confirm('¬øConfirmas que quieres optimizar la base de datos?\n\nEsto puede tardar varios minutos.')) {
                return;
            }

            try {
                showNotification('Optimizando base de datos...', 'info');
                
                const response = await fetch('/api/mantenimiento/optimize', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                const result = await response.json();
                
                if (result.success) {
                    showNotification('Optimizaci√≥n completada exitosamente', 'success');
                    localStorage.setItem('lastOptimization', new Date().toISOString());
                    loadDatabaseStats(); // Refresh stats
                } else {
                    showNotification('Error en la optimizaci√≥n: ' + result.error, 'error');
                }
            } catch (error) {
                console.error('Error optimizing database:', error);
                showNotification('Error optimizando la base de datos', 'error');
            }
        }

        // Create backup
        async function createBackup() {
            if (!confirm('¬øConfirmas que quieres crear un respaldo?\n\nEsto puede tardar varios minutos.')) {
                return;
            }

            try {
                showNotification('Creando respaldo...', 'info');
                
                const response = await fetch('/api/mantenimiento/backup', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                const result = await response.json();
                
                if (result.success) {
                    showNotification('Respaldo creado exitosamente', 'success');
                    localStorage.setItem('lastBackup', new Date().toISOString());
                    localStorage.setItem('backupSize', result.backupSize || 'N/A');
                    loadBackupInfo(); // Refresh backup info
                } else {
                    showNotification('Error creando respaldo: ' + result.error, 'error');
                }
            } catch (error) {
                console.error('Error creating backup:', error);
                showNotification('Error creando respaldo', 'error');
            }
        }

        // Download backup
        function downloadBackup() {
            const lastBackup = localStorage.getItem('lastBackup');
            
            if (!lastBackup) {
                showNotification('No hay respaldo disponible para descargar', 'error');
                return;
            }

            // Create download link
            const link = document.createElement('a');
            link.href = '/api/mantenimiento/backup/download';
            link.download = `backup_${new Date().toISOString().split('T')[0]}.sql`;
            
            // Add authorization header if needed
            showNotification('Descargando respaldo...', 'info');
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Restore backup
        async function restoreBackup() {
            const fileInput = document.getElementById('backup-file');
            const file = fileInput.files[0];
            
            if (!file) {
                showNotification('Selecciona un archivo de respaldo', 'error');
                return;
            }

            if (!confirm('‚ö†Ô∏è ADVERTENCIA ‚ö†Ô∏è\n\nRestaurar un respaldo REEMPLAZAR√Å todos los datos actuales.\n\n¬øEst√°s ABSOLUTAMENTE seguro?')) {
                return;
            }

            try {
                showNotification('Restaurando respaldo...', 'info');
                
                const formData = new FormData();
                formData.append('backup', file);
                
                const response = await fetch('/api/mantenimiento/restore', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: formData
                });

                const result = await response.json();
                
                if (result.success) {
                    showNotification('Respaldo restaurado exitosamente', 'success');
                    setTimeout(() => {
                        location.reload(); // Reload to reflect changes
                    }, 2000);
                } else {
                    showNotification('Error restaurando respaldo: ' + result.error, 'error');
                }
            } catch (error) {
                console.error('Error restoring backup:', error);
                showNotification('Error restaurando respaldo', 'error');
            }
        }

        // Export data
        async function exportData() {
            const format = document.getElementById('export-format').value;
            const fromDate = document.getElementById('export-from').value;
            const toDate = document.getElementById('export-to').value;
            
            if (!fromDate || !toDate) {
                showNotification('Selecciona el rango de fechas para exportar', 'error');
                return;
            }

            try {
                showNotification('Exportando datos...', 'info');
                
                const response = await fetch('/api/mantenimiento/export', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({
                        format,
                        fromDate,
                        toDate
                    })
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    
                    link.href = url;
                    link.download = `export_${fromDate}_${toDate}.${format === 'excel' ? 'xlsx' : format}`;
                    
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    window.URL.revokeObjectURL(url);
                    showNotification('Datos exportados exitosamente', 'success');
                } else {
                    const error = await response.json();
                    showNotification('Error exportando datos: ' + error.error, 'error');
                }
            } catch (error) {
                console.error('Error exporting data:', error);
                showNotification('Error exportando datos', 'error');
            }
        }

        // Refresh system data
        async function refreshSystemData() {
            try {
                showNotification('Refrescando datos del sistema...', 'info');
                
                const response = await fetch('/api/admin/refresh-data', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                const result = await response.json();
                
                if (result.success) {
                    // Actualizar estad√≠sticas en la interfaz
                    document.getElementById('last-refresh').textContent = new Date().toLocaleString();
                    document.getElementById('cache-status').textContent = 'Limpio';
                    document.getElementById('cache-status').style.color = '#10b981';
                    
                    // Mostrar estad√≠sticas actuales
                    const refreshResult = document.getElementById('refresh-result');
                    refreshResult.innerHTML = `
                        <h4>üìä Datos actuales de PostgreSQL:</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-top: 0.5rem;">
                            <div class="stat-item">
                                <span class="stat-label">Total solicitudes:</span>
                                <span class="stat-value">${result.stats.total_solicitudes}</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Solicitudes hoy:</span>
                                <span class="stat-value">${result.stats.solicitudes_hoy}</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Productos activos:</span>
                                <span class="stat-value">${result.stats.productos_activos}</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Usuarios activos:</span>
                                <span class="stat-value">${result.stats.usuarios_activos}</span>
                            </div>
                        </div>
                        <p style="margin-top: 1rem; font-size: 0.875rem; color: var(--text-secondary);">
                            Rango de fechas: ${result.stats.fecha_solicitud_mas_antigua || 'N/A'} a ${result.stats.fecha_solicitud_mas_reciente || 'N/A'}
                        </p>
                    `;
                    refreshResult.style.display = 'block';
                    
                    showNotification('‚úÖ Datos refrescados exitosamente', 'success');
                    
                    // Recargar todas las secciones
                    loadSolicitudes();
                    loadUsers();
                    loadProducts();
                    loadRequestsStats();
                    
                } else {
                    showNotification('Error refrescando datos: ' + result.error, 'error');
                }
            } catch (error) {
                console.error('Error refreshing data:', error);
                showNotification('Error de conexi√≥n al refrescar datos', 'error');
            }
        }

        // Clear all cache
        async function clearAllCache() {
            if (!confirm('¬øLimpiar todo el cache del sistema?\n\nEsto forzar√° la recarga de todos los datos desde PostgreSQL.')) {
                return;
            }

            try {
                showNotification('Limpiando cache...', 'info');
                
                // Limpiar cache local del navegador
                if (localStorage) {
                    localStorage.removeItem('products_cache');
                    localStorage.removeItem('users_cache');
                    localStorage.removeItem('solicitudes_cache');
                }

                // Actualizar estado en la interfaz
                document.getElementById('cache-status').textContent = 'Limpio';
                document.getElementById('cache-status').style.color = '#10b981';
                document.getElementById('last-refresh').textContent = new Date().toLocaleString();
                
                showNotification('‚úÖ Cache limpiado exitosamente', 'success');
                
                // Refrescar datos autom√°ticamente
                refreshSystemData();
                
            } catch (error) {
                console.error('Error clearing cache:', error);
                showNotification('Error limpiando cache', 'error');
            }
        }

        // Diagnosticar restauraci√≥n autom√°tica de datos
        async function diagnosticarRestauracion() {
            try {
                showNotification('Ejecutando diagn√≥stico de auto-restauraci√≥n...', 'info');
                
                const response = await fetch('/api/admin/diagnostico-datos', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                const result = await response.json();
                
                if (result.success) {
                    const refreshResult = document.getElementById('refresh-result');
                    const diagnostico = result.diagnostico;
                    
                    refreshResult.innerHTML = `
                        <h4>üîç Diagn√≥stico de Auto-Restauraci√≥n de Datos</h4>
                        
                        <div style="margin: 1rem 0;">
                            <h5 style="color: ${result.resumen_warnings.length > 0 ? '#ef4444' : '#10b981'}">
                                ${result.resumen_warnings.length > 0 ? '‚ö†Ô∏è PROBLEMAS DETECTADOS' : '‚úÖ SIN PROBLEMAS DETECTADOS'}
                            </h5>
                            ${result.resumen_warnings.length > 0 ? 
                                '<ul style="color: #ef4444; margin: 0.5rem 0;">' + 
                                result.resumen_warnings.map(w => `<li>${w}</li>`).join('') + 
                                '</ul>' : 
                                '<p style="color: #10b981;">No se detectaron causas obvias de restauraci√≥n autom√°tica.</p>'
                            }
                        </div>

                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin: 1rem 0;">
                            <div class="stat-item">
                                <span class="stat-label">Triggers en BD:</span>
                                <span class="stat-value" style="color: ${diagnostico.triggers_bd.length > 0 ? '#ef4444' : '#10b981'}">
                                    ${diagnostico.triggers_bd.length}
                                </span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Funciones autom√°ticas:</span>
                                <span class="stat-value" style="color: ${diagnostico.funciones_automaticas.length > 0 ? '#ef4444' : '#10b981'}">
                                    ${diagnostico.funciones_automaticas.length}
                                </span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Conexiones activas:</span>
                                <span class="stat-value">${diagnostico.conexiones_activas.length}</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Timers activos:</span>
                                <span class="stat-value" style="color: ${diagnostico.proceso_node.active_timers > 5 ? '#ef4444' : '#10b981'}">
                                    ${diagnostico.proceso_node.active_timers}
                                </span>
                            </div>
                        </div>

                        <div style="margin-top: 1rem;">
                            <h5>üìä Estad√≠sticas de Tabla solicitudes_etiquetas:</h5>
                            <p style="font-size: 0.875rem; color: var(--text-secondary);">
                                Inserts: ${diagnostico.estadisticas_tabla?.inserts_total || 0} | 
                                Updates: ${diagnostico.estadisticas_tabla?.updates_total || 0} | 
                                Deletes: ${diagnostico.estadisticas_tabla?.deletes_total || 0}
                            </p>
                        </div>

                        <div style="margin-top: 1rem;">
                            <h5>üíæ Archivos de Backup:</h5>
                            <p style="font-size: 0.875rem; color: var(--text-secondary);">
                                ${diagnostico.archivos_backup.length > 0 ? 
                                    diagnostico.archivos_backup.map(b => 
                                        typeof b === 'string' ? b : 
                                        `${b.name} (${b.size_mb}MB) ${b.is_recent ? 'üî• RECIENTE' : ''}`
                                    ).join('<br>') : 
                                    'No hay archivos de backup'
                                }
                            </p>
                        </div>

                        <div style="margin-top: 1rem; padding: 1rem; background: ${result.resumen_warnings.length > 0 ? '#fef2f2' : '#f0fdf4'}; border-radius: 6px;">
                            <h5>üîß Soluci√≥n Sugerida:</h5>
                            <p style="margin: 0; font-size: 0.875rem;">
                                ${result.solucion_sugerida}
                            </p>
                        </div>
                    `;
                    refreshResult.style.display = 'block';
                    
                    if (result.resumen_warnings.length > 0) {
                        showNotification(`‚ö†Ô∏è Diagn√≥stico: ${result.resumen_warnings.length} problemas detectados`, 'warning');
                    } else {
                        showNotification('‚úÖ Diagn√≥stico completado - Sin problemas detectados', 'success');
                    }
                    
                } else {
                    showNotification('Error en diagn√≥stico: ' + result.error, 'error');
                }
            } catch (error) {
                console.error('Error ejecutando diagn√≥stico:', error);
                showNotification('Error de conexi√≥n en diagn√≥stico', 'error');
            }
        }

        // Deshabilitar auto-restauraci√≥n de datos
        async function deshabilitarAutoRestauracion() {
            if (!confirm('üõë ¬øDESHABILITAR procesos autom√°ticos de restauraci√≥n?\n\nEsto eliminar√°:\n- Triggers autom√°ticos\n- Cache del servidor\n- Timers activos\n\n¬øContinuar?')) {
                return;
            }

            if (!confirm('‚ö†Ô∏è CONFIRMACI√ìN FINAL\n\nEsta acci√≥n puede afectar el funcionamiento del sistema.\n\n¬øEst√°s completamente seguro?')) {
                return;
            }

            try {
                showNotification('Deshabilitando procesos autom√°ticos...', 'info');
                
                const response = await fetch('/api/admin/deshabilitar-auto-restauracion', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                const result = await response.json();
                
                if (result.success) {
                    const refreshResult = document.getElementById('refresh-result');
                    
                    refreshResult.innerHTML = `
                        <h4>üõë Procesos Autom√°ticos Deshabilitados</h4>
                        
                        <div style="margin: 1rem 0;">
                            <h5 style="color: #10b981;">‚úÖ DESHABILITACI√ìN COMPLETADA</h5>
                            <p style="color: #10b981;">Los procesos autom√°ticos de restauraci√≥n han sido deshabilitados.</p>
                        </div>

                        <div style="margin: 1rem 0;">
                            <h5>üîß Acciones Ejecutadas:</h5>
                            <ul style="font-size: 0.875rem; margin: 0.5rem 0;">
                                ${result.acciones_ejecutadas.map(accion => `<li>${accion}</li>`).join('')}
                            </ul>
                        </div>

                        <div style="margin: 1rem 0;">
                            <h5>üìã Recomendaciones:</h5>
                            <ul style="font-size: 0.875rem; margin: 0.5rem 0; color: var(--text-secondary);">
                                ${result.recomendaciones.map(rec => `<li>${rec}</li>`).join('')}
                            </ul>
                        </div>

                        <div style="margin-top: 1rem; padding: 1rem; background: #f0fdf4; border-radius: 6px;">
                            <h5>‚úÖ Pr√≥ximos Pasos:</h5>
                            <p style="margin: 0; font-size: 0.875rem;">
                                1. Reinicia el servidor<br>
                                2. Elimina datos de PostgreSQL<br>
                                3. Verifica que NO se restauren autom√°ticamente<br>
                                4. Si persiste el problema, buscar scripts externos
                            </p>
                        </div>
                    `;
                    refreshResult.style.display = 'block';
                    
                    showNotification('üõë Procesos autom√°ticos deshabilitados - ¬°Reinicia el servidor!', 'success');
                    
                } else {
                    showNotification('Error deshabilitando procesos: ' + result.error, 'error');
                }
            } catch (error) {
                console.error('Error deshabilitando auto-restauraci√≥n:', error);
                showNotification('Error de conexi√≥n al deshabilitar procesos', 'error');
            }
        }

        // Initialize maintenance info when the page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize chat if user is logged in
            if (localStorage.getItem('token')) {
                initializeChat();
            }
        });

        // === CHAT SYSTEM FUNCTIONS ===

        let currentChannel = null;
        let chatRefreshInterval = null;
        let lastMessageId = null;

        // Initialize chat system
        function initializeChat() {
            loadChatChannels();
            loadOnlineUsers();
            updateUserStatus();
            
            // Set up periodic updates
            chatRefreshInterval = setInterval(() => {
                if (currentChannel) {
                    loadChatMessages(true); // Silent refresh
                }
                loadOnlineUsers();
                updateNotificationBadge();
            }, 10000); // Update every 10 seconds

            // Handle status changes
            document.getElementById('status-selector').addEventListener('change', updateUserStatus);
            
            // Set current user name
            const userData = JSON.parse(localStorage.getItem('userData') || '{}');
            document.getElementById('current-user-name').textContent = userData.nombre_completo || 'Usuario';
        }

        // Load chat channels
        async function loadChatChannels() {
            try {
                const response = await fetch('/api/chat/canales', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                if (response.ok) {
                    const canales = await response.json();
                    displayChannels(canales);
                }
            } catch (error) {
                console.error('Error loading channels:', error);
            }
        }

        // Display channels in sidebar
        function displayChannels(canales) {
            const container = document.getElementById('channels-list');
            
            container.innerHTML = canales.map(canal => `
                <div class="channel-item" onclick="selectChannel(${canal.id_canal}, '${canal.nombre_canal}')" data-channel="${canal.id_canal}">
                    <div class="channel-name">
                        <span>${getChannelIcon(canal.tipo_canal)} ${canal.nombre_canal}</span>
                    </div>
                    ${canal.mensajes_no_leidos > 0 ? 
                        `<span class="notification-badge">${canal.mensajes_no_leidos}</span>` : 
                        ''
                    }
                </div>
            `).join('');
        }

        // Get icon for channel type
        function getChannelIcon(tipo) {
            switch (tipo) {
                case 'general': return 'üåê';
                case 'departamento': return 'üè¢';
                case 'privado': return 'üîí';
                default: return 'üí¨';
            }
        }

        // Select a channel
        function selectChannel(channelId, channelName) {
            // Remove active class from all channels
            document.querySelectorAll('.channel-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Add active class to selected channel
            document.querySelector(`[data-channel="${channelId}"]`).classList.add('active');
            
            currentChannel = channelId;
            document.getElementById('current-channel-name').textContent = channelName;
            document.getElementById('chat-input-container').style.display = 'block';
            
            loadChatMessages();
            markChannelAsRead(channelId);
        }

        // Load messages for current channel
        async function loadChatMessages(silent = false) {
            if (!currentChannel) return;
            
            try {
                const response = await fetch(`/api/chat/canales/${currentChannel}/mensajes?limit=50`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    displayMessages(data.mensajes, silent);
                }
            } catch (error) {
                if (!silent) {
                    console.error('Error loading messages:', error);
                }
            }
        }

        // Display messages in chat
        function displayMessages(mensajes, silent = false) {
            const container = document.getElementById('chat-messages');
            const currentUserId = JSON.parse(localStorage.getItem('userData') || '{}').id_usuario;
            
            if (mensajes.length === 0) {
                container.innerHTML = '<div class="welcome-message"><p>No hay mensajes en este canal. ¬°S√© el primero en escribir!</p></div>';
                return;
            }

            const shouldScrollToBottom = !silent || (container.scrollTop + container.clientHeight >= container.scrollHeight - 10);
            
            container.innerHTML = mensajes.map(mensaje => {
                const isOwn = mensaje.id_usuario === currentUserId;
                const messageClass = isOwn ? 'message own' : 
                                   mensaje.tipo_mensaje === 'sistema' ? 'message system' : 'message';
                
                return `
                    <div class="${messageClass}" data-message-id="${mensaje.id_mensaje}">
                        ${mensaje.tipo_mensaje !== 'sistema' ? `
                            <div class="message-header">
                                <span class="message-author">${mensaje.nombre_completo} ${mensaje.codigo_empleado ? `(${mensaje.codigo_empleado})` : ''}</span>
                                <span class="message-time">${formatMessageTime(mensaje.fecha_mensaje)}</span>
                            </div>
                        ` : ''}
                        <div class="message-content">${mensaje.mensaje}</div>
                    </div>
                `;
            }).join('');
            
            if (shouldScrollToBottom) {
                container.scrollTop = container.scrollHeight;
            }
            
            // Update last message ID
            if (mensajes.length > 0) {
                lastMessageId = mensajes[mensajes.length - 1].id_mensaje;
            }
        }

        // Format message timestamp
        function formatMessageTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diffInHours = (now - date) / (1000 * 60 * 60);
            
            if (diffInHours < 24) {
                return date.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
            } else if (diffInHours < 48) {
                return 'Ayer ' + date.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
            } else {
                return date.toLocaleDateString('es-ES', { month: 'short', day: 'numeric' }) + 
                       ' ' + date.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
            }
        }

        // Send message
        async function sendMessage() {
            if (!currentChannel) return;
            
            const input = document.getElementById('message-input');
            const message = input.value.trim();
            
            if (!message) return;
            
            try {
                const response = await fetch(`/api/chat/canales/${currentChannel}/mensajes`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({ mensaje: message })
                });

                if (response.ok) {
                    input.value = '';
                    loadChatMessages(); // Refresh messages
                } else {
                    showNotification('Error enviando mensaje', 'error');
                }
            } catch (error) {
                console.error('Error sending message:', error);
                showNotification('Error de conexi√≥n al enviar mensaje', 'error');
            }
        }

        // Handle keypress in message input
        function handleMessageKeypress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        // Load online users
        async function loadOnlineUsers() {
            try {
                const response = await fetch('/api/chat/usuarios-en-linea', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                if (response.ok) {
                    const usuarios = await response.json();
                    displayOnlineUsers(usuarios);
                }
            } catch (error) {
                console.error('Error loading online users:', error);
            }
        }

        // Display online users
        function displayOnlineUsers(usuarios) {
            const container = document.getElementById('online-users-list');
            const count = document.getElementById('online-count');
            
            count.textContent = usuarios.length;
            
            container.innerHTML = usuarios.map(usuario => `
                <div class="user-item">
                    <div class="channel-name">
                        <span class="status-indicator status-${getStatusClass(usuario.estado)}"></span>
                        <span>${usuario.nombre_completo}</span>
                    </div>
                    <small>${usuario.departamento}</small>
                </div>
            `).join('');
        }

        // Get status CSS class
        function getStatusClass(estado) {
            switch (estado) {
                case 'en_linea': return 'online';
                case 'ausente': return 'away';
                case 'ocupado': return 'busy';
                default: return 'offline';
            }
        }

        // Update user status
        async function updateUserStatus() {
            const statusSelector = document.getElementById('status-selector');
            const statusIndicator = document.getElementById('current-user-status');
            const estado = statusSelector.value;
            
            try {
                const response = await fetch('/api/chat/estado', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({ estado })
                });

                if (response.ok) {
                    statusIndicator.className = `status-indicator status-${getStatusClass(estado)}`;
                }
            } catch (error) {
                console.error('Error updating status:', error);
            }
        }

        // Update notification badge
        async function updateNotificationBadge() {
            try {
                // Obtener userId de m√∫ltiples fuentes
                const urlParams = new URLSearchParams(window.location.search);
                let userId = urlParams.get('user');
                
                // Si no est√° en URL, intentar desde localStorage
                if (!userId) {
                    const userData = JSON.parse(localStorage.getItem('userData') || '{}');
                    userId = userData.id_usuario;
                }
                
                // Si a√∫n no hay userId, intentar currentUser
                if (!userId) {
                    const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
                    userId = currentUser.id_usuario;
                }
                
                // Default a admin si no se encuentra
                if (!userId) {
                    userId = '1';
                }
                
                const response = await fetch(`/api/chat/no-leidos?userId=${userId}`);

                if (response.ok) {
                    const data = await response.json();
                    const totalNoLeidos = data.total || 0;
                    
                    const badge = document.getElementById('chat-badge');
                    if (totalNoLeidos > 0) {
                        badge.textContent = totalNoLeidos;
                        badge.style.display = 'inline';
                    } else {
                        badge.style.display = 'none';
                    }
                }
            } catch (error) {
                console.error('Error updating notification badge:', error);
            }
        }

        // Mark channel as read
        async function markChannelAsRead(channelId) {
            try {
                await fetch(`/api/chat/canales/${channelId}/marcar-leido`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });
                
                updateNotificationBadge();
                loadChatChannels(); // Refresh channel list to update badges
            } catch (error) {
                console.error('Error marking as read:', error);
            }
        }

        // Mark all messages as read
        function markAllAsRead() {
            if (currentChannel) {
                markChannelAsRead(currentChannel);
            }
        }

        // Clean up chat when leaving
        window.addEventListener('beforeunload', () => {
            if (chatRefreshInterval) {
                clearInterval(chatRefreshInterval);
            }
        });
    </script>

    <style>
        .badge {
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .badge-success {
            background: #dcfce7;
            color: #166534;
        }

        .badge-error {
            background: #fee2e2;
            color: #991b1b;
        }

        .badge-warning {
            background: #fef3c7;
            color: #92400e;
        }

        .badge-secondary {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .badge-administracion {
            background: #ddd6fe;
            color: #5b21b6;
        }

        .badge-supervisor {
            background: #bfdbfe;
            color: #1d4ed8;
        }

        .badge-costurera {
            background: #fed7d7;
            color: #c53030;
        }

        .badge-encargada_embalaje {
            background: #c6f6d5;
            color: #2d3748;
        }

        .badge-completada {
            background: #dcfce7;
            color: #166534;
        }

        .badge-proceso {
            background: #fef3c7;
            color: #92400e;
        }

        .badge-pendiente {
            background: #f1f5f9;
            color: #475569;
        }

        .badge-cancelada {
            background: #fee2e2;
            color: #991b1b;
        }

        .stats-filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            align-items: end;
        }

        .kpi-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            position: relative;
            overflow: hidden;
        }

        .kpi-card::after {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 80px;
            height: 80px;
            background: radial-gradient(circle, rgba(255,255,255,0.3) 0%, transparent 70%);
            border-radius: 50%;
            transform: translate(30px, -30px);
            transition: all 0.4s ease;
        }

        .kpi-card:hover {
            transform: translateY(-5px) scale(1.03);
            box-shadow: 0 15px 45px rgba(0, 0, 0, 0.15);
            border-color: rgba(255, 255, 255, 0.4);
        }

        .kpi-card:hover::after {
            transform: translate(10px, -10px) scale(1.2);
        }

        .chart-card {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .chart-card:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-lg);
        }

        .analysis-card {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .analysis-card:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-lg);
        }

        @media (max-width: 768px) {
            .charts-container {
                grid-template-columns: 1fr !important;
            }
            
            .stats-filter-grid {
                grid-template-columns: 1fr;
            }
            
            .kpi-dashboard {
                grid-template-columns: repeat(2, 1fr) !important;
            }
        }
    </style>

    <!-- Modal: Exportar Base de Datos -->
    <div id="export-database-modal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <button class="modal-close" onclick="closeModal('export-database-modal')">&times;</button>
            <div class="modal-header">
                <h3 class="modal-title">üóÑÔ∏è Exportar Base de Datos</h3>
            </div>
            
            <div class="form-group">
                <p style="margin-bottom: 1rem; color: var(--text-secondary);">
                    Selecciona las tablas que deseas exportar en formato SQL:
                </p>
                
                <label class="checkbox-label" style="display: block; margin-bottom: 0.5rem;">
                    <input type="checkbox" id="export-usuarios" checked>
                    <span>üë§ Usuarios</span>
                </label>
                <label class="checkbox-label" style="display: block; margin-bottom: 0.5rem;">
                    <input type="checkbox" id="export-productos" checked>
                    <span>üì¶ Productos</span>
                </label>
                <label class="checkbox-label" style="display: block; margin-bottom: 0.5rem;">
                    <input type="checkbox" id="export-solicitudes">
                    <span>üìã Solicitudes de Etiquetas</span>
                </label>
                <label class="checkbox-label" style="display: block; margin-bottom: 0.5rem;">
                    <input type="checkbox" id="export-historial">
                    <span>üìú Historial de Solicitudes</span>
                </label>
                <label class="checkbox-label" style="display: block; margin-bottom: 0.5rem;">
                    <input type="checkbox" id="export-cola">
                    <span>üñ®Ô∏è Cola de Impresi√≥n</span>
                </label>
                <label class="checkbox-label" style="display: block; margin-bottom: 0.5rem;">
                    <input type="checkbox" id="export-config">
                    <span>‚öôÔ∏è Configuraci√≥n del Sistema</span>
                </label>
            </div>
            
            <div class="modal-actions" style="display: flex; gap: 0.5rem; margin-top: 1.5rem;">
                <button type="button" class="btn btn-secondary" onclick="closeModal('export-database-modal')">
                    Cancelar
                </button>
                <button type="button" class="btn btn-success" onclick="exportDatabase()">
                    üì• Descargar SQL
                </button>
            </div>
        </div>
    </div>

    <!-- Modal: Exportar Excel -->
    <div id="export-excel-modal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <button class="modal-close" onclick="closeModal('export-excel-modal')">&times;</button>
            <div class="modal-header">
                <h3 class="modal-title">üìä Exportar a Excel</h3>
            </div>
            
            <div class="form-group">
                <p style="margin-bottom: 1rem; color: var(--text-secondary);">
                    Selecciona las tablas que deseas exportar a Excel:
                </p>
                
                <label class="checkbox-label" style="display: block; margin-bottom: 0.5rem;">
                    <input type="checkbox" id="excel-usuarios" checked>
                    <span>üë§ Usuarios</span>
                </label>
                <label class="checkbox-label" style="display: block; margin-bottom: 0.5rem;">
                    <input type="checkbox" id="excel-productos" checked>
                    <span>üì¶ Productos</span>
                </label>
                <label class="checkbox-label" style="display: block; margin-bottom: 0.5rem;">
                    <input type="checkbox" id="excel-solicitudes" checked>
                    <span>üìã Solicitudes de Etiquetas</span>
                </label>
            </div>
            
            <div class="modal-actions" style="display: flex; gap: 0.5rem; margin-top: 1.5rem;">
                <button type="button" class="btn btn-secondary" onclick="closeModal('export-excel-modal')">
                    Cancelar
                </button>
                <button type="button" class="btn btn-success" onclick="exportExcel()">
                    üì• Descargar Excel
                </button>
            </div>
        </div>
    </div>

    <!-- Modal: Exportar Informe Estad√≠stico -->
    <div id="export-report-modal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <button class="modal-close" onclick="closeModal('export-report-modal')">&times;</button>
            <div class="modal-header">
                <h3 class="modal-title">üìà Exportar Informe Estad√≠stico</h3>
            </div>
            
            <div class="form-group">
                <p style="margin-bottom: 1rem; color: var(--text-secondary);">
                    Selecciona el per√≠odo para generar el informe:
                </p>
                
                <label class="form-label">Fecha Inicio:</label>
                <input type="date" class="form-input" id="report-fecha-inicio" style="margin-bottom: 1rem;">
                
                <label class="form-label">Fecha Fin:</label>
                <input type="date" class="form-input" id="report-fecha-fin" style="margin-bottom: 1rem;">
                
                <p style="margin-top: 1.5rem; margin-bottom: 0.5rem; font-weight: 600;">El informe incluir√°:</p>
                <ul style="margin-left: 1.5rem; color: var(--text-secondary);">
                    <li>üìä Producci√≥n por costurera</li>
                    <li>üè∑Ô∏è Etiquetas generadas</li>
                    <li>üìã Solicitudes de etiquetas</li>
                    <li>üèÜ Productos m√°s confeccionados</li>
                    <li>üìâ Productos menos confeccionados</li>
                    <li>üìà Estad√≠stica de crecimiento semanal</li>
                </ul>
            </div>
            
            <div class="modal-actions" style="display: flex; gap: 0.5rem; margin-top: 1.5rem;">
                <button type="button" class="btn btn-secondary" onclick="closeModal('export-report-modal')">
                    Cancelar
                </button>
                <button type="button" class="btn btn-success" onclick="exportReport()">
                    üì• Generar Informe PDF
                </button>
            </div>
        </div>
    </div>

    <!-- Modal: Importar Base de Datos -->
    <div id="import-database-modal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <button class="modal-close" onclick="closeModal('import-database-modal')">&times;</button>
            <div class="modal-header">
                <h3 class="modal-title">üì• Importar Base de Datos</h3>
            </div>
            
            <div class="form-group">
                <p style="margin-bottom: 1rem; color: var(--text-secondary);">
                    Selecciona un archivo SQL para importar datos de otra instalaci√≥n:
                </p>
                
                <label class="form-label">Archivo SQL:</label>
                <input type="file" class="form-input" id="import-file" accept=".sql" style="margin-bottom: 1rem;">
                
                <label class="checkbox-label" style="display: block; margin-top: 1.5rem; padding: 1rem; background: var(--error-light); border-radius: var(--radius);">
                    <input type="checkbox" id="import-replace">
                    <span style="color: var(--error-color); font-weight: 600;">‚ö†Ô∏è Reemplazar datos actuales (Se borrar√°n todos los datos existentes)</span>
                </label>
                
                <p style="margin-top: 1rem; font-size: 0.875rem; color: var(--text-secondary);">
                    Si no marcas la opci√≥n, los datos se agregar√°n sin eliminar los existentes.
                </p>
            </div>
            
            <div class="modal-actions" style="display: flex; gap: 0.5rem; margin-top: 1.5rem;">
                <button type="button" class="btn btn-secondary" onclick="closeModal('import-database-modal')">
                    Cancelar
                </button>
                <button type="button" class="btn btn-success" onclick="importDatabase()">
                    üì§ Importar Datos
                </button>
            </div>
        </div>
    </div>

    <script>
        // Funciones para los modales de exportaci√≥n/importaci√≥n
        
        function showExportDatabaseModal() {
            document.getElementById('export-database-modal').classList.add('active');
        }
        
        function showExportExcelModal() {
            document.getElementById('export-excel-modal').classList.add('active');
        }
        
        function showExportReportModal() {
            // Establecer fechas por defecto
            const today = new Date();
            const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
            document.getElementById('report-fecha-inicio').valueAsDate = firstDay;
            document.getElementById('report-fecha-fin').valueAsDate = today;
            document.getElementById('export-report-modal').classList.add('active');
        }
        
        function showImportDatabaseModal() {
            document.getElementById('import-database-modal').classList.add('active');
        }
        
        async function exportDatabase() {
            const tables = [];
            if (document.getElementById('export-usuarios').checked) tables.push('usuarios');
            if (document.getElementById('export-productos').checked) tables.push('productos');
            if (document.getElementById('export-solicitudes').checked) tables.push('solicitudes_etiquetas');
            if (document.getElementById('export-historial').checked) tables.push('historial_solicitudes');
            if (document.getElementById('export-cola').checked) tables.push('cola_impresion');
            if (document.getElementById('export-config').checked) tables.push('configuracion_sistema');
            
            if (tables.length === 0) {
                showNotification('Selecciona al menos una tabla para exportar', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/admin/export-database', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({ tables })
                });
                
                if (!response.ok) throw new Error('Error al exportar');
                
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `sistema_etiquetas_${new Date().toISOString().split('T')[0]}.sql`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                showNotification('Base de datos exportada exitosamente', 'success');
                closeModal('export-database-modal');
            } catch (error) {
                console.error('Error:', error);
                showNotification('Error al exportar base de datos', 'error');
            }
        }
        
        async function exportExcel() {
            const tables = [];
            if (document.getElementById('excel-usuarios').checked) tables.push('usuarios');
            if (document.getElementById('excel-productos').checked) tables.push('productos');
            if (document.getElementById('excel-solicitudes').checked) tables.push('solicitudes_etiquetas');
            
            if (tables.length === 0) {
                showNotification('Selecciona al menos una tabla para exportar', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/admin/export-excel', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({ tables })
                });
                
                if (!response.ok) throw new Error('Error al exportar');
                
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `sistema_etiquetas_${new Date().toISOString().split('T')[0]}.xlsx`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                showNotification('Excel exportado exitosamente', 'success');
                closeModal('export-excel-modal');
            } catch (error) {
                console.error('Error:', error);
                showNotification('Error al exportar Excel', 'error');
            }
        }
        
        async function exportReport() {
            const fechaInicio = document.getElementById('report-fecha-inicio').value;
            const fechaFin = document.getElementById('report-fecha-fin').value;
            
            if (!fechaInicio || !fechaFin) {
                showNotification('Selecciona el rango de fechas', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/admin/export-report', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({ fechaInicio, fechaFin })
                });
                
                if (!response.ok) throw new Error('Error al generar informe');
                
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `informe_${fechaInicio}_${fechaFin}.pdf`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                showNotification('Informe generado exitosamente', 'success');
                closeModal('export-report-modal');
            } catch (error) {
                console.error('Error:', error);
                showNotification('Error al generar informe', 'error');
            }
        }
        
        async function importDatabase() {
            const fileInput = document.getElementById('import-file');
            const replace = document.getElementById('import-replace').checked;
            
            if (!fileInput.files || fileInput.files.length === 0) {
                showNotification('Selecciona un archivo SQL para importar', 'error');
                return;
            }
            
            const file = fileInput.files[0];
            const formData = new FormData();
            formData.append('sqlFile', file);
            formData.append('replace', replace);
            
            try {
                const response = await fetch('/api/admin/import-database', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: formData
                });
                
                const data = await response.json();
                
                if (!response.ok) throw new Error(data.error || 'Error al importar');
                
                showNotification(`Datos importados exitosamente: ${data.message}`, 'success');
                closeModal('import-database-modal');
                
                // Recargar datos
                setTimeout(() => location.reload(), 2000);
            } catch (error) {
                console.error('Error:', error);
                showNotification('Error al importar base de datos: ' + error.message, 'error');
            }
        }

        // =============================================
        // FUNCIONES PARA PRODUCTOS ESPECIALES
        // =============================================

        let productosEspecialesData = [];

        async function loadProductosEspeciales() {
            try {
                const response = await fetch('/api/productos-especiales', {
                    headers: getAuthHeaders()
                });

                if (!response.ok) throw new Error('Error al cargar productos especiales');

                productosEspecialesData = await response.json();
                renderProductosEspeciales(productosEspecialesData);
                updateStatsProductosEspeciales(productosEspecialesData);

            } catch (error) {
                console.error('Error:', error);
                document.getElementById('productos-especiales-table-body').innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 3rem; color: var(--error-color);">
                            <p style="font-size: 1.2rem; margin-bottom: 0.5rem;">‚ùå Error</p>
                            <p>${error.message}</p>
                        </td>
                    </tr>
                `;
            }
        }

        function renderProductosEspeciales(productos) {
            const tbody = document.getElementById('productos-especiales-table-body');

            if (productos.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 3rem; color: var(--text-secondary);">
                            <p style="font-size: 1.2rem; margin-bottom: 0.5rem;">üì¶ Sin productos especiales</p>
                            <p>No hay productos especiales registrados</p>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = productos.map(prod => {
                const componentes = [];
                if (prod.nombre_producto_1) componentes.push(prod.nombre_producto_1);
                if (prod.nombre_producto_2) componentes.push(prod.nombre_producto_2);
                if (prod.nombre_producto_3) componentes.push(prod.nombre_producto_3);
                if (prod.nombre_producto_4) componentes.push(prod.nombre_producto_4);

                const componentesHTML = componentes.length > 0 
                    ? `<div style="display: flex; flex-direction: column; gap: 4px;">${componentes.map(c => 
                        `<span style="background: #f3f4f6; padding: 4px 8px; border-radius: 6px; font-size: 0.75rem;">${c}</span>`
                    ).join('')}</div>`
                    : '<span style="color: var(--text-secondary);">Sin componentes</span>';

                const estadoBadge = prod.activo
                    ? '<span class="status-badge status-active">‚úÖ Activo</span>'
                    : '<span class="status-badge status-inactive">‚ùå Inactivo</span>';

                return `
                    <tr data-nombre="${prod.nombre_producto_especial}" data-codigo="${prod.codigo_producto_especial}" data-estado="${prod.activo ? 'activo' : 'inactivo'}">
                        <td>${prod.id_producto_especial}</td>
                        <td style="font-family: 'Courier New', monospace; font-weight: 600;">${prod.codigo_producto_especial}</td>
                        <td style="font-weight: 500;">${prod.nombre_producto_especial}</td>
                        <td>${componentesHTML}</td>
                        <td><span style="background: #fef3c7; color: #92400e; padding: 4px 10px; border-radius: 12px; font-size: 0.75rem; font-weight: 600;">${prod.tipo_combo || 'COMBO'}</span></td>
                        <td>${estadoBadge}</td>
                        <td style="font-size: 0.875rem; color: var(--text-secondary);">${new Date(prod.created_at).toLocaleString()}</td>
                        <td>
                            <div style="display: flex; gap: 0.5rem; justify-content: center;">
                                <button class="btn-action btn-view" onclick="viewProductoEspecial(${prod.id_producto_especial})" title="Ver detalle">
                                    üëÅÔ∏è
                                </button>
                                <button class="btn-action btn-edit" onclick="editProductoEspecial(${prod.id_producto_especial})" title="Editar">
                                    ‚úèÔ∏è
                                </button>
                                <button class="btn-action ${prod.activo ? 'btn-delete' : 'btn-success'}" 
                                        onclick="toggleProductoEspecialEstado(${prod.id_producto_especial}, ${!prod.activo})" 
                                        title="${prod.activo ? 'Desactivar' : 'Activar'}">
                                    ${prod.activo ? 'üîí' : 'üîì'}
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function updateStatsProductosEspeciales(productos) {
            const total = productos.length;
            const activos = productos.filter(p => p.activo).length;
            const inactivos = productos.filter(p => !p.activo).length;
            
            let totalComponentes = 0;
            productos.forEach(p => {
                if (p.id_producto_1) totalComponentes++;
                if (p.id_producto_2) totalComponentes++;
                if (p.id_producto_3) totalComponentes++;
                if (p.id_producto_4) totalComponentes++;
            });

            document.getElementById('stat-total-especiales').textContent = total;
            document.getElementById('stat-especiales-activos').textContent = activos;
            document.getElementById('stat-especiales-inactivos').textContent = inactivos;
            document.getElementById('stat-especiales-componentes').textContent = totalComponentes;
        }

        function searchProductosEspeciales(query) {
            const filtered = productosEspecialesData.filter(p => 
                p.nombre_producto_especial.toLowerCase().includes(query.toLowerCase()) ||
                p.codigo_producto_especial.toLowerCase().includes(query.toLowerCase())
            );
            renderProductosEspeciales(filtered);
        }

        function filterProductosEspecialesByEstado(estado) {
            if (!estado) {
                renderProductosEspeciales(productosEspecialesData);
                return;
            }
            const filtered = productosEspecialesData.filter(p => 
                (estado === 'activo' && p.activo) || (estado === 'inactivo' && !p.activo)
            );
            renderProductosEspeciales(filtered);
        }

        function refreshProductosEspeciales() {
            showNotification('üîÑ Actualizando productos especiales...', 'info');
            loadProductosEspeciales();
        }

        function exportProductosEspeciales() {
            showNotification('üì• Funci√≥n de exportaci√≥n en desarrollo', 'info');
        }

        async function viewProductoEspecial(id) {
            const prod = productosEspecialesData.find(p => p.id_producto_especial === id);
            if (!prod) return;

            const componentes = [];
            if (prod.nombre_producto_1) componentes.push(`‚Ä¢ ${prod.nombre_producto_1} (Cantidad: ${prod.cantidad_producto_1})`);
            if (prod.nombre_producto_2) componentes.push(`‚Ä¢ ${prod.nombre_producto_2} (Cantidad: ${prod.cantidad_producto_2})`);
            if (prod.nombre_producto_3) componentes.push(`‚Ä¢ ${prod.nombre_producto_3} (Cantidad: ${prod.cantidad_producto_3})`);
            if (prod.nombre_producto_4) componentes.push(`‚Ä¢ ${prod.nombre_producto_4} (Cantidad: ${prod.cantidad_producto_4})`);

            alert(`
üéÅ PRODUCTO ESPECIAL - DETALLE

ID: ${prod.id_producto_especial}
C√≥digo: ${prod.codigo_producto_especial}
Nombre: ${prod.nombre_producto_especial}
Tipo: ${prod.tipo_combo || 'COMBO'}
Estado: ${prod.activo ? '‚úÖ Activo' : '‚ùå Inactivo'}
Creado: ${new Date(prod.created_at).toLocaleString()}

COMPONENTES:
${componentes.join('\n')}
            `.trim());
        }

        function editProductoEspecial(id) {
            showNotification('‚úèÔ∏è Funci√≥n de edici√≥n en desarrollo', 'info');
        }

        async function toggleProductoEspecialEstado(id, nuevoEstado) {
            if (!confirm(`¬øEst√° seguro de ${nuevoEstado ? 'ACTIVAR' : 'DESACTIVAR'} este producto especial?`)) {
                return;
            }

            try {
                const response = await fetch(`/api/productos-especiales/${id}`, {
                    method: 'PUT',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({ activo: nuevoEstado })
                });

                if (!response.ok) throw new Error('Error al cambiar estado');

                showNotification(`‚úÖ Producto ${nuevoEstado ? 'activado' : 'desactivado'} exitosamente`, 'success');
                await loadProductosEspeciales();

            } catch (error) {
                console.error('Error:', error);
                showNotification('‚ùå Error al cambiar estado: ' + error.message, 'error');
            }
        }

        // =============================================
        // FUNCIONES PARA SOLICITUDES ESPECIALES
        // =============================================

        let solicitudesEspecialesData = [];

        async function loadSolicitudesEspeciales() {
            try {
                const response = await fetch('/api/solicitudes-etiquetas-especiales', {
                    headers: getAuthHeaders()
                });

                if (!response.ok) throw new Error('Error al cargar solicitudes especiales');

                solicitudesEspecialesData = await response.json();
                renderSolicitudesEspeciales(solicitudesEspecialesData);
                updateStatsSolicitudesEspeciales(solicitudesEspecialesData);

            } catch (error) {
                console.error('Error:', error);
                document.getElementById('solicitudes-especiales-table-body').innerHTML = `
                    <tr>
                        <td colspan="11" style="text-align: center; padding: 3rem; color: var(--error-color);">
                            <p style="font-size: 1.2rem; margin-bottom: 0.5rem;">‚ùå Error</p>
                            <p>${error.message}</p>
                        </td>
                    </tr>
                `;
            }
        }

        function renderSolicitudesEspeciales(solicitudes) {
            const tbody = document.getElementById('solicitudes-especiales-table-body');

            if (solicitudes.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="11" style="text-align: center; padding: 3rem; color: var(--text-secondary);">
                            <p style="font-size: 1.2rem; margin-bottom: 0.5rem;">üìã Sin solicitudes especiales</p>
                            <p>No hay solicitudes especiales registradas</p>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = solicitudes.map(sol => {
                const estadoBadge = getEstadoBadgeSolicitud(sol.estado_solicitud);
                const prioridadBadge = getPrioridadBadge(sol.prioridad);

                return `
                    <tr data-producto="${sol.nombre_producto_especial?.toLowerCase() || ''}" 
                        data-costurera="${sol.nombre_costurera?.toLowerCase() || ''}"
                        data-estado="${sol.estado_solicitud}">
                        <td style="font-weight: 600;">#${sol.id_solicitud}</td>
                        <td style="font-weight: 500;">${sol.nombre_producto_especial || 'N/A'}</td>
                        <td style="font-family: 'Courier New', monospace; font-size: 0.875rem;">${sol.codigo_producto_especial || 'N/A'}</td>
                        <td>${sol.nombre_costurera || 'N/A'}</td>
                        <td style="text-align: center; font-weight: 600; color: var(--primary-color);">${sol.cantidad_solicitada}</td>
                        <td style="text-align: center;">
                            <div style="background: #f3f4f6; padding: 6px 12px; border-radius: 8px; font-size: 0.75rem;">
                                0/${sol.cantidad_solicitada}
                            </div>
                        </td>
                        <td style="text-align: center;">${estadoBadge}</td>
                        <td style="text-align: center;">${prioridadBadge}</td>
                        <td style="font-size: 0.875rem; color: var(--text-secondary);">${new Date(sol.fecha_solicitud).toLocaleString()}</td>
                        <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; font-size: 0.875rem;">${sol.observaciones || '-'}</td>
                        <td>
                            <div style="display: flex; gap: 0.5rem; justify-content: center;">
                                <button class="btn-action btn-view" onclick="viewSolicitudEspecial(${sol.id_solicitud})" title="Ver detalle">
                                    üëÅÔ∏è
                                </button>
                                ${sol.estado_solicitud === 'pendiente' ? `
                                    <button class="btn-action btn-success" onclick="aprobarSolicitudEspecial(${sol.id_solicitud})" title="Aprobar">
                                        ‚úÖ
                                    </button>
                                ` : ''}
                                ${sol.estado_solicitud !== 'completada' ? `
                                    <button class="btn-action btn-delete" onclick="eliminarSolicitudEspecial(${sol.id_solicitud})" title="Eliminar">
                                        üóëÔ∏è
                                    </button>
                                ` : ''}
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function updateStatsSolicitudesEspeciales(solicitudes) {
            const total = solicitudes.length;
            const pendientes = solicitudes.filter(s => s.estado_solicitud === 'pendiente').length;
            const proceso = solicitudes.filter(s => s.estado_solicitud === 'proceso').length;
            const completadas = solicitudes.filter(s => s.estado_solicitud === 'completada').length;
            const canceladas = solicitudes.filter(s => s.estado_solicitud === 'cancelada').length;
            const etiquetas = solicitudes.reduce((sum, s) => sum + parseInt(s.cantidad_solicitada || 0), 0);

            document.getElementById('stat-total-sol-especiales').textContent = total;
            document.getElementById('stat-sol-esp-pendientes').textContent = pendientes;
            document.getElementById('stat-sol-esp-proceso').textContent = proceso;
            document.getElementById('stat-sol-esp-completadas').textContent = completadas;
            document.getElementById('stat-sol-esp-canceladas').textContent = canceladas;
            document.getElementById('stat-sol-esp-etiquetas').textContent = etiquetas;
        }

        function getEstadoBadgeSolicitud(estado) {
            const badges = {
                'pendiente': '<span class="status-badge" style="background: #fef3c7; color: #92400e;">‚è≥ Pendiente</span>',
                'proceso': '<span class="status-badge" style="background: #dbeafe; color: #1e40af;">üîÑ En Proceso</span>',
                'completada': '<span class="status-badge status-active">‚úÖ Completada</span>',
                'cancelada': '<span class="status-badge status-inactive">‚ùå Cancelada</span>'
            };
            return badges[estado] || estado;
        }

        function getPrioridadBadge(prioridad) {
            const badges = {
                'alta': '<span style="background: #fee2e2; color: #991b1b; padding: 4px 10px; border-radius: 12px; font-size: 0.75rem; font-weight: 600;">üî¥ Alta</span>',
                'media': '<span style="background: #fef3c7; color: #92400e; padding: 4px 10px; border-radius: 12px; font-size: 0.75rem; font-weight: 600;">üü° Media</span>',
                'baja': '<span style="background: #d1fae5; color: #065f46; padding: 4px 10px; border-radius: 12px; font-size: 0.75rem; font-weight: 600;">üü¢ Baja</span>'
            };
            return badges[prioridad] || badges['media'];
        }

        function searchSolicitudesEspeciales(query) {
            const filtered = solicitudesEspecialesData.filter(s => 
                s.nombre_producto_especial?.toLowerCase().includes(query.toLowerCase()) ||
                s.nombre_costurera?.toLowerCase().includes(query.toLowerCase())
            );
            renderSolicitudesEspeciales(filtered);
        }

        function filterSolicitudesEspecialesByEstado(estado) {
            if (!estado) {
                renderSolicitudesEspeciales(solicitudesEspecialesData);
                return;
            }
            const filtered = solicitudesEspecialesData.filter(s => s.estado_solicitud === estado);
            renderSolicitudesEspeciales(filtered);
        }

        function applyDateFilterSolicitudesEspeciales() {
            const desde = document.getElementById('filter-fecha-desde').value;
            const hasta = document.getElementById('filter-fecha-hasta').value;

            if (!desde || !hasta) {
                showNotification('‚ö†Ô∏è Seleccione ambas fechas', 'warning');
                return;
            }

            const filtered = solicitudesEspecialesData.filter(s => {
                const fecha = new Date(s.fecha_solicitud).toISOString().split('T')[0];
                return fecha >= desde && fecha <= hasta;
            });

            renderSolicitudesEspeciales(filtered);
            showNotification(`üìÖ Filtrado: ${filtered.length} solicitudes entre ${desde} y ${hasta}`, 'info');
        }

        function refreshSolicitudesEspeciales() {
            showNotification('üîÑ Actualizando solicitudes especiales...', 'info');
            loadSolicitudesEspeciales();
        }

        function exportSolicitudesEspeciales() {
            showNotification('üì• Funci√≥n de exportaci√≥n en desarrollo', 'info');
        }

        async function viewSolicitudEspecial(id) {
            const sol = solicitudesEspecialesData.find(s => s.id_solicitud === id);
            if (!sol) return;

            alert(`
‚≠ê SOLICITUD ESPECIAL - DETALLE

ID: #${sol.id_solicitud}
Producto: ${sol.nombre_producto_especial || 'N/A'}
C√≥digo: ${sol.codigo_producto_especial || 'N/A'}
Costurera: ${sol.nombre_costurera || 'N/A'}
Cantidad: ${sol.cantidad_solicitada}
Estado: ${sol.estado_solicitud}
Prioridad: ${sol.prioridad || 'media'}
Fecha: ${new Date(sol.fecha_solicitud).toLocaleString()}
${sol.observaciones ? `\nObservaciones: ${sol.observaciones}` : ''}
${sol.observaciones_supervisor ? `\nObservaciones Supervisor: ${sol.observaciones_supervisor}` : ''}
            `.trim());
        }

        async function aprobarSolicitudEspecial(id) {
            if (!confirm('¬øAprobar esta solicitud especial?')) return;

            try {
                const response = await fetch(`/api/supervisor/cambiar-estado/${id}`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({
                        nuevo_estado: 'proceso',
                        observaciones_supervisor: 'Aprobado desde panel administrativo'
                    })
                });

                if (!response.ok) throw new Error('Error al aprobar');

                showNotification('‚úÖ Solicitud aprobada exitosamente', 'success');
                await loadSolicitudesEspeciales();

            } catch (error) {
                console.error('Error:', error);
                showNotification('‚ùå Error al aprobar: ' + error.message, 'error');
            }
        }

        async function eliminarSolicitudEspecial(id) {
            if (!confirm('¬øEst√° seguro de ELIMINAR permanentemente esta solicitud especial? Esta acci√≥n no se puede deshacer.')) return;

            try {
                const response = await fetch(`/api/solicitudes-etiquetas/${id}`, {
                    method: 'DELETE',
                    headers: getAuthHeaders()
                });

                if (!response.ok) throw new Error('Error al eliminar');

                showNotification('‚úÖ Solicitud eliminada exitosamente', 'success');
                await loadSolicitudesEspeciales();

            } catch (error) {
                console.error('Error:', error);
                showNotification('‚ùå Error al eliminar: ' + error.message, 'error');
            }
        }

    </script>
</body>
</html>