<!-- ========================================== -->
<!-- COMPONENTE: BIT√ÅCORA DE PRODUCCI√ìN -->
<!-- ========================================== -->

<style>
/* Secci√≥n de bit√°cora */
.seccion-bitacora {
    background: white;
    border-radius: 12px;
    padding: 30px;
    margin: 20px 0;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.bitacora-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 24px;
    flex-wrap: wrap;
    gap: 16px;
}

.bitacora-header h2 {
    color: #1e293b;
    font-size: 24px;
    display: flex;
    align-items: center;
    gap: 12px;
}

.btn-nueva-entrada {
    padding: 12px 24px;
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s ease;
}

.btn-nueva-entrada:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
}

/* Filtros de bit√°cora */
.bitacora-filtros {
    background: #f8fafc;
    padding: 20px;
    border-radius: 8px;
    margin-bottom: 24px;
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
}

.filtro-grupo {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.filtro-grupo label {
    font-size: 14px;
    font-weight: 600;
    color: #64748b;
}

.filtro-grupo input,
.filtro-grupo select {
    padding: 10px;
    border: 2px solid #e2e8f0;
    border-radius: 6px;
    font-size: 14px;
    transition: border-color 0.2s;
}

.filtro-grupo input:focus,
.filtro-grupo select:focus {
    outline: none;
    border-color: #667eea;
}

.btn-aplicar-filtros {
    padding: 10px 20px;
    background: #667eea;
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    align-self: flex-end;
}

.btn-aplicar-filtros:hover {
    background: #5568d3;
}

/* Tabla de bit√°cora */
.tabla-bitacora {
    width: 100%;
    border-collapse: collapse;
    overflow-x: auto;
    display: block;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    border-radius: 12px;
}

.tabla-bitacora thead {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    box-shadow: 0 2px 4px rgba(102, 126, 234, 0.3);
}

.tabla-bitacora th {
    padding: 16px 14px;
    text-align: left;
    border-bottom: none;
    font-weight: 700;
    text-transform: uppercase;
    font-size: 0.75rem;
    letter-spacing: 1px;
}

.tabla-bitacora td {
    padding: 14px;
    text-align: left;
    border-bottom: 1px solid #e2e8f0;
}

.tabla-bitacora tbody tr:nth-child(even) {
    background: #f8fafc;
}

.tabla-bitacora tbody tr:hover {
    background: #eef2ff;
    transform: scale(1.005);
    box-shadow: 0 2px 8px rgba(102, 126, 234, 0.15);
    transition: all 0.2s ease;
}

.estado-badge {
    padding: 8px 16px;
    border-radius: 24px;
    font-size: 13px;
    font-weight: 700;
    display: inline-flex;
    align-items: center;
    gap: 6px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.estado-activo {
    background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
    color: #065f46;
    border: 2px solid #34d399;
}

.estado-editado {
    background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
    color: #92400e;
    border: 2px solid #fbbf24;
}

.estado-anulado {
    background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
    color: #991b1b;
    border: 2px solid #f87171;
}

.acciones-bitacora {
    display: flex;
    gap: 8px;
    justify-content: center;
}

.btn-accion {
    padding: 8px 14px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 13px;
    font-weight: 600;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.btn-editar {
    background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
    color: white;
}

.btn-editar:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(251, 191, 36, 0.4);
}

.btn-anular {
    background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    color: white;
}

.btn-anular:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
}

/* Modal de Anular */
.modal-anular {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    z-index: 9999;
    backdrop-filter: blur(5px);
}

.modal-anular.active {
    display: flex;
    align-items: center;
    justify-content: center;
}

.modal-anular-contenido {
    background: white;
    border-radius: 16px;
    padding: 32px;
    max-width: 500px;
    width: 90%;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
}

.modal-anular-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 20px;
}

.modal-anular-header h3 {
    margin: 0;
    color: #1e293b;
    font-size: 22px;
}

.modal-anular-pregunta {
    font-size: 16px;
    color: #64748b;
    margin-bottom: 24px;
    line-height: 1.6;
}

.opciones-anular {
    display: flex;
    flex-direction: column;
    gap: 12px;
    margin-bottom: 24px;
}

.btn-opcion-anular {
    padding: 16px 20px;
    border: 2px solid #e2e8f0;
    border-radius: 12px;
    background: white;
    cursor: pointer;
    transition: all 0.2s;
    text-align: left;
    display: flex;
    align-items: center;
    gap: 12px;
}

.btn-opcion-anular:hover {
    border-color: #667eea;
    background: #f8fafc;
}

.btn-opcion-anular .icono {
    font-size: 24px;
}

.btn-opcion-anular .texto {
    flex: 1;
}

.btn-opcion-anular .titulo {
    font-weight: 600;
    color: #1e293b;
    margin-bottom: 4px;
}

.btn-opcion-anular .descripcion {
    font-size: 13px;
    color: #64748b;
}

.form-motivo {
    display: none;
    margin-top: 20px;
}

.form-motivo.active {
    display: block;
}

.form-motivo label {
    display: block;
    font-weight: 600;
    color: #1e293b;
    margin-bottom: 8px;
}

.form-motivo textarea {
    width: 100%;
    padding: 12px;
    border: 2px solid #e2e8f0;
    border-radius: 8px;
    font-size: 14px;
    min-height: 100px;
    resize: vertical;
}

.form-motivo textarea:focus {
    outline: none;
    border-color: #667eea;
}

.modal-acciones {
    display: flex;
    gap: 12px;
    justify-content: flex-end;
    margin-top: 20px;
}

.btn-cancelar-modal {
    padding: 12px 24px;
    background: #e2e8f0;
    color: #64748b;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
}

.btn-cancelar-modal:hover {
    background: #cbd5e1;
}

.btn-confirmar-modal {
    padding: 12px 24px;
    background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
}

.btn-confirmar-modal:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
}

/* Modal de Nueva Entrada / Editar */
.modal-bitacora-form {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    z-index: 9999;
    backdrop-filter: blur(5px);
}

.modal-bitacora-form.active {
    display: flex;
    align-items: center;
    justify-content: center;
}

.modal-form-contenido {
    background: white;
    border-radius: 16px;
    padding: 32px;
    max-width: 600px;
    width: 90%;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
}

.form-bitacora {
    display: flex;
    flex-direction: column;
    gap: 20px;
}

.form-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.form-group label {
    font-weight: 600;
    color: #1e293b;
}

.form-group input,
.form-group select,
.form-group textarea {
    padding: 12px;
    border: 2px solid #e2e8f0;
    border-radius: 8px;
    font-size: 14px;
}

.form-group input:focus,
.form-group select:focus,
.form-group textarea:focus {
    outline: none;
    border-color: #667eea;
}

/* Responsive */
@media (max-width: 768px) {
    .tabla-bitacora {
        font-size: 12px;
    }
    
    .tabla-bitacora th,
    .tabla-bitacora td {
        padding: 8px 4px;
    }
    
    .acciones-bitacora {
        flex-direction: column;
    }
    
    .bitacora-filtros {
        grid-template-columns: 1fr;
    }
}
</style>

<!-- Secci√≥n de Bit√°cora -->
<div class="seccion-bitacora">
    <div class="bitacora-header">
        <h2>
            üìã Bit√°cora de Producci√≥n
        </h2>
        <button class="btn-nueva-entrada" onclick="abrirModalNuevaEntrada()">
            ‚ûï Nueva Entrada
        </button>
    </div>
    
    <!-- Filtros -->
    <div class="bitacora-filtros">
        <div class="filtro-grupo">
            <label>Fecha Inicio</label>
            <input type="date" id="filtro-fecha-inicio" />
        </div>
        
        <div class="filtro-grupo">
            <label>Fecha Fin</label>
            <input type="date" id="filtro-fecha-fin" />
        </div>
        
        <div class="filtro-grupo">
            <label>Usuario</label>
            <select id="filtro-usuario">
                <option value="">Todos</option>
            </select>
        </div>
        
        <div class="filtro-grupo">
            <label>Producto</label>
            <select id="filtro-producto">
                <option value="">Todos</option>
            </select>
        </div>
        
        <div class="filtro-grupo">
            <label>Estado</label>
            <select id="filtro-estado">
                <option value="">Todos</option>
                <option value="ACTIVO">Activo</option>
                <option value="EDITADO">Editado</option>
                <option value="ANULADO">Anulado</option>
            </select>
        </div>
        
        <div class="filtro-grupo">
            <button class="btn-aplicar-filtros" onclick="cargarBitacora()">
                üîç Aplicar Filtros
            </button>
        </div>
    </div>
    
    <!-- Tabla de registros -->
    <div style="overflow-x: auto;">
        <table class="tabla-bitacora">
            <thead>
                <tr>
                    <th>Fecha</th>
                    <th>Usuario</th>
                    <th>Producto</th>
                    <th>Cantidad</th>
                    <th>Estado</th>
                    <th>Modificado por</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody id="tabla-bitacora-body">
                <tr>
                    <td colspan="7" style="text-align: center; padding: 40px;">
                        Cargando registros...
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- Modal: Anular Registro -->
<div class="modal-anular" id="modal-anular-bitacora">
    <div class="modal-anular-contenido">
        <div class="modal-anular-header">
            <span style="font-size: 32px;">‚ö†Ô∏è</span>
            <h3>Anular Registro</h3>
        </div>
        
        <p class="modal-anular-pregunta">
            ¬øQu√© deseas hacer con este registro de producci√≥n?
        </p>
        
        <div class="opciones-anular">
            <button class="btn-opcion-anular" onclick="seleccionarOpcionAnular('editar')">
                <span class="icono">‚úèÔ∏è</span>
                <div class="texto">
                    <div class="titulo">Editar y Corregir</div>
                    <div class="descripcion">Modificar la cantidad o producto y registrar el motivo</div>
                </div>
            </button>
            
            <button class="btn-opcion-anular" onclick="seleccionarOpcionAnular('anular')">
                <span class="icono">üö´</span>
                <div class="texto">
                    <div class="titulo">Solo Anular</div>
                    <div class="descripcion">Cancelar el registro completamente sin modificar</div>
                </div>
            </button>
        </div>
        
        <div class="form-motivo" id="form-motivo-anular">
            <label>Motivo de la anulaci√≥n/correcci√≥n *</label>
            <textarea 
                id="textarea-motivo-anular" 
                placeholder="Describe el motivo..."
                required
            ></textarea>
        </div>
        
        <div class="modal-acciones">
            <button class="btn-cancelar-modal" onclick="cerrarModalAnular()">
                Cancelar
            </button>
            <button class="btn-confirmar-modal" id="btn-confirmar-anular" onclick="confirmarAnulacion()" style="display: none;">
                Confirmar
            </button>
        </div>
    </div>
</div>

<!-- Modal: Nueva Entrada / Editar -->
<div class="modal-bitacora-form" id="modal-form-bitacora">
    <div class="modal-form-contenido">
        <div class="modal-anular-header">
            <span style="font-size: 32px;">üìù</span>
            <h3 id="titulo-modal-form">Nueva Entrada en Bit√°cora</h3>
        </div>
        
        <form class="form-bitacora" onsubmit="guardarEntradaBitacora(event)">
            <input type="hidden" id="form-bitacora-id" />
            <input type="hidden" id="form-bitacora-modo" value="crear" />
            
            <div class="form-group">
                <label>Producto *</label>
                <select id="form-bitacora-producto" required>
                    <option value="">Seleccionar producto...</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>Cantidad *</label>
                <input 
                    type="number" 
                    id="form-bitacora-cantidad" 
                    min="1" 
                    required 
                    placeholder="Cantidad producida"
                />
            </div>
            
            <div class="form-group" id="grupo-observaciones" style="display: none;">
                <label>Motivo de la correcci√≥n *</label>
                <textarea 
                    id="form-bitacora-observaciones" 
                    placeholder="Describe el motivo del cambio..."
                ></textarea>
            </div>
            
            <div class="modal-acciones">
                <button type="button" class="btn-cancelar-modal" onclick="cerrarModalFormBitacora()">
                    Cancelar
                </button>
                <button type="submit" class="btn-confirmar-modal" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                    Guardar
                </button>
            </div>
        </form>
    </div>
</div>

<script>
let registroAnularActual = null;
let opcionAnularSeleccionada = null;

// Funci√≥n auxiliar para obtener userId
function getUserId() {
    // 1. Intentar desde URL
    const urlParams = new URLSearchParams(window.location.search);
    let userId = urlParams.get('user');
    
    // 2. Intentar desde localStorage userData
    if (!userId) {
        const userData = JSON.parse(localStorage.getItem('userData') || '{}');
        userId = userData.id_usuario || userData.id;
    }
    
    // 3. Intentar desde localStorage currentUser
    if (!userId) {
        const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
        userId = currentUser.id_usuario || currentUser.id;
    }
    
    return userId;
}

// ========================================
// CARGAR BIT√ÅCORA
// ========================================
async function cargarBitacora() {
    const tbody = document.getElementById('tabla-bitacora-body');
    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px;">Cargando...</td></tr>';
    
    try {
        const userId = getUserId();
        
        // Construir URL con filtros
        const params = new URLSearchParams();
        
        const fechaInicio = document.getElementById('filtro-fecha-inicio')?.value;
        const fechaFin = document.getElementById('filtro-fecha-fin')?.value;
        const usuario = document.getElementById('filtro-usuario')?.value;
        const producto = document.getElementById('filtro-producto')?.value;
        const estado = document.getElementById('filtro-estado')?.value;
        
        if (fechaInicio) params.append('fecha_inicio', fechaInicio);
        if (fechaFin) params.append('fecha_fin', fechaFin);
        if (usuario) params.append('id_usuario', usuario);
        if (producto) params.append('id_producto', producto);
        if (estado) params.append('estado', estado);
        if (userId) params.append('userId', userId);
        
        const response = await fetch(`/api/bitacora/listar?${params.toString()}`);
        
        const result = await response.json();
        const registros = result.data || [];
        
        if (registros.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: #94a3b8;">No hay registros en la bit√°cora</td></tr>';
            return;
        }
        
        tbody.innerHTML = registros.map(reg => {
            const fecha = new Date(reg.fecha).toLocaleString('es-PE', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            const estadoClass = `estado-${reg.estado.toLowerCase()}`;
            const modificadoPor = reg.nombre_modificador || '-';
            
            const puedeEditar = reg.estado === 'ACTIVO';
            
            // Emoji seg√∫n estado
            const estadoEmoji = {
                'ACTIVO': '‚úÖ',
                'EDITADO': '‚úèÔ∏è',
                'ANULADO': 'üö´'
            };
            
            return `
                <tr>
                    <td style="white-space: nowrap;">${fecha}</td>
                    <td>${reg.nombre_usuario || 'Usuario'}</td>
                    <td><strong>${reg.nombre_producto}</strong></td>
                    <td style="text-align: center; font-size: 18px; font-weight: bold; color: #059669;">${reg.cantidad}</td>
                    <td style="text-align: center;">
                        <span class="estado-badge ${estadoClass}">
                            ${estadoEmoji[reg.estado]} ${reg.estado}
                        </span>
                    </td>
                    <td style="font-size: 13px; color: #64748b;">${modificadoPor}</td>
                    <td>
                        <div class="acciones-bitacora">
                            ${puedeEditar ? `
                                <button class="btn-accion btn-editar" onclick='editarRegistroBitacora(${JSON.stringify(reg)})' title="Editar">
                                    ‚úèÔ∏è
                                </button>
                                <button class="btn-accion btn-anular" onclick='abrirModalAnular(${JSON.stringify(reg)})' title="Anular">
                                    üö´
                                </button>
                            ` : '<span style="color: #94a3b8;">-</span>'}
                        </div>
                    </td>
                </tr>
            `;
        }).join('');
        
    } catch (error) {
        console.error('Error cargando bit√°cora:', error);
        tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px; color: #ef4444;">‚ùå Error cargando registros</td></tr>';
    }
}

// ========================================
// MODAL ANULAR
// ========================================
function abrirModalAnular(registro) {
    registroAnularActual = registro;
    opcionAnularSeleccionada = null;
    
    document.getElementById('modal-anular-bitacora').classList.add('active');
    document.getElementById('form-motivo-anular').classList.remove('active');
    document.getElementById('btn-confirmar-anular').style.display = 'none';
    document.getElementById('textarea-motivo-anular').value = '';
}

function cerrarModalAnular() {
    document.getElementById('modal-anular-bitacora').classList.remove('active');
    registroAnularActual = null;
    opcionAnularSeleccionada = null;
}

function seleccionarOpcionAnular(opcion) {
    opcionAnularSeleccionada = opcion;
    
    document.getElementById('form-motivo-anular').classList.add('active');
    document.getElementById('btn-confirmar-anular').style.display = 'block';
}

async function confirmarAnulacion() {
    const motivo = document.getElementById('textarea-motivo-anular').value.trim();
    
    if (!motivo) {
        alert('Por favor, ingresa el motivo');
        return;
    }
    
    try {
        const userId = getUserId();
        
        if (opcionAnularSeleccionada === 'anular') {
            // Solo anular
            const response = await fetch('/api/bitacora/anular', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    id: registroAnularActual.id,
                    motivo_cambio: motivo,
                    userId: userId
                })
            });
            
            const result = await response.json();
            
            if (result.success) {
                alert('‚úÖ Registro anulado exitosamente');
                cerrarModalAnular();
                await cargarBitacora();
            } else {
                alert('Error: ' + result.error);
            }
            
        } else if (opcionAnularSeleccionada === 'editar') {
            // Abrir formulario de edici√≥n
            cerrarModalAnular();
            editarRegistroBitacoraConMotivo(registroAnularActual, motivo);
        }
        
    } catch (error) {
        console.error('Error:', error);
        alert('Error procesando la anulaci√≥n');
    }
}

// ========================================
// MODAL FORMULARIO (Crear / Editar)
// ========================================
async function abrirModalNuevaEntrada() {
    document.getElementById('titulo-modal-form').textContent = 'Nueva Entrada en Bit√°cora';
    document.getElementById('form-bitacora-modo').value = 'crear';
    document.getElementById('form-bitacora-id').value = '';
    document.getElementById('form-bitacora-producto').value = '';
    document.getElementById('form-bitacora-cantidad').value = '';
    document.getElementById('grupo-observaciones').style.display = 'none';
    document.getElementById('form-bitacora-observaciones').value = '';
    
    await cargarProductosEnSelector();
    
    document.getElementById('modal-form-bitacora').classList.add('active');
}

function cerrarModalFormBitacora() {
    document.getElementById('modal-form-bitacora').classList.remove('active');
}

function editarRegistroBitacora(registro) {
    if (!registro || !registro.id) {
        console.error('Registro inv√°lido:', registro);
        alert('Error: Registro no v√°lido');
        return;
    }
    
    document.getElementById('titulo-modal-form').textContent = 'Editar Registro';
    document.getElementById('form-bitacora-modo').value = 'editar';
    document.getElementById('form-bitacora-id').value = registro.id;
    document.getElementById('form-bitacora-producto').value = registro.id_producto;
    document.getElementById('form-bitacora-cantidad').value = registro.cantidad;
    document.getElementById('grupo-observaciones').style.display = 'block';
    document.getElementById('form-bitacora-observaciones').value = '';
    document.getElementById('form-bitacora-observaciones').required = true;
    
    cargarProductosEnSelector();
    
    document.getElementById('modal-form-bitacora').classList.add('active');
}

function editarRegistroBitacoraConMotivo(registro, motivo) {
    if (!registro || !registro.id) {
        console.error('Registro inv√°lido en editarConMotivo:', registro);
        alert('Error: No se pudo obtener la informaci√≥n del registro');
        return;
    }
    editarRegistroBitacora(registro);
    document.getElementById('form-bitacora-observaciones').value = motivo;
}

async function cargarProductosEnSelector() {
    try {
        const response = await fetch('/api/productos?all=true');
        const result = await response.json();
        const productos = result.data || result.productos || result;
        
        const selector = document.getElementById('form-bitacora-producto');
        selector.innerHTML = '<option value="">Seleccionar producto...</option>';
        
        if (Array.isArray(productos)) {
            productos.forEach(prod => {
                const option = document.createElement('option');
                option.value = prod.id_producto;
                option.textContent = prod.nombre_producto;
                selector.appendChild(option);
            });
        }
    } catch (error) {
        console.error('Error cargando productos:', error);
    }
}

async function guardarEntradaBitacora(event) {
    event.preventDefault();
    
    const modo = document.getElementById('form-bitacora-modo').value;
    const id = document.getElementById('form-bitacora-id').value;
    const id_producto = document.getElementById('form-bitacora-producto').value;
    const cantidad = document.getElementById('form-bitacora-cantidad').value;
    const observaciones = document.getElementById('form-bitacora-observaciones').value.trim();
    
    try {
        const userId = getUserId();
        
        if (modo === 'crear') {
            const response = await fetch('/api/bitacora/crear', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    id_usuario: parseInt(userId),
                    id_producto: parseInt(id_producto),
                    cantidad: parseInt(cantidad),
                    observaciones: observaciones || null
                })
            });
            
            const result = await response.json();
            
            if (result.success) {
                alert('‚úÖ Entrada creada exitosamente');
                cerrarModalFormBitacora();
                await cargarBitacora();
            } else {
                alert('Error: ' + result.error);
            }
            
        } else if (modo === 'editar') {
            if (!observaciones) {
                alert('Debes ingresar el motivo de la correcci√≥n');
                return;
            }
            
            const response = await fetch('/api/bitacora/editar', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    id: parseInt(id),
                    id_producto: parseInt(id_producto),
                    cantidad: parseInt(cantidad),
                    motivo_cambio: observaciones,
                    userId: parseInt(userId)
                })
            });
            
            const result = await response.json();
            
            if (result.success) {
                alert('‚úÖ Registro actualizado exitosamente');
                cerrarModalFormBitacora();
                await cargarBitacora();
            } else {
                alert('Error: ' + result.error);
            }
        }
        
    } catch (error) {
        console.error('Error guardando entrada:', error);
        alert('Error guardando entrada en bit√°cora');
    }
}

// ========================================
// CARGAR SELECTORES DE FILTROS
// ========================================
async function cargarFiltrosBitacora() {
    try {
        // Cargar usuarios
        const usuariosResponse = await fetch('/api/usuarios');
        const usuariosResult = await usuariosResponse.json();
        const usuarios = usuariosResult.data || usuariosResult.usuarios || usuariosResult;
        
        const selectorUsuario = document.getElementById('filtro-usuario');
        if (Array.isArray(usuarios)) {
            usuarios.forEach(u => {
                const option = document.createElement('option');
                option.value = u.id_usuario;
                option.textContent = `${u.nombre} ${u.apellido}`;
                selectorUsuario.appendChild(option);
            });
        }
        
        // Cargar productos
        const productosResponse = await fetch('/api/productos?all=true');
        const productosResult = await productosResponse.json();
        const productos = productosResult.data || productosResult.productos || productosResult;
        
        const selectorProducto = document.getElementById('filtro-producto');
        if (Array.isArray(productos)) {
            productos.forEach(p => {
                const option = document.createElement('option');
                option.value = p.id_producto;
                option.textContent = p.nombre_producto;
                selectorProducto.appendChild(option);
            });
        }
        
        console.log('‚úÖ Filtros cargados');
    } catch (error) {
        console.error('Error cargando filtros:', error);
    }
}

// ========================================
// EXPONER FUNCIONES AL SCOPE GLOBAL
// ========================================
window.cargarBitacora = cargarBitacora;
window.abrirModalAnular = abrirModalAnular;
window.cerrarModalAnular = cerrarModalAnular;
window.seleccionarOpcionAnular = seleccionarOpcionAnular;
window.confirmarAnulacion = confirmarAnulacion;
window.abrirModalNuevaEntrada = abrirModalNuevaEntrada;
window.cerrarModalFormBitacora = cerrarModalFormBitacora;
window.editarRegistroBitacora = editarRegistroBitacora;
window.editarRegistroBitacoraConMotivo = editarRegistroBitacoraConMotivo;
window.guardarEntradaBitacora = guardarEntradaBitacora;
window.cargarFiltrosBitacora = cargarFiltrosBitacora;

// Inicializar cuando cargue la p√°gina
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', async () => {
        await cargarFiltrosBitacora();
        await cargarBitacora();
    });
} else {
    cargarFiltrosBitacora().then(() => cargarBitacora());
}
</script>
