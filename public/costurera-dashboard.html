<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Costurera - Sistema de Etiquetas QR</title>
    <link rel="icon" type="image/x-icon" href="logo-icon.ico">
    
    <!-- Sistema de Dise√±o Accesible -->
    <link rel="stylesheet" href="/css/base/design-system.css">
    <link rel="stylesheet" href="/css/components/buttons.css">
    <!-- Tema se carga din√°micamente con theme-switcher.js -->
    
    <!-- Temas de g√©nero (legacy - mantener por compatibilidad) -->
    <link rel="stylesheet" href="gender-themes.css">
    <script src="theme-system.js" defer></script>
    
    <!-- Theme Switcher -->
    <script src="/css/theme-switcher.js" defer></script>
    
    <!-- ‚ú® OVERRIDE: Desactivar estilos legacy que interfieren con nuevo sistema de temas -->
    <link rel="stylesheet" href="/css/override-legacy-styles.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            /* ‚ú® Usar variables del sistema de temas en lugar de colores hardcodeados */
            background: var(--color-background, #ffffff);
            min-height: 100vh;
            position: relative;
            transition: all 0.5s ease;
        }

        @keyframes gradientShift {
            0% {
                background-position: 0% 50%;
            }
            50% {
                background-position: 100% 50%;
            }
            100% {
                background-position: 0% 50%;
            }
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            z-index: -1;
            pointer-events: none;
            transition: all 0.5s ease;
        }

        /* Flores decorativas flotantes */
        .flowers-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
            overflow: hidden;
        }

        .flower {
            position: absolute;
            font-size: 30px;
            opacity: 0.4;
            animation: floatFlower 15s ease-in-out infinite;
        }

        .flower:nth-child(1) { left: 10%; top: 15%; animation-delay: 0s; }
        .flower:nth-child(2) { left: 85%; top: 25%; animation-delay: 3s; }
        .flower:nth-child(3) { left: 20%; top: 70%; animation-delay: 6s; }
        .flower:nth-child(4) { left: 75%; top: 60%; animation-delay: 9s; }
        .flower:nth-child(5) { left: 50%; top: 40%; animation-delay: 12s; }

        @keyframes floatFlower {
            0%, 100% { transform: translate(0, 0) rotate(0deg); }
            25% { transform: translate(20px, -20px) rotate(10deg); }
            50% { transform: translate(-15px, 15px) rotate(-10deg); }
            75% { transform: translate(10px, -10px) rotate(5deg); }
        }

        /* Corazones flotantes */
        .hearts-container {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
            overflow: hidden;
        }

        .heart {
            position: absolute;
            font-size: 20px;
            bottom: -50px;
            opacity: 0.6;
            animation: riseHeart 12s linear infinite;
        }

        .heart:nth-child(1) { left: 15%; animation-delay: 0s; font-size: 25px; }
        .heart:nth-child(2) { left: 35%; animation-delay: 3s; font-size: 18px; }
        .heart:nth-child(3) { left: 55%; animation-delay: 6s; font-size: 22px; }
        .heart:nth-child(4) { left: 75%; animation-delay: 9s; font-size: 20px; }

        @keyframes riseHeart {
            0% { 
                bottom: -50px;
                transform: translateX(0) rotate(0deg);
                opacity: 0.6;
            }
            50% {
                transform: translateX(30px) rotate(180deg);
            }
            100% { 
                bottom: 110vh;
                transform: translateX(-20px) rotate(360deg);
                opacity: 0;
            }
        }

    /* Estilo para icono peque√±o de juegos en la cabecera */
    .games-icon-mini{display:inline-flex;align-items:center;justify-content:center;width:36px;height:36px;border-radius:8px;background:rgba(255,255,255,0.06);margin-right:8px;border:1px solid rgba(0,0,0,0.04)}
    .games-icon-mini:hover{background:rgba(255,255,255,0.12)}

        /* MODO OSCURO */
        body.dark-mode {
            background: linear-gradient(-45deg, #2d1b3d, #4a1942, #1a0f2e, #3d1f47);
        }

        body.dark-mode::before {
            background: rgba(20, 20, 40, 0.85);
        }

        body.dark-mode .flower,
        body.dark-mode .heart {
            opacity: 0.25;
            filter: brightness(0.7);
        }

        .header {
            background: linear-gradient(
                135deg,
                rgba(255, 182, 223, 0.95),
                rgba(255, 214, 232, 0.95),
                rgba(255, 192, 230, 0.95)
            );
            background-size: 200% 200%;
            color: #1a202c;
            padding: 20px;
            box-shadow: 
                0 2px 10px rgba(255, 105, 180, 0.2),
                0 0 15px rgba(255, 182, 223, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.8),
                inset 0 -1px 0 rgba(255, 105, 180, 0.2);
            border: 1px solid rgba(255, 192, 230, 0.6);
            position: relative;
            overflow: hidden;
            animation: chromeShift 8s ease infinite;
            transition: all 0.5s ease;
        }

        body.dark-mode .header {
            background: linear-gradient(
                135deg,
                rgba(77, 36, 65, 0.95),
                rgba(92, 45, 78, 0.95),
                rgba(68, 40, 70, 0.95)
            );
            box-shadow: 
                0 2px 10px rgba(0, 0, 0, 0.5),
                0 0 15px rgba(138, 43, 226, 0.3),
                inset 0 1px 0 rgba(138, 43, 226, 0.4),
                inset 0 -1px 0 rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(138, 43, 226, 0.4);
            color: #f3e5f5;
        }

        @keyframes chromeShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                90deg,
                transparent,
                rgba(255, 255, 255, 0.4),
                transparent
            );
            animation: headerShine 4s infinite;
        }

        @keyframes headerShine {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        .header-content {
            max-width: 1000px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 28px;
            display: flex;
            align-items: center;
            gap: 10px;
            text-shadow: 
                0 1px 0 rgba(255, 255, 255, 0.8),
                0 -1px 0 rgba(0, 0, 0, 0.2);
            color: #2d3748;
            position: relative;
            z-index: 1;
        }

        .costurera-header-logo {
            height: 50px;
            width: auto;
            background: rgba(255, 255, 255, 0.9);
            padding: 5px 10px;
            border-radius: 8px;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
            transition: all 0.3s ease;
        }

        .costurera-header-logo:hover {
            transform: scale(1.05);
            background: rgba(255, 255, 255, 0.95);
            filter: drop-shadow(0 2px 6px rgba(0,0,0,0.4));
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        /* Toggle Imprimir Rotulado en Header */
        .rotulado-toggle-container {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(0, 0, 0, 0.3);
            padding: 8px 15px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .rotulado-toggle-container span {
            color: white;
            font-size: 13px;
            font-weight: 500;
        }

        .rotulado-toggle {
            position: relative;
            width: 48px;
            height: 24px;
            cursor: pointer;
        }

        .rotulado-toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .rotulado-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.3);
            border: 2px solid rgba(255, 255, 255, 0.5);
            transition: 0.4s;
            border-radius: 24px;
        }

        .rotulado-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 2px;
            bottom: 2px;
            background: white;
            transition: 0.4s;
            border-radius: 50%;
        }

        .rotulado-toggle input:checked + .rotulado-slider {
            background: #10b981;
            border-color: #059669;
        }

        .rotulado-toggle input:checked + .rotulado-slider:before {
            transform: translateX(24px);
        }

        /* Toggle Modo Oscuro/Claro */
        .theme-toggle {
            position: relative;
            width: 60px;
            height: 30px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 30px;
            cursor: pointer;
            display: flex;
            align-items: center;
            padding: 3px;
            transition: all 0.4s ease;
            box-shadow: 
                0 2px 8px rgba(0, 0, 0, 0.2),
                inset 0 1px 2px rgba(255, 255, 255, 0.3);
        }

        .theme-toggle:hover {
            transform: scale(1.05);
        }

        .theme-toggle-slider {
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            position: absolute;
            left: 3px;
            transition: all 0.4s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        }

        body.dark-mode .theme-toggle {
            background: linear-gradient(135deg, #4a1942, #2d1b3d);
        }

        body.dark-mode .theme-toggle-slider {
            left: 33px;
        }

        .supervisor-badge {
            background: rgba(245, 158, 11, 0.9);
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .logout-btn {
            background: rgba(255,255,255,0.2);
            border: 2px solid rgba(255,255,255,0.3);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }

        .main-container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 30px 20px;
        }

        .nav-tabs {
            display: flex;
            margin-bottom: 20px;
            background: white;
            border-radius: 15px;
            padding: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: all 0.5s ease;
            gap: 8px;
        }

        body.dark-mode .nav-tabs {
            background: rgba(45, 27, 61, 0.9);
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }

        .nav-tab {
            flex: 1;
            padding: 18px 20px;
            text-align: center;
            cursor: pointer;
            border-radius: 12px;
            font-weight: 700;
            font-size: 16px;
            transition: all 0.3s ease;
            color: #666;
            background: transparent;
            border: 2px solid transparent;
        }

        .nav-tab:hover {
            background: rgba(236, 72, 153, 0.1);
            border-color: rgba(236, 72, 153, 0.3);
            transform: translateY(-1px);
        }

        body.dark-mode .nav-tab {
            color: #d8b4fe;
        }

        .nav-tab.active {
            background: linear-gradient(135deg, #ec4899, #d946ef, #c026d3);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(236, 72, 153, 0.4);
            border-color: transparent;
        }

        body.dark-mode .nav-tab.active {
            background: linear-gradient(135deg, #a855f7, #8b5cf6, #7c3aed);
            box-shadow: 0 6px 20px rgba(168, 85, 247, 0.5);
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .content-card {
            /* ‚ú® Usar variables del sistema de temas */
            background: var(--color-surface, #ffffff);
            border-radius: 15px;
            padding: 30px;
            box-shadow: var(--shadow-md, 0 4px 6px rgba(0, 0, 0, 0.1));
            border: 1px solid var(--color-border, rgba(0, 0, 0, 0.1));
            transition: all 0.5s ease;
        }

        /* DARK MODE DESHABILITADO - Usar sistema de temas con bot√≥n flotante */
        /* body.dark-mode .content-card { ... } */

        .form-group {
            margin-bottom: 25px;
        }

        .form-label {
            display: block;
            color: #333;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 16px;
            transition: color 0.5s ease;
        }

        body.dark-mode .form-label {
            color: #f3e5f5;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid rgba(236, 72, 153, 0.2);
            border-radius: 10px;
            transition: all 0.5s ease;
            font-size: 16px;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.8);
        }

        body.dark-mode .form-input,
        body.dark-mode .form-select,
        body.dark-mode .form-textarea {
            background: rgba(68, 40, 70, 0.8);
            border-color: rgba(168, 85, 247, 0.3);
            color: #f3e5f5;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: #ec4899;
            background: white;
            box-shadow: 0 0 0 3px rgba(236, 72, 153, 0.1);
        }

        body.dark-mode .form-input:focus,
        body.dark-mode .form-select:focus,
        body.dark-mode .form-textarea:focus {
            border-color: #d946ef;
            background: rgba(68, 40, 70, 0.95);
            box-shadow: 0 0 0 3px rgba(217, 70, 239, 0.2);
        }

        .form-textarea {
            resize: vertical;
            min-height: 80px;
        }

        /* Estilos para informaci√≥n de cantidad */
        .info-icon {
            color: #f59e0b;
            font-size: 16px;
            cursor: pointer;
            margin-left: 5px;
            transition: transform 0.2s ease;
        }

        .info-icon:hover {
            transform: scale(1.2);
        }

        .cantidad-info {
            margin-top: 10px;
            animation: slideDown 0.3s ease-out;
        }

        .info-box {
            background: linear-gradient(135deg, #fef3c7 0%, #fbbf24 100%);
            border: 2px solid #f59e0b;
            border-radius: 8px;
            padding: 15px;
            font-size: 13px;
            line-height: 1.4;
        }

        .info-box h4 {
            margin: 0 0 8px 0;
            color: #92400e;
            font-size: 14px;
        }

        .info-box p {
            margin: 0 0 8px 0;
            color: #451a03;
        }

        .info-box ul {
            margin: 8px 0;
            padding-left: 20px;
            color: #451a03;
        }

        .info-box li {
            margin: 4px 0;
        }

        .info-examples {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .example {
            background: rgba(255, 255, 255, 0.7);
            padding: 5px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            color: #92400e;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 200px;
            gap: 20px;
            align-items: end;
        }

        /* Estilos para tarjeta de saludo personalizado - COMPACTA */
        .greeting-card {
            background: linear-gradient(135deg, #fef3c7 0%, #f59e0b 100%);
            border-radius: 10px;
            padding: 12px 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(245, 158, 11, 0.15);
            border: 1px solid rgba(245, 158, 11, 0.2);
            opacity: 0.92;
        }

        .greeting-content {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .greeting-icon {
            font-size: 32px;
            animation: bounce 2s infinite;
        }

        .greeting-text h3 {
            margin: 0 0 4px 0;
            color: #92400e;
            font-size: 16px;
            font-weight: 600;
        }

        .greeting-text p {
            margin: 0 0 8px 0;
            color: #451a03;
            font-size: 13px;
            line-height: 1.3;
        }

        .stats-summary {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .stat-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            background: rgba(255, 255, 255, 0.85);
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 11px;
            font-weight: 600;
            border: 1.5px solid transparent;
            box-shadow: 0 1px 2px rgba(0,0,0,0.08);
        }

        .stat-badge.pendiente {
            border-color: #d97706;
            color: #d97706;
        }

        .stat-badge.pendiente .stat-number {
            background: #d97706 !important;
            color: white !important;
        }

        .stat-badge.proceso {
            border-color: #2563eb;
            color: #2563eb;
        }

        .stat-badge.proceso .stat-number {
            background: #2563eb !important;
            color: white !important;
        }

        .stat-badge.completado {
            border-color: #059669;
            color: #059669;
        }

        .stat-badge.completado .stat-number {
            background: #059669 !important;
            color: white !important;
        }

        .stat-number {
            background: #6b7280;
            color: white !important;
            padding: 2px 7px;
            border-radius: 10px;
            font-weight: 700;
            min-width: 18px;
            text-align: center;
            font-size: 11px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.12);
            display: inline-block;
        }

        /* üñ®Ô∏è Estilos para indicadores de impresoras */
        .stat-badge.printer-status {
            border-color: #92400e;
            color: #92400e;
            background: rgba(255, 255, 255, 0.95);
            cursor: help;
            transition: all 0.3s ease;
        }

        .stat-badge.printer-status:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .printer-indicator {
            font-size: 14px;
            animation: pulse-printer 2s ease-in-out infinite;
        }

        @keyframes pulse-printer {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.15); }
        }

        .stat-label {
            font-size: 11px;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {
                transform: translateY(0);
            }
            40% {
                transform: translateY(-10px);
            }
            60% {
                transform: translateY(-5px);
            }
        }

        .priority-select {
            padding: 12px;
            border-radius: 8px;
            border: 2px solid #e2e8f0;
            font-weight: 600;
        }

        .priority-normal {
            background: #e0f2fe;
            color: #0369a1;
            border-color: #0369a1;
        }

        .priority-alta {
            background: #fee2e2;
            color: #dc2626;
            border-color: #dc2626;
        }

        .priority-urgente {
            background: #fef3c7;
            color: #d97706;
            border-color: #d97706;
        }

        .submit-btn {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3);
        }

        .submit-btn:disabled {
            background: #d1d5db;
            cursor: not-allowed;
            transform: none;
        }

        .preview-btn {
            background: linear-gradient(135deg, #6366f1, #4f46e5);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            justify-content: center;
        }

        .preview-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(99, 102, 241, 0.3);
        }

        .preview-btn:disabled {
            background: #d1d5db;
            cursor: not-allowed;
            transform: none;
        }

        /* Toggle Switch para Auto-Services */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 26px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.3);
            transition: 0.4s;
            border-radius: 26px;
            border: 2px solid rgba(255, 255, 255, 0.5);
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: 0.4s;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .toggle-switch input:checked + .toggle-slider {
            background-color: #10b981;
            border-color: #059669;
        }

        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }

        .toggle-switch input:focus + .toggle-slider {
            box-shadow: 0 0 1px #10b981;
        }

        .refresh-btn {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.2);
        }

        .refresh-btn:hover {
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .refresh-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.2);
        }

        .refresh-btn.refreshing {
            animation: spin 1s linear infinite;
            pointer-events: none;
            opacity: 0.7;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .records-container {
            max-height: 600px;
            overflow-y: auto;
        }

        .record-item {
            /* ‚ú® Usar variables del sistema de temas */
            background: var(--color-surface, #ffffff);
            border: 2px solid var(--color-border, rgba(0, 0, 0, 0.1));
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-sm, 0 1px 3px rgba(0, 0, 0, 0.12));
        }

        .record-item:hover {
            border-color: var(--color-primary, #007bff);
            box-shadow: var(--shadow-md, 0 4px 6px rgba(0, 0, 0, 0.1));
            transform: translateY(-2px);
        }

        .record-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 15px;
        }

        .record-number {
            font-weight: bold;
            color: #333;
            font-size: 18px;
        }

        .record-date {
            color: #666;
            font-size: 14px;
        }

        .record-details {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr;
            gap: 15px;
            margin-bottom: 10px;
        }

        .record-product {
            font-weight: 600;
            color: #333;
        }

        .record-quantity {
            color: #667eea;
            font-weight: 600;
        }

        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            text-align: center;
        }

        .status-pendiente {
            background: #fef3c7;
            color: #d97706;
        }

        .status-en_proceso {
            background: #dbeafe;
            color: #2563eb;
        }

        .status-completado {
            background: #d1fae5;
            color: #059669;
        }

        .status-rechazada {
            background: #fee2e2;
            color: #dc2626;
        }

        .record-observations {
            margin-top: 10px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.6);
            border-radius: 8px;
            font-style: italic;
            color: #666;
            border-left: 4px solid #ec4899;
        }

        /* Bot√≥n de editar observaciones */
        .btn-edit-observaciones {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 8px 16px;
            background: #f3f4f6;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 20px;
            position: relative;
            min-width: 100px;
        }

        .btn-edit-observaciones .btn-text {
            font-size: 14px;
            font-weight: 600;
            color: #4b5563;
        }

        .btn-edit-observaciones:hover {
            background: #667eea;
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
        }

        .btn-edit-observaciones:hover .btn-text {
            color: white;
        }

        /* Bot√≥n con notita (cuando tiene observaciones) */
        .btn-edit-observaciones.has-notes {
            background: linear-gradient(135deg, #10b981, #059669);
            border-color: #10b981;
            animation: pulse-green 2s infinite;
        }

        .btn-edit-observaciones.has-notes .btn-text {
            color: white;
        }

        /* Puntito de notificaci√≥n */
        .notification-dot {
            position: absolute;
            top: -4px;
            right: -4px;
            width: 12px;
            height: 12px;
            background: #ef4444;
            border: 2px solid white;
            border-radius: 50%;
            animation: pulse-red 1.5s infinite;
        }

        @keyframes pulse-green {
            0%, 100% {
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7);
            }
            50% {
                box-shadow: 0 0 0 8px rgba(16, 185, 129, 0);
            }
        }

        @keyframes pulse-red {
            0%, 100% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.2);
                opacity: 0.8;
            }
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .empty-state .icon {
            font-size: 60px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .spinner {
            width: 30px;
            height: 30px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .success-message {
            background: #d1fae5;
            color: #059669;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #059669;
            display: none;
        }

        .error-message {
            background: #fee2e2;
            color: #dc2626;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #dc2626;
            display: none;
        }

        .password-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .password-modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            text-align: center;
            max-width: 400px;
            width: 90%;
        }

        /* Bot√≥n de Ayuda Flotante - Posicionado debajo del theme switcher */
        .help-button {
            position: fixed;
            bottom: 100px; /* Ajustado para estar debajo del bot√≥n de tema (que est√° en 24px) */
            right: 24px;
            width: 56px;
            height: 56px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 1069; /* Justo debajo del theme switcher (1070) */
            border: 3px solid rgba(255, 255, 255, 0.3);
            text-decoration: none;
        }

        .help-button:hover {
            transform: scale(1.1) rotate(5deg);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
            border-color: rgba(255, 255, 255, 0.6);
        }

        .help-button .icon {
            font-size: 26px;
            color: white;
            font-weight: bold;
        }

        .help-button .tooltip {
            position: absolute;
            right: 70px;
            background: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 8px 15px;
            border-radius: 8px;
            font-size: 13px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .help-button:hover .tooltip {
            opacity: 1;
        }

        .help-button .tooltip::after {
            content: '';
            position: absolute;
            right: -8px;
            top: 50%;
            transform: translateY(-50%);
            width: 0;
            height: 0;
            border-left: 8px solid rgba(0, 0, 0, 0.85);
            border-top: 8px solid transparent;
            border-bottom: 8px solid transparent;
        }

        /* Ajustes responsive para botones flotantes */
        @media (max-width: 768px) {
            .help-button {
                width: 48px;
                height: 48px;
                bottom: 85px; /* Ajustado para m√≥vil */
                right: 16px;
            }

            .help-button .icon {
                font-size: 22px;
            }

            .help-button .tooltip {
                font-size: 12px;
                padding: 6px 12px;
                right: 60px;
            }
        }

        .modal-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            text-align: center;
            margin: 15px 0;
        }

        .modal-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(
                135deg, 
                #667eea, 
                #764ba2,
                #ec4899,
                #667eea
            );
            background-size: 300% 300%;
            color: white;
            position: relative;
            overflow: hidden;
            animation: buttonGradient 4s ease infinite;
            box-shadow: 
                0 4px 15px rgba(102, 126, 234, 0.3),
                0 0 20px rgba(236, 72, 153, 0.2);
        }

        @keyframes buttonGradient {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .btn-primary::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(
                45deg,
                transparent,
                rgba(255, 255, 255, 0.1),
                transparent
            );
            transform: rotate(45deg);
            animation: buttonShine 3s linear infinite;
        }

        @keyframes buttonShine {
            0% { transform: translateX(-100%) rotate(45deg); }
            100% { transform: translateX(100%) rotate(45deg); }
        }

        .btn-primary:hover {
            transform: scale(1.02);
            box-shadow: 
                0 6px 20px rgba(102, 126, 234, 0.4),
                0 0 30px rgba(236, 72, 153, 0.4);
        }

        .btn-secondary {
            background: #e2e8f0;
            color: #64748b;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .record-details {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .nav-tabs {
                flex-direction: column;
            }
        }

        /* Chat Styles for Costureras */
        .chat-container-costurera {
            display: flex;
            height: 60vh;
            /* ‚ú® Usar variables del sistema de temas */
            background: var(--color-surface, #ffffff);
            border-radius: 10px;
            box-shadow: var(--shadow-lg, 0 10px 15px rgba(0, 0, 0, 0.1));
            border: 1px solid var(--color-border, rgba(0, 0, 0, 0.1));
            overflow: hidden;
            margin-top: 10px;
        }

        .chat-sidebar-costurera {
            width: 280px;
            /* ‚ú® Usar variables del sistema de temas */
            background: var(--color-surface-secondary, #f9fafb);
            border-right: 1px solid var(--color-border, rgba(0, 0, 0, 0.1));
            display: flex;
            flex-direction: column;
        }

        .chat-header-costurera {
            padding: 15px;
            border-bottom: 1px solid var(--color-border, rgba(0, 0, 0, 0.1));
            /* ‚ú® Usar variables del sistema de temas */
            background: var(--color-primary, #007bff);
            color: white;
        }

        .chat-header-costurera h3 {
            margin: 0 0 8px;
            font-size: 16px;
        }

        .user-status-costurera {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
        }

        .status-online { background: #28a745; }
        .status-away { background: #ffc107; }
        .status-busy { background: #dc3545; }
        .status-offline { background: #6c757d; }

        .status-select {
            padding: 2px 4px;
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 4px;
            font-size: 11px;
            background: rgba(255,255,255,0.1);
            color: white;
        }

        .chat-channels-costurera, .online-users-costurera {
            flex: 1;
            overflow-y: auto;
        }

        .channels-header-costurera, .users-header-costurera {
            padding: 12px 15px;
            background: linear-gradient(135deg, #fce7f3 0%, #fbcfe8 100%);
            font-weight: 600;
            font-size: 13px;
            color: #831843;
            border-bottom: 1px solid rgba(236, 72, 153, 0.2);
        }

        .channels-list-costurera, .users-list-costurera {
            padding: 8px 0;
        }

        .channel-item-costurera, .user-item-costurera {
            padding: 8px 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 13px;
            transition: background-color 0.2s;
        }

        .channel-item-costurera:hover, .user-item-costurera:hover {
            background: rgba(236, 72, 153, 0.1);
        }

        .channel-item-costurera.active {
            background: linear-gradient(135deg, #ec4899, #d946ef);
            color: white;
        }

        .channel-name-costurera {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .notification-badge {
            background: #dc3545;
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            min-width: 16px;
            text-align: center;
        }

        .chat-main-costurera {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .chat-messages-header-costurera {
            padding: 15px;
            border-bottom: 1px solid rgba(236, 72, 153, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255, 255, 255, 0.8);
        }

        .chat-messages-header-costurera h3 {
            margin: 0;
            font-size: 16px;
            color: #333;
        }

        .chat-actions-costurera {
            display: flex;
            gap: 8px;
        }

        .chat-messages-costurera {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            background: linear-gradient(180deg, #fef5fb 0%, #fcedf8 100%);
            display: flex;
            flex-direction: column;
        }

        .welcome-message-costurera {
            text-align: center;
            margin: auto;
            color: #831843;
        }

        .welcome-message-costurera h3 {
            color: #ec4899;
            margin-bottom: 10px;
        }

        .message-costurera {
            margin-bottom: 12px;
            padding: 10px 12px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(236, 72, 153, 0.1);
            border: 1px solid rgba(236, 72, 153, 0.1);
            max-width: 80%;
        }

        .message-header-costurera {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .message-author-costurera {
            font-weight: 600;
            color: #ec4899;
            font-size: 12px;
        }

        .message-time-costurera {
            font-size: 11px;
            color: #6c757d;
        }

        .message-content-costurera {
            color: #333;
            line-height: 1.4;
            white-space: pre-wrap;
            font-size: 13px;
        }

        .message-costurera.own {
            background: linear-gradient(135deg, #ec4899, #d946ef);
            color: white;
            align-self: flex-end;
            margin-left: auto;
        }

        .message-costurera.own .message-author-costurera {
            color: white;
        }

        .message-costurera.own .message-time-costurera {
            color: rgba(255, 255, 255, 0.8);
        }

        .message-costurera.system {
            background: rgba(252, 231, 243, 0.8);
            color: #831843;
            font-style: italic;
            text-align: center;
            align-self: center;
            max-width: 60%;
            border: 1px solid rgba(236, 72, 153, 0.2);
        }

        .chat-input-container-costurera {
            padding: 15px;
            border-top: 1px solid rgba(236, 72, 153, 0.2);
            background: rgba(255, 255, 255, 0.8);
        }

        .chat-input-wrapper-costurera {
            display: flex;
            gap: 8px;
            align-items: flex-end;
        }

        .message-input-costurera {
            flex: 1;
            min-height: 36px;
            max-height: 80px;
            padding: 8px 12px;
            border: 1px solid rgba(236, 72, 153, 0.3);
            border-radius: 6px;
            resize: none;
            font-family: inherit;
            font-size: 13px;
            background: rgba(255, 255, 255, 0.9);
        }

        .send-button-costurera {
            padding: 8px 12px;
            background: linear-gradient(135deg, #ec4899, #d946ef);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .send-button-costurera:hover {
            background: linear-gradient(135deg, #d946ef, #c026d3);
            box-shadow: 0 4px 12px rgba(236, 72, 153, 0.3);
            transform: translateY(-1px);
        }

        .chat-input-actions-costurera {
            margin-top: 8px;
        }

        /* Responsive para chat de costureras */
        @media (max-width: 768px) {
            .chat-container-costurera {
                flex-direction: column;
                height: 50vh;
            }
            
            .chat-sidebar-costurera {
                width: 100%;
                max-height: 150px;
            }

            .form-input {
                font-size: 18px;
                padding: 18px;
            }
        }

        /* Responsive para tablets */
        @media (max-width: 1024px) and (min-width: 769px) {
            .form-input {
                font-size: 16px;
                padding: 16px;
            }
        }
    </style>
</head>
<body>

    <!-- Flores decorativas -->
    <div class="flowers-container">
        <div class="flower">üå∏</div>
        <div class="flower">üå∫</div>
        <div class="flower">üåº</div>
        <div class="flower">üåª</div>
        <div class="flower">üå∑</div>
    </div>

    <!-- Corazones flotantes -->
    <div class="hearts-container">
        <div class="heart">üíñ</div>
        <div class="heart">üíï</div>
        <div class="heart">üíó</div>
        <div class="heart">üíù</div>
    </div>

    <div class="header">
        <div class="header-content">
            <h1>
                <!--LOGO_START<img src="assets/logoicon.png" alt="Logo de la Empresa" class="costurera-header-logo">LOGO_END-->
                <span>‚úÇÔ∏è</span>
                <span id="page-title">Dashboard Costurera</span>
            </h1>
            <div class="user-info">
                <!-- Toggle Automatizar Rotulado -->
                <div class="rotulado-toggle-container">
                    <span>Automatizar rotulado</span>
                    <label class="rotulado-toggle">
                        <input type="checkbox" id="toggle-auto-servicesgd" onchange="toggleAutoServicesGD()">
                        <span class="rotulado-slider"></span>
                    </label>
                </div>
                
                <!-- üî™ Toggle Guillotina Autom√°tica -->
                <div class="rotulado-toggle-container">
                    <span>Guillotina autom√°tica</span>
                    <label class="rotulado-toggle">
                        <input type="checkbox" id="corte-automatico-toggle" onchange="toggleCorteAutomatico()">
                        <span class="rotulado-slider"></span>
                    </label>
                </div>
                
                <!-- Bot√≥n Juegos (mando) -->
                <a href="/games/panel-juegos.html" class="games-icon-mini" title="Juegos" aria-label="Juegos">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                        <path d="M6 10h.01M18 10h.01M12 10v.01M12 14v.01M21 8c0-1.1-.9-2-2-2h-2.27c-.46 0-.9-.28-1.06-.72L14.4 2.3A2 2 0 0 0 12.61 1H11.4a2 2 0 0 0-1.79 1.3L8.33 5.3c-.16.44-.6.72-1.06.72H5c-1.1 0-2 .9-2 2v6c0 1.1.9 2 2 2h3l1 2h6l1-2h3c1.1 0 2-.9 2-2V8z" stroke="#111" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </a>
                
                <!-- Toggle Decoraciones -->
                <div class="decorations-toggle" onclick="toggleDecorations()" title="Mostrar/Ocultar decoraciones">
                    <span id="decorations-toggle-icon">‚ú®</span>
                </div>
                <div id="supervisor-badge" class="supervisor-badge" style="display: none;">
                    Supervisor
                </div>
                <div>
                    <div id="user-name">Cargando...</div>
                    <small id="user-role">Costurera</small>
                </div>
                <button class="logout-btn" id="back-to-supervisor-btn" onclick="backToSupervisor()" style="display: none; margin-right: 10px; background: #f59e0b;">
                    ‚Üê Volver
                </button>
                <button class="logout-btn" onclick="logout()">Salir</button>
            </div>
        </div>
    </div>

    <div class="main-container">
        <!-- Navegaci√≥n por tabs -->
        <div class="nav-tabs">
            <div class="nav-tab active" onclick="switchTab('registros')">
                üìã Mis Registros
            </div>
            <div class="nav-tab" onclick="switchTab('crear')">
                ‚ûï Crear Nuevo Registro
            </div>
            <div class="nav-tab" onclick="switchTab('chat')">
                üí¨ Chat <span id="chat-badge-costurera" class="notification-badge" style="display: none;">0</span>
            </div>
        </div>

        <!-- Tab: Mis Registros -->
        <div class="tab-content active" id="registros-tab">
            <!-- Mensaje personalizado basado en horario - MOVIDO AQU√ç, JUSTO ANTES DE MIS REGISTROS -->
            <div class="greeting-card" id="greeting-card">
                <div class="greeting-content">
                    <div class="greeting-icon" id="greeting-icon">üåÖ</div>
                    <div class="greeting-text">
                        <h3 id="greeting-title">Buenos d√≠as</h3>
                        <p id="greeting-message">Cargando mensaje personalizado...</p>
                        <div class="stats-summary" id="stats-summary">
                            <span class="stat-badge pendiente">
                                <span class="stat-number" id="stats-pendiente">0</span>
                                <span class="stat-label">Pendientes</span>
                            </span>
                            <span class="stat-badge proceso">
                                <span class="stat-number" id="stats-proceso">0</span>
                                <span class="stat-label">En Proceso</span>
                            </span>
                            <span class="stat-badge completado">
                                <span class="stat-number" id="stats-completado">0</span>
                                <span class="stat-label">Completadas</span>
                            </span>
                            
                            <!-- üñ®Ô∏è Indicadores de Impresoras -->
                            <span class="stat-badge printer-status" id="godex-badge" title="Estado de Godex G530">
                                <span class="printer-indicator" id="godex-indicator">‚ö™</span>
                                <span class="stat-label">Godex</span>
                            </span>
                            <span class="stat-badge printer-status" id="zebra-badge" title="Estado de Zebra ZD230">
                                <span class="printer-indicator" id="zebra-indicator">‚ö™</span>
                                <span class="stat-label">Zebra</span>
                            </span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="content-card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="margin: 0; color: #333;">üìã Mis Registros</h2>
                    <button id="refresh-records-btn" class="refresh-btn" onclick="refreshRecords()" title="Actualizar registros">
                        üîÑ Actualizar
                    </button>
                </div>
                <div class="records-container" id="records-container">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Cargando registros...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab: Crear Nuevo Registro -->
        <div class="tab-content" id="crear-tab">
            <div class="content-card">
                <h2 style="margin-bottom: 20px; color: #333;">‚ûï Crear Nuevo Registro</h2>
                
                <div class="success-message" id="success-message"></div>
                <div class="error-message" id="error-message"></div>

                <!-- Formulario para Producto Normal -->
                <div id="form-producto-normal">
                    <form id="nuevo-registro-form">
                    <div class="form-group">
                        <label class="form-label" for="producto">Producto Terminado *</label>
                        <input type="text" class="form-input" id="producto" list="productos-list" 
                               placeholder=""
                               autocomplete="off" required>
                        <datalist id="productos-list">
                            <!-- Las opciones se cargan din√°micamente -->
                        </datalist>
                        <small style="color: #666; font-size: 12px;">
                            üí° Escribe el producto
                        </small>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" for="cantidad">
                                Cantidad Terminada * 
                                <span class="info-icon" onclick="toggleCantidadInfo()" title="Informaci√≥n sobre impresi√≥n">
                                    ‚ö†Ô∏è
                                </span>
                            </label>
                            <input type="number" class="form-input" id="cantidad" min="1" max="1000" required 
                                   placeholder="">
                            
                            <!-- Mensaje r√°pido siempre visible -->
                            <small style="color: #f59e0b; font-size: 12px; margin-top: 4px; display: block;">
                                ‚ö†Ô∏è Coloque la cantidad
                            </small>
                            
                            <!-- Informaci√≥n explicativa -->
                            <div class="cantidad-info" id="cantidad-info" style="display: none;">
                                <div class="info-box">
                                    <h4>üìã Informaci√≥n de Impresi√≥n</h4>
                                    <p><strong>Importante:</strong> El sistema imprime etiquetas por unidad, no por pares.</p>
                                    <ul>
                                        <li>Si ingresas <strong>20</strong>, se imprimir√°n <strong>20 etiquetas</strong> (no 40)</li>
                                        <li>Para n√∫meros impares, se agrega 1 etiqueta extra para evitar desperdicios</li>
                                        <li>Ejemplo: 21 ‚Üí se imprimir√°n 22 etiquetas</li>
                                    </ul>
                                    <div class="info-examples">
                                        <div class="example">25 ‚Üí 26 etiquetas üìã</div>
                                        <div class="example">30 ‚Üí 30 etiquetas ‚úÖ</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="prioridad">Prioridad</label>
                            <select class="form-select priority-select priority-normal" id="prioridad" onchange="updatePriorityStyle()">
                                <option value="normal">Normal</option>
                                <option value="alta">Alta</option>
                                <option value="urgente">Urgente</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="observaciones">Observaciones (opcional)</label>
                        <textarea class="form-textarea" id="observaciones" 
                                  placeholder="Coloque alguna nota de entrega del lote...."></textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="empresa">üè¢ Empresa / Entidad</label>
                        <select class="form-input" id="empresa" required style="padding: 14px; font-size: 15px;">
                            <option value="HECHO EN PERU">HECHO EN PERU</option>
                        </select>
                    </div>

                    <!-- üè∑Ô∏è OPCIONES DE ROTULADO GODEX -->
                    <div style="border: 2px solid #f59e0b; border-radius: 8px; padding: 15px; background: #fffbeb; margin-top: 15px;">
                        <div style="font-size: 14px; font-weight: 600; color: #92400e; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                            <span>üè∑Ô∏è</span>
                            <span>Configuraci√≥n de Rotulado (Costureras)</span>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
                            <!-- Logo Principal -->
                            <div style="display: flex; flex-direction: column; gap: 5px;">
                                <label style="font-size: 12px; font-weight: 500; color: #78350f;">Logo Principal Arriba</label>
                                <select id="logo-rotulado" class="form-input" style="padding: 8px; font-size: 13px; border: 1px solid #f59e0b;">
                                    <option value="camitex">Camitex - Empresa</option>
                                    <option value="algodon_100">100% Algod√≥n</option>
                                    <option value="maxima_suavidad" selected>M√°xima Suavidad</option>
                                    <option value="producto_peruano">Producto Peruano</option>
                                    <option value="arequipeno">Producto Arequipe√±o</option>
                                    <option value="sin_logo">Sin Logo</option>
                                </select>
                            </div>

                            <!-- Logo Secundario (Misti) -->
                            <div style="display: flex; flex-direction: column; gap: 5px;">
                                <label style="font-size: 12px; font-weight: 500; color: #78350f;">Logo Secundario</label>
                                <select id="logo-secundario" class="form-input" style="padding: 8px; font-size: 13px; border: 1px solid #f59e0b;">
                                    <option value="con_logo">Con Logo Misti</option>
                                    <option value="sin_logo" selected>Sin Logo</option>
                                </select>
                            </div>

                            <!-- Logos de Advertencia -->
                            <div style="display: flex; flex-direction: column; gap: 5px;">
                                <label style="font-size: 12px; font-weight: 500; color: #78350f;">Iconos Advertencia</label>
                                <select id="logos-advertencia" class="form-input" style="padding: 8px; font-size: 13px; border: 1px solid #f59e0b;">
                                    <option value="con_iconos" selected>Con Iconos</option>
                                    <option value="sin_iconos">Sin Iconos</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div style="display: flex; gap: 10px;">
                        <button type="button" class="preview-btn" onclick="openPreviewModal(false)" id="preview-btn-normal">
                            üëÅÔ∏è Visualizar
                        </button>
                        <button type="submit" class="submit-btn" id="submit-btn" style="flex: 2;">
                            üè∑Ô∏è Solicitar Etiquetas QR
                        </button>
                    </div>
                </form>
                </div>

                <!-- Formulario para Producto Especial (JUEGO/COMBO) -->
                <div id="form-producto-especial" style="display: none;">
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 15px; border-radius: 10px; margin-bottom: 20px; color: white;">
                        <h3 style="margin: 0; font-size: 18px;">‚≠ê Solicitud de Producto Especial (JUEGO/COMBO)</h3>
                        <p style="margin: 10px 0 0 0; font-size: 14px; opacity: 0.9;">Selecciona un producto especial pre-configurado</p>
                    </div>

                    <form id="nuevo-registro-especial-form">
                        <div class="form-group">
                            <label class="form-label" for="producto-especial">Producto Especial *</label>
                            <input type="text" class="form-input" id="producto-especial" list="productos-especiales-list" 
                                   placeholder="Escribe para buscar JUEGO o COMBO..." 
                                   autocomplete="off" required>
                            <datalist id="productos-especiales-list">
                                <!-- Las opciones se cargan din√°micamente -->
                            </datalist>
                            <small style="color: #666; font-size: 12px;">
                                üí° Estos son productos compuestos por varios componentes
                            </small>
                            
                            <!-- Detalle del producto especial seleccionado -->
                            <div id="detalle-producto-especial" style="display: none; margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #667eea;">
                                <h4 style="margin: 0 0 10px 0; color: #667eea; font-size: 16px;">üì¶ Componentes del JUEGO/COMBO:</h4>
                                <div id="componentes-lista"></div>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label" for="cantidad-especial">
                                    Cantidad de Juegos/Combos * 
                                </label>
                                <input type="number" class="form-input" id="cantidad-especial" min="1" max="100" required 
                                       placeholder="Ejemplo: 5">
                                <small style="color: #666; font-size: 12px; margin-top: 4px; display: block;">
                                    ‚ÑπÔ∏è Se generar√°n etiquetas para todos los componentes de cada juego
                                </small>
                            </div>

                            <div class="form-group">
                                <label class="form-label" for="prioridad-especial">Prioridad</label>
                                <select class="form-select priority-select priority-normal" id="prioridad-especial" onchange="updatePriorityStyleEspecial()">
                                    <option value="normal">Normal</option>
                                    <option value="alta">Alta</option>
                                    <option value="urgente">Urgente</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="observaciones-especial">Observaciones (opcional)</label>
                            <textarea class="form-textarea" id="observaciones-especial" 
                                      placeholder="Observaciones sobre este lote de juegos/combos..."></textarea>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="empresa-especial">üè¢ Empresa / Entidad</label>
                            <select class="form-input" id="empresa-especial" required style="padding: 14px; font-size: 15px;">
                                <option value="HECHO EN PERU">HECHO EN PERU</option>
                            </select>
                        </div>

                        <div style="display: flex; gap: 10px;">
                            <button type="button" class="btn-secondary" onclick="volverFormularioNormal()" style="flex: 1; padding: 12px; background: #6c757d; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px;">
                                ‚Üê Volver a Normal
                            </button>
                            <button type="button" class="preview-btn" onclick="openPreviewModal(true)" id="preview-btn-especial" style="flex: 1;">
                                üëÅÔ∏è Visualizar
                            </button>
                            <button type="submit" class="submit-btn" id="submit-btn-especial" style="flex: 2;">
                                üè∑Ô∏è Solicitar Etiquetas para JUEGO/COMBO
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para contrase√±a de supervisor -->
    <div class="password-modal" id="password-modal">
        <div class="modal-content">
            <h3>Confirmar Cambios</h3>
            <p>Se requiere contrase√±a de supervisor para aplicar cambios</p>
            <form id="supervisor-password-form" onsubmit="handleSupervisorPasswordSubmit(event)">
                <input 
                    type="password" 
                    class="modal-input" 
                    id="supervisor-password" 
                    name="supervisor-password"
                    placeholder="Contrase√±a de supervisor"
                    autocomplete="current-password"
                    required
                >
                <div class="modal-buttons">
                    <button type="button" class="btn btn-secondary" onclick="closePasswordModal()">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Confirmar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Tab: Chat -->
    <div class="tab-content" id="chat-tab">
        <div class="content-card">
            <div class="chat-container-costurera">
                <div class="chat-sidebar-costurera">
                    <div class="chat-header-costurera">
                        <h3>üí¨ Chat del Equipo</h3>
                        <div class="user-status-costurera">
                            <span id="current-user-status-costurera" class="status-indicator status-online"></span>
                            <span id="current-user-name-costurera">Usuario</span>
                            <select id="status-selector-costurera" class="status-select">
                                <option value="en_linea">üü¢ En l√≠nea</option>
                                <option value="ausente">üü° Ausente</option>
                                <option value="ocupado">üî¥ Ocupado</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="chat-channels-costurera">
                        <div class="channels-header-costurera">
                            <h4>Mis Canales</h4>
                        </div>
                        <div id="channels-list-costurera" class="channels-list-costurera">
                            <!-- Los canales se cargan din√°micamente -->
                        </div>
                    </div>
                    
                    <div class="online-users-costurera">
                        <div class="users-header-costurera">
                            <h4>Compa√±eros <span id="online-count-costurera">0</span></h4>
                        </div>
                        <div id="online-users-list-costurera" class="users-list-costurera">
                            <!-- Usuarios en l√≠nea se cargan din√°micamente -->
                        </div>
                    </div>
                </div>
                
                <div class="chat-main-costurera">
                    <div class="chat-messages-header-costurera">
                        <h3 id="current-channel-name-costurera">Selecciona un canal</h3>
                        <div class="chat-actions-costurera">
                            <button class="btn btn-secondary" onclick="loadChatMessagesCosturera()" title="Actualizar">
                                üîÑ
                            </button>
                        </div>
                    </div>
                    
                    <div id="chat-messages-costurera" class="chat-messages-costurera">
                        <div class="welcome-message-costurera">
                            <h3>¬°Bienvenida al Chat del Equipo! üëã</h3>
                            <p>Aqu√≠ puedes comunicarte con supervisores y compa√±eras de trabajo.</p>
                            <p>Selecciona un canal para comenzar.</p>
                        </div>
                    </div>
                    
                    <div id="chat-input-container-costurera" class="chat-input-container-costurera" style="display: none;">
                        <div class="chat-input-wrapper-costurera">
                            <textarea id="message-input-costurera" class="message-input-costurera" 
                                    placeholder="Escribe tu mensaje..." 
                                    onkeypress="handleMessageKeypressCosturera(event)"></textarea>
                            <button class="send-button-costurera" onclick="sendMessageCosturera()">
                                üì§
                            </button>
                        </div>
                        <div class="chat-input-actions-costurera">
                            <small class="text-muted">Presiona Enter para enviar, Shift+Enter para nueva l√≠nea</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para seleccionar tipo de solicitud -->
    <div class="modal-overlay" id="tipo-solicitud-popup" style="display: none;">
        <div class="modal-content" style="max-width: 600px; text-align: center;">
            <h3 style="margin-bottom: 30px; color: #333;">Selecciona el tipo de solicitud</h3>
            <div style="display: flex; gap: 20px; justify-content: center; flex-wrap: wrap;">
                <div class="tipo-producto-option" onclick="seleccionarTipoSolicitud('normal')" style="flex: 1; min-width: 250px; padding: 30px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 15px; cursor: pointer; transition: transform 0.3s, box-shadow 0.3s;">
                    <div style="font-size: 48px; margin-bottom: 15px;">üì¶</div>
                    <h4 style="margin-bottom: 10px; font-size: 20px;">Producto Normal</h4>
                    <p style="font-size: 14px; opacity: 0.9;"></p>
                </div>
                <div class="tipo-producto-option" onclick="seleccionarTipoSolicitud('especial')" style="flex: 1; min-width: 250px; padding: 30px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; border-radius: 15px; cursor: pointer; transition: transform 0.3s, box-shadow 0.3s;">
                    <div style="font-size: 48px; margin-bottom: 15px;">‚≠ê</div>
                    <h4 style="margin-bottom: 10px; font-size: 20px;">Producto Especial</h4>
                    <p style="font-size: 14px; opacity: 0.9;"></p>
                </div>
            </div>
            <button onclick="cerrarPopupTipoSolicitud()" style="margin-top: 30px; padding: 12px 30px; background: #6c757d; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px;">
                Cancelar
            </button>
        </div>
    </div>

    <!-- Modal para editar observaciones -->
    <div class="modal-overlay" id="popup-observaciones" style="display: none;">
        <div class="modal-content" style="max-width: 600px;">
            <h3 style="margin-bottom: 20px; color: #333;">
                üìù Observaciones del Registro
            </h3>
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <strong>Producto:</strong> <span id="observaciones-producto"></span>
            </div>
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 10px; font-weight: bold; color: #555;">
                    Escribe tus observaciones:
                </label>
                <textarea 
                    id="observaciones-texto" 
                    rows="6" 
                    style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px; font-family: inherit; resize: vertical;"
                    placeholder="Agrega aqu√≠ cualquier observaci√≥n importante sobre este registro..."
                ></textarea>
                <div style="font-size: 12px; color: #666; margin-top: 5px;">
                    üí° Estas observaciones son solo para referencia interna. No afectan el producto ni la impresi√≥n.
                </div>
            </div>
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button 
                    onclick="cerrarPopupObservaciones()" 
                    style="padding: 12px 24px; background: #6c757d; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px;"
                >
                    Cancelar
                </button>
                <button 
                    onclick="guardarObservaciones()" 
                    style="padding: 12px 24px; background: #28a745; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: bold;"
                >
                    ‚úÖ Guardar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal para visualizaci√≥n de etiquetas -->
    <div class="modal-overlay" id="preview-modal" style="display: none;">
        <div class="modal-content" style="max-width: 1100px; padding: 0; background: #2d3748; border-radius: 0;">
            <!-- Bot√≥n cerrar flotante -->
            <button 
                onclick="closePreviewModal()" 
                style="position: absolute; top: 15px; right: 15px; background: #ef4444; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600; z-index: 10;">
                ‚úï Cerrar
            </button>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0;">
                <!-- Etiqueta QR (izquierda) -->
                <div style="background: white; padding: 20px; display: flex; align-items: center; justify-content: center;">
                    <canvas id="preview-canvas-etiqueta" width="400" height="200"></canvas>
                </div>

                <!-- Rotulado (derecha) -->
                <div style="background: white; padding: 20px; display: flex; align-items: center; justify-content: center;">
                    <canvas id="preview-canvas-rotulado" width="200" height="400"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Popup de Observaciones -->
    <div class="modal-overlay" id="observaciones-popup" style="display: none;">
        <div class="modal-content" style="max-width: 550px;">
            <h3 style="margin-bottom: 20px; color: #333; display: flex; align-items: center; gap: 10px;">
                üìù Observaciones del Registro
            </h3>
            
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <div style="font-size: 14px; color: #666; margin-bottom: 5px;">Producto:</div>
                <div style="font-size: 16px; font-weight: 600; color: #333;" id="observaciones-producto-nombre"></div>
            </div>
            
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #555;">
                    Observaciones:
                </label>
                <textarea 
                    id="observaciones-textarea"
                    placeholder="Escribe aqu√≠ cualquier observaci√≥n sobre este registro..."
                    style="width: 100%; min-height: 150px; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; font-family: inherit; resize: vertical;"
                ></textarea>
                <small style="color: #666; font-size: 12px; display: block; margin-top: 5px;">
                    üí° Las observaciones se guardar√°n autom√°ticamente al cerrar
                </small>
            </div>
            
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button 
                    onclick="cerrarPopupObservaciones()"
                    style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;">
                    Cancelar
                </button>
                <button 
                    onclick="guardarObservaciones()"
                    style="padding: 10px 20px; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600;">
                    üíæ Guardar
                </button>
            </div>
        </div>
    </div>

    <style>
        /* Modal overlay para popup de selecci√≥n */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            backdrop-filter: blur(4px);
        }

        .modal-overlay .modal-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            animation: modalFadeIn 0.3s ease;
        }

        @keyframes modalFadeIn {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .tipo-producto-option:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
    </style>

    <script>
        let currentUser = null;
        let currentCostureraId = null;
        let isSupervisor = false;
        let productos = [];
        let productosEspecialesDisponibles = [];
        let productoEspecialSeleccionado = null;
        let pendingChanges = null;

        // üî™ FUNCI√ìN TOGGLE DE CORTE AUTOM√ÅTICO
        function toggleCorteAutomatico() {
            const toggle = document.getElementById('corte-automatico-toggle');
            const estado = toggle.checked;
            
            // Guardar en localStorage
            localStorage.setItem('corteAutomaticoActivado', estado);
            
            // Mensaje visual usando funci√≥n existente
            const mensaje = estado ? 'üî™ Corte autom√°tico activado' : '‚úÇÔ∏è Corte desactivado (manual)';
            showSuccess(mensaje);
            
            console.log(`üî™ Corte autom√°tico: ${estado ? 'ON' : 'OFF'}`);
        }

        // üîÑ RESTAURAR ESTADO DEL TOGGLE AL CARGAR
        function restaurarEstadoCorte() {
            const toggle = document.getElementById('corte-automatico-toggle');
            const estadoGuardado = localStorage.getItem('corteAutomaticoActivado');
            
            if (estadoGuardado !== null) {
                // Restaurar estado guardado
                toggle.checked = (estadoGuardado === 'true');
                console.log(`üîÑ Estado de corte restaurado: ${toggle.checked ? 'ON' : 'OFF'}`);
            } else {
                // üî™ DEFAULT: ACTIVADO por defecto (primera vez)
                toggle.checked = true;
                localStorage.setItem('corteAutomaticoActivado', 'true');
                console.log('üî™ Corte autom√°tico activado por defecto (primera vez)');
            }
        }

        // Inicializar p√°gina
        window.addEventListener('load', async () => {
            // Obtener par√°metros de URL
            const urlParams = new URLSearchParams(window.location.search);
            const userId = urlParams.get('user');
            const supervisorMode = urlParams.get('supervisor') === 'true';

            // Verificar autenticaci√≥n
            const userData = localStorage.getItem('currentUser');
            const token = localStorage.getItem('token');
            if (!userData || !token) {
                window.location.href = '/login';
                return;
            }
            
            // Validar token con el servidor
            try {
                const validationResponse = await fetch('/api/usuarios/me', {
                    headers: getAuthHeaders()
                });
                
                if (!validationResponse.ok) {
                    console.warn('‚ö†Ô∏è Token inv√°lido o expirado, redirigiendo al login...');
                    localStorage.clear();
                    window.location.href = '/login';
                    return;
                }
            } catch (error) {
                console.warn('‚ö†Ô∏è Error validando token, redirigiendo al login...');
                localStorage.clear();
                window.location.href = '/login';
                return;
            }
            
            currentUser = JSON.parse(userData);
            isSupervisor = supervisorMode || currentUser.rol === 'supervisor';
            currentCostureraId = userId || currentUser.id;

            // Configurar interfaz
            setupInterface();

            // Restaurar estado del toggle de corte
            restaurarEstadoCorte();

            // Cargar datos
            await loadData();
            

            
            // Actualizar mensaje personalizado cada 30 minutos
            setInterval(() => {
                updateGreetingMessage();
            }, 30 * 60 * 1000); // 30 minutos
        });

        // Configurar interfaz seg√∫n modo
        function setupInterface() {
            if (isSupervisor && currentCostureraId !== currentUser.id) {
                // Supervisor actuando como costurera
                document.getElementById('supervisor-badge').style.display = 'block';
                document.getElementById('page-title').textContent = 'Dashboard Supervisor';
                document.getElementById('back-to-supervisor-btn').style.display = 'block';
                
                // Cargar nombre de la costurera
                loadCostureraName();
            } else {
                // Costurera normal
                document.getElementById('user-name').textContent = currentUser.nombre;
                document.getElementById('user-role').textContent = 'Costurera';
                
                // Actualizar mensaje de saludo para costurera normal
                updateGreetingMessage();
            }
        }

        // Funci√≥n para obtener headers de autenticaci√≥n
        function getAuthHeaders() {
            const token = localStorage.getItem('token');
            return {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            };
        }

        // Funci√≥n para manejar errores de autenticaci√≥n
        function handleAuthError(response) {
            if (response.status === 401) {
                console.warn('‚ö†Ô∏è Sesi√≥n expirada, redirigiendo al login...');
                localStorage.removeItem('token');
                localStorage.removeItem('currentUser');
                setTimeout(() => {
                    window.location.href = '/login';
                }, 1500);
                return true;
            }
            return false;
        }

        // Cargar nombre de costurera (para supervisor)
        async function loadCostureraName() {
            try {
                const response = await fetch(`/api/usuarios/${currentCostureraId}`, {
                    method: 'GET',
                    headers: getAuthHeaders()
                });
                
                if (handleAuthError(response)) return; // Manejar sesi√≥n expirada
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const costurera = await response.json();
                document.getElementById('user-name').textContent = costurera.nombre_completo;
                document.getElementById('user-role').textContent = 'Actuando como Costurera';
                
                // Actualizar mensaje de saludo con el nuevo nombre
                updateGreetingMessage();
            } catch (error) {
                // Silenciar error (fallback autom√°tico sin ruido en consola)
                // Si hay error, mostrar un mensaje gen√©rico
                document.getElementById('user-name').textContent = 'Costurera';
                document.getElementById('user-role').textContent = 'Cargando...';
                
                // Actualizar mensaje incluso con error
                updateGreetingMessage();
            }
        }

        // Cargar todos los datos
        // Cargar entidades desde la API y poblar los dropdowns
        async function cargarEntidadesDropdown() {
            try {
                const response = await fetch('/api/entidades', {
                    method: 'GET',
                    headers: getAuthHeaders()
                });
                
                if (handleAuthError(response)) return; // Manejar sesi√≥n expirada
                
                if (!response.ok) {
                    // Silenciar warning (usa valores por defecto autom√°ticamente)
                    return;
                }
                
                const entidades = await response.json();
                
                // Poblar dropdown del formulario normal
                const empresaSelect = document.getElementById('empresa');
                if (empresaSelect && entidades.length > 0) {
                    empresaSelect.innerHTML = entidades.map(ent => 
                        `<option value="${ent.nombre_entidad}" ${ent.nombre_entidad === 'HECHO EN PERU' ? 'selected' : ''}>${ent.nombre_entidad}</option>`
                    ).join('');
                }
                
                // Poblar dropdown del formulario especial
                const empresaEspecialSelect = document.getElementById('empresa-especial');
                if (empresaEspecialSelect && entidades.length > 0) {
                    empresaEspecialSelect.innerHTML = entidades.map(ent => 
                        `<option value="${ent.nombre_entidad}" ${ent.nombre_entidad === 'HECHO EN PERU' ? 'selected' : ''}>${ent.nombre_entidad}</option>`
                    ).join('');
                }
                
            } catch (error) {
                console.error('Error cargando entidades para dropdown:', error);
            }
        }

        async function loadData() {
            await Promise.all([
                loadProductos(),
                loadRegistros(),
                updateSubmitButtonText(), // Actualizar texto del bot√≥n seg√∫n auto_services
                cargarEntidadesDropdown()  // Cargar entidades en los dropdowns
            ]);
            
            // Actualizar mensaje personalizado
            updateGreetingMessage();
        }

        // Actualizar texto del bot√≥n seg√∫n el estado de auto_services
        async function updateSubmitButtonText() {
            try {
                // Obtener informaci√≥n actualizada del usuario actual
                const userId = currentCostureraId || currentUser.id;
                const response = await fetch(`/api/usuarios/${userId}`, {
                    method: 'GET',
                    headers: getAuthHeaders()
                });
                
                if (handleAuthError(response)) return; // Manejar sesi√≥n expirada
                
                if (!response.ok) {
                    // Silenciar warning (bot√≥n mantiene texto por defecto)
                    return;
                }
                
                const usuario = await response.json();
                const submitBtn = document.getElementById('submit-btn');
                const toggleAutoServicesGD = document.getElementById('toggle-auto-servicesgd');
                
                // Actualizar bot√≥n de etiquetas QR
                if (usuario.auto_services === true) {
                    submitBtn.innerHTML = 'üñ®Ô∏è Imprimir Etiquetas QR';
                    submitBtn.style.background = 'linear-gradient(135deg, #10b981, #059669)';
                    console.log('‚úÖ Usuario con auto-services activo ‚Üí Bot√≥n: "Imprimir Etiquetas QR"');
                } else {
                    submitBtn.innerHTML = 'üè∑Ô∏è Solicitar Etiquetas QR';
                    submitBtn.style.background = 'linear-gradient(135deg, #ec4899, #db2777)';
                    console.log('üìã Usuario con modo manual ‚Üí Bot√≥n: "Solicitar Etiquetas QR"');
                }
                
                // Actualizar toggle de rotulado Godex (header)
                if (toggleAutoServicesGD) {
                    toggleAutoServicesGD.checked = usuario.auto_servicesgd === true;
                    console.log(`üè∑Ô∏è Toggle Godex actualizado: ${usuario.auto_servicesgd === true ? 'ACTIVADO' : 'DESACTIVADO'}`);
                }
            } catch (error) {
                console.error('Error actualizando texto del bot√≥n:', error);
            }
        }

        // Sistema de mensajes personalizados basados en horario
        function updateGreetingMessage() {
            const now = new Date();
            const hour = now.getHours();
            
            // Obtener nombre del usuario desde el elemento DOM que se actualiza por la API
            const userNameElement = document.getElementById('user-name');
            const userName = userNameElement ? userNameElement.textContent : (currentUser?.nombre_completo || 'Costurera');
            
            // Funci√≥n para obtener nombre apropiado (m√°ximo 15 caracteres para etiquetas)
            function getDisplayName(fullName) {
                if (!fullName || fullName === 'Costurera') return 'Costurera';
                
                const words = fullName.trim().split(' ');
                
                // Si el primer nombre es muy largo, solo usar el primer nombre
                if (words[0].length > 12) {
                    return words[0].substring(0, 12);
                }
                
                // Si hay segundo nombre y junto caben en 15 caracteres, usar ambos
                if (words.length > 1 && (words[0] + ' ' + words[1]).length <= 15) {
                    return words[0] + ' ' + words[1];
                }
                
                // Si solo cabe el primer nombre, usarlo
                return words[0];
            }
            
            const displayName = getDisplayName(userName);
            
            let greeting, message, icon;
            
            // üåÉ MADRUGADA PROFUNDA (12:00 AM - 4:59 AM)
            if (hour >= 0 && hour < 5) {
                greeting = `Buenas madrugadas Se√±ora ${displayName}`;
                icon = 'üåÉ';
                const deepNightMessages = [
                    `¬øTrabajando tan tarde? Recuerde cuidar su descanso para ma√±ana.`,
                    `¬°Qu√© dedicaci√≥n! ¬øSe siente c√≥moda trabajando en estas horas tan tranquilas?`,
                    `Es muy tarde, ¬øno tiene sue√±o? Cuide su salud y descanse cuando pueda.`,
                    `La noche est√° avanzada. ¬øQu√© productos est√° terminando a esta hora?`,
                    `¬øNo tiene fr√≠o en la madrugada? Recuerde abrigarse bien mientras trabaja.`,
                    `Hora silenciosa para concentrarse. ¬øC√≥mo se siente trabajando sin interrupciones?`
                ];
                message = deepNightMessages[Math.floor(Math.random() * deepNightMessages.length)];
            }
            // üåÖ AMANECER (5:00 AM - 6:59 AM)
            else if (hour >= 5 && hour < 7) {
                greeting = `Buenos d√≠as Se√±ora ${displayName}`;
                icon = 'üåÖ';
                const dawnMessages = [
                    `¬°Qu√© madrugadora! ¬øYa desayun√≥ antes de empezar el trabajo?`,
                    `El d√≠a est√° comenzando. ¬øC√≥mo se siente para iniciar sus labores?`,
                    `¬°Muy temprano! ¬øDurmi√≥ bien? Es importante descansar para rendir mejor.`,
                    `El amanecer es hermoso. ¬øLe gusta trabajar en estas horas tranquilas?`,
                    `¬°Qu√© disciplina! ¬øSiempre se levanta tan temprano para trabajar?`
                ];
                message = dawnMessages[Math.floor(Math.random() * dawnMessages.length)];
            }
            // ‚òÄÔ∏è MA√ëANA TEMPRANA (7:00 AM - 8:59 AM)
            else if (hour >= 7 && hour < 9) {
                greeting = `Buenos d√≠as Se√±ora ${displayName}`;
                icon = '‚òÄÔ∏è';
                const earlyMorningMessages = [
                    `¬°Buenos d√≠as! ¬øDurmi√≥ bien? Esperamos que est√© lista para un d√≠a productivo.`,
                    `¬°Qu√© hora perfecta para comenzar! ¬øQu√© productos planea confeccionar hoy?`,
                    `La ma√±ana est√° fresca. ¬øYa desayun√≥? Un buen desayuno da energ√≠a para trabajar.`,
                    `¬°Buen d√≠a! ¬øC√≥mo amaneci√≥ hoy? El clima est√° perfecto para trabajar c√≥moda.`,
                    `Hora ideal para empezar. ¬øSe siente motivada para alcanzar sus metas del d√≠a?`,
                    `¬°Muy buenos d√≠as! ¬øYa organiz√≥ qu√© tareas va a realizar primero?`,
                    `La energ√≠a matutina es la mejor. ¬øEst√° lista para un d√≠a lleno de logros?`
                ];
                message = earlyMorningMessages[Math.floor(Math.random() * earlyMorningMessages.length)];
            }
            // üåû MEDIA MA√ëANA (9:00 AM - 10:59 AM)
            else if (hour >= 9 && hour < 11) {
                greeting = `Buenos d√≠as Se√±ora ${displayName}`;
                icon = 'ÔøΩ';
                const midMorningMessages = [
                    `¬øC√≥mo va el trabajo esta ma√±ana? Esperamos que todo marche muy bien.`,
                    `Ya lleva unas horas trabajando. ¬øSe siente c√≥moda y concentrada?`,
                    `La ma√±ana est√° avanzando. ¬øQu√© tal van sus productos de hoy?`,
                    `Hora productiva del d√≠a. ¬øYa tom√≥ un peque√±o descanso para relajar la vista?`,
                    `¬øC√≥mo se siente? Recuerde mantener una buena postura mientras trabaja.`,
                    `Media ma√±ana perfecta. ¬øEst√° logrando el ritmo de trabajo que esperaba?`
                ];
                message = midMorningMessages[Math.floor(Math.random() * midMorningMessages.length)];
            }
            // üïö PRE-ALMUERZO (11:00 AM - 12:29 PM)
            else if (hour >= 11 && (hour < 12 || (hour === 12 && now.getMinutes() < 30))) {
                greeting = `Buenos d√≠as Se√±ora ${displayName}`;
                icon = 'üïö';
                const preLunchMessages = [
                    `Ya se acerca la hora del almuerzo. ¬øTiene hambre? ¬øQu√© va a almorzar hoy?`,
                    `Falta poco para el almuerzo. ¬øC√≥mo han ido las tareas de la ma√±ana?`,
                    `¬øYa est√° pensando en el almuerzo? Es importante alimentarse bien.`,
                    `La ma√±ana est√° por terminar. ¬øLogr√≥ completar lo que ten√≠a planeado?`,
                    `Casi mediod√≠a. ¬øSe siente satisfecha con el avance de esta ma√±ana?`
                ];
                message = preLunchMessages[Math.floor(Math.random() * preLunchMessages.length)];
            }
            // üçΩÔ∏è HORA DE ALMUERZO (12:30 PM - 1:29 PM)
            else if ((hour === 12 && now.getMinutes() >= 30) || hour === 13) {
                greeting = `Buen mediod√≠a Se√±ora ${displayName}`;
                icon = 'üçΩÔ∏è';
                const lunchMessages = [
                    `¬øYa almorz√≥? Es hora de reponer energ√≠as para continuar el d√≠a.`,
                    `Hora del almuerzo. ¬øQu√© rico que va a comer hoy? ¬°Provecho!`,
                    `Ya hace hambre, ¬øverdad? Venden chifa m√°s arriba si gusta algo diferente.`,
                    `El sol est√° fuerte. ¬øQu√© tal si toma un descanso para almorzar tranquila?`,
                    `Mediod√≠a perfecto. Recuerde hidratarse bien y descansar un ratito.`,
                    `¬øYa pens√≥ qu√© almorzar? Una buena comida da fuerzas para la tarde.`
                ];
                message = lunchMessages[Math.floor(Math.random() * lunchMessages.length)];
            }
            // üå§Ô∏è TARDE PRODUCTIVA (1:30 PM - 3:59 PM)
            else if (hour >= 14 && hour < 16) {
                greeting = `Buenas tardes Se√±ora ${displayName}`;
                icon = 'üå§Ô∏è';
                const productiveAfternoonMessages = [
                    `¬øC√≥mo va el trabajo esta tarde? Esperamos que todo marche excelente.`,
                    `La tarde es perfecta para concentrarse. ¬øQu√© productos est√° terminando?`,
                    `¬øSe siente bien despu√©s del almuerzo? La energ√≠a de la tarde es muy buena.`,
                    `Hora muy productiva del d√≠a. ¬øC√≥mo van sus metas y objetivos?`,
                    `¬øYa descans√≥ un poco la vista? Es importante cuidar la salud visual.`,
                    `La tarde est√° ideal para trabajar. ¬øSe siente motivada y concentrada?`,
                    `¬øQu√© tal el ritmo de trabajo? Esta es una hora muy eficiente del d√≠a.`
                ];
                message = productiveAfternoonMessages[Math.floor(Math.random() * productiveAfternoonMessages.length)];
            }
            // üåá TARDE AVANZADA (4:00 PM - 5:59 PM)
            else if (hour >= 16 && hour < 18) {
                greeting = `Buenas tardes Se√±ora ${displayName}`;
                icon = 'üåá';
                const lateAfternoonMessages = [
                    `La tarde est√° avanzando. ¬øC√≥mo se siente? ¬øNecesita un peque√±o descanso?`,
                    `¬øQu√© tal van los productos de hoy? ¬°Seguro ha logrado mucho!`,
                    `Tarde productiva. ¬øYa est√° pensando en las tareas para ma√±ana?`,
                    `¬øSe siente cansada o a√∫n tiene energ√≠a? Recuerde cuidar su bienestar.`,
                    `La jornada est√° por terminar. ¬øEst√° satisfecha con el trabajo de hoy?`,
                    `¬øC√≥mo han estado las horas de la tarde? ¬øTodo bien con sus labores?`
                ];
                message = lateAfternoonMessages[Math.floor(Math.random() * lateAfternoonMessages.length)];
            }
            // üåÜ ATARDECER (6:00 PM - 8:59 PM)
            else if (hour >= 18 && hour < 21) {
                greeting = `Buenas tardes Se√±ora ${displayName}`;
                icon = 'üåÜ';
                const eveningMessages = [
                    `El atardecer est√° llegando. ¬øC√≥mo fue su d√≠a de trabajo hoy?`,
                    `¬øYa est√° pensando en descansar? Trabaj√≥ muy bien durante el d√≠a.`,
                    `La tarde se est√° yendo. ¬øLogr√≥ completar todo lo que ten√≠a planeado?`,
                    `¬øSe siente satisfecha con el trabajo realizado? ¬°Seguro fue muy productiva!`,
                    `Hora de ir finalizando. ¬øQu√© tal si organiza el espacio para ma√±ana?`,
                    `El d√≠a est√° terminando. ¬øTiene planes agradables para la noche?`
                ];
                message = eveningMessages[Math.floor(Math.random() * eveningMessages.length)];
            }
            // üåô NOCHE (9:00 PM - 11:59 PM)
            else {
                greeting = `Buenas noches Se√±ora ${displayName}`;
                icon = 'üåô';
                const nightMessages = [
                    `Esperamos que descanse bien esta noche. Trabaj√≥ arduamente hoy.`,
                    `Hora de relajarse. ¬°Qu√© d√≠a tan productivo y lleno de logros ha tenido!`,
                    `Es momento de descansar. Ma√±ana ser√° otro d√≠a lleno de oportunidades.`,
                    `Buena hora para terminar. Descanse bien y reponga energ√≠as para ma√±ana.`,
                    `La noche es perfecta para descansar. ¬øYa cen√≥ algo rico y nutritivo?`
                ];
                message = nightMessages[Math.floor(Math.random() * nightMessages.length)];
            }
            
            // Actualizar la interfaz
            document.getElementById('greeting-icon').textContent = icon;
            document.getElementById('greeting-title').textContent = greeting;
            document.getElementById('greeting-message').textContent = message;
            
            // Cargar estad√≠sticas de trabajos
            updateWorkStats();
        }

        // Actualizar estad√≠sticas de trabajo para el mensaje personalizado
        async function updateWorkStats() {
            try {
                const response = await fetch(`/api/registros/${currentCostureraId}`, {
                    method: 'GET',
                    headers: getAuthHeaders()
                });
                
                if (!response.ok) return;
                
                const registros = await response.json();
                
                console.log('üìä ESTAD√çSTICAS DEBUG:', registros);
                
                // Contar por estados - CORREGIDO PARA COINCIDIR CON BD
                const stats = {
                    pendiente: 0,
                    proceso: 0,
                    completado: 0
                };
                
                registros.forEach(registro => {
                    console.log('üìù Registro:', registro.numero_solicitud, 'Estado:', registro.estado_solicitud);
                    
                    if (registro.estado_solicitud === 'pendiente') {
                        stats.pendiente++;
                    } else if (registro.estado_solicitud === 'proceso') {  // ‚úÖ CORREGIDO: era 'en_proceso'
                        stats.proceso++;
                    } else if (registro.estado_solicitud === 'completada') {  // ‚úÖ CORREGIDO: era 'completado'
                        stats.completado++;
                    }
                });
                
                // Actualizar la interfaz
                document.getElementById('stats-pendiente').textContent = stats.pendiente;
                document.getElementById('stats-proceso').textContent = stats.proceso;
                document.getElementById('stats-completado').textContent = stats.completado;
                
                // Si es de noche, agregar mensaje sobre productividad
                const hour = new Date().getHours();
                if (hour >= 18 || hour <= 0) {
                    const totalProductos = stats.completado;
                    if (totalProductos > 0) {
                        const currentMessage = document.getElementById('greeting-message').textContent;
                        document.getElementById('greeting-message').textContent = 
                            currentMessage + ` Complet√≥ ${totalProductos} productos hoy. ¬°Excelente trabajo!`;
                    }
                }
                
            } catch (error) {
                console.error('Error cargando estad√≠sticas:', error);
                // Valores por defecto
                document.getElementById('stats-pendiente').textContent = '0';
                document.getElementById('stats-proceso').textContent = '0';
                document.getElementById('stats-completado').textContent = '0';
            }
        }

        // Cargar lista de productos con b√∫squeda mejorada
        async function loadProductos() {
            try {
                // Cargar TODOS los productos sin l√≠mite
                const response = await fetch('/api/productos?all=true&activos=true', {
                    method: 'GET',
                    headers: getAuthHeaders()
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                // Manejar nueva estructura de respuesta con paginaci√≥n
                productos = result.data || result || [];
                
                console.log(`üì¶ Productos cargados: ${productos.length}/${result.total || 'N/A'}`);
                console.log('üìã Respuesta del servidor:', result);
                
                if (result.all) {
                    console.log('‚úÖ Cargados TODOS los productos disponibles');
                } else {
                    console.warn('‚ö†Ô∏è Carga paginada - algunos productos podr√≠an faltar');
                }
                
                // Cargar en datalist para autocompletado
                const dataList = document.getElementById('productos-list');
                dataList.innerHTML = '';
                
                productos.forEach(producto => {
                    const option = document.createElement('option');
                    option.value = `${producto.nombre_producto} (${producto.codigo_producto})`;
                    option.setAttribute('data-id', producto.id_producto);
                    dataList.appendChild(option);
                });
                
                // Agregar evento de b√∫squeda en tiempo real
                setupProductSearch();
                
            } catch (error) {
                console.error('Error cargando productos:', error);
                showError('Error cargando productos');
            }
        }

        // Configurar b√∫squeda de productos en tiempo real
        function setupProductSearch() {
            const productInput = document.getElementById('producto');
            
            productInput.addEventListener('input', function() {
                const inputValue = this.value.toLowerCase();
                const dataList = document.getElementById('productos-list');
                
                // Filtrar productos que coincidan con la b√∫squeda
                const filteredProducts = productos.filter(producto => 
                    producto.nombre_producto.toLowerCase().includes(inputValue) ||
                    producto.codigo_producto.toLowerCase().includes(inputValue)
                );
                
                // Actualizar datalist con productos filtrados
                dataList.innerHTML = '';
                filteredProducts.slice(0, 50).forEach(producto => { // Mostrar m√°ximo 50 resultados
                    const option = document.createElement('option');
                    option.value = `${producto.nombre_producto} (${producto.codigo_producto})`;
                    option.setAttribute('data-id', producto.id_producto);
                    dataList.appendChild(option);
                });
            });
        }

        // Obtener ID del producto seleccionado
        function getSelectedProductId() {
            const productInput = document.getElementById('producto');
            const inputValue = productInput.value;
            
            // Buscar el producto por nombre o c√≥digo
            const foundProduct = productos.find(producto => 
                `${producto.nombre_producto} (${producto.codigo_producto})` === inputValue ||
                producto.nombre_producto === inputValue ||
                producto.codigo_producto === inputValue
            );
            
            return foundProduct ? foundProduct.id_producto : null;
        }

        // Funci√≥n auxiliar para escapar HTML y prevenir XSS
        function escapeHtml(text) {
            if (!text) return '';
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }

        // Cargar registros de la costurera
        async function loadRegistros() {
            try {
                 const response = await fetch(`/api/registros/${currentCostureraId}`, {
                    method: 'GET',
                    headers: getAuthHeaders()
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const registros = await response.json();
                
                const container = document.getElementById('records-container');
                
                if (registros.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="icon">üìù</div>
                            <h3>No tienes registros a√∫n</h3>
                            <p>Crea tu primer registro usando la pesta√±a "Crear Nuevo Registro"</p>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = registros.map(registro => {
                    // Determinar qu√© acciones mostrar seg√∫n el estado
                    const isPendiente = registro.estado_solicitud === 'pendiente';
                    const rotuladoImpreso = registro.rotulado_impreso || false;
                    const qrImpreso = registro.qr_impreso || false;
                    const tieneObservaciones = registro.observaciones && registro.observaciones.trim().length > 0;
                    
                    return `
                    <div class="record-item">
                        <div class="record-header">
                            <div class="record-number">${registro.numero_solicitud}</div>
                            <div class="record-date">${new Date(registro.fecha_creacion).toLocaleDateString()}</div>
                        </div>
                        
                        <!-- Indicadores de impresi√≥n -->
                        <div style="display: flex; gap: 10px; margin: 10px 0; align-items: center;">
                            <div style="display: flex; align-items: center; gap: 5px; padding: 5px 10px; background: ${qrImpreso ? '#d4edda' : '#f8d7da'}; border-radius: 5px; font-size: 13px;">
                                ${qrImpreso ? '‚úÖ' : '‚è≥'} 
                                <span style="font-weight: 500;">QR</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 5px; padding: 5px 10px; background: ${rotuladoImpreso ? '#d4edda' : '#f8d7da'}; border-radius: 5px; font-size: 13px;">
                                ${rotuladoImpreso ? '‚úÖ' : '‚è≥'}
                                <span style="font-weight: 500;">üè∑Ô∏è ROTULADO</span>
                            </div>
                        </div>
                        
                        <div class="record-details">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 10px;">
                                <div>
                                    <div class="record-product">${registro.nombre_producto}</div>
                                    <div class="record-quantity">${registro.cantidad_productos} unidades</div>
                                    <div class="status-badge status-${registro.estado_solicitud}">
                                        ${getEstadoLabel(registro.estado_solicitud)}
                                    </div>
                                </div>
                                
                                <!-- Bot√≥n de editar con notita si hay observaciones -->
                                <button 
                                    onclick="abrirPopupObservaciones(${registro.id_solicitud}, '${escapeHtml(registro.observaciones || '')}', '${registro.nombre_producto}')"
                                    class="btn-edit-observaciones ${tieneObservaciones ? 'has-notes' : ''}"
                                    title="${tieneObservaciones ? 'Ver/Editar observaciones' : 'Agregar observaciones'}"
                                >
                                    üìù
                                    ${tieneObservaciones ? '<span class="notification-dot"></span>' : ''}
                                    <span class="btn-text">editar</span>
                                </button>
                            </div>
                        </div>
                        ${registro.creado_por_supervisor ? `
                            <div style="font-size: 12px; color: #666; margin-top: 8px;">
                                üìù Creado por supervisor: ${registro.supervisor_creador || 'Supervisor'}
                            </div>
                        ` : ''}
                        
                        <!-- Bot√≥n imprimir rotulado (solo si pendiente y no tiene rotulado impreso) -->
                        ${isPendiente && !rotuladoImpreso ? `
                            <div style="margin-top: 10px; display: flex; gap: 10px;">
                                <button 
                                    onclick="imprimirRotuladoRegistro(${registro.id_solicitud}, this)"
                                    style="flex: 1; padding: 8px 15px; background: linear-gradient(135deg, #f59e0b, #d97706); color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 500; font-size: 13px;"
                                >
                                    üè∑Ô∏è Imprimir Rotulado
                                </button>
                            </div>
                        ` : ''}
                    </div>
                `;
                }).join('');
                
            } catch (error) {
                console.error('Error cargando registros:', error);
                document.getElementById('records-container').innerHTML = 
                    '<div class="empty-state">Error cargando registros</div>';
            }
        }

        // Funci√≥n para actualizar registros manualmente
        async function refreshRecords() {
            const refreshBtn = document.getElementById('refresh-records-btn');
            const btnText = refreshBtn.innerHTML;
            
            try {
                // Mostrar animaci√≥n de actualizaci√≥n
                refreshBtn.innerHTML = 'üîÑ Actualizando...';
                refreshBtn.classList.add('refreshing');
                refreshBtn.disabled = true;
                
                // Recargar registros
                await loadRegistros();
                
                // Actualizar tambi√©n las estad√≠sticas del d√≠a
                await updateWorkStats();
                
                // Mostrar mensaje de √©xito temporal
                refreshBtn.innerHTML = '‚úÖ Actualizado';
                
                // Restaurar bot√≥n despu√©s de 2 segundos
                setTimeout(() => {
                    refreshBtn.innerHTML = btnText;
                    refreshBtn.classList.remove('refreshing');
                    refreshBtn.disabled = false;
                }, 2000);
                
            } catch (error) {
                console.error('Error actualizando registros:', error);
                refreshBtn.innerHTML = '‚ùå Error';
                
                setTimeout(() => {
                    refreshBtn.innerHTML = btnText;
                    refreshBtn.classList.remove('refreshing');
                    refreshBtn.disabled = false;
                }, 2000);
            }
        }

        // Obtener etiqueta de estado
        function getEstadoLabel(estado) {
            const labels = {
                'pendiente': 'Pendiente',
                'en_proceso': 'En Proceso',
                'completado': 'Completado',
                'rechazada': 'Rechazada'
            };
            return labels[estado] || estado;
        }

        // Cambiar tab
        function switchTab(tabName) {
            // Si es la tab de crear, mostrar popup de selecci√≥n
            if (tabName === 'crear') {
                document.getElementById('tipo-solicitud-popup').style.display = 'flex';
                return;
            }
            
            // Actualizar tabs
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            document.querySelector(`[onclick="switchTab('${tabName}')"]`).classList.add('active');
            document.getElementById(`${tabName}-tab`).classList.add('active');
            
            // Si cambia a registros, recargar
            if (tabName === 'registros') {
                loadRegistros();
                updateGreetingMessage(); // Actualizar mensaje personalizado
            } else if (tabName === 'chat') {
                if (!chatRefreshIntervalCosturera) {
                    initializeChatCosturera();
                }
            }
        }

        // Seleccionar tipo de solicitud
        function seleccionarTipoSolicitud(tipo) {
            // Cerrar popup
            document.getElementById('tipo-solicitud-popup').style.display = 'none';
            
            // Activar tab de crear
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            document.querySelector(`[onclick="switchTab('crear')"]`).classList.add('active');
            document.getElementById('crear-tab').classList.add('active');
            
            if (tipo === 'normal') {
                // Mostrar formulario normal, ocultar especial
                document.getElementById('form-producto-normal').style.display = 'block';
                document.getElementById('form-producto-especial').style.display = 'none';
            } else if (tipo === 'especial') {
                // Mostrar formulario especial, ocultar normal
                document.getElementById('form-producto-normal').style.display = 'none';
                document.getElementById('form-producto-especial').style.display = 'block';
                // Cargar productos especiales disponibles
                cargarProductosEspecialesDisponibles();
            }
        }

        // Volver al formulario normal
        function volverFormularioNormal() {
            document.getElementById('form-producto-especial').style.display = 'none';
            document.getElementById('form-producto-normal').style.display = 'block';
            // Limpiar formulario especial
            document.getElementById('nuevo-registro-especial-form').reset();
            document.getElementById('detalle-producto-especial').style.display = 'none';
        }

        // Cerrar popup de tipo de solicitud
        function cerrarPopupTipoSolicitud() {
            document.getElementById('tipo-solicitud-popup').style.display = 'none';
        }

        // ========== FUNCIONES PARA OBSERVACIONES ==========
        
        // Abrir popup de observaciones
        function abrirPopupObservaciones(idSolicitud, observacionesActuales, nombreProducto) {
            const popup = document.getElementById('popup-observaciones');
            const textarea = document.getElementById('observaciones-texto');
            const tituloProducto = document.getElementById('observaciones-producto');
            
            // Guardar el ID de solicitud actual
            popup.dataset.solicitudId = idSolicitud;
            
            // Actualizar contenido
            tituloProducto.textContent = nombreProducto;
            textarea.value = observacionesActuales || '';
            
            // Mostrar popup
            popup.style.display = 'flex';
            textarea.focus();
        }
        
        // Cerrar popup de observaciones
        function cerrarPopupObservaciones() {
            document.getElementById('popup-observaciones').style.display = 'none';
        }
        
        // Guardar observaciones
        async function guardarObservaciones() {
            const popup = document.getElementById('popup-observaciones');
            const textarea = document.getElementById('observaciones-texto');
            const idSolicitud = popup.dataset.solicitudId;
            const observaciones = textarea.value.trim();
            
            try {
                const response = await fetch(`/api/solicitudes/${idSolicitud}/observaciones`, {
                    method: 'PATCH',
                    headers: {
                        ...getAuthHeaders(),
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ observaciones })
                });
                
                if (!response.ok) {
                    throw new Error('Error al guardar observaciones');
                }
                
                // Cerrar popup
                cerrarPopupObservaciones();
                
                // Recargar registros para mostrar la notita actualizada
                await loadRegistros();
                
                // Mostrar mensaje de √©xito
                alert('‚úÖ Observaciones guardadas correctamente');
                
            } catch (error) {
                console.error('Error guardando observaciones:', error);
                alert('‚ùå Error al guardar observaciones');
            }
        }

        // ========== FIN FUNCIONES OBSERVACIONES ==========

        // Actualizar estilo de prioridad para formulario especial
        function updatePriorityStyleEspecial() {
            const select = document.getElementById('prioridad-especial');
            const value = select.value;
            
            select.className = `form-select priority-select priority-${value}`;
        }

        // Actualizar estilo de prioridad
        function updatePriorityStyle() {
            const select = document.getElementById('prioridad');
            const value = select.value;
            
            select.className = `form-select priority-select priority-${value}`;
        }

        // ========== FUNCIONES PARA MODAL DE VISUALIZACI√ìN ==========
        
        function openPreviewModal(isEspecial) {
            const modal = document.getElementById('preview-modal');
            modal.style.display = 'flex';
            
            // Renderizar vistas previas
            setTimeout(() => {
                renderPreviewEtiqueta(isEspecial);
                renderPreviewRotulado(isEspecial);
            }, 100);
        }

        function closePreviewModal() {
            document.getElementById('preview-modal').style.display = 'none';
        }

        function renderPreviewEtiqueta(isEspecial) {
            const canvas = document.getElementById('preview-canvas-etiqueta');
            const ctx = canvas.getContext('2d');
            
            // Limpiar canvas
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Obtener datos del formulario
            let nombreProducto, codigoProducto, lote, empresa, modelo, unidadMedida, idProducto;
            
            if (isEspecial) {
                // Para productos especiales
                const productoSelect = document.getElementById('producto-especial-select');
                if (productoSelect && productoSelect.selectedIndex >= 0) {
                    const selectedOption = productoSelect.options[productoSelect.selectedIndex];
                    nombreProducto = selectedOption.text || 'PRODUCTO ESPECIAL';
                    
                    // Buscar producto en el array de productos especiales
                    const productoId = selectedOption.value;
                    const productoData = productosEspecialesDisponibles?.find(p => p.id_producto_especial == productoId);
                    
                    if (productoData) {
                        idProducto = productoData.id_producto_especial;
                        codigoProducto = productoData.codigo_producto || '000000';
                        modelo = productoData.descripcion_corta || 'PRODUCTO TEXTIL';
                        unidadMedida = productoData.unidad_medida || 'UNIDAD';
                    } else {
                        idProducto = '000000';
                        codigoProducto = '000000';
                        modelo = 'PRODUCTO TEXTIL';
                        unidadMedida = 'UNIDAD';
                    }
                } else {
                    nombreProducto = 'SELECCIONE UN PRODUCTO';
                    idProducto = '000000';
                    codigoProducto = '000000';
                    modelo = 'PRODUCTO TEXTIL';
                    unidadMedida = 'UNIDAD';
                }
                const loteInput = document.getElementById('lote-especial');
                const empresaSelect = document.getElementById('empresa-especial');
                lote = loteInput ? loteInput.value || 'LOTE-001' : 'LOTE-001';
                empresa = empresaSelect ? empresaSelect.value || 'HECHO EN PERU' : 'HECHO EN PERU';
            } else {
                // Para productos normales
                const productoInput = document.getElementById('producto');
                const productoInputValue = productoInput ? productoInput.value : '';
                
                // Buscar producto en el array de productos por nombre
                const productoData = productos?.find(p => p.nombre_producto === productoInputValue);
                
                if (productoData) {
                    // Usar solo el nombre del producto sin el c√≥digo
                    nombreProducto = productoData.nombre_producto;
                    idProducto = productoData.id_producto;
                    codigoProducto = productoData.codigo_producto || '000000';
                    modelo = productoData.modelo || productoData.descripcion_corta || 'PRODUCTO TEXTIL';
                    unidadMedida = productoData.unidad_medida || 'UNIDAD';
                } else {
                    nombreProducto = 'SELECCIONE UN PRODUCTO';
                    idProducto = '000000';
                    codigoProducto = '000000';
                    modelo = 'PRODUCTO TEXTIL';
                    unidadMedida = 'UNIDAD';
                }
                
                const loteInput = document.getElementById('lote');
                const empresaSelect = document.getElementById('empresa');
                lote = loteInput ? loteInput.value || 'LOTE-001' : 'LOTE-001';
                empresa = empresaSelect ? empresaSelect.value || 'HECHO EN PERU' : 'HECHO EN PERU';
            }
            
            // Formatear ID con padding
            const formattedId = idProducto.toString().padStart(6, '0');
            
            // === DIBUJAR MARCO NEGRO EXTERNO (como en la imagen) ===
            ctx.strokeStyle = '#000000';
            ctx.lineWidth = 4;
            ctx.strokeRect(2, 2, canvas.width - 4, canvas.height - 4);
            
            // Dividir nombre en dos l√≠neas (m√°ximo 28 caracteres por l√≠nea - actualizado)
            const palabras = nombreProducto.split(' ');
            let linea1 = '';
            let linea2 = '';
            let lineaActual = 1;
            
            palabras.forEach(palabra => {
                if (lineaActual === 1) {
                    if ((linea1 + ' ' + palabra).trim().length <= 28) {
                        linea1 = (linea1 + ' ' + palabra).trim();
                    } else {
                        lineaActual = 2;
                        linea2 = palabra;
                    }
                } else {
                    if ((linea2 + ' ' + palabra).trim().length <= 28) {
                        linea2 = (linea2 + ' ' + palabra).trim();
                    }
                }
            });
            
            // === DIBUJAR C√ìDIGO QR (izquierda) ===
            const qrSize = 140;
            const qrX = 15;
            const qrY = 40;
            
            // Marco negro del QR
            ctx.fillStyle = '#000000';
            ctx.fillRect(qrX, qrY, qrSize, qrSize);
            
            // Fondo blanco interno
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(qrX + 8, qrY + 8, qrSize - 16, qrSize - 16);
            
            // Patr√≥n QR simulado (m√°s denso y realista)
            ctx.fillStyle = '#000000';
            const cellSize = 8;
            const qrCells = Math.floor((qrSize - 16) / cellSize);
            
            for (let i = 0; i < qrCells; i++) {
                for (let j = 0; j < qrCells; j++) {
                    // Crear patr√≥n m√°s realista con esquinas fijas
                    const isCorner = (i < 3 && j < 3) || (i < 3 && j >= qrCells - 3) || (i >= qrCells - 3 && j < 3);
                    const shouldFill = isCorner || Math.random() > 0.5;
                    
                    if (shouldFill) {
                        ctx.fillRect(qrX + 8 + i * cellSize, qrY + 8 + j * cellSize, cellSize - 1, cellSize - 1);
                    }
                }
            }
            
            // Marcadores de esquina del QR (cuadrados grandes en 3 esquinas)
            const markerSize = 24;
            // Esquina superior izquierda
            ctx.fillStyle = '#000000';
            ctx.fillRect(qrX + 12, qrY + 12, markerSize, markerSize);
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(qrX + 16, qrY + 16, markerSize - 8, markerSize - 8);
            ctx.fillStyle = '#000000';
            ctx.fillRect(qrX + 20, qrY + 20, markerSize - 16, markerSize - 16);
            
            // Esquina superior derecha
            ctx.fillStyle = '#000000';
            ctx.fillRect(qrX + qrSize - 36, qrY + 12, markerSize, markerSize);
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(qrX + qrSize - 32, qrY + 16, markerSize - 8, markerSize - 8);
            ctx.fillStyle = '#000000';
            ctx.fillRect(qrX + qrSize - 28, qrY + 20, markerSize - 16, markerSize - 16);
            
            // Esquina inferior izquierda
            ctx.fillStyle = '#000000';
            ctx.fillRect(qrX + 12, qrY + qrSize - 36, markerSize, markerSize);
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(qrX + 16, qrY + qrSize - 32, markerSize - 8, markerSize - 8);
            ctx.fillStyle = '#000000';
            ctx.fillRect(qrX + 20, qrY + qrSize - 28, markerSize - 16, markerSize - 16);
            
            // === INFORMACI√ìN DEL PRODUCTO (derecha del QR) ===
            const textX = 200;
            let textY = 30;
            
            ctx.fillStyle = '#000000';
            ctx.textAlign = 'left';
            ctx.textBaseline = 'top';
            
            // Nombre del producto (2 l√≠neas, fuente 24px)
            ctx.font = 'bold 18px Arial';
            ctx.fillText(linea1.toUpperCase(), textX, textY);
            if (linea2) {
                ctx.fillText(linea2.toUpperCase(), textX, textY + 24);
            }
            
            textY = 112;
            
            // Modelo/Descripci√≥n (fuente 28px)
            ctx.font = 'bold 20px Arial';
            ctx.fillText(modelo.toUpperCase(), textX, textY);
            
            textY = 139;
            
            // Unidad de Medida (fuente 18px)
            ctx.font = '14px Arial';
            ctx.fillText('UM: ' + unidadMedida, textX, textY);
            
            textY = 159;
            
            // ID del Producto (fuente 18px)
            ctx.fillText('ID: ' + formattedId, textX, textY);
            
            textY = 179;
            
            // Empresa (fuente 18px, puede tener word wrap)
            ctx.font = 'bold 14px Arial';
            wrapText(ctx, empresa.toUpperCase(), textX, textY, 180, 18);
        }

        function renderPreviewRotulado(isEspecial) {
            const canvas = document.getElementById('preview-canvas-rotulado');
            const ctx = canvas.getContext('2d');
            
            // Limpiar canvas
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Obtener datos del producto
            let subcategoria, marca, modelo;
            
            if (isEspecial) {
                const productoSelect = document.getElementById('producto-especial-select');
                if (productoSelect && productoSelect.selectedIndex >= 0) {
                    const productoId = selectedOption.value;
                    const productoData = productosEspecialesDisponibles?.find(p => p.id_producto_especial == productoId);
                    
                    if (productoData) {
                        subcategoria = productoData.subcategoria || productoData.descripcion_corta || 'PRODUCTO';
                        marca = productoData.marca || '';
                        modelo = productoData.modelo || '';
                    } else {
                        subcategoria = 'PRODUCTO';
                        marca = '';
                        modelo = '';
                    }
                } else {
                    subcategoria = 'PRODUCTO';
                    marca = '';
                    modelo = '';
                }
            } else {
                const productoInput = document.getElementById('producto');
                const productoInputValue = productoInput ? productoInput.value : '';
                
                const productoData = productos?.find(p => p.nombre_producto === productoInputValue);
                
                if (productoData) {
                    // Usar SUBCATEGORIA para el rotulado (ALMOHADA, COBERTOR, SABANA, etc)
                    subcategoria = productoData.subcategoria || productoData.descripcion_corta || 'PRODUCTO';
                    marca = productoData.marca || '';  // Tipo de tela (BP, TC, etc)
                    modelo = productoData.modelo || ''; // Tama√±o (1.5P, Queen, King, etc)
                } else {
                    subcategoria = 'PRODUCTO';
                    marca = '';
                    modelo = '';
                }
            }
            
            // === DISE√ëO DEL ROTULADO (3cm x 5cm = 236x394 dots) ===
            
            // Dibujar marco exterior
            ctx.strokeStyle = '#000000';
            ctx.lineWidth = 3;
            ctx.strokeRect(3, 3, canvas.width - 6, canvas.height - 6);
            
            let currentY = 20;
            
            // === SECCI√ìN 1: LOGO CAMITEX ===
            // Simular logo con texto estilizado
            ctx.fillStyle = '#2563eb'; // Azul Camitex
            ctx.font = 'bold 24px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('CAMITEX', canvas.width / 2, currentY + 20);
            
            ctx.font = '12px Arial';
            ctx.fillStyle = '#666666';
            ctx.fillText('Ropa de Cama', canvas.width / 2, currentY + 38);
            
            // L√≠nea divisoria
            currentY += 55;
            ctx.strokeStyle = '#cccccc';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(15, currentY);
            ctx.lineTo(canvas.width - 15, currentY);
            ctx.stroke();
            
            currentY += 15;
            
            // === SECCI√ìN 2: SUBCATEGOR√çA (TIPO DE PRODUCTO) ===
            ctx.fillStyle = '#000000';
            ctx.font = 'bold 22px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(subcategoria.toUpperCase(), canvas.width / 2, currentY);
            
            currentY += 35;
            
            // === SECCI√ìN 3: TELA (MARCA) ===
            if (marca) {
                ctx.font = '14px Arial';
                ctx.fillStyle = '#333333';
                ctx.fillText('TELA: ' + marca.toUpperCase(), canvas.width / 2, currentY);
                currentY += 25;
            }
            
            // === SECCI√ìN 4: TAMA√ëO (MODELO) ===
            if (modelo) {
                ctx.font = 'bold 16px Arial';
                ctx.fillStyle = '#000000';
                ctx.fillText('TAMA√ëO: ' + modelo.toUpperCase(), canvas.width / 2, currentY);
                currentY += 30;
            }
            
            // === SECCI√ìN 5: ICONOS DE LAVADO (simulados) ===
            ctx.font = '14px Arial';
            ctx.fillStyle = '#666666';
            ctx.fillText('[30¬∞] [‚úó] [@] [‚Äî] [‚úó]', canvas.width / 2, currentY);
            currentY += 25;
            
            // === SECCI√ìN 6: ORIGEN ===
            ctx.font = 'bold 12px Arial';
            ctx.fillStyle = '#16a34a'; // Verde para destacar
            const empresaSelect = isEspecial ? 
                document.getElementById('empresa-especial') : 
                document.getElementById('empresa');
            const empresa = empresaSelect ? empresaSelect.value : 'HECHO EN PERU';
            ctx.fillText(empresa.toUpperCase(), canvas.width / 2, currentY);
            
            // Resetear alineaci√≥n
            ctx.textAlign = 'left';
        }

        function wrapText(ctx, text, x, y, maxWidth, lineHeight) {
            const words = text.split(' ');
            let line = '';
            let currentY = y;

            for (let i = 0; i < words.length; i++) {
                const testLine = line + words[i] + ' ';
                const metrics = ctx.measureText(testLine);
                const testWidth = metrics.width;

                if (testWidth > maxWidth && i > 0) {
                    ctx.fillText(line, x, currentY);
                    line = words[i] + ' ';
                    currentY += lineHeight;
                } else {
                    line = testLine;
                }
            }
            ctx.fillText(line, x, currentY);
        }

        // ========== FIN FUNCIONES VISUALIZACI√ìN ==========

        // ========== FUNCIONES ROTULADO GODEX ==========
        
        // Toggle auto-impresi√≥n Godex
        // ========== FUNCIONES ROTULADO GODEX ==========
        
        // Toggle Auto-impresi√≥n Godex (Rotulado)
        async function toggleAutoServicesGD() {
            const toggle = document.getElementById('toggle-auto-servicesgd');
            const isActive = toggle.checked;
            
            try {
                const userId = currentCostureraId || currentUser.id_usuario;
                const response = await fetch(`/api/usuarios/${userId}/auto-servicesgd`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        ...getAuthHeaders()
                    },
                    body: JSON.stringify({ auto_servicesgd: isActive })
                });
                
                if (!response.ok) {
                    throw new Error('Error al actualizar configuraci√≥n');
                }
                
                if (isActive) {
                    showSuccess('‚úÖ Rotulado Godex: SE IMPRIMIR√Å autom√°ticamente junto con las etiquetas QR');
                } else {
                    showSuccess('‚ÑπÔ∏è Rotulado Godex: DESACTIVADO (solo etiquetas QR)');
                }
                
            } catch (error) {
                console.error('Error cambiando modo auto-servicesgd:', error);
                toggle.checked = !isActive; // Revertir
                showError('‚ùå Error al cambiar configuraci√≥n');
            }
        }
        
        // Imprimir rotulado de un registro espec√≠fico
        async function imprimirRotuladoRegistro(idSolicitud, btnElement) {
            const btnText = btnElement.innerHTML;
            
            try {
                btnElement.disabled = true;
                btnElement.innerHTML = 'üñ®Ô∏è Imprimiendo...';
                
                // üî™ Obtener estado de guillotina autom√°tica (default: true)
                const estadoGuardado = localStorage.getItem('corteAutomaticoActivado');
                const corteActivado = estadoGuardado === null ? true : estadoGuardado === 'true';
                console.log(`üî™ Imprimiendo con corte: ${corteActivado ? 'ACTIVADO' : 'DESACTIVADO'}`);
                
                const response = await fetch(`/api/registros/${idSolicitud}/imprimir-rotulado`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...getAuthHeaders()
                    },
                    body: JSON.stringify({
                        conCorte: corteActivado // üî™ Enviar configuraci√≥n de corte
                    })
                });
                
                if (handleAuthError(response)) {
                    btnElement.disabled = false;
                    btnElement.innerHTML = btnText;
                    return; // Manejar sesi√≥n expirada
                }
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Error al imprimir');
                }
                
                const data = await response.json();
                showSuccess(`‚úÖ ${data.mensaje}`);
                
                // Recargar registros despu√©s de 1 segundo
                setTimeout(() => {
                    loadRegistros();
                }, 1000);
                
            } catch (error) {
                console.error('Error imprimiendo rotulado:', error);
                showError('‚ùå ' + error.message);
                btnElement.disabled = false;
                btnElement.innerHTML = btnText;
            }
        }
        
        // ========== FIN FUNCIONES ROTULADO GODEX ==========

        // Toggle informaci√≥n de cantidad
        function toggleCantidadInfo() {
            const infoDiv = document.getElementById('cantidad-info');
            if (infoDiv.style.display === 'none' || infoDiv.style.display === '') {
                infoDiv.style.display = 'block';
            } else {
                infoDiv.style.display = 'none';
            }
        }

        // Manejar env√≠o de formulario
        document.getElementById('nuevo-registro-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const selectedProductId = getSelectedProductId();
            
            if (!selectedProductId) {
                showError('Por favor selecciona un producto v√°lido de la lista');
                return;
            }
            
            // üî™ Obtener estado del toggle de corte
            const corteActivado = document.getElementById('corte-automatico-toggle').checked;
            
            // üè∑Ô∏è Obtener opciones de rotulado Godex
            const logoRotulado = document.getElementById('logo-rotulado').value;
            const logoSecundario = document.getElementById('logo-secundario').value;
            const logosAdvertencia = document.getElementById('logos-advertencia').value;
            
            const formData = {
                id_producto: selectedProductId,
                cantidad_productos: parseInt(document.getElementById('cantidad').value),
                prioridad: document.getElementById('prioridad').value,
                observaciones: document.getElementById('observaciones').value.trim(),
                empresa: document.getElementById('empresa').value,
                id_usuario_costurera: currentCostureraId,
                es_supervisor: isSupervisor && currentCostureraId !== currentUser.id,
                conCorte: corteActivado, // üî™ Enviar configuraci√≥n de corte
                // üè∑Ô∏è Opciones de rotulado
                logoPrincipal: logoRotulado, // 'camitex', 'algodon_100', 'maxima_suavidad', 'producto_peruano', 'sin_logo'
                conLogoMisti: logoSecundario === 'con_logo',
                conIconos: logosAdvertencia === 'con_iconos'
            };
            
            const submitBtn = document.getElementById('submit-btn');
            submitBtn.disabled = true;
            submitBtn.textContent = '‚è≥ Creando solicitud...';
            
            try {
                const response = await fetch('/api/crear-solicitud', {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showSuccess(`‚úÖ Solicitud creada: ${result.solicitud.numero_solicitud}`);
                    document.getElementById('nuevo-registro-form').reset();
                    updatePriorityStyle();
                    
                    // üîÑ Recargar registros inmediatamente para mostrar el badge verde
                    await loadRegistros();
                    
                    // Cambiar a tab de registros despu√©s de 2 segundos
                    setTimeout(() => {
                        switchTab('registros');
                    }, 2000);
                    
                } else {
                    showError(result.error || 'Error creando solicitud');
                }
                
            } catch (error) {
                console.error('Error creando solicitud:', error);
                showError('Error de conexi√≥n');
            } finally {
                submitBtn.disabled = false;
                // Restaurar texto del bot√≥n seg√∫n auto_services
                await updateSubmitButtonText();
            }
        });

        // Mostrar mensaje de √©xito
        function showSuccess(message) {
            const successDiv = document.getElementById('success-message');
            successDiv.textContent = message;
            successDiv.style.display = 'block';
            
            setTimeout(() => {
                successDiv.style.display = 'none';
            }, 5000);
        }

        // Mostrar mensaje de error
        function showError(message) {
            const errorDiv = document.getElementById('error-message');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        // ===== FUNCIONES PARA PRODUCTOS ESPECIALES (JUEGOS/COMBOS) =====

        // Cargar lista de productos especiales disponibles
        async function cargarProductosEspecialesDisponibles() {
            try {
                const response = await fetch('/api/productos-especiales', {
                    headers: getAuthHeaders()
                });
                
                if (!response.ok) {
                    throw new Error('Error al cargar productos especiales');
                }
                
                const result = await response.json();
                productosEspecialesDisponibles = Array.isArray(result) ? result : [];
                
                // Llenar datalist
                const datalist = document.getElementById('productos-especiales-list');
                datalist.innerHTML = productosEspecialesDisponibles.map(pe => 
                    `<option value="${pe.codigo_producto} - ${pe.nombre_producto}" data-id="${pe.id_producto_especial}">`
                ).join('');
                
                console.log(`‚úÖ ${productosEspecialesDisponibles.length} productos especiales cargados`);
                console.log('Productos:', productosEspecialesDisponibles);
                
            } catch (error) {
                console.error('Error cargando productos especiales:', error);
                showError('Error al cargar productos especiales');
            }
        }

        // Detectar selecci√≥n de producto especial y mostrar componentes
        document.addEventListener('DOMContentLoaded', () => {
            const inputEspecial = document.getElementById('producto-especial');
            
            inputEspecial.addEventListener('change', async function() {
                const value = this.value.trim();
                
                // Buscar el producto especial seleccionado
                const productoEncontrado = productosEspecialesDisponibles.find(pe => 
                    `${pe.codigo_producto} - ${pe.nombre_producto}` === value
                );
                
                if (productoEncontrado) {
                    productoEspecialSeleccionado = productoEncontrado;
                    await mostrarComponentesProductoEspecial(productoEncontrado.id_producto_especial);
                } else {
                    productoEspecialSeleccionado = null;
                    document.getElementById('detalle-producto-especial').style.display = 'none';
                }
            });
        });

        // Mostrar componentes de un producto especial
        async function mostrarComponentesProductoEspecial(idProductoEspecial) {
            try {
                const response = await fetch(`/api/productos-especiales/${idProductoEspecial}/componentes`, {
                    headers: getAuthHeaders()
                });
                
                if (!response.ok) {
                    throw new Error('Error al cargar componentes');
                }
                
                const result = await response.json();
                const componentes = result.componentes || [];
                
                const componentesHTML = componentes.map(comp => `
                    <div style="display: flex; align-items: center; gap: 10px; padding: 8px; background: white; border-radius: 6px; margin-bottom: 8px;">
                        <span style="font-size: 20px;">üì¶</span>
                        <div style="flex: 1;">
                            <strong>${comp.codigo_producto}</strong> - ${comp.nombre_producto}
                        </div>
                        <span style="background: #667eea; color: white; padding: 4px 12px; border-radius: 20px; font-size: 13px; font-weight: bold;">
                            x${comp.cantidad}
                        </span>
                    </div>
                `).join('');
                
                document.getElementById('componentes-lista').innerHTML = componentesHTML;
                document.getElementById('detalle-producto-especial').style.display = 'block';
                
            } catch (error) {
                console.error('Error mostrando componentes:', error);
                showError('Error al cargar componentes del producto especial');
            }
        }

        // Manejar env√≠o de formulario de producto especial
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('nuevo-registro-especial-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                if (!productoEspecialSeleccionado) {
                    showError('Por favor selecciona un producto especial v√°lido de la lista');
                    return;
                }
                
                const formData = {
                    id_producto_especial: productoEspecialSeleccionado.id_producto_especial,
                    cantidad_juegos: parseInt(document.getElementById('cantidad-especial').value),
                    prioridad: document.getElementById('prioridad-especial').value,
                    observaciones: document.getElementById('observaciones-especial').value.trim(),
                    empresa: document.getElementById('empresa-especial').value,
                    id_usuario_costurera: currentCostureraId,
                    es_supervisor: isSupervisor && currentCostureraId !== currentUser.id
                };
                
                const submitBtn = document.getElementById('submit-btn-especial');
                submitBtn.disabled = true;
                submitBtn.textContent = '‚è≥ Creando solicitud especial...';
                
                try {
                    const response = await fetch('/api/crear-solicitud-especial', {
                        method: 'POST',
                        headers: getAuthHeaders(),
                        body: JSON.stringify(formData)
                    });
                    
                    const result = await response.json();
                    
                    if (response.ok) {
                        showSuccess(`‚úÖ Solicitud especial creada: ${result.solicitud.numero_solicitud}`);
                        document.getElementById('nuevo-registro-especial-form').reset();
                        document.getElementById('detalle-producto-especial').style.display = 'none';
                        productoEspecialSeleccionado = null;
                        updatePriorityStyleEspecial();
                        
                        // Cambiar a tab de registros despu√©s de 2 segundos
                        setTimeout(() => {
                            switchTab('registros');
                        }, 2000);
                        
                    } else {
                        showError(result.error || 'Error creando solicitud especial');
                    }
                    
                } catch (error) {
                    console.error('Error creando solicitud especial:', error);
                    showError('Error de conexi√≥n');
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'üè∑Ô∏è Solicitar Etiquetas para JUEGO/COMBO';
                }
            });
        });

        // Logout
        function logout() {
            localStorage.removeItem('currentUser');
            window.location.href = '/login';
        }

        // Volver al modo supervisor
        function backToSupervisor() {
            if (isSupervisor) {
                window.location.href = '/supervisor-dashboard.html';
            }
        }

        // Funciones para modal de contrase√±a (por implementar si es necesario)
        function closePasswordModal() {
            document.getElementById('password-modal').classList.remove('show');
            pendingChanges = null;
        }

        // Manejar env√≠o del formulario de contrase√±a de supervisor
        function handleSupervisorPasswordSubmit(event) {
            event.preventDefault(); // Prevenir recarga de p√°gina
            confirmChanges();
        }

        function confirmChanges() {
            // Implementar l√≥gica de confirmaci√≥n con contrase√±a
            closePasswordModal();
        }

        // === CHAT FUNCTIONS FOR COSTURERAS ===

        let currentChannelCosturera = null;
        let chatRefreshIntervalCosturera = null;
        let lastMessageIdCosturera = null;

        // Initialize chat system for costureras
        function initializeChatCosturera() {
            loadChatChannelsCosturera();
            loadOnlineUsersCosturera();
            updateUserStatusCosturera();
            
            // Set up periodic updates
            chatRefreshIntervalCosturera = setInterval(() => {
                if (currentChannelCosturera) {
                    loadChatMessagesCosturera(true); // Silent refresh
                }
                loadOnlineUsersCosturera();
                updateNotificationBadgeCosturera();
            }, 15000); // Update every 15 seconds

            // Handle status changes
            document.getElementById('status-selector-costurera').addEventListener('change', updateUserStatusCosturera);
            
            // Set current user name
            document.getElementById('current-user-name-costurera').textContent = 
                currentUser?.nombre_completo || 'Usuario';
        }

        // Load chat channels for costureras
        async function loadChatChannelsCosturera() {
            try {
                const response = await fetch('/api/chat/canales', {
                    headers: getAuthHeaders()
                });

                if (response.ok) {
                    const canales = await response.json();
                    displayChannelsCosturera(canales);
                }
            } catch (error) {
                console.error('Error loading channels:', error);
            }
        }

        // Display channels in sidebar
        function displayChannelsCosturera(canales) {
            const container = document.getElementById('channels-list-costurera');
            
            container.innerHTML = canales.map(canal => `
                <div class="channel-item-costurera" onclick="selectChannelCosturera(${canal.id_canal}, '${canal.nombre_canal}')" data-channel="${canal.id_canal}">
                    <div class="channel-name-costurera">
                        <span>${getChannelIconCosturera(canal.tipo_canal)} ${canal.nombre_canal}</span>
                    </div>
                    ${canal.mensajes_no_leidos > 0 ? 
                        `<span class="notification-badge">${canal.mensajes_no_leidos}</span>` : 
                        ''
                    }
                </div>
            `).join('');
        }

        // Get icon for channel type
        function getChannelIconCosturera(tipo) {
            switch (tipo) {
                case 'general': return 'üåê';
                case 'departamento': return 'üè¢';
                case 'privado': return 'üîí';
                default: return 'üí¨';
            }
        }

        // Select a channel
        function selectChannelCosturera(channelId, channelName) {
            // Remove active class from all channels
            document.querySelectorAll('.channel-item-costurera').forEach(item => {
                item.classList.remove('active');
            });
            
            // Add active class to selected channel
            const channelElement = document.querySelector(`[data-channel="${channelId}"]`);
            if (channelElement) {
                channelElement.classList.add('active');
            }
            
            currentChannelCosturera = channelId;
            document.getElementById('current-channel-name-costurera').textContent = channelName;
            document.getElementById('chat-input-container-costurera').style.display = 'block';
            
            loadChatMessagesCosturera();
            markChannelAsReadCosturera(channelId);
        }

        // Load messages for current channel
        async function loadChatMessagesCosturera(silent = false) {
            if (!currentChannelCosturera) return;
            
            try {
                const response = await fetch(`/api/chat/canales/${currentChannelCosturera}/mensajes?limit=30`, {
                    headers: getAuthHeaders()
                });

                if (response.ok) {
                    const data = await response.json();
                    displayMessagesCosturera(data.mensajes, silent);
                }
            } catch (error) {
                if (!silent) {
                    console.error('Error loading messages:', error);
                }
            }
        }

        // Display messages in chat
        function displayMessagesCosturera(mensajes, silent = false) {
            const container = document.getElementById('chat-messages-costurera');
            const currentUserId = currentUser?.id_usuario;
            
            if (mensajes.length === 0) {
                container.innerHTML = '<div class="welcome-message-costurera"><p>No hay mensajes en este canal. ¬°S√© la primera en escribir!</p></div>';
                return;
            }

            const shouldScrollToBottom = !silent || (container.scrollTop + container.clientHeight >= container.scrollHeight - 10);
            
            container.innerHTML = mensajes.map(mensaje => {
                const isOwn = mensaje.id_usuario === currentUserId;
                const messageClass = isOwn ? 'message-costurera own' : 
                                   mensaje.tipo_mensaje === 'sistema' ? 'message-costurera system' : 'message-costurera';
                
                return `
                    <div class="${messageClass}" data-message-id="${mensaje.id_mensaje}">
                        ${mensaje.tipo_mensaje !== 'sistema' ? `
                            <div class="message-header-costurera">
                                <span class="message-author-costurera">${mensaje.nombre_completo}</span>
                                <span class="message-time-costurera">${formatMessageTimeCosturera(mensaje.fecha_mensaje)}</span>
                            </div>
                        ` : ''}
                        <div class="message-content-costurera">${mensaje.mensaje}</div>
                    </div>
                `;
            }).join('');
            
            if (shouldScrollToBottom) {
                container.scrollTop = container.scrollHeight;
            }
            
            // Update last message ID
            if (mensajes.length > 0) {
                lastMessageIdCosturera = mensajes[mensajes.length - 1].id_mensaje;
            }
        }

        // Format message timestamp
        function formatMessageTimeCosturera(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diffInHours = (now - date) / (1000 * 60 * 60);
            
            if (diffInHours < 24) {
                return date.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
            } else if (diffInHours < 48) {
                return 'Ayer ' + date.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
            } else {
                return date.toLocaleDateString('es-ES', { month: 'short', day: 'numeric' }) + 
                       ' ' + date.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
            }
        }

        // Send message
        async function sendMessageCosturera() {
            if (!currentChannelCosturera) return;
            
            const input = document.getElementById('message-input-costurera');
            const message = input.value.trim();
            
            if (!message) return;
            
            try {
                const response = await fetch(`/api/chat/canales/${currentChannelCosturera}/mensajes`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({ mensaje: message })
                });

                if (response.ok) {
                    input.value = '';
                    loadChatMessagesCosturera(); // Refresh messages
                } else {
                    showAlert('Error enviando mensaje', 'error');
                }
            } catch (error) {
                console.error('Error sending message:', error);
                showAlert('Error de conexi√≥n al enviar mensaje', 'error');
            }
        }

        // Handle keypress in message input
        function handleMessageKeypressCosturera(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessageCosturera();
            }
        }

        // Load online users
        async function loadOnlineUsersCosturera() {
            try {
                const response = await fetch('/api/chat/usuarios-en-linea', {
                    headers: getAuthHeaders()
                });

                if (response.ok) {
                    const usuarios = await response.json();
                    displayOnlineUsersCosturera(usuarios);
                }
            } catch (error) {
                console.error('Error loading online users:', error);
            }
        }

        // Display online users
        function displayOnlineUsersCosturera(usuarios) {
            const container = document.getElementById('online-users-list-costurera');
            const count = document.getElementById('online-count-costurera');
            
            count.textContent = usuarios.length;
            
            container.innerHTML = usuarios.map(usuario => `
                <div class="user-item-costurera">
                    <div class="channel-name-costurera">
                        <span class="status-indicator status-${getStatusClassCosturera(usuario.estado)}"></span>
                        <span>${usuario.nombre_completo}</span>
                    </div>
                    <small>${usuario.departamento}</small>
                </div>
            `).join('');
        }

        // Get status CSS class
        function getStatusClassCosturera(estado) {
            switch (estado) {
                case 'en_linea': return 'online';
                case 'ausente': return 'away';
                case 'ocupado': return 'busy';
                default: return 'offline';
            }
        }

        // Update user status
        async function updateUserStatusCosturera() {
            const statusSelector = document.getElementById('status-selector-costurera');
            const statusIndicator = document.getElementById('current-user-status-costurera');
            const estado = statusSelector.value;
            
            try {
                const response = await fetch('/api/chat/estado', {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({ estado })
                });

                if (response.ok) {
                    statusIndicator.className = `status-indicator status-${getStatusClassCosturera(estado)}`;
                }
            } catch (error) {
                console.error('Error updating status:', error);
            }
        }

        // Update notification badge
        async function updateNotificationBadgeCosturera() {
            try {
                // Obtener userId de m√∫ltiples fuentes
                const urlParams = new URLSearchParams(window.location.search);
                let userId = urlParams.get('user');
                
                // Si no est√° en URL, intentar desde localStorage
                if (!userId) {
                    const userData = JSON.parse(localStorage.getItem('userData') || '{}');
                    userId = userData.id_usuario;
                }
                
                // Si a√∫n no hay userId, intentar currentUser
                if (!userId) {
                    const currentUser = JSON.parse(localStorage.getItem('currentUser') || '{}');
                    userId = currentUser.id_usuario;
                }
                
                if (!userId) {
                    console.log('No se pudo obtener userId para notificaciones');
                    return;
                }
                
                const response = await fetch(`/api/chat/no-leidos?userId=${userId}`);

                if (response.ok) {
                    const data = await response.json();
                    const totalNoLeidos = data.total || 0;
                    
                    const badge = document.getElementById('chat-badge-costurera');
                    if (totalNoLeidos > 0) {
                        badge.textContent = totalNoLeidos;
                        badge.style.display = 'inline';
                    } else {
                        badge.style.display = 'none';
                    }
                }
            } catch (error) {
                console.error('Error updating notification badge:', error);
            }
        }

        // Mark channel as read
        async function markChannelAsReadCosturera(channelId) {
            try {
                await fetch(`/api/chat/canales/${channelId}/marcar-leido`, {
                    method: 'POST',
                    headers: getAuthHeaders()
                });
                
                updateNotificationBadgeCosturera();
                loadChatChannelsCosturera(); // Refresh channel list to update badges
            } catch (error) {
                console.error('Error marking as read:', error);
            }
        }

        // Clean up chat when leaving
        window.addEventListener('beforeunload', () => {
            if (chatRefreshIntervalCosturera) {
                clearInterval(chatRefreshIntervalCosturera);
            }
        });

        // ============================================
        // CYCLICAL THEME SWITCHER (DESHABILITADO)
        // ============================================
        // Bot√≥n eliminado del header - Solo usar bot√≥n flotante
        
        // Cargar tema guardado al iniciar
        window.addEventListener('DOMContentLoaded', () => {
            // Remover clase dark-mode para no interferir con nuevo sistema
            document.body.classList.remove('dark-mode');
            
            // üîÑ Iniciar sistema de auto-reload
            iniciarAutoReload();
        });

        // ============================================
        // üîÑ SISTEMA DE AUTO-RELOAD (POLLING)
        // ============================================
        let lastStatsCheck = null;
        let autoReloadInterval = null;

        async function verificarCambios() {
            try {
                const response = await fetch('/api/stats-rapidas', {
                    method: 'GET',
                    headers: getAuthHeaders()
                });
                
                if (!response.ok) return;
                
                const stats = await response.json();
                
                // Si es la primera vez, solo guardar
                if (lastStatsCheck === null) {
                    lastStatsCheck = stats;
                    console.log('üìä Stats iniciales:', stats);
                    return;
                }
                
                // Verificar si hay cambios
                const cambiosDetectados = 
                    stats.pendientes !== lastStatsCheck.pendientes ||
                    stats.en_proceso !== lastStatsCheck.en_proceso ||
                    stats.completadas !== lastStatsCheck.completadas;
                
                if (cambiosDetectados) {
                    console.log('üîÑ Cambios detectados! Recargando registros...');
                    console.log('Anterior:', lastStatsCheck);
                    console.log('Nuevo:', stats);
                    
                    // Recargar registros autom√°ticamente
                    await loadRegistros();
                    await updateWorkStats();
                    
                    // Actualizar last check
                    lastStatsCheck = stats;
                    
                    // Mostrar notificaci√≥n visual sutil
                    mostrarNotificacionActualizacion();
                }
                
                // Si hay solicitudes pendientes de impresi√≥n, reintentar
                if (stats.pendientes_impresion > 0) {
                    console.log(`üñ®Ô∏è Hay ${stats.pendientes_impresion} solicitud(es) pendientes de impresi√≥n. Reintentando...`);
                    await reintentarImpresiones();
                }
                
            } catch (error) {
                console.error('Error en verificarCambios:', error);
            }
        }

        async function reintentarImpresiones() {
            try {
                const response = await fetch('/api/reintentar-impresiones-pendientes', {
                    method: 'POST',
                    headers: getAuthHeaders()
                });
                
                if (!response.ok) return;
                
                const result = await response.json();
                if (result.exitosas > 0) {
                    console.log(`‚úÖ Impresiones reintentadas: ${result.exitosas} exitosas, ${result.fallidas} fallidas`);
                    // Recargar registros para actualizar estado
                    await loadRegistros();
                }
            } catch (error) {
                console.error('Error reintentando impresiones:', error);
            }
        }

        function mostrarNotificacionActualizacion() {
            // Crear notificaci√≥n temporal en la esquina superior derecha
            const notif = document.createElement('div');
            notif.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                background: linear-gradient(135deg, #10b981, #059669);
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
                z-index: 9999;
                font-size: 14px;
                font-weight: 600;
                display: flex;
                align-items: center;
                gap: 8px;
                animation: slideInRight 0.3s ease;
            `;
            notif.innerHTML = 'üîÑ <span>Registros actualizados</span>';
            document.body.appendChild(notif);
            
            // Remover despu√©s de 3 segundos
            setTimeout(() => {
                notif.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => notif.remove(), 300);
            }, 3000);
        }

        function iniciarAutoReload() {
            console.log('üöÄ Sistema de auto-reload iniciado (cada 10 segundos)');
            
            // Verificar cambios cada 10 segundos
            autoReloadInterval = setInterval(verificarCambios, 10000);
            
            // Primera verificaci√≥n inmediata
            verificarCambios();
        }

        function detenerAutoReload() {
            if (autoReloadInterval) {
                clearInterval(autoReloadInterval);
                console.log('‚èπÔ∏è Sistema de auto-reload detenido');
            }
        }

        // Agregar estilos para animaciones
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideInRight {
                from {
                    transform: translateX(400px);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }
            
            @keyframes slideOutRight {
                from {
                    transform: translateX(0);
                    opacity: 1;
                }
                to {
                    transform: translateX(400px);
                    opacity: 0;
                }
            }
        `;
        document.head.appendChild(style);

        // ‚≠ê SISTEMA DE MONITOREO DE IMPRESORAS
        let printerStatusInterval = null;
        
        async function verificarEstadoImpresoras() {
            try {
                const response = await fetch('/api/printer-status-all', {
                    headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') }
                });
                
                if (!response.ok) throw new Error('Error al verificar impresoras');
                
                const data = await response.json();
                
                // Actualizar Godex (indicador en greeting-card)
                const godexConnected = data.godex.connected;
                const godexIndicator = document.getElementById('godex-indicator');
                const godexBadge = document.getElementById('godex-badge');
                
                if (godexConnected) {
                    godexIndicator.textContent = 'üü¢'; // Verde
                    godexBadge.title = `Godex G530 - Conectada (${data.godex.ip})`;
                    godexBadge.style.borderColor = '#059669';
                    godexBadge.style.color = '#059669';
                } else {
                    godexIndicator.textContent = 'üî¥'; // Rojo
                    godexBadge.title = 'Godex G530 - Desconectada';
                    godexBadge.style.borderColor = '#dc2626';
                    godexBadge.style.color = '#dc2626';
                }
                
                // Actualizar Zebra (indicador en greeting-card)
                const zebraConnected = data.zebra.connected;
                const zebraIndicator = document.getElementById('zebra-indicator');
                const zebraBadge = document.getElementById('zebra-badge');
                
                if (zebraConnected) {
                    zebraIndicator.textContent = 'üü¢'; // Verde
                    zebraBadge.title = `Zebra ZD230 - Conectada (${data.zebra.ip})`;
                    zebraBadge.style.borderColor = '#059669';
                    zebraBadge.style.color = '#059669';
                } else {
                    zebraIndicator.textContent = 'üî¥'; // Rojo
                    zebraBadge.title = 'Zebra ZD230 - Desconectada';
                    zebraBadge.style.borderColor = '#dc2626';
                    zebraBadge.style.color = '#dc2626';
                }
                
                console.log(`üîç Estado impresoras: Godex ${godexConnected ? 'üü¢' : 'üî¥'} | Zebra ${zebraConnected ? 'üü¢' : 'üî¥'}`);
                
            } catch (error) {
                console.error('‚ùå Error verificando estado de impresoras:', error);
                // Mostrar estado de error (amarillo)
                const godexIndicator = document.getElementById('godex-indicator');
                const zebraIndicator = document.getElementById('zebra-indicator');
                const godexBadge = document.getElementById('godex-badge');
                const zebraBadge = document.getElementById('zebra-badge');
                
                if (godexIndicator) {
                    godexIndicator.textContent = 'üü°';
                    godexBadge.title = 'Godex G530 - Error al verificar';
                    godexBadge.style.borderColor = '#d97706';
                    godexBadge.style.color = '#d97706';
                }
                if (zebraIndicator) {
                    zebraIndicator.textContent = 'üü°';
                    zebraBadge.title = 'Zebra ZD230 - Error al verificar';
                    zebraBadge.style.borderColor = '#d97706';
                    zebraBadge.style.color = '#d97706';
                }
            }
        }
        
        function iniciarMonitoreoImpresoras() {
            console.log('üñ®Ô∏è Iniciando monitoreo de impresoras (cada 30 segundos)');
            
            // Primera verificaci√≥n inmediata
            verificarEstadoImpresoras();
            
            // Verificar cada 30 segundos
            printerStatusInterval = setInterval(verificarEstadoImpresoras, 30000);
        }
        
        function detenerMonitoreoImpresoras() {
            if (printerStatusInterval) {
                clearInterval(printerStatusInterval);
                console.log('‚èπÔ∏è Monitoreo de impresoras detenido');
            }
        }

        // Inicializar listeners para botones de preview
        document.addEventListener('DOMContentLoaded', () => {
            // üñ®Ô∏è Iniciar monitoreo de impresoras
            iniciarMonitoreoImpresoras();
            
            // Listener para formulario normal
            const productoSelect = document.getElementById('producto');
            const previewBtnNormal = document.getElementById('preview-btn-normal');
            
            if (productoSelect && previewBtnNormal) {
                // Inicialmente deshabilitado
                previewBtnNormal.disabled = true;
                
                productoSelect.addEventListener('change', () => {
                    const hasSelection = productoSelect.value && productoSelect.value !== '';
                    previewBtnNormal.disabled = !hasSelection;
                });
            }
            
            // Listener para formulario especial
            const productoEspecialSelect = document.getElementById('producto-especial-select');
            const previewBtnEspecial = document.getElementById('preview-btn-especial');
            
            if (productoEspecialSelect && previewBtnEspecial) {
                // Inicialmente deshabilitado
                previewBtnEspecial.disabled = true;
                
                productoEspecialSelect.addEventListener('change', () => {
                    const hasSelection = productoEspecialSelect.value && productoEspecialSelect.value !== '';
                    previewBtnEspecial.disabled = !hasSelection;
                });
            }
        });
        
        // Detener monitoreo al cerrar p√°gina
        window.addEventListener('beforeunload', () => {
            detenerMonitoreoImpresoras();
        });
    </script>

    <!-- Bot√≥n de Ayuda Flotante -->
    <a href="manual-ayuda.html" class="help-button" target="_blank">
        <span class="icon">?</span>
        <span class="tooltip">Ayuda</span>
    </a>

    <!-- Bot√≥n Flotante: Bit√°cora de Producci√≥n -->
    <button class="bitacora-button" onclick="toggleBitacoraModal()">
        <span class="icon">üìã</span>
        <span class="tooltip">Bit√°cora de Producci√≥n</span>
    </button>

    <!-- Modal: Bit√°cora de Producci√≥n -->
    <div id="modal-bitacora-fullscreen" class="modal-bitacora-fullscreen">
        <div class="modal-bitacora-content">
            <div class="modal-bitacora-header">
                <h2>üìã Bit√°cora de Producci√≥n</h2>
                <button class="btn-cerrar-bitacora" onclick="toggleBitacoraModal()">‚úï</button>
            </div>
            <div id="bitacora-component"></div>
        </div>
    </div>

    <script>
        // Toggle modal de bit√°cora
        function toggleBitacoraModal() {
            const modal = document.getElementById('modal-bitacora-fullscreen');
            modal.classList.toggle('active');
            
            // Si se abre el modal, cargar datos
            if (modal.classList.contains('active')) {
                if (typeof cargarBitacora === 'function') {
                    cargarBitacora();
                }
            }
        }

        // Cargar componente de bit√°cora
        fetch('/components/bitacora-produccion.html')
            .then(response => response.text())
            .then(html => {
                // Separar HTML y Scripts
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = html;
                
                // Insertar HTML
                const container = document.getElementById('bitacora-component');
                container.innerHTML = '';
                
                // Copiar todos los nodos excepto scripts
                Array.from(tempDiv.children).forEach(child => {
                    if (child.tagName !== 'SCRIPT') {
                        container.appendChild(child.cloneNode(true));
                    }
                });
                
                // Ejecutar scripts
                const scripts = tempDiv.querySelectorAll('script');
                scripts.forEach(oldScript => {
                    const newScript = document.createElement('script');
                    if (oldScript.src) {
                        newScript.src = oldScript.src;
                    } else {
                        newScript.textContent = oldScript.textContent;
                    }
                    document.body.appendChild(newScript);
                });
                
                console.log('‚úÖ Componente de bit√°cora cargado');
            })
            .catch(error => console.error('‚ùå Error cargando bit√°cora:', error));
    </script>

    <style>
        /* Bot√≥n flotante de bit√°cora */
        .bitacora-button {
            position: fixed;
            bottom: 170px; /* Debajo del bot√≥n de ayuda */
            right: 24px;
            width: 56px;
            height: 56px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 1069;
            border: 3px solid rgba(255, 255, 255, 0.3);
        }

        .bitacora-button:hover {
            transform: scale(1.1) rotate(5deg);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.6);
            border-color: rgba(255, 255, 255, 0.6);
        }

        .bitacora-button .icon {
            font-size: 26px;
        }

        .bitacora-button .tooltip {
            position: absolute;
            right: 70px;
            background: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 8px 15px;
            border-radius: 8px;
            font-size: 13px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .bitacora-button:hover .tooltip {
            opacity: 1;
        }

        .bitacora-button .tooltip::after {
            content: '';
            position: absolute;
            right: -8px;
            top: 50%;
            transform: translateY(-50%);
            width: 0;
            height: 0;
            border-left: 8px solid rgba(0, 0, 0, 0.85);
            border-top: 8px solid transparent;
            border-bottom: 8px solid transparent;
        }

        /* Modal fullscreen de bit√°cora */
        .modal-bitacora-fullscreen {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 10000;
            backdrop-filter: blur(5px);
            animation: fadeIn 0.3s ease;
        }

        .modal-bitacora-fullscreen.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-bitacora-content {
            background: white;
            width: 95%;
            max-width: 1400px;
            height: 90vh;
            border-radius: 20px;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
            animation: slideUp 0.3s ease;
        }

        .modal-bitacora-header {
            position: sticky;
            top: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 20px 20px 0 0;
            z-index: 10;
        }

        .modal-bitacora-header h2 {
            margin: 0;
            font-size: 24px;
        }

        .btn-cerrar-bitacora {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-cerrar-bitacora:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg);
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from {
                transform: translateY(50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @media (max-width: 768px) {
            .bitacora-button {
                width: 48px;
                height: 48px;
                bottom: 145px;
                right: 16px;
            }

            .bitacora-button .icon {
                font-size: 22px;
            }

            .modal-bitacora-content {
                width: 100%;
                height: 100vh;
                border-radius: 0;
            }

            .modal-bitacora-header {
                border-radius: 0;
            }
        }
    </style>
</body>
</html>