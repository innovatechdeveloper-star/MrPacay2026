<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Supervisor - Sistema de Etiquetas QR</title>
    <link rel="icon" type="image/x-icon" href="logo-icon.ico">
    
    <!-- Sistema de Dise√±o Accesible -->    
    <link rel="stylesheet" href="/css/base/design-system.css">
    <link rel="stylesheet" href="/css/components/buttons.css">
    <!-- Tema se carga din√°micamente con theme-switcher.js -->
    
    <!-- Temas de g√©nero (legacy - mantener por compatibilidad) -->
    <link rel="stylesheet" href="gender-themes.css">
    <script src="theme-system.js" defer></script>
    
    <!-- Theme Switcher -->
    <script src="/css/theme-switcher.js" defer></script>
    
    <!-- ‚ú® OVERRIDE: Desactivar estilos legacy que interfieren con nuevo sistema de temas -->
    <link rel="stylesheet" href="/css/override-legacy-styles.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            /* ‚ú® Usar variables del sistema de temas en lugar de colores hardcodeados */
            background: var(--color-background, #ffffff);
            min-height: 100vh;
            position: relative;
            transition: all 0.5s ease;
        }

        @keyframes gradientShift {
            0% {
                background-position: 0% 50%;
            }
            50% {
                background-position: 100% 50%;
            }
            100% {
                background-position: 0% 50%;
            }
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            z-index: -1;
            pointer-events: none;
            transition: all 0.5s ease;
        }

        /* Estrellas decorativas */
        .stars-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
            overflow: hidden;
        }

        .star-deco {
            position: absolute;
            font-size: 25px;
            opacity: 0.5;
            animation: twinkleStar 3s ease-in-out infinite;
        }

        .star-deco:nth-child(1) { left: 15%; top: 20%; animation-delay: 0s; }
        .star-deco:nth-child(2) { left: 80%; top: 15%; animation-delay: 1s; }
        .star-deco:nth-child(3) { left: 25%; top: 65%; animation-delay: 2s; }
        .star-deco:nth-child(4) { left: 70%; top: 75%; animation-delay: 1.5s; }
        .star-deco:nth-child(5) { left: 50%; top: 45%; animation-delay: 0.5s; }

        @keyframes twinkleStar {
            0%, 100% { opacity: 0.5; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.3); }
        }

        /* Mariposas flotantes */
        .butterflies-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
            overflow: hidden;
        }

        .butterfly {
            position: absolute;
            font-size: 28px;
            opacity: 0.6;
            animation: flyButterfly 20s ease-in-out infinite;
        }

        .butterfly:nth-child(1) { 
            left: 10%; 
            top: 30%; 
            animation-delay: 0s; 
            animation-duration: 18s;
        }
        .butterfly:nth-child(2) { 
            left: 70%; 
            top: 50%; 
            animation-delay: 5s; 
            animation-duration: 22s;
        }
        .butterfly:nth-child(3) { 
            left: 40%; 
            top: 70%; 
            animation-delay: 10s; 
            animation-duration: 20s;
        }

        /* Estilo para icono peque√±o de juegos en la cabecera */
        .games-icon-mini{display:inline-flex;align-items:center;justify-content:center;width:36px;height:36px;border-radius:8px;background:rgba(255,255,255,0.06);margin-right:8px;border:1px solid rgba(255,255,255,0.08)}
        .games-icon-mini:hover{background:rgba(255,255,255,0.12)}

        @keyframes flyButterfly {
            0%, 100% { 
                transform: translate(0, 0) rotate(0deg);
                opacity: 0.6;
            }
            25% { 
                transform: translate(100px, -80px) rotate(15deg);
                opacity: 0.8;
            }
            50% { 
                transform: translate(50px, -150px) rotate(-15deg);
                opacity: 0.7;
            }
            75% { 
                transform: translate(-80px, -100px) rotate(10deg);
                opacity: 0.6;
            }
        }

        /* MODO OSCURO */
        body.dark-mode {
            background: linear-gradient(-45deg, #1e1b4b, #4c1d95, #312e81, #1e3a8a);
        }

        body.dark-mode::before {
            background: rgba(15, 15, 35, 0.85);
        }

        body.dark-mode .star-deco,
        body.dark-mode .butterfly {
            opacity: 0.3;
            filter: brightness(0.8);
        }

        .header {
            background: linear-gradient(
                135deg,
                rgba(236, 72, 153, 0.85),
                rgba(217, 70, 239, 0.85),
                rgba(244, 114, 182, 0.85)
            );
            background-size: 200% 200%;
            color: white;
            padding: 20px;
            box-shadow: 
                0 2px 10px rgba(236, 72, 153, 0.3),
                0 0 15px rgba(217, 70, 239, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.5),
                inset 0 -1px 0 rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 182, 223, 0.6);
            position: relative;
            overflow: hidden;
            animation: chromeShift 8s ease infinite;
            transition: all 0.5s ease;
        }

        body.dark-mode .header {
            background: linear-gradient(
                135deg,
                rgba(88, 28, 135, 0.95),
                rgba(109, 40, 217, 0.95),
                rgba(76, 29, 149, 0.95)
            );
            box-shadow: 
                0 2px 10px rgba(0, 0, 0, 0.5),
                0 0 15px rgba(139, 92, 246, 0.4),
                inset 0 1px 0 rgba(167, 139, 250, 0.3),
                inset 0 -1px 0 rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(139, 92, 246, 0.5);
        }

        @keyframes chromeShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                90deg,
                transparent,
                rgba(255, 255, 255, 0.4),
                transparent
            );
            animation: headerShine 4s infinite;
        }

        @keyframes headerShine {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header-logo {
            height: 45px;
            width: auto;
            background: rgba(255, 255, 255, 0.9);
            padding: 5px 10px;
            border-radius: 6px;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
            transition: all 0.3s ease;
        }

        .header-logo:hover {
            background: rgba(255, 255, 255, 0.95);
            transform: scale(1.05);
        }

        .header h1 {
            font-size: 28px;
            text-shadow: 
                0 2px 4px rgba(0, 0, 0, 0.3),
                0 0 10px rgba(255, 255, 255, 0.5);
            color: white !important;
            position: relative;
            z-index: 1;
        }

        body.dark-mode .header h1 {
            color: white !important;
            text-shadow: 
                0 2px 4px rgba(0, 0, 0, 0.5),
                0 0 15px rgba(167, 139, 250, 0.6);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
            color: white;
        }

        .user-info div {
            color: white;
        }

        .user-info small {
            color: rgba(255, 255, 255, 0.9);
        }

        body.dark-mode .user-info {
            color: white !important;
        }

        body.dark-mode .user-info div {
            color: white !important;
        }

        body.dark-mode .user-info small {
            color: rgba(255, 255, 255, 0.9) !important;
        }

        /* Toggle Modo Oscuro/Claro */
        .theme-toggle {
            position: relative;
            width: 60px;
            height: 30px;
            background: linear-gradient(135deg, #d946ef, #a855f7);
            border-radius: 30px;
            cursor: pointer;
            display: flex;
            align-items: center;
            padding: 3px;
            transition: all 0.4s ease;
            box-shadow: 
                0 2px 8px rgba(0, 0, 0, 0.2),
                inset 0 1px 2px rgba(255, 255, 255, 0.3);
        }

        .theme-toggle:hover {
            transform: scale(1.05);
        }

        .theme-toggle-slider {
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            position: absolute;
            left: 3px;
            transition: all 0.4s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        }

        body.dark-mode .theme-toggle {
            background: linear-gradient(135deg, #581c87, #4c1d95);
        }

        body.dark-mode .theme-toggle-slider {
            left: 33px;
        }

        .crown-icon {
            font-size: 24px;
            background: rgba(255,255,255,0.2);
            padding: 8px;
            border-radius: 50%;
        }

        .logout-btn {
            background: rgba(255,255,255,0.2);
            border: 2px solid rgba(255,255,255,0.3);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }

        .main-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 30px 20px;
        }

        /* Estilos para tarjeta de saludo del supervisor */
        .supervisor-greeting-card {
            background: linear-gradient(135deg, #fce7f3 0%, #ec4899 100%);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 4px 15px rgba(236, 72, 153, 0.3);
            border: 1px solid rgba(236, 72, 153, 0.4);
            transition: all 0.5s ease;
        }

        body.dark-mode .supervisor-greeting-card {
            background: linear-gradient(135deg, #4c1d95 0%, #7c3aed 100%);
            box-shadow: 0 4px 15px rgba(124, 58, 237, 0.4);
            border: 1px solid rgba(167, 139, 250, 0.4);
        }

        .supervisor-greeting-content {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .supervisor-greeting-icon {
            font-size: 48px;
            animation: bounce 2s infinite;
            color: #ffffff;
        }

        .supervisor-greeting-text {
            flex: 1;
        }

        .supervisor-greeting-text h3 {
            margin: 0 0 8px 0;
            color: #ffffff;
            font-size: 24px;
            font-weight: 700;
        }

        .supervisor-greeting-text p {
            margin: 0 0 15px 0;
            color: #f0f9ff;
            font-size: 16px;
            line-height: 1.5;
        }

        .supervisor-stats-summary {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .supervisor-stat-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: rgba(255, 255, 255, 0.9);
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            border: 2px solid transparent;
        }

        .supervisor-stat-badge.impresa {
            border-color: #10b981;
            color: #10b981;
        }

        .supervisor-stat-badge.impresa .supervisor-stat-number {
            background: #10b981 !important;
            color: white !important;
        }

        .supervisor-stat-badge.completado {
            border-color: #059669;
            color: #059669;
        }

        .supervisor-stat-badge.completado .supervisor-stat-number {
            background: #059669 !important;
            color: white !important;
        }

        .supervisor-stat-badge.proceso {
            border-color: #2563eb;
            color: #2563eb;
        }

        .supervisor-stat-badge.proceso .supervisor-stat-number {
            background: #2563eb !important;
            color: white !important;
        }

        .supervisor-stat-number {
            background: #6b7280;
            color: white !important;
            padding: 4px 10px;
            border-radius: 12px;
            font-weight: 700;
            min-width: 22px;
            text-align: center;
            font-size: 14px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.15);
            display: inline-block;
        }

        /* üñ®Ô∏è Estilos para indicadores de impresoras */
        .supervisor-stat-badge.printer-status {
            border-color: #ffffff;
            color: #ffffff;
            background: rgba(255, 255, 255, 0.25);
            cursor: help;
            transition: all 0.3s ease;
        }

        .supervisor-stat-badge.printer-status:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.25);
            background: rgba(255, 255, 255, 0.35);
        }

        .printer-indicator {
            font-size: 16px;
            animation: pulse-printer 2s ease-in-out infinite;
        }

        @keyframes pulse-printer {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.15); }
        }

        .supervisor-stat-label {
            font-size: 12px;
        }

        .mode-actions {
            display: flex;
            align-items: center;
        }

        .return-btn {
            background: #10b981;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .return-btn:hover {
            background: #059669;
            transform: translateY(-2px);
        }

        .dashboard-sections {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
            gap: 30px;
        }

        .section-card {
            /* ‚ú® Usar variables del sistema de temas */
            background: var(--color-surface, #ffffff);
            border-radius: 15px;
            padding: 25px;
            box-shadow: var(--shadow-md, 0 4px 6px rgba(0, 0, 0, 0.1));
            border: 1px solid var(--color-border, rgba(0, 0, 0, 0.1));
            transition: all 0.5s ease;
        }

        /* DARK MODE DESHABILITADO - Usar sistema de temas con bot√≥n flotante */
        /* body.dark-mode .section-card { ... } */

        .section-card:hover {
            transform: translateY(-5px);
        }

        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .section-icon {
            font-size: 24px;
            margin-right: 12px;
            padding: 10px;
            border-radius: 10px;
            background: linear-gradient(135deg, #ec4899, #d946ef);
            color: white;
            transition: all 0.5s ease;
        }

        /* Estilos para las pesta√±as de filtro de solicitudes */
        /* Pesta√±as de filtro - REDISE√ëADAS */
        .solicitudes-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            background: transparent;
            padding: 0;
        }

        .tab-btn {
            flex: 1;
            min-width: 110px;
            padding: 10px 14px;
            border: none;
            background: rgba(255, 255, 255, 0.7);
            color: #666;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
        }

        body.dark-mode .tab-btn {
            background: rgba(58, 29, 61, 0.6);
            color: #ccc;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .tab-btn:hover {
            transform: translateY(-1px);
            background: rgba(255, 255, 255, 0.95);
            box-shadow: 0 4px 8px rgba(236, 72, 153, 0.15);
        }

        body.dark-mode .tab-btn:hover {
            background: rgba(58, 29, 61, 0.8);
            box-shadow: 0 4px 8px rgba(168, 85, 247, 0.2);
        }

        .tab-btn.active {
            background: linear-gradient(135deg, #ec4899, #d946ef);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(236, 72, 153, 0.35);
        }

        body.dark-mode .tab-btn.active {
            background: linear-gradient(135deg, #a855f7, #7c3aed);
            box-shadow: 0 6px 15px rgba(168, 85, 247, 0.4);
        }

        .tab-btn span {
            font-weight: 800;
            font-size: 16px;
            line-height: 1;
        }

        .tab-btn.active span {
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }

        /* Estilo para tarjeta DORADA de Solicitudes Especiales */
        .tab-btn.especiales {
            background: linear-gradient(135deg, #fef3c7, #fbbf24);
            color: #92400e;
            border: 2px solid #f59e0b;
        }

        .tab-btn.especiales:hover {
            background: linear-gradient(135deg, #fde68a, #f59e0b);
            box-shadow: 0 4px 8px rgba(245, 158, 11, 0.3);
        }

        .tab-btn.especiales.active {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
            box-shadow: 0 6px 15px rgba(245, 158, 11, 0.5);
        }

        body.dark-mode .tab-btn.especiales {
            background: linear-gradient(135deg, #92400e, #78350f);
            color: #fde68a;
            border-color: #d97706;
        }

        body.dark-mode .tab-btn.especiales.active {
            background: linear-gradient(135deg, #d97706, #b45309);
            color: white;
        }

        body.dark-mode .section-icon {
            background: linear-gradient(135deg, #a855f7, #7c3aed);
        }

        .section-title {
            font-size: 20px;
            color: #333;
            transition: color 0.5s ease;
        }

        body.dark-mode .section-title {
            color: #e9d5ff;
            font-weight: 600;
        }

        .date-filters {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
        }

        .date-input {
            padding: 8px 12px;
            border: 2px solid rgba(236, 72, 153, 0.3);
            border-radius: 6px;
            font-size: 14px;
            background: rgba(255, 255, 255, 0.9);
            transition: all 0.3s ease;
        }

        .date-input:focus {
            outline: none;
            border-color: #ec4899;
            box-shadow: 0 0 0 3px rgba(236, 72, 153, 0.1);
        }

        .filter-btn {
            padding: 8px 15px;
            background: linear-gradient(135deg, #ec4899, #d946ef);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .filter-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(236, 72, 153, 0.4);
            background: linear-gradient(135deg, #d946ef, #c026d3);
        }

        /* Estilos para el panel de historial */
        .historial-filters {
            background: linear-gradient(135deg, #fef5fb 0%, #fce8f3 100%);
            padding: 20px;
            border-radius: 8px;
            margin: 15px 0;
            border: 1px solid rgba(236, 72, 153, 0.2);
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            align-items: start;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filter-group label {
            font-size: 14px;
            font-weight: 500;
            color: #374151;
        }

        .filter-input, .filter-select {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
            background: white;
        }

        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .checkbox-group label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: normal;
            cursor: pointer;
        }

        .checkbox-group input[type="checkbox"] {
            margin: 0;
        }

        .filter-actions {
            display: flex;
            gap: 10px;
            align-items: end;
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .btn-secondary:hover {
            background: #4b5563;
            transform: translateY(-2px);
        }

        .historial-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            transition: all 0.5s ease;
        }

        body.dark-mode .historial-table {
            background: rgba(30, 27, 75, 0.85);
            box-shadow: 0 1px 3px rgba(0,0,0,0.5);
        }

        .historial-table th {
            background: #f8fafc;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid #e2e8f0;
            font-size: 14px;
            transition: all 0.5s ease;
        }

        body.dark-mode .historial-table th {
            background: rgba(76, 29, 149, 0.6);
            color: #e9d5ff;
            border-bottom: 2px solid rgba(139, 92, 246, 0.3);
        }

        .historial-table td {
            padding: 12px;
            border-bottom: 1px solid #f1f5f9;
            font-size: 14px;
            transition: all 0.5s ease;
        }

        body.dark-mode .historial-table td {
            color: #e9d5ff;
            border-bottom: 1px solid rgba(139, 92, 246, 0.2);
        }

        .historial-table tr:hover {
            background: #f8fafc;
        }

        body.dark-mode .historial-table tr:hover {
            background: rgba(76, 29, 149, 0.3);
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            text-align: center;
        }

        .status-pendiente {
            background: #fef3c7;
            color: #92400e;
        }

        .status-proceso {
            background: #dbeafe;
            color: #1e40af;
        }

        .status-completada {
            background: #d1fae5;
            color: #065f46;
        }

        .historial-stats {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .stat-badge {
            padding: 8px 15px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 8px;
            border: 2px solid rgba(236, 72, 153, 0.2);
            font-size: 14px;
            font-weight: 500;
            box-shadow: 0 2px 4px rgba(236, 72, 153, 0.08);
        }

        .costureras-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .costurera-card {
            /* ‚ú® Usar variables del sistema de temas */
            background: var(--color-surface, #ffffff);
            border: 2px solid var(--color-border, rgba(0, 0, 0, 0.1));
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .costurera-card:hover {
            transform: translateY(-3px);
            border-color: var(--color-primary, #007bff);
            box-shadow: var(--shadow-lg, 0 10px 15px rgba(0, 0, 0, 0.1));
        }

        .costurera-avatar {
            width: 50px;
            height: 50px;
            /* ‚ú® Usar variables del sistema de temas */
            background: var(--color-primary, #007bff);
            border-radius: 50%;
            margin: 0 auto 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
            font-weight: bold;
        }

        .costurera-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .costurera-status {
            font-size: 12px;
            color: #666;
            padding: 3px 8px;
            background: #e2e8f0;
            border-radius: 15px;
        }

        .pending-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .pending-item {
            /* ‚ú® Usar variables del sistema de temas */
            background: var(--color-surface, #ffffff);
            border: 2px solid var(--color-border, rgba(0, 0, 0, 0.1));
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-sm, 0 1px 3px rgba(0, 0, 0, 0.12));
        }

        .pending-item:hover {
            box-shadow: var(--shadow-md, 0 4px 6px rgba(0, 0, 0, 0.1));
            border-color: var(--color-primary, #007bff);
            transform: translateY(-2px);
        }

        .pending-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 10px;
        }

        .pending-info {
            flex: 1;
        }

        .pending-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .pending-details {
            color: #666;
            font-size: 14px;
        }

        .pending-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        .action-btn {
            padding: 8px 15px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .approve-btn {
            background: #10b981;
            color: white;
        }

        .approve-btn:hover {
            background: #059669;
            transform: translateY(-1px);
        }

        .reject-btn {
            background: #ef4444;
            color: white;
        }

        .reject-btn:hover {
            background: #dc2626;
            transform: translateY(-1px);
        }

        /* Bot√≥n de actualizaci√≥n */
        .refresh-btn {
            background: linear-gradient(135deg, #ec4899, #d946ef);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(236, 72, 153, 0.2);
        }

        .refresh-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(236, 72, 153, 0.3);
            background: linear-gradient(135deg, #d946ef, #c026d3);
        }

        .refresh-btn:active {
            transform: translateY(0);
        }

        .refresh-btn.refreshing {
            opacity: 0.7;
            cursor: not-allowed;
            pointer-events: none;
        }

        .refresh-btn.refreshing::before {
            content: "üîÑ";
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* =============================================
           ESTILOS PARA SISTEMA DE COLA DE APROBACI√ìN
           ============================================= */
        
        /* Bot√≥n Aprobar - Estado procesando (gris, deshabilitado) */
        .approve-btn.processing {
            background: #9ca3af !important;
            color: #6b7280 !important;
            cursor: not-allowed !important;
            opacity: 0.7;
            pointer-events: none;
        }
        
        /* Bot√≥n Aprobar - Estado en cola (amarillo) */
        .approve-btn.queued {
            background: #f59e0b !important;
            color: white !important;
            animation: pulse-queue 2s infinite;
        }
        
        .approve-btn.queued:before {
            content: "‚è≥ ";
        }
        
        /* Bot√≥n Cancelar - Reemplaza a Rechazar cuando est√° procesando */
        .cancel-btn {
            background: #ef4444 !important;
            color: white !important;
            border: 2px solid #dc2626 !important;
            font-weight: 700;
            animation: pulse-cancel 1.5s infinite;
        }
        
        .cancel-btn:hover {
            background: #dc2626 !important;
            transform: scale(1.05);
        }
        
        /* Animaciones */
        @keyframes pulse-queue {
            0%, 100% { 
                background: #f59e0b; 
                box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.7);
            }
            50% { 
                background: #d97706; 
                box-shadow: 0 0 0 10px rgba(245, 158, 11, 0);
            }
        }
        
        @keyframes pulse-cancel {
            0%, 100% { 
                transform: scale(1);
            }
            50% { 
                transform: scale(1.02);
            }
        }
        
        /* Indicador visual de cola activa */
        .queue-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: linear-gradient(45deg, #f59e0b, #d97706);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            margin-left: 10px;
            animation: bounce 1s infinite;
        }

        .priority-badge {
            padding: 4px 8px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .priority-alta {
            background: #fee2e2;
            color: #dc2626;
        }

        .priority-urgente {
            background: #fef3c7;
            color: #d97706;
        }

        .priority-normal {
            background: #e0f2fe;
            color: #0369a1;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
        }

        .stat-item {
            text-align: center;
            padding: 15px;
            background: linear-gradient(135deg, #f8fafc, #e2e8f0);
            border-radius: 10px;
        }

        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .empty-state img {
            width: 60px;
            opacity: 0.5;
            margin-bottom: 15px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .spinner {
            width: 30px;
            height: 30px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .dashboard-sections {
                grid-template-columns: 1fr;
            }
            
            .costureras-grid {
                grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            }
            
            .mode-content {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
        }

        /* Estilos para Gesti√≥n de Productos */
        .productos-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 15px;
        }

        .producto-action-card {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 25px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            min-height: 180px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .producto-action-card:hover {
            transform: translateY(-5px);
            border-color: #667eea;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        }

        .action-icon {
            font-size: 48px;
            margin-bottom: 10px;
            padding: 15px;
            border-radius: 50%;
            width: 80px;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .add-icon {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }

        .remove-icon {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }

        .search-icon {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
        }

        .especial-icon {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
        }

        .especial-card:hover {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            border-color: #f59e0b;
        }

        .producto-action-card h3 {
            font-size: 18px;
            font-weight: 600;
            margin: 0;
        }

        .producto-action-card p {
            font-size: 14px;
            margin: 0;
            opacity: 0.8;
        }

        /* Estilos para opciones de tipo de producto */
        .tipo-producto-option:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }

        /* Estilos para botones de tipo de producto en modal */
        .btn-tipo-producto {
            transition: all 0.3s ease;
        }

        .btn-tipo-producto:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .btn-tipo-producto.active {
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }

        #btn-productos-normales.active {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
        }

        #btn-productos-normales:not(.active) {
            background: white;
            color: #3b82f6;
        }

        #btn-productos-especiales.active {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            color: white;
            border-color: #f59e0b;
        }

        #btn-productos-especiales:not(.active) {
            background: white;
            color: #f59e0b;
        }

        /* Estilos para Modales */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(4px);
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 0;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            width: 90%;
        }

        .large-modal {
            max-width: 900px;
        }

        /* Bot√≥n de Ayuda Flotante - Posicionado debajo del theme switcher */
        .help-button {
            position: fixed;
            bottom: 100px; /* Ajustado para estar debajo del bot√≥n de tema (que est√° en 24px) */
            right: 24px;
            width: 56px;
            height: 56px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 1069; /* Justo debajo del theme switcher (1070) */
            border: 3px solid rgba(255, 255, 255, 0.3);
            text-decoration: none;
        }

        .help-button:hover {
            transform: scale(1.1) rotate(5deg);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
            border-color: rgba(255, 255, 255, 0.6);
        }

        .help-button .icon {
            font-size: 26px;
            color: white;
            font-weight: bold;
        }

        .help-button .tooltip {
            position: absolute;
            right: 70px;
            background: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 8px 15px;
            border-radius: 8px;
            font-size: 13px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .help-button:hover .tooltip {
            opacity: 1;
        }

        .help-button .tooltip::after {
            content: '';
            position: absolute;
            right: -8px;
            top: 50%;
            transform: translateY(-50%);
            width: 0;
            height: 0;
            border-left: 8px solid rgba(0, 0, 0, 0.85);
            border-top: 8px solid transparent;
            border-bottom: 8px solid transparent;
        }

        /* Ajustes responsive para botones flotantes */
        @media (max-width: 768px) {
            .help-button {
                width: 48px;
                height: 48px;
                bottom: 85px; /* Ajustado para m√≥vil */
                right: 16px;
            }

            .help-button .icon {
                font-size: 22px;
            }

            .help-button .tooltip {
                font-size: 12px;
                padding: 6px 12px;
                right: 60px;
            }
        }

        .modal-header {
            background: linear-gradient(135deg, #ec4899 0%, #d946ef 50%, #a855f7 100%);
            color: white;
            padding: 25px 30px;
            border-radius: 20px 20px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 20px rgba(236, 72, 153, 0.3);
            position: relative;
            overflow: hidden;
        }

        .modal-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url("data:image/svg+xml,%3Csvg width='100' height='100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M0 0h100v100H0z' fill='none'/%3E%3Cpath d='M20 20h60v60H20z' fill='rgba(255,255,255,0.05)'/%3E%3C/svg%3E");
            opacity: 0.1;
            pointer-events: none;
        }

        .modal-header h3 {
            font-size: 22px;
            font-weight: 700;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 12px;
            position: relative;
            z-index: 1;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        body.dark-mode .modal-header {
            background: linear-gradient(135deg, #a855f7 0%, #8b5cf6 50%, #7c3aed 100%);
            box-shadow: 0 4px 20px rgba(168, 85, 247, 0.4);
        }

        .modal-close {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            font-size: 20px;
            font-weight: 700;
            width: 40px;
            height: 40px;
            border-radius: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            z-index: 1;
        }

        .modal-close:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
            transform: rotate(90deg) scale(1.1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .modal-close:active {
            transform: rotate(90deg) scale(0.95);
        }

        .product-form {
            padding: 25px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .form-field {
            display: flex;
            flex-direction: column;
        }

        .form-field label {
            font-weight: 600;
            margin-bottom: 5px;
            color: #374151;
        }

        .form-field input, .form-field select {
            padding: 10px 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-field input:focus, .form-field select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-actions {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
            padding: 25px 0 10px 0;
            border-top: 2px solid #f3f4f6;
            margin-top: 20px;
        }

        body.dark-mode .form-actions {
            border-top-color: rgba(168, 85, 247, 0.2);
        }

        /* ============================================= */
        /* FORMULARIO DE EDICI√ìN DE PRODUCTO - MODERNO */
        /* ============================================= */
        .product-info-section {
            padding: 25px 30px;
            background: linear-gradient(135deg, #fafafa 0%, #ffffff 100%);
            border-radius: 16px;
            margin-bottom: 20px;
        }

        body.dark-mode .product-info-section {
            background: linear-gradient(135deg, rgba(45, 27, 61, 0.3) 0%, rgba(45, 27, 61, 0.1) 100%);
        }

        #edit-product-form .form-group {
            margin-bottom: 20px;
        }

        #edit-product-form .form-group:not(.label-config-section) {
            position: relative;
        }

        /* Campo de ancho completo (Nombre) */
        #edit-product-form .form-group.full-width {
            margin-bottom: 25px;
        }

        #edit-product-form .form-group.full-width input {
            font-size: 18px;
            font-weight: 600;
            padding: 16px 20px;
            background: #ffffff;
            border: 3px solid #e5e7eb;
        }

        #edit-product-form .form-group.full-width input:focus {
            border-color: #ec4899;
            box-shadow: 0 0 0 5px rgba(236, 72, 153, 0.15),
                        0 8px 20px rgba(236, 72, 153, 0.2);
        }

        body.dark-mode #edit-product-form .form-group.full-width input {
            background: rgba(45, 27, 61, 0.6);
            border-color: rgba(168, 85, 247, 0.4);
        }

        /* Grid de 2 columnas para campos cortos */
        .form-grid-2col {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            .form-grid-2col {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            #edit-product-form .form-group.full-width input {
                font-size: 16px;
                padding: 14px 16px;
            }
        }

        /* Campo compacto (Estado) */
        #edit-product-form .form-group.compact {
            max-width: 300px;
        }

        #edit-product-form label {
            display: block;
            font-weight: 700;
            font-size: 13px;
            color: #374151;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
            letter-spacing: 0.3px;
            text-transform: uppercase;
        }

        body.dark-mode #edit-product-form label {
            color: #e5e7eb;
        }

        /* Labels de campos importantes m√°s grandes */
        #edit-product-form .form-group.full-width label {
            font-size: 15px;
            color: #ec4899;
            text-transform: none;
        }

        body.dark-mode #edit-product-form .form-group.full-width label {
            color: #a855f7;
        }

        /* Inputs y Selects Modernos */
        #edit-product-form input[type="text"],
        #edit-product-form select {
            width: 100%;
            padding: 14px 18px;
            font-size: 16px;
            font-weight: 500;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            background: #ffffff;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            color: #1f2937;
        }

        body.dark-mode #edit-product-form input[type="text"],
        body.dark-mode #edit-product-form select {
            color: #e5e7eb;
        }

        #edit-product-form input[type="text"]:hover,
        #edit-product-form select:hover {
            border-color: #d1d5db;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
        }

        #edit-product-form input[type="text"]:focus,
        #edit-product-form select:focus {
            outline: none;
            border-color: #ec4899;
            box-shadow: 0 0 0 4px rgba(236, 72, 153, 0.15),
                        0 4px 12px rgba(236, 72, 153, 0.2);
            transform: translateY(-1px);
        }

        /* Placeholder moderno */
        #edit-product-form input::placeholder {
            color: #9ca3af;
            font-weight: 400;
            font-style: italic;
        }

        /* Select con estilo */
        #edit-product-form select {
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%23ec4899'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 20px;
            padding-right: 40px;
        }

        /* Select deshabilitado */
        #edit-product-form select:disabled {
            background-color: #f3f4f6;
            cursor: not-allowed;
            opacity: 0.6;
        }

        /* Small text (helper text) */
        #edit-product-form small {
            display: block;
            margin-top: 6px;
            font-size: 12px;
            color: #6b7280;
            line-height: 1.4;
        }

        body.dark-mode #edit-product-form small {
            color: #9ca3af;
        }

        /* Separador moderno */
        #edit-product-form hr {
            margin: 35px 0 !important;
            border: none !important;
            height: 3px;
            background: linear-gradient(90deg, 
                transparent 0%, 
                rgba(236, 72, 153, 0.3) 20%, 
                rgba(236, 72, 153, 0.6) 50%, 
                rgba(236, 72, 153, 0.3) 80%, 
                transparent 100%
            );
            border-radius: 3px;
        }

        body.dark-mode #edit-product-form hr {
            background: linear-gradient(90deg, 
                transparent 0%, 
                rgba(168, 85, 247, 0.3) 20%, 
                rgba(168, 85, 247, 0.6) 50%, 
                rgba(168, 85, 247, 0.3) 80%, 
                transparent 100%
            );
        }

        /* Animaci√≥n de entrada */
        #edit-product-form .form-group {
            animation: slideInUp 0.3s ease-out forwards;
            opacity: 0;
        }

        #edit-product-form .form-group:nth-child(1) { animation-delay: 0.05s; }
        #edit-product-form .form-group:nth-child(2) { animation-delay: 0.1s; }
        #edit-product-form .form-group:nth-child(3) { animation-delay: 0.15s; }
        #edit-product-form .form-group:nth-child(4) { animation-delay: 0.2s; }
        #edit-product-form .form-group:nth-child(5) { animation-delay: 0.25s; }
        #edit-product-form .form-group:nth-child(6) { animation-delay: 0.3s; }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Dark mode inputs */
        body.dark-mode #edit-product-form input[type="text"],
        body.dark-mode #edit-product-form select {
            background: rgba(45, 27, 61, 0.5);
            border-color: rgba(168, 85, 247, 0.3);
            color: #e5e7eb;
        }

        body.dark-mode #edit-product-form input[type="text"]:focus,
        body.dark-mode #edit-product-form select:focus {
            background: rgba(45, 27, 61, 0.7);
            border-color: #a855f7;
            box-shadow: 0 0 0 4px rgba(168, 85, 247, 0.2),
                        0 4px 12px rgba(168, 85, 247, 0.3);
        }

        body.dark-mode #edit-product-form select {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%23a855f7'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
        }

        /* ============================================= */
        /* BOTONES DE CONFIGURACI√ìN DE CAMPOS DE ETIQUETA */
        /* ============================================= */
        .label-field-btn {
            position: relative;
            padding: 15px 12px;
            border: 3px solid #e5e7eb;
            background: #f9fafb;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            overflow: hidden;
        }

        .label-field-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
        }

        /* Bot√≥n ACTIVO (campo seleccionado) */
        .label-field-btn.active {
            border-color: #ec4899;
            background: linear-gradient(135deg, #fdf2f8 0%, #fce7f3 100%);
            transform: scale(1.05);
            box-shadow: 0 8px 20px rgba(236, 72, 153, 0.25);
        }

        .label-field-btn.active:hover {
            transform: scale(1.08) translateY(-3px);
            box-shadow: 0 10px 25px rgba(236, 72, 153, 0.35);
        }

        /* Bot√≥n INACTIVO (campo NO seleccionado) */
        .label-field-btn:not(.active) {
            border-color: #d1d5db;
            background: #e5e7eb;
            opacity: 0.65;
            transform: scale(0.95);
        }

        .label-field-btn:not(.active):hover {
            opacity: 0.85;
            transform: scale(0.98) translateY(-3px);
        }

        /* Icono del campo */
        .label-field-btn .field-icon {
            font-size: 28px;
            transition: transform 0.3s ease;
        }

        .label-field-btn.active .field-icon {
            transform: scale(1.15);
            filter: drop-shadow(0 2px 4px rgba(236, 72, 153, 0.3));
        }

        .label-field-btn:not(.active) .field-icon {
            opacity: 0.5;
            filter: grayscale(60%);
        }

        /* Nombre del campo */
        .label-field-btn .field-name {
            font-size: 11px;
            font-weight: 700;
            letter-spacing: 0.5px;
            color: #374151;
            text-transform: uppercase;
        }

        .label-field-btn.active .field-name {
            color: #ec4899;
        }

        .label-field-btn:not(.active) .field-name {
            color: #9ca3af;
        }

        /* Check/X indicator */
        .label-field-btn .field-check {
            position: absolute;
            top: 6px;
            right: 6px;
            font-size: 18px;
            font-weight: 900;
            transition: all 0.3s ease;
        }

        .label-field-btn.active .field-check {
            color: #10b981;
            transform: scale(1.1);
        }

        .label-field-btn:not(.active) .field-check {
            color: #ef4444;
        }

        /* Animaci√≥n al hacer click */
        .label-field-btn:active {
            transform: scale(0.95);
        }

        /* Modo oscuro */
        body.dark-mode .label-field-btn {
            background: rgba(45, 27, 61, 0.5);
            border-color: rgba(168, 85, 247, 0.2);
        }

        body.dark-mode .label-field-btn.active {
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.2) 0%, rgba(168, 85, 247, 0.3) 100%);
            border-color: #a855f7;
            box-shadow: 0 8px 20px rgba(168, 85, 247, 0.3);
        }

        body.dark-mode .label-field-btn:not(.active) {
            background: rgba(45, 27, 61, 0.8);
            border-color: rgba(168, 85, 247, 0.15);
        }

        body.dark-mode .label-field-btn .field-name {
            color: #e5e7eb;
        }

        body.dark-mode .label-field-btn.active .field-name {
            color: #a855f7;
        }

        body.dark-mode .label-field-btn:not(.active) .field-name {
            color: #6b7280;
        }

        /* ============================================= */
        /* NUEVA SECCI√ìN DE CONFIGURACI√ìN DE ETIQUETA */
        /* ============================================= */
        .label-config-section {
            background: linear-gradient(135deg, #fef3f9 0%, #fef9fc 100%);
            border: 2px solid #fce7f3;
            border-radius: 16px;
            padding: 20px;
            margin: 15px 0;
        }

        body.dark-mode .label-config-section {
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.1) 0%, rgba(236, 72, 153, 0.05) 100%);
            border-color: rgba(168, 85, 247, 0.2);
        }

        .label-config-title {
            font-size: 18px;
            font-weight: 700;
            color: #ec4899;
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .title-icon {
            font-size: 24px;
        }

        .label-config-subtitle {
            color: #6b7280;
            font-size: 13px;
            margin-bottom: 20px;
            line-height: 1.6;
            padding-left: 34px;
        }

        body.dark-mode .label-config-subtitle {
            color: #9ca3af;
        }

        /* Grid de campos con descripciones */
        .label-fields-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .field-wrapper {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .field-description {
            font-size: 10px;
            color: #6b7280;
            text-align: center;
            line-height: 1.4;
            padding: 0 8px;
            min-height: 28px;
        }

        body.dark-mode .field-description {
            color: #9ca3af;
        }

        /* Info box con consejo */
        .label-config-info {
            background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
            border: 2px solid #fde68a;
            border-radius: 12px;
            padding: 12px 15px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
            margin-top: 15px;
        }

        body.dark-mode .label-config-info {
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.15) 0%, rgba(251, 191, 36, 0.08) 100%);
            border-color: rgba(251, 191, 36, 0.3);
        }

        .info-icon {
            font-size: 22px;
            flex-shrink: 0;
        }

        .info-content {
            font-size: 12px;
            color: #78716c;
            line-height: 1.6;
        }

        .info-content strong {
            color: #92400e;
            font-weight: 700;
        }

        body.dark-mode .info-content {
            color: #d1d5db;
        }

        body.dark-mode .info-content strong {
            color: #fbbf24;
        }

        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            font-size: 14px;
        }

        .btn-primary {
            background: linear-gradient(
                135deg, 
                #ec4899 0%, 
                #d946ef 50%,
                #a855f7 100%
            );
            background-size: 200% 200%;
            color: white;
            position: relative;
            overflow: hidden;
            animation: buttonGradient 3s ease infinite;
            padding: 14px 32px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 700;
            border: none;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 
                0 4px 20px rgba(236, 72, 153, 0.4),
                0 0 30px rgba(236, 72, 153, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }

        @keyframes buttonGradient {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .btn-primary:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 
                0 8px 30px rgba(236, 72, 153, 0.5),
                0 0 40px rgba(236, 72, 153, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
        }

        .btn-primary:active {
            transform: translateY(-1px) scale(0.98);
            box-shadow: 
                0 2px 10px rgba(236, 72, 153, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }

        body.dark-mode .btn-primary {
            background: linear-gradient(
                135deg, 
                #a855f7 0%, 
                #8b5cf6 50%,
                #7c3aed 100%
            );
            box-shadow: 
                0 4px 20px rgba(168, 85, 247, 0.5),
                0 0 30px rgba(168, 85, 247, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }

        body.dark-mode .btn-primary:hover {
            box-shadow: 
                0 8px 30px rgba(168, 85, 247, 0.6),
                0 0 40px rgba(168, 85, 247, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
        }

        .btn-primary::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(
                45deg,
                transparent,
                rgba(255, 255, 255, 0.1),
                transparent
            );
            transform: rotate(45deg);
            animation: buttonShine 3s linear infinite;
        }

        @keyframes buttonShine {
            0% { transform: translateX(-100%) rotate(45deg); }
            100% { transform: translateX(100%) rotate(45deg); }
        }

        .btn-success {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .btn-edit {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
            border: none;
            padding: 0.4rem 0.8rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
        }

        .btn-edit:hover {
            background: linear-gradient(135deg, #d97706, #b45309);
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(217, 119, 6, 0.3);
        }

        .btn-cancel {
            background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
            color: white;
            border: 2px solid transparent;
            padding: 14px 28px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            font-size: 15px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            position: relative;
            overflow: hidden;
        }

        .btn-cancel::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            transform: translate(-50%, -50%);
            transition: width 0.5s, height 0.5s;
        }

        .btn-cancel:hover {
            background: linear-gradient(135deg, #4b5563 0%, #374151 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.25);
        }

        .btn-cancel:hover::before {
            width: 300px;
            height: 300px;
        }

        .btn-cancel:active {
            transform: translateY(0px);
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.2);
        }

        body.dark-mode .btn-cancel {
            background: linear-gradient(135deg, rgba(107, 114, 128, 0.3) 0%, rgba(75, 85, 99, 0.5) 100%);
            border-color: rgba(107, 114, 128, 0.5);
        }

        body.dark-mode .btn-cancel:hover {
            background: linear-gradient(135deg, rgba(75, 85, 99, 0.5) 0%, rgba(55, 65, 81, 0.7) 100%);
            border-color: rgba(107, 114, 128, 0.7);
        }

        .btn-delete {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            border: none;
            padding: 0.4rem 0.8rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
        }

        .btn-delete:hover {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(220, 38, 38, 0.3);
        }

        .search-section {
            padding: 20px;
            border-bottom: 1px solid #e5e7eb;
        }

        .search-input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 15px;
        }

        .filters-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .filter-select {
            padding: 10px 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
        }

        .products-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .product-item {
            padding: 15px;
            border-bottom: 1px solid #e5e7eb;
            cursor: pointer;
            transition: background-color 0.3s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .product-item:hover {
            background-color: #f8fafc;
        }

        .product-info h4 {
            margin: 0 0 5px 0;
            color: #1f2937;
        }

        .product-info p {
            margin: 0;
            color: #6b7280;
            font-size: 14px;
        }

        .products-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .products-table th,
        .products-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }

        .products-table th {
            background-color: #f8fafc;
            font-weight: 600;
            color: #374151;
        }

        .products-table tbody tr:hover {
            background-color: #f8fafc;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-active {
            background-color: #d1fae5;
            color: #065f46;
        }

        .status-inactive {
            background-color: #fee2e2;
            color: #991b1b;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #6b7280;
        }

        /* Estilos para formulario simplificado */
        .simplified-form {
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        .essential-fields {
            background: #f8fafc;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #e2e8f0;
        }

        .essential-fields h4 {
            margin: 0 0 15px 0;
            color: #1f2937;
            font-size: 16px;
            font-weight: 600;
        }

        .automatic-fields {
            background: #f0f9ff;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #bae6fd;
        }

        .automatic-fields h4 {
            margin: 0 0 15px 0;
            color: #0369a1;
            font-size: 16px;
            font-weight: 600;
        }

        .auto-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .auto-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
            padding: 10px;
            background: white;
            border-radius: 6px;
            border: 1px solid #e0f2fe;
        }

        .auto-label {
            font-weight: 600;
            font-size: 12px;
            color: #0369a1;
        }

        .auto-value {
            font-size: 14px;
            color: #374151;
            font-style: italic;
        }

        .form-field small {
            font-size: 12px;
            color: #6b7280;
            margin-top: 4px;
            font-style: italic;
        }

        .form-field select {
            padding: 12px 15px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            background: white;
            cursor: pointer;
        }

        .form-field select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        @media (max-width: 768px) {
            .auto-info {
                grid-template-columns: 1fr;
            }
            
            .simplified-form {
                gap: 20px;
            }
        }

        /* Estilos para Cola de Impresi√≥n */
        .printer-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            font-weight: 600;
        }

        .status-indicator {
            font-size: 12px;
            animation: pulse 2s infinite;
        }

        .status-connected {
            color: #10b981;
        }

        .status-disconnected {
            color: #ef4444;
        }

        .status-checking {
            color: #f59e0b;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .queue-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .queue-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8fafc;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }

        .summary-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .summary-label {
            font-size: 12px;
            color: #6b7280;
            font-weight: 600;
        }

        .summary-value {
            font-size: 18px;
            font-weight: 700;
            color: #1f2937;
        }

        .queue-container {
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            overflow: hidden;
        }

        .queue-table {
            width: 100%;
            border-collapse: collapse;
        }

        .queue-table th {
            background: #f8fafc;
            padding: 12px 8px;
            text-align: left;
            font-weight: 600;
            font-size: 12px;
            color: #374151;
            border-bottom: 2px solid #e2e8f0;
        }

        .queue-table td {
            padding: 10px 8px;
            border-bottom: 1px solid #f1f5f9;
            font-size: 13px;
        }

        .queue-table tbody tr:hover {
            background-color: #f8fafc;
        }

        .queue-status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-pendiente {
            background-color: #fef3c7;
            color: #92400e;
        }

        .status-imprimiendo {
            background-color: #dbeafe;
            color: #1e40af;
        }

        .status-impresa {
            background-color: #d1fae5;
            color: #065f46;
        }

        .status-error {
            background-color: #fee2e2;
            color: #991b1b;
        }

        .queue-actions {
            display: flex;
            gap: 5px;
        }

        .action-btn {
            padding: 4px 8px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 600;
            transition: all 0.2s;
        }

        .action-btn-retry {
            background: #f59e0b;
            color: white;
        }

        .action-btn-retry:hover {
            background: #d97706;
        }

        .qr-code-display {
            font-family: monospace;
            font-size: 11px;
            max-width: 120px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .queue-notifications {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1001;
            max-width: 400px;
        }

        .notification-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 15px;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            animation: slideInRight 0.3s ease;
        }

        .notification-close {
            background: none;
            border: none;
            font-size: 16px;
            cursor: pointer;
            color: #6b7280;
            margin-left: auto;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        @media (max-width: 768px) {
            .queue-controls {
                justify-content: center;
            }
            
            .queue-table {
                font-size: 12px;
            }
            
            .queue-table th, .queue-table td {
                padding: 8px 4px;
            }
            
            .queue-notifications {
                left: 10px;
                right: 10px;
                max-width: none;
            }
        }

        /* ============================================
           ESTILOS PARA GESTI√ìN DE USUARIOS
           ============================================ */

        /* Bot√≥n de Gesti√≥n en header */
        .gestion-icon-mini {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.15);
            border: 1.5px solid rgba(255, 255, 255, 0.25);
            transition: all 0.3s ease;
            position: relative;
        }

        .gestion-icon-mini:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .gestion-icon-mini:active {
            transform: scale(0.95);
        }

        /* Modal overlay */
        .gestion-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.75);
            backdrop-filter: blur(5px);
            z-index: 9999;
            display: none;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }

        .gestion-modal-overlay.show {
            display: flex;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        /* Modal contenedor */
        .gestion-modal {
            background: white;
            border-radius: 20px;
            width: 95%;
            max-width: 900px;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
            animation: slideUp 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        body.dark-mode .gestion-modal {
            background: #1f2937;
            color: #e5e7eb;
        }

        @keyframes slideUp {
            from {
                transform: translateY(50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* Header del modal */
        .gestion-modal-header {
            background: linear-gradient(135deg, #ec4899, #d946ef);
            color: white;
            padding: 20px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 3px solid rgba(255, 255, 255, 0.3);
        }

        body.dark-mode .gestion-modal-header {
            background: linear-gradient(135deg, #7c3aed, #a855f7);
        }

        .gestion-modal-title {
            font-size: 24px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 0;
        }

        .gestion-modal-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 28px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            line-height: 1;
        }

        .gestion-modal-close:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg);
        }

        /* Contenido del modal */
        .gestion-modal-body {
            padding: 25px;
            overflow-y: auto;
            flex: 1;
        }

        /* Tabla de usuarios */
        .gestion-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        body.dark-mode .gestion-table {
            background: #374151;
        }

        .gestion-table thead {
            background: linear-gradient(135deg, #ec4899, #d946ef);
            color: white;
        }

        body.dark-mode .gestion-table thead {
            background: linear-gradient(135deg, #7c3aed, #a855f7);
        }

        .gestion-table th {
            padding: 15px 12px;
            text-align: left;
            font-weight: 600;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .gestion-table th:first-child {
            padding-left: 20px;
        }

        .gestion-table th:last-child {
            padding-right: 20px;
            text-align: center;
        }

        .gestion-table tbody tr {
            border-bottom: 1px solid #f3f4f6;
            transition: all 0.2s ease;
        }

        body.dark-mode .gestion-table tbody tr {
            border-bottom: 1px solid #4b5563;
        }

        .gestion-table tbody tr:hover {
            background: #fce7f3;
        }

        body.dark-mode .gestion-table tbody tr:hover {
            background: #4b5563;
        }

        .gestion-table tbody tr:last-child {
            border-bottom: none;
        }

        .gestion-table td {
            padding: 15px 12px;
            font-size: 14px;
        }

        .gestion-table td:first-child {
            padding-left: 20px;
            font-weight: 600;
            color: #6b7280;
        }

        body.dark-mode .gestion-table td:first-child {
            color: #9ca3af;
        }

        .gestion-table td:last-child {
            text-align: center;
        }

        /* Input editable */
        .gestion-input {
            width: 100%;
            padding: 8px 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.2s ease;
            background: white;
        }

        body.dark-mode .gestion-input {
            background: #1f2937;
            border-color: #4b5563;
            color: #e5e7eb;
        }

        .gestion-input:focus {
            outline: none;
            border-color: #ec4899;
            box-shadow: 0 0 0 3px rgba(236, 72, 153, 0.1);
        }

        body.dark-mode .gestion-input:focus {
            border-color: #a855f7;
            box-shadow: 0 0 0 3px rgba(168, 85, 247, 0.2);
        }

        /* Select de rol */
        .gestion-select {
            width: 100%;
            padding: 8px 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            background: white;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        body.dark-mode .gestion-select {
            background: #1f2937;
            border-color: #4b5563;
            color: #e5e7eb;
        }

        .gestion-select:focus {
            outline: none;
            border-color: #ec4899;
            box-shadow: 0 0 0 3px rgba(236, 72, 153, 0.1);
        }

        /* Badge de estado */
        .gestion-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .gestion-badge.activo {
            background: #d1fae5;
            color: #065f46;
        }

        body.dark-mode .gestion-badge.activo {
            background: #064e3b;
            color: #6ee7b7;
        }

        .gestion-badge.inactivo {
            background: #fee2e2;
            color: #991b1b;
        }

        body.dark-mode .gestion-badge.inactivo {
            background: #7f1d1d;
            color: #fca5a5;
        }

        /* Toggle de auto_services */
        .auto-service-toggle {
            display: flex;
            gap: 8px;
            align-items: center;
            justify-content: center;
        }

        .toggle-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            border: 2px solid;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
            /* Estado INACTIVO por defecto: gris, peque√±o, hacia atr√°s */
            filter: grayscale(100%);
            opacity: 0.5;
            transform: scale(0.85);
        }

        .toggle-btn.automatico {
            background: #d1fae5;
            border-color: #10b981;
            color: #065f46;
        }

        .toggle-btn.automatico:hover {
            background: #10b981;
            color: white;
            transform: scale(1.05);
            filter: grayscale(0%);
            opacity: 0.9;
        }

        /* Estado ACTIVO: grande, brillante, hacia adelante */
        .toggle-btn.automatico.active {
            background: #10b981;
            color: white;
            box-shadow: 0 0 15px rgba(16, 185, 129, 0.6), 0 0 0 4px rgba(16, 185, 129, 0.2);
            filter: grayscale(0%);
            opacity: 1;
            transform: scale(1.15);
            font-weight: 700;
        }

        .toggle-btn.manual {
            background: #fee2e2;
            border-color: #ef4444;
            color: #991b1b;
        }

        .toggle-btn.manual:hover {
            background: #ef4444;
            color: white;
            transform: scale(1.05);
            filter: grayscale(0%);
            opacity: 0.9;
        }

        /* Estado ACTIVO: grande, brillante, hacia adelante */
        .toggle-btn.manual.active {
            background: #ef4444;
            color: white;
            box-shadow: 0 0 15px rgba(239, 68, 68, 0.6), 0 0 0 4px rgba(239, 68, 68, 0.2);
            filter: grayscale(0%);
            opacity: 1;
            transform: scale(1.15);
            font-weight: 700;
        }

        body.dark-mode .toggle-btn.automatico {
            background: #064e3b;
            color: #6ee7b7;
            border-color: #059669;
        }

        body.dark-mode .toggle-btn.automatico.active {
            background: #059669;
            color: white;
            box-shadow: 0 0 15px rgba(5, 150, 105, 0.6), 0 0 0 4px rgba(5, 150, 105, 0.2);
        }

        body.dark-mode .toggle-btn.manual {
            background: #7f1d1d;
            color: #fca5a5;
            border-color: #dc2626;
        }

        body.dark-mode .toggle-btn.manual.active {
            background: #dc2626;
            color: white;
            box-shadow: 0 0 15px rgba(220, 38, 38, 0.6), 0 0 0 4px rgba(220, 38, 38, 0.2);
        }

        /* Loading spinner */
        .gestion-loading {
            text-align: center;
            padding: 40px;
            color: #6b7280;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #f3f4f6;
            border-top-color: #ec4899;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Responsive para tablets y m√≥viles */
        @media (max-width: 768px) {
            .gestion-modal {
                width: 98%;
                max-height: 95vh;
                border-radius: 15px;
            }

            .gestion-modal-title {
                font-size: 18px;
            }

            .gestion-modal-body {
                padding: 15px;
            }

            .gestion-table {
                font-size: 12px;
            }

            .gestion-table th, .gestion-table td {
                padding: 10px 8px;
            }

            .gestion-table th:first-child,
            .gestion-table td:first-child {
                padding-left: 12px;
            }

            .gestion-input, .gestion-select {
                font-size: 16px; /* Para evitar zoom en iOS */
            }

            .toggle-btn {
                font-size: 11px;
                padding: 6px 10px;
            }
        }
    </style>
</head>
<body>

    <!-- Estrellas decorativas -->
    <div class="stars-container">
        <div class="star-deco">‚≠ê</div>
        <div class="star-deco">‚ú®</div>
        <div class="star-deco">üí´</div>
        <div class="star-deco">üåü</div>
        <div class="star-deco">‚ö°</div>
    </div>

    <!-- Mariposas flotantes -->
    <div class="butterflies-container">
        <div class="butterfly">ü¶ã</div>
        <div class="butterfly">ü¶ã</div>
        <div class="butterfly">ü¶ã</div>
    </div>

    <div class="header">
        <div class="header-content">
            <div class="header-left">
                <!--LOGO_START<img src="assets/logoicon.png" alt="Logo" class="header-logo" />LOGO_END-->
                <h1>üè∑Ô∏è Dashboard Supervisor</h1>
            </div>
            <div class="user-info">
                <!-- Bot√≥n Juegos (mando) -->
                <a href="/games/panel-juegos.html" class="games-icon-mini" title="Juegos" aria-label="Juegos">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                        <path d="M6 10h.01M18 10h.01M12 10v.01M12 14v.01M21 8c0-1.1-.9-2-2-2h-2.27c-.46 0-.9-.28-1.06-.72L14.4 2.3A2 2 0 0 0 12.61 1H11.4a2 2 0 0 0-1.79 1.3L8.33 5.3c-.16.44-.6.72-1.06.72H5c-1.1 0-2 .9-2 2v6c0 1.1.9 2 2 2h3l1 2h6l1-2h3c1.1 0 2-.9 2-2V8z" stroke="#fff" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </a>
                <!-- Bot√≥n Gesti√≥n de Usuarios -->
                <div class="gestion-icon-mini" onclick="abrirGestionUsuarios()" title="Gesti√≥n de Usuarios" style="cursor: pointer;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2M9 11a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM23 21v-2a4 4 0 0 0-3-3.87M16 3.13a4 4 0 0 1 0 7.75" stroke="#fff" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </div>
                
                <!-- Bot√≥n Entidades (Empresas) -->
                <div class="gestion-icon-mini" onclick="abrirModalNuevaEntidad()" title="Registrar Nueva Entidad (Empresa)" style="cursor: pointer;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M3 21h18M3 7v14M21 7v14M9 7h6M9 11h6M9 15h6M7 3h10l2 4H5l2-4z" stroke="#fff" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </div>
                
                <!-- Toggle Decoraciones -->
                <div class="decorations-toggle" onclick="toggleDecorations()" title="Mostrar/Ocultar decoraciones">
                    <span id="decorations-toggle-icon">‚ú®</span>
                </div>
                <div class="crown-icon">üëë</div>
                <div>
                    <div id="supervisor-name">Panchita</div>
                    <small>Supervisor General</small>
                </div>
                <button class="logout-btn" onclick="logout()">Salir</button>
            </div>
        </div>
    </div>

    <!-- Indicador de modo actual -->
    <div class="main-container">
        <!-- Mensaje personalizado para supervisor -->
        <div class="supervisor-greeting-card" id="supervisor-greeting-card">
            <div class="supervisor-greeting-content">
                <div class="supervisor-greeting-icon" id="supervisor-greeting-icon">üåÖ</div>
                <div class="supervisor-greeting-text">
                    <h3 id="supervisor-greeting-title">Buenos d√≠as</h3>
                    <p id="supervisor-greeting-message">Cargando mensaje personalizado...</p>
                    <div class="supervisor-stats-summary" id="supervisor-stats-summary">
                        <span class="supervisor-stat-badge impresa">
                            <span class="supervisor-stat-number" id="supervisor-stats-impresa">0</span>
                            <span class="supervisor-stat-label">Impresas</span>
                        </span>
                        <span class="supervisor-stat-badge completado">
                            <span class="supervisor-stat-number" id="supervisor-stats-completado">0</span>
                            <span class="supervisor-stat-label">Completadas</span>
                        </span>
                        <span class="supervisor-stat-badge proceso">
                            <span class="supervisor-stat-number" id="supervisor-stats-proceso">0</span>
                            <span class="supervisor-stat-label">En Proceso</span>
                        </span>
                        
                        <!-- üñ®Ô∏è Indicadores de Impresoras -->
                        <span class="supervisor-stat-badge printer-status" id="godex-badge" title="Estado de Godex G530">
                            <span class="printer-indicator" id="godex-indicator">‚ö™</span>
                            <span class="supervisor-stat-label">Godex</span>
                        </span>
                        <span class="supervisor-stat-badge printer-status" id="zebra-badge" title="Estado de Zebra ZD230">
                            <span class="printer-indicator" id="zebra-indicator">‚ö™</span>
                            <span class="supervisor-stat-label">Zebra</span>
                        </span>
                    </div>
                </div>
                <div class="mode-actions">
                    <button class="return-btn" id="return-btn" onclick="returnToSupervisorMode()" style="display: none;">
                        Volver a Supervisor
                    </button>
                </div>
            </div>
        </div>

        <!-- //DEBUG MOVIL desactivado -->
        <!-- Panel de Debug para m√≥viles -->
        <!--
        <div id="mobile-debug-panel" style="background: #1f2937; color: #10b981; padding: 10px; margin: 10px 0; border-radius: 8px; font-family: monospace; font-size: 12px; max-height: 200px; overflow-y: auto; display: none;">
            <div style="color: #f59e0b; font-weight: bold; margin-bottom: 5px;">üîç DEBUG M√ìVIL (Toca para ocultar)</div>
            <div id="mobile-debug">Iniciando debug...</div>
        </div>
        -->

        <!-- //automatizador en pruebas -->
        <!-- Configuraci√≥n de Auto-aprobaci√≥n -->
        <!--
        <div class="section-card" style="margin-bottom: 20px; background: linear-gradient(135deg, #fef3c7 0%, #f59e0b 100%); border: none;">
            <div class="section-header">
                <div class="section-icon">‚è∞</div>
                <h2 class="section-title" style="color: #92400e;">Opcion en desarrollo no activar</h2>
                <button class="toggle-section-btn" onclick="toggleAutoApprovalSection()" style="background: rgba(146, 64, 14, 0.2); color: #92400e;">
                    ‚öôÔ∏è Configurar
                </button>
            </div>
            
            <div id="auto-approval-config" style="display: none; margin-top: 1rem; background: rgba(255,255,255,0.9); padding: 1rem; border-radius: 8px; border: 1px solid rgba(146, 64, 14, 0.2);">
                <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                    <label style="display: flex; align-items: center; gap: 0.5rem; font-weight: 600;">
                        <input type="checkbox" id="autoApprovalEnabled" onchange="toggleAutoApproval()" style="transform: scale(1.2);">
                        Activar auto-aprobaci√≥n autom√°tica
                    </label>
                </div>
                
                <div id="auto-approval-options" style="display: none;">
                    <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                        <label style="font-weight: 600; color: #92400e;">Aprobar autom√°ticamente despu√©s de:</label>
                        <select id="autoApprovalTime" onchange="updateAutoApprovalSettings()" style="padding: 0.5rem; border-radius: 4px; border: 1px solid #d97706;">
                            <option value="10">10 minutos</option>
                            <option value="30">30 minutos</option>
                            <option value="60">1 hora</option>
                            <option value="120">2 horas</option>
                        </select>
                    </div>
                    
                    <div style="background: #fef2f2; padding: 0.75rem; border-radius: 4px; border-left: 4px solid #ef4444; margin-bottom: 1rem;">
                        <p style="font-size: 0.875rem; color: #991b1b;">
                            ‚ö†Ô∏è <strong>Importante:</strong> Las solicitudes pendientes se aprobar√°n autom√°ticamente despu√©s del tiempo configurado. 
                            Solo aplica para nuevas solicitudes.
                        </p>
                    </div>
                    
                    <div style="display: flex; gap: 1rem;">
                        <button onclick="testAutoApproval()" class="action-btn" style="background: #10b981; padding: 0.5rem 1rem;">
                            üß™ Probar Sistema
                        </button>
                        <button onclick="resetAutoApprovalTimers()" class="action-btn" style="background: #ef4444; padding: 0.5rem 1rem;">
                            üîÑ Reiniciar Temporizadores
                        </button>
                    </div>
                </div>

             Status del sistema
              //<div id="auto-approval-status" style="margin-top: 1rem; padding: 0.75rem; background: #f3f4f6; border-radius: 4px; display: none;">
                    <p style="font-size: 0.875rem; color: #374151;">
                        <strong>Estado:</strong> <span id="auto-approval-status-text">Inactivo</span>
                    </p>
                    <p style="font-size: 0.875rem; color: #374151; margin-top: 0.25rem;">
                        <strong>Pr√≥ximas aprobaciones:</strong> <span id="pending-auto-approvals">0</span>
                    </p>
                </div>
            </div> 
        </div> -->
        

        <!-- Secciones del Dashboard -->
        <div class="dashboard-sections" id="dashboard-sections">
            <!-- 1. Secci√≥n TODAS LAS SOLICITUDES RECIENTES (√∫ltimas 24 horas) -->
            <div class="section-card">
                <div class="section-header">
                    <div class="section-icon" id="solicitudes-icon" onclick="cambiarModoSolicitudes()" style="cursor: pointer;" title="Click para cambiar entre Normales y Especiales">üìã</div>
                    <h2 class="section-title" id="solicitudes-title">Solicitudes Pendientes</h2>
                    <button class="refresh-btn" onclick="refreshSolicitudesActuales()" title="Actualizar solicitudes">
                        üîÑ Actualizar
                    </button>
                </div>
                
                <!-- Pesta√±as de filtro -->
                <div class="solicitudes-tabs">
                    <button class="tab-btn active" onclick="filtrarSolicitudesPorEstado('todas')" data-estado="todas">
                        <div style="font-size: 20px; margin-bottom: 2px;">üåê</div>
                        <div style="font-size: 11px; opacity: 0.9;">Todas</div>
                        <span id="count-todas" style="font-size: 18px; font-weight: 800;">0</span>
                    </button>
                    <button class="tab-btn" onclick="filtrarSolicitudesPorEstado('pendiente')" data-estado="pendiente">
                        <div style="font-size: 20px; margin-bottom: 2px;">‚è≥</div>
                        <div style="font-size: 11px; opacity: 0.9;">Pendientes</div>
                        <span id="count-pendiente" style="font-size: 18px; font-weight: 800;">0</span>
                    </button>
                    <button class="tab-btn" onclick="filtrarSolicitudesPorEstado('proceso')" data-estado="proceso">
                        <div style="font-size: 20px; margin-bottom: 2px;">üîÑ</div>
                        <div style="font-size: 11px; opacity: 0.9;">En Proceso</div>
                        <span id="count-proceso" style="font-size: 18px; font-weight: 800;">0</span>
                    </button>
                    <button class="tab-btn" onclick="filtrarSolicitudesPorEstado('completada')" data-estado="completada">
                        <div style="font-size: 20px; margin-bottom: 2px;">‚úÖ</div>
                        <div style="font-size: 11px; opacity: 0.9;">Completadas</div>
                        <span id="count-completada" style="font-size: 18px; font-weight: 800;">0</span>
                    </button>
                </div>
                
                <!-- Lista de solicitudes -->
                <div class="pending-list" id="todas-solicitudes-list">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Cargando solicitudes...</p>
                    </div>
                </div>
            </div>

            <!-- 2. Secci√≥n Solicitudes Pendientes (SOLO pendientes) -->
            <div class="section-card" style="display: none;">
                <div class="section-header">
                    <div class="section-icon">‚è≥</div>
                    <h2 class="section-title">Solicitudes Pendientes</h2>
                    <button class="refresh-btn" onclick="refreshSolicitudes()" title="Actualizar solicitudes">
                        üîÑ Actualizar
                    </button>
                </div>
                <div class="pending-list" id="pending-list">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Cargando solicitudes...</p>
                    </div>
                </div>
            </div>

            <!-- 2. Secci√≥n Gesti√≥n de Productos -->
            <div class="section-card">
                <div class="section-header">
                    <div class="section-icon">üì¶</div>
                    <h2 class="section-title">Gesti√≥n de Productos</h2>
                </div>
                <div class="productos-grid">
                    <div class="producto-action-card" onclick="showAddProductModal()">
                        <div class="action-icon add-icon">‚ûï</div>
                        <h3>A√±adir Producto</h3>
                        <p></p>
                    </div>
                    <div class="producto-action-card" onclick="showRemoveProductModal()">
                        <div class="action-icon remove-icon">‚ûñ</div>
                        <h3>Quitar Producto</h3>
                        <p></p>
                    </div>
                    <div class="producto-action-card" onclick="showProductsListModal()">
                        <div class="action-icon search-icon">üîç</div>
                        <h3>Consultar Productos</h3>
                        <p></p>
                    </div>
                    <div class="producto-action-card" onclick="showGestionProductosEspecialesModal()">
                        <div class="action-icon special-icon" style="background: linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%);">üéÅ</div>
                        <h3>Productos Especiales</h3>
                        <p></p>
                    </div>
                    <div class="producto-action-card" onclick="showGestionSolicitudesEspecialesModal()">
                        <div class="action-icon special-icon" style="background: linear-gradient(135deg, #ec4899 0%, #be185d 100%);">üìã</div>
                        <h3>Solicitudes Especiales</h3>
                        <p></p>
                    </div>
                </div>
            </div>

            <!-- 3. Secci√≥n Costureras -->
            <div class="section-card">
                <div class="section-header">
                    <div class="section-icon">‚úÇÔ∏è</div>
                    <h2 class="section-title">Costureras</h2>
                </div>
                <div class="costureras-grid" id="costureras-grid">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Cargando costureras...</p>
                    </div>
                </div>
            </div>

            <!-- 4. Secci√≥n Estad√≠sticas -->
            <div class="section-card">
                <div class="section-header">
                    <div class="section-icon">üìä</div>
                    <h2 class="section-title">Estad√≠sticas del D√≠a</h2>
                </div>
                <div class="stats-grid" id="stats-grid">
                    <div class="stat-item">
                        <div class="stat-number" id="total-pendientes">-</div>
                        <div class="stat-label">Pendientes</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="total-proceso">-</div>
                        <div class="stat-label">En Proceso</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="total-completadas">-</div>
                        <div class="stat-label">Completadas</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="total-hoy">-</div>
                        <div class="stat-label">Hoy</div>
                    </div>
                </div>
            </div>

            <!-- Modal Nueva Entidad -->
            <div class="modal-overlay" id="modal-nueva-entidad" style="display: none;">
                <div class="modal-content" style="max-width: 550px;">
                    <div class="modal-header">
                        <h3>üè¢ Registrar Nueva Entidad (Empresa)</h3>
                        <button class="close-modal-btn" onclick="cerrarModalNuevaEntidad()">‚úñ</button>
                    </div>
                    <form id="form-nueva-entidad" onsubmit="crearEntidad(event)">
                        <div style="padding: 25px;">
                            <div style="background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #3b82f6;">
                                <p style="margin: 0; color: #1e40af; font-size: 14px; line-height: 1.5;">
                                    <strong>üí° Informaci√≥n:</strong> Las entidades registradas aqu√≠ aparecer√°n en el desplegable de las costureras al crear solicitudes de etiquetas.
                                </p>
                            </div>
                            
                            <div class="form-group" style="margin-bottom: 20px;">
                                <label for="nueva-entidad-nombre" style="display: block; margin-bottom: 10px; font-weight: 600; color: #374151; font-size: 15px;">
                                    üè∑Ô∏è Nombre de la Entidad *
                                </label>
                                <input type="text" id="nueva-entidad-nombre" name="nombre_entidad" required 
                                       placeholder="Ejemplo: HECHO EN PERU, EMPRESA XYZ S.A.C., etc." maxlength="100"
                                       style="width: 100%; padding: 14px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 15px; transition: all 0.3s;"
                                       onfocus="this.style.borderColor='#3b82f6'; this.style.boxShadow='0 0 0 3px rgba(59, 130, 246, 0.1)'" 
                                       onblur="this.style.borderColor='#e5e7eb'; this.style.boxShadow='none'">
                                <small style="display: block; margin-top: 8px; color: #6b7280; font-size: 13px;">
                                    Se convertir√° autom√°ticamente a may√∫sculas
                                </small>
                            </div>
                        </div>
                        
                        <div class="modal-footer" style="display: flex; gap: 12px; justify-content: flex-end; padding: 20px; background: #f9fafb; border-top: 1px solid #e5e7eb;">
                            <button type="button" class="btn btn-secondary" onclick="cerrarModalNuevaEntidad()" 
                                    style="padding: 12px 24px; font-size: 15px;">
                                ‚ùå Cancelar
                            </button>
                            <button type="submit" class="btn btn-primary" 
                                    style="padding: 12px 24px; font-size: 15px; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);">
                                ‚úÖ Crear Entidad
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- 6. Secci√≥n Historial Completo -->
            <div class="section-card">
                <div class="section-header">
                    <div class="section-icon">üìã</div>
                    <h2 class="section-title">Historial de Solicitudes</h2>
                    <button class="btn btn-primary" onclick="toggleHistorial()" id="historial-btn">
                        üìä Ver Historial
                    </button>
                </div>
                
                <!-- Panel de Filtros -->
                <div class="historial-filters" id="historial-filters" style="display: none;">
                    <div class="filters-grid">
                        <div class="filter-group">
                            <label>üìÖ Fecha Desde:</label>
                            <input type="date" id="filter-fecha-desde" class="filter-input">
                        </div>
                        <div class="filter-group">
                            <label>ÔøΩ Fecha Hasta:</label>
                            <input type="date" id="filter-fecha-hasta" class="filter-input">
                        </div>
                        <div class="filter-group">
                            <label>üè∑Ô∏è Estado:</label>
                            <div class="checkbox-group">
                                <label><input type="checkbox" id="filter-pendiente" checked> Pendiente</label>
                                <label><input type="checkbox" id="filter-proceso" checked> En Proceso</label>
                                <label><input type="checkbox" id="filter-completada" checked> Completada</label>
                            </div>
                        </div>
                        <div class="filter-group">
                            <label>üë§ Costurera:</label>
                            <select id="filter-costurera" class="filter-select">
                                <option value="">Todas las costureras</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>üî¢ ID Solicitud:</label>
                            <input type="text" id="filter-id" placeholder="Ej: SOL-123" class="filter-input">
                        </div>
                        <div class="filter-actions">
                            <button class="btn btn-primary" onclick="applyFilters()">üîç Aplicar Filtros</button>
                            <button class="btn btn-secondary" onclick="clearFilters()">üóëÔ∏è Limpiar</button>
                        </div>
                    </div>
                </div>

                <!-- Tabla de Historial -->
                <div class="historial-content" id="historial-content" style="display: none;">
                    <div class="historial-stats" id="historial-stats"></div>
                    <div style="max-height: 500px; overflow-y: auto;">
                        <table class="historial-table" id="historial-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>N√∫mero</th>
                                    <th>Costurera</th>
                                    <th>Producto</th>
                                    <th>Cantidad</th>
                                    <th>Estado</th>
                                    <th>Fecha</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="historial-tbody">
                                <tr><td colspan="8" class="loading">Cargando historial...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 6. Secci√≥n Cola de Impresi√≥n -->
            <div class="section-card">
                <div class="section-header">
                    <div class="section-icon">üñ®Ô∏è</div>
                    <h2 class="section-title">Cola de Impresi√≥n</h2>
                    <div class="printer-status" id="printer-status">
                        <span class="status-indicator" id="printer-indicator">‚ö™</span>
                        <span id="printer-text">Verificando...</span>
                    </div>
                </div>
                
                <!-- Controles de la Cola -->
                <div class="queue-controls">
                    <button class="btn btn-primary" onclick="checkPrinterStatus()">üîç Verificar Impresora</button>
                    <button class="btn btn-success" id="resume-btn" onclick="resumePrinting()" style="display: none;">‚ñ∂Ô∏è Reanudar Impresi√≥n</button>
                    <button class="btn btn-warning" onclick="clearErrorJobs()">üóëÔ∏è Limpiar Errores</button>
                    <button class="btn btn-secondary" onclick="refreshPrintQueue()">üîÑ Actualizar</button>
                </div>

                <!-- Estado de la Cola -->
                <div class="queue-summary" id="queue-summary">
                    <div class="summary-item">
                        <span class="summary-label">En Cola:</span>
                        <span class="summary-value" id="queue-count">-</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">Procesando:</span>
                        <span class="summary-value" id="processing-status">-</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">√öltima Verificaci√≥n:</span>
                        <span class="summary-value" id="last-check">-</span>
                    </div>
                </div>

                <!-- Lista de Trabajos de Impresi√≥n -->
                <div class="queue-container" style="max-height: 400px; overflow-y: auto;">
                    <table class="queue-table" id="print-queue-table">
                        <thead>
                            <tr>
                                <th>Solicitud</th>
                                <th>Producto</th>
                                <th>Costurera</th>
                                <th>Cantidad</th>
                                <th>QR Code</th>
                                <th>Estado</th>
                                <th>Fecha</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="queue-tbody">
                            <tr>
                                <td colspan="8" class="loading">Cargando cola de impresi√≥n...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Notificaciones de la Cola -->
                <div class="queue-notifications" id="queue-notifications" style="display: none;">
                    <div class="notification-item">
                        <span class="notification-icon">‚ö†Ô∏è</span>
                        <span class="notification-text" id="notification-text"></span>
                        <button class="notification-close" onclick="hideQueueNotification()">‚úï</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Popup de Selecci√≥n: Tipo de Producto -->
    <div class="modal-overlay" id="tipo-producto-popup" style="display: none;">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3>‚ûï Selecciona el Tipo de Producto</h3>
                <button class="modal-close" onclick="closeModal('tipo-producto-popup')">‚úï</button>
            </div>
            <div style="padding: 30px;">
                <div style="display: grid; gap: 20px;">
                    <!-- Opci√≥n: Producto Normal -->
                    <div class="tipo-producto-option" onclick="seleccionarTipoProducto('normal')" 
                         style="border: 3px solid #10b981; border-radius: 12px; padding: 25px; cursor: pointer; transition: all 0.3s; background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);">
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <div style="font-size: 48px;">üì¶</div>
                            <div>
                                <h3 style="margin: 0 0 8px 0; color: #065f46;">Producto Normal</h3>
                                <p style="margin: 0; color: #047857; font-size: 14px;">
                                    Un producto individual (unidad)
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- Opci√≥n: Producto Especial (JUEGO) -->
                    <div class="tipo-producto-option" onclick="seleccionarTipoProducto('especial')"
                         style="border: 3px solid #f59e0b; border-radius: 12px; padding: 25px; cursor: pointer; transition: all 0.3s; background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);">
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <div style="font-size: 48px;">‚≠ê</div>
                            <div>
                                <h3 style="margin: 0 0 8px 0; color: #92400e;">Producto Especial (JUEGO/COMBO)</h3>
                                <p style="margin: 0; color: #b45309; font-size: 14px;">
                                    Un conjunto de productos (en desarrollo)
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <div style="margin-top: 20px; padding: 15px; background: #f0f9ff; border-left: 4px solid #3b82f6; border-radius: 4px;">
                    <strong style="color: #1e40af;">üí° Tip:</strong>
                    <p style="margin: 5px 0 0 0; color: #1e3a8a; font-size: 13px;">
                        Los productos especiales generan <strong>m√∫ltiples etiquetas</strong> autom√°ticamente:
                        1 etiqueta informativa + N etiquetas individuales de sus componentes.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para A√±adir Producto -->
    <div class="modal-overlay" id="add-product-modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>‚ûï A√±adir Nuevo Producto</h3>
                <button class="modal-close" onclick="closeModal('add-product-modal')">‚úï</button>
            </div>
            <form class="product-form" id="add-product-form">
                <div class="simplified-form">
                    <!-- CAMPOS QUE LLENAN LAS SUPERVISORAS -->
                    <div class="essential-fields">
                        <h4>üìã Informaci√≥n B√°sica (Requerida)</h4>
                        
                        <div class="form-field">
                            <label>üì¶ Nombre del Producto *</label>
                            <input type="text" id="new-nombre" placeholder="Escriba el nombre especifico del producto" required>
                            <small></small>
                        </div>

                        <div class="form-field">
                            <label>üè∑Ô∏è Subcategor√≠a *</label>
                            <select id="new-subcategoria" required>
                                <option value="">Seleccione el tipo de producto...</option>
                                <option value="PROTECTORES">PROTECTORES</option>
                                <option value="FRAZADAS">FRAZADAS</option>
                                <option value="SABANAS">SABANAS</option>
                                <option value="DUBET">DUBET</option>
                                <option value="EDREDONES">EDREDONES</option>
                            </select>
                            <small style="color: #666;">Solo productos terminados disponibles</small>
                        </div>

                        <div class="form-field">
                            <label>üè≠ Marca (opcional)</label>
                            <input type="text" id="new-marca" 
                                   placeholder=""
                                   list="new-marcas-datalist"
                                   autocomplete="off">
                            <datalist id="new-marcas-datalist">
                                <!-- Se llenar√° din√°micamente con JavaScript -->
                            </datalist>
                        </div>

                        <div class="form-field">
                            <label>üìã Modelo (opcional)</label>
                            <input type="text" id="new-modelo" 
                                   placeholder=""
                                   list="new-modelos-datalist"
                                   autocomplete="off">
                            <datalist id="new-modelos-datalist">
                                <!-- Se llenar√° din√°micamente con JavaScript -->
                            </datalist>
                        </div>
                    </div>

                    <!-- CAMPOS AUTOM√ÅTICOS (INFORMATIVOS) -->
                    <div class="automatic-fields">
                        <h4>Informaci√≥n Autom√°tica</h4>
                        <div class="auto-info">
                            <div class="auto-item">
                                <span class="auto-label">üî¢ C√≥digo:</span>
                                <span class="auto-value" id="preview-codigo">Se generar√° autom√°ticamente</span>
                            </div>
                            <div class="auto-item">
                                <span class="auto-label">üìù Descripci√≥n:</span>
                                <span class="auto-value" id="preview-descripcion">Igual al nombre del producto</span>
                            </div>
                            <div class="auto-item">
                                <span class="auto-label">üè∑Ô∏è Categor√≠a:</span>
                                <span class="auto-value">Productos Terminados</span>
                            </div>
                            <div class="auto-item">
                                <span class="auto-label">üìè Unidad:</span>
                                <span class="auto-value">UNIDAD</span>
                            </div>
                            <div class="auto-item">
                                <span class="auto-label">üîó C√≥digo de Barras:</span>
                                <span class="auto-value" id="preview-barcode">Se generar√° autom√°ticamente</span>
                            </div>
                            <div class="auto-item">
                                <span class="auto-label">üì¶ SKU:</span>
                                <span class="auto-value" id="preview-sku">Se generar√° autom√°ticamente</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('add-product-modal')">Cancelar</button>
                    <button type="submit" class="btn btn-success">üíæ Crear Producto</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para Quitar Producto -->
    <div class="modal-overlay" id="remove-product-modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>‚ûñ Desactivar Producto</h3>
                <button class="modal-close" onclick="closeModal('remove-product-modal')">‚úï</button>
            </div>
            <div class="search-section">
                <input type="text" id="search-product-remove" placeholder="üîç Buscar producto a desactivar..." class="search-input">
                <div class="products-list" id="remove-products-list">
                    <div class="loading">Cargando productos...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Consultar Productos -->
    <div class="modal-overlay" id="products-list-modal" style="display: none;">
        <div class="modal-content large-modal">
            <div class="modal-header">
                <h3 id="products-modal-title">üîç Consultar Productos Activos</h3>
                <button class="modal-close" onclick="closeModal('products-list-modal')">‚úï</button>
            </div>
            
            <!-- Botones de alternancia: Normales / Especiales -->
            <div style="padding: 15px; background: #f8fafc; border-bottom: 2px solid #e2e8f0; display: flex; gap: 10px; justify-content: center;">
                <button id="btn-productos-normales" class="btn-tipo-producto active" onclick="mostrarProductosNormales()" 
                        style="padding: 12px 24px; border-radius: 8px; border: 2px solid #3b82f6; background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: white; font-weight: bold; cursor: pointer; transition: all 0.3s;">
                    üì¶ Productos Normales
                </button>
                <button id="btn-productos-especiales" class="btn-tipo-producto" onclick="mostrarProductosEspeciales()" 
                        style="padding: 12px 24px; border-radius: 8px; border: 2px solid #f59e0b; background: white; color: #f59e0b; font-weight: bold; cursor: pointer; transition: all 0.3s;">
                    ‚≠ê Productos Especiales
                </button>
            </div>

            <div class="search-section">
                <input type="text" id="search-products" placeholder="üîç Buscar productos..." class="search-input">
                <div class="filters-row">
                    <select id="filter-categoria" class="filter-select">
                        <option value="">Todas las categor√≠as</option>
                    </select>
                    <select id="filter-subcategoria" class="filter-select">
                        <option value="">Todas las subcategor√≠as</option>
                    </select>
                </div>
            </div>
            <div style="max-height: 500px; overflow-y: auto;">
                <table class="products-table" id="products-table">
                    <thead>
                        <tr>
                            <th>C√≥digo</th>
                            <th>Nombre</th>
                            <th>Categor√≠a</th>
                            <th>Subcategor√≠a</th>
                            <th>Marca</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="products-tbody">
                        <tr><td colspan="7" class="loading">Cargando productos...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal para Editar Producto -->
    <div class="modal-overlay" id="edit-product-modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>‚úèÔ∏è Editar Producto</h3>
                <button class="modal-close" onclick="closeModal('edit-product-modal')">‚úï</button>
            </div>
            <form id="edit-product-form">
                <input type="hidden" id="edit-product-id">
                
                <!-- Secci√≥n de Informaci√≥n B√°sica -->
                <div class="product-info-section">
                    <!-- Nombre ocupa toda la fila -->
                    <div class="form-group full-width">
                        <label for="edit-product-name">üìù Nombre del Producto *</label>
                        <input type="text" id="edit-product-name" required 
                               placeholder="Ej: Sabana 2 plazas">
                    </div>

                    <!-- Grid de 2 columnas para campos cortos -->
                    <div class="form-grid-2col">
                        <div class="form-group">
                            <label for="edit-product-brand">üè≠ Marca</label>
                            <input type="text" id="edit-product-brand" 
                                   placeholder="Marca"
                                   list="edit-marcas-datalist"
                                   autocomplete="off">
                            <datalist id="edit-marcas-datalist">
                                <!-- Se llenar√° din√°micamente con JavaScript -->
                            </datalist>
                        </div>

                        <div class="form-group">
                            <label for="edit-product-model">üìê Modelo</label>
                            <input type="text" id="edit-product-model" 
                                   placeholder="Modelo o talla"
                                   list="edit-modelos-datalist"
                                   autocomplete="off">
                            <datalist id="edit-modelos-datalist">
                                <!-- Se llenar√° din√°micamente con JavaScript -->
                            </datalist>
                        </div>

                        <div class="form-group">
                            <label for="edit-product-categoria">üè∑Ô∏è Categor√≠a *</label>
                            <select id="edit-product-categoria" required disabled style="background-color: #f5f5f5;">
                                <option value="Productos Terminados">Productos Terminados</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="edit-product-subcategoria">üìÇ Subcategor√≠a *</label>
                            <select id="edit-product-subcategoria" required>
                                <option value="">Seleccionar...</option>
                                <!-- Se cargar√°n din√°micamente desde PostgreSQL -->
                            </select>
                        </div>
                    </div>

                    <!-- Estado en su propia fila pero m√°s peque√±o -->
                    <div class="form-group compact">
                        <label for="edit-product-status">üîÑ Estado</label>
                        <select id="edit-product-status">
                            <option value="true">‚úÖ Activo</option>
                            <option value="false">‚ùå Inactivo</option>
                        </select>
                    </div>
                </div>

                <!-- Separador visual -->
                <hr style="margin: 30px 0; border: none; border-top: 3px solid rgba(236, 72, 153, 0.2); border-radius: 2px;">

                <!-- Configuraci√≥n de Etiqueta -->
                <div class="form-group label-config-section">
                    <label class="label-config-title">
                        <span class="title-icon">üè∑Ô∏è</span>
                        <span class="title-text">Configuraci√≥n de Etiqueta</span>
                    </label>
                    <p class="label-config-subtitle">
                        Personaliza los campos que aparecer√°n en las etiquetas impresas de este producto
                    </p>
                    
                    <!-- Botones Toggle con Descripciones -->
                    <div class="label-fields-grid">
                        <!-- QR -->
                        <div class="field-wrapper">
                            <button type="button" class="label-field-btn active" data-field="qr" onclick="toggleLabelFieldBtn(this, 'qr')">
                                <div class="field-icon">üì±</div>
                                <div class="field-name">QR</div>
                                <div class="field-check">‚úì</div>
                            </button>
                            <div class="field-description">
                                C√≥digo QR escaneable para identificaci√≥n r√°pida
                            </div>
                        </div>
                        
                        <!-- NOMBRE -->
                        <div class="field-wrapper">
                            <button type="button" class="label-field-btn active" data-field="nombre" onclick="toggleLabelFieldBtn(this, 'nombre')">
                                <div class="field-icon">üìù</div>
                                <div class="field-name">NOMBRE</div>
                                <div class="field-check">‚úì</div>
                            </button>
                            <div class="field-description">
                                Nombre completo del producto
                            </div>
                        </div>
                        
                        <!-- ID -->
                        <div class="field-wrapper">
                            <button type="button" class="label-field-btn" data-field="id" onclick="toggleLabelFieldBtn(this, 'id')">
                                <div class="field-icon">üî¢</div>
                                <div class="field-name">ID</div>
                                <div class="field-check">‚úó</div>
                            </button>
                            <div class="field-description">
                                C√≥digo de identificaci√≥n √∫nico
                            </div>
                        </div>
                        
                        <!-- UNIDAD -->
                        <div class="field-wrapper">
                            <button type="button" class="label-field-btn active" data-field="unidad" onclick="toggleLabelFieldBtn(this, 'unidad')">
                                <div class="field-icon">üì¶</div>
                                <div class="field-name">UNIDAD</div>
                                <div class="field-check">‚úì</div>
                            </button>
                            <div class="field-description">
                                Unidad de medida (pza, kg, m, etc)
                            </div>
                        </div>
                        
                        <!-- MODELO -->
                        <div class="field-wrapper">
                            <button type="button" class="label-field-btn active" data-field="modelo" onclick="toggleLabelFieldBtn(this, 'modelo')">
                                <div class="field-icon">üè≠</div>
                                <div class="field-name">MODELO</div>
                                <div class="field-check">‚úì</div>
                            </button>
                            <div class="field-description">
                                Modelo o variante del producto
                            </div>
                        </div>
                        
                        <!-- EMPRESA -->
                        <div class="field-wrapper">
                            <button type="button" class="label-field-btn active" data-field="empresa" onclick="toggleLabelFieldBtn(this, 'empresa')">
                                <div class="field-icon">üè¢</div>
                                <div class="field-name">EMPRESA</div>
                                <div class="field-check">‚úì</div>
                            </button>
                            <div class="field-description">
                                Texto "HECHO EN PERU"
                            </div>
                        </div>
                    </div>

                    <!-- Info Box -->
                    <div class="label-config-info">
                        <div class="info-icon">üí°</div>
                        <div class="info-content">
                            <strong>Consejo:</strong> Si desactivas el QR, el texto ocupar√° toda la etiqueta con letras m√°s grandes. 
                            Ideal para productos grandes que ya tienen c√≥digo de barras.
                        </div>
                    </div>

                    <!-- Campos hidden para enviar al backend -->
                    <input type="hidden" id="edit-product-mostrar-qr" value="true">
                    <input type="hidden" id="edit-product-mostrar-nombre" value="true">
                    <input type="hidden" id="edit-product-mostrar-id" value="true">
                    <input type="hidden" id="edit-product-mostrar-unidad" value="true">
                    <input type="hidden" id="edit-product-mostrar-modelo" value="true">
                    <input type="hidden" id="edit-product-mostrar-empresa" value="true">
                </div>

                <div class="form-actions">
                    <button type="button" class="btn-cancel" onclick="closeModal('edit-product-modal')">
                        Cancelar
                    </button>
                    <button type="submit" class="btn-primary">
                        üíæ Guardar Cambios
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para Productos Especiales -->
    <div class="modal-overlay" id="productos-especiales-modal" style="display: none;">
        <div class="modal-content large-modal">
            <div class="modal-header" style="background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); color: white;">
                <h3>‚≠ê Productos Especiales (JUEGOS y COMBOS)</h3>
                <button class="modal-close" onclick="closeModal('productos-especiales-modal')" style="color: white;">‚úï</button>
            </div>
            
            <div class="special-actions-bar" style="display: flex; justify-content: space-between; padding: 15px; background: #fef3c7; border-radius: 8px; margin-bottom: 20px;">
                <button class="btn-primary" onclick="showCrearEspecialModal()" style="background: linear-gradient(135deg, #10b981, #059669);">
                    ‚ûï Crear Producto Especial
                </button>
                <button class="btn-secondary" onclick="showSolicitudesEspecialesModal()" style="background: linear-gradient(135deg, #3b82f6, #1d4ed8);">
                    üìã Ver Solicitudes
                </button>
            </div>

            <div class="search-section">
                <input type="text" id="search-especiales" placeholder="üîç Buscar productos especiales..." class="search-input">
            </div>

            <div style="max-height: 500px; overflow-y: auto;">
                <table class="products-table" id="especiales-table">
                    <thead>
                        <tr>
                            <th>C√≥digo</th>
                            <th>Nombre</th>
                            <th>Componentes</th>
                            <th>Total Items</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="especiales-tbody">
                        <tr><td colspan="6" class="loading">Cargando productos especiales...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal para Crear/Editar Producto Especial -->
    <div class="modal-overlay" id="crear-especial-modal" style="display: none;">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); color: white;">
                <h3 id="crear-especial-title">‚≠ê Crear Producto Especial</h3>
                <button class="modal-close" onclick="closeModal('crear-especial-modal')" style="color: white;">‚úï</button>
            </div>
            
            <form id="crear-especial-form" style="padding: 30px;">
                <input type="hidden" id="especial-id">
                
                <!-- Informaci√≥n b√°sica -->
                <div style="background: white; border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <h4 style="margin: 0 0 20px 0; color: #1f2937; display: flex; align-items: center; gap: 8px;">
                        <span style="font-size: 24px;">üìù</span>
                        Informaci√≥n B√°sica
                    </h4>
                    
                    <!-- Campo c√≥digo oculto: se genera autom√°ticamente -->
                    <div class="form-group" style="margin-bottom: 15px; display: none;">
                        <label for="especial-codigo" style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">
                            üîñ C√≥digo del JUEGO/COMBO *
                        </label>
                        <input type="text" id="especial-codigo" placeholder="Ej: JUEGO-COB-2P"
                               style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px; transition: all 0.3s;"
                               onfocus="this.style.borderColor='#f59e0b'" onblur="this.style.borderColor='#e5e7eb'">
                    </div>
                    
                    <!-- Mensaje informativo sobre generaci√≥n autom√°tica -->
                    <div style="background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); padding: 12px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #3b82f6;">
                        <p style="margin: 0; color: #1e40af; font-size: 13px;">
                            <strong>‚ÑπÔ∏è C√≥digo autom√°tico:</strong> El c√≥digo se generar√° autom√°ticamente en formato <strong>ESP-001</strong>, <strong>ESP-002</strong>, etc.
                        </p>
                    </div>

                    <div class="form-group">
                        <label for="especial-nombre" style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">
                            üìù Nombre del Producto Especial *
                        </label>
                        <input type="text" id="especial-nombre" required placeholder="Ej: JUEGO COBERTOR 2P + SABANA 2P"
                               style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px; transition: all 0.3s;"
                               onfocus="this.style.borderColor='#f59e0b'" onblur="this.style.borderColor='#e5e7eb'">
                    </div>
                </div>

                <!-- Selecci√≥n de productos componentes -->
                <div style="background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%); border-radius: 12px; padding: 25px; margin-bottom: 20px; border: 2px solid #fbbf24;">
                    <h4 style="margin: 0 0 15px 0; color: #92400e; display: flex; align-items: center; gap: 8px;">
                        <span style="font-size: 24px;">üß©</span>
                        Productos que componen el JUEGO
                    </h4>
                    
                    <p style="margin: 0 0 20px 0; color: #b45309; font-size: 13px; background: white; padding: 10px; border-radius: 6px;">
                        üí° <strong>Tip:</strong> Empieza con 1 producto y usa el bot√≥n "+ A√±adir al juego" para agregar m√°s (m√°ximo 4)
                    </p>

                    <!-- Contenedor din√°mico de productos -->
                    <div id="productos-componentes-container">
                        <!-- Los productos se agregar√°n din√°micamente aqu√≠ -->
                    </div>

                    <!-- Bot√≥n para a√±adir m√°s productos -->
                    <button type="button" id="btn-agregar-producto" onclick="agregarProductoAlJuego()" 
                            style="width: 100%; padding: 12px; border-radius: 8px; border: 2px dashed #f59e0b; background: white; color: #f59e0b; font-weight: bold; cursor: pointer; transition: all 0.3s; margin-top: 15px;"
                            onmouseover="this.style.background='#fffbeb'" onmouseout="this.style.background='white'">
                        ‚ûï A√±adir al juego (m√°ximo 4 productos)
                    </button>
                </div>

                <div class="form-actions" style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button type="button" class="btn-cancel" onclick="closeModal('crear-especial-modal')"
                            style="padding: 12px 24px; border-radius: 8px; border: 2px solid #d1d5db; background: white; color: #6b7280; font-weight: 600; cursor: pointer;">
                        Cancelar
                    </button>
                    <button type="submit" class="btn-primary" 
                            style="padding: 12px 24px; border-radius: 8px; border: none; background: linear-gradient(135deg, #fbbf24, #f59e0b); color: white; font-weight: 600; cursor: pointer; box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);">
                        üíæ Guardar Producto Especial
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Configuraci√≥n de Etiqueta -->
    <div id="modal-config-etiqueta" class="modal-overlay" style="display: none;">
        <div class="modal-content" style="max-width: 600px;">
            <h3 style="margin: 0 0 20px 0; color: #1f2937; font-size: 20px;">
                ‚öôÔ∏è Configurar Etiqueta del Producto
            </h3>
            
            <div id="config-producto-info" style="padding: 12px; background: #f3f4f6; border-radius: 8px; margin-bottom: 20px;">
                <strong id="config-producto-nombre" style="color: #374151; font-size: 14px;"></strong>
                <p style="margin: 4px 0 0 0; font-size: 12px; color: #6b7280;">Selecciona qu√© informaci√≥n mostrar en la etiqueta</p>
            </div>

            <form id="form-config-etiqueta" style="display: flex; flex-direction: column; gap: 16px;">
                <input type="hidden" id="config-producto-index">
                <input type="hidden" id="config-producto-id">
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <!-- QR -->
                    <label style="display: flex; align-items: center; gap: 10px; padding: 12px; background: white; border: 2px solid #e5e7eb; border-radius: 8px; cursor: pointer; transition: all 0.2s;"
                           onmouseover="this.style.borderColor='#3b82f6'; this.style.background='#eff6ff'"
                           onmouseout="this.style.borderColor='#e5e7eb'; this.style.background='white'">
                        <input type="checkbox" id="config-mostrar-qr" checked
                               style="width: 20px; height: 20px; cursor: pointer;">
                        <div>
                            <div style="font-weight: 600; color: #1f2937; font-size: 14px;">üì± C√≥digo QR</div>
                            <div style="font-size: 11px; color: #6b7280;">Mostrar QR en etiqueta</div>
                        </div>
                    </label>

                    <!-- Nombre -->
                    <label style="display: flex; align-items: center; gap: 10px; padding: 12px; background: white; border: 2px solid #e5e7eb; border-radius: 8px; cursor: pointer; transition: all 0.2s;"
                           onmouseover="this.style.borderColor='#3b82f6'; this.style.background='#eff6ff'"
                           onmouseout="this.style.borderColor='#e5e7eb'; this.style.background='white'">
                        <input type="checkbox" id="config-mostrar-nombre" checked
                               style="width: 20px; height: 20px; cursor: pointer;">
                        <div>
                            <div style="font-weight: 600; color: #1f2937; font-size: 14px;">üìù Nombre</div>
                            <div style="font-size: 11px; color: #6b7280;">Nombre del producto</div>
                        </div>
                    </label>

                    <!-- ID -->
                    <label style="display: flex; align-items: center; gap: 10px; padding: 12px; background: white; border: 2px solid #e5e7eb; border-radius: 8px; cursor: pointer; transition: all 0.2s;"
                           onmouseover="this.style.borderColor='#3b82f6'; this.style.background='#eff6ff'"
                           onmouseout="this.style.borderColor='#e5e7eb'; this.style.background='white'">
                        <input type="checkbox" id="config-mostrar-id" checked
                               style="width: 20px; height: 20px; cursor: pointer;">
                        <div>
                            <div style="font-weight: 600; color: #1f2937; font-size: 14px;">üî¢ ID/C√≥digo</div>
                            <div style="font-size: 11px; color: #6b7280;">C√≥digo del producto</div>
                        </div>
                    </label>

                    <!-- Unidad -->
                    <label style="display: flex; align-items: center; gap: 10px; padding: 12px; background: white; border: 2px solid #e5e7eb; border-radius: 8px; cursor: pointer; transition: all 0.2s;"
                           onmouseover="this.style.borderColor='#3b82f6'; this.style.background='#eff6ff'"
                           onmouseout="this.style.borderColor='#e5e7eb'; this.style.background='white'">
                        <input type="checkbox" id="config-mostrar-unidad" checked
                               style="width: 20px; height: 20px; cursor: pointer;">
                        <div>
                            <div style="font-weight: 600; color: #1f2937; font-size: 14px;">üìè Unidad</div>
                            <div style="font-size: 11px; color: #6b7280;">Unidad de medida</div>
                        </div>
                    </label>

                    <!-- Modelo -->
                    <label style="display: flex; align-items: center; gap: 10px; padding: 12px; background: white; border: 2px solid #e5e7eb; border-radius: 8px; cursor: pointer; transition: all 0.2s;"
                           onmouseover="this.style.borderColor='#3b82f6'; this.style.background='#eff6ff'"
                           onmouseout="this.style.borderColor='#e5e7eb'; this.style.background='white'">
                        <input type="checkbox" id="config-mostrar-modelo" checked
                               style="width: 20px; height: 20px; cursor: pointer;">
                        <div>
                            <div style="font-weight: 600; color: #1f2937; font-size: 14px;">üè∑Ô∏è Modelo</div>
                            <div style="font-size: 11px; color: #6b7280;">Modelo del producto</div>
                        </div>
                    </label>

                    <!-- Empresa -->
                    <label style="display: flex; align-items: center; gap: 10px; padding: 12px; background: white; border: 2px solid #e5e7eb; border-radius: 8px; cursor: pointer; transition: all 0.2s;"
                           onmouseover="this.style.borderColor='#3b82f6'; this.style.background='#eff6ff'"
                           onmouseout="this.style.borderColor='#e5e7eb'; this.style.background='white'">
                        <input type="checkbox" id="config-mostrar-empresa" checked
                               style="width: 20px; height: 20px; cursor: pointer;">
                        <div>
                            <div style="font-weight: 600; color: #1f2937; font-size: 14px;">üè¢ Empresa</div>
                            <div style="font-size: 11px; color: #6b7280;">Info de la empresa</div>
                        </div>
                    </label>
                </div>

                <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 10px;">
                    <button type="button" onclick="cerrarModalConfigEtiqueta()"
                            style="padding: 10px 20px; background: #6b7280; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; transition: background 0.2s;"
                            onmouseover="this.style.background='#4b5563'"
                            onmouseout="this.style.background='#6b7280'">
                        Cancelar
                    </button>
                    <button type="submit"
                            style="padding: 10px 20px; background: #10b981; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; transition: background 0.2s;"
                            onmouseover="this.style.background='#059669'"
                            onmouseout="this.style.background='#10b981'">
                        üíæ Guardar Configuraci√≥n
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- ============================================== -->
    <!-- MODAL: GESTI√ìN ADMINISTRATIVA DE PRODUCTOS ESPECIALES -->
    <!-- ============================================== -->
    <div class="modal-overlay" id="modal-gestion-productos-especiales" style="display: none;">
        <div class="modal-content" style="max-width: 1200px; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column;">
            <div class="modal-header" style="background: linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%); color: white;">
                <h3>üéÅ Gesti√≥n de Productos Especiales (Juegos/Combos)</h3>
                <button class="modal-close" onclick="closeModal('modal-gestion-productos-especiales')" style="color: white;">‚úï</button>
            </div>
            
            <div style="padding: 25px; flex: 1; overflow-y: auto;">
                <!-- Barra de b√∫squeda y acciones -->
                <div style="display: flex; gap: 15px; margin-bottom: 20px; align-items: center;">
                    <div style="flex: 1; position: relative;">
                        <input type="text" id="search-especiales-admin" placeholder="üîç Buscar por c√≥digo o nombre..." 
                               onkeyup="filtrarProductosEspecialesAdmin()"
                               style="width: 100%; padding: 12px 45px 12px 15px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 14px;">
                        <span style="position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: #9ca3af; font-size: 20px;">üîç</span>
                    </div>
                    <button onclick="abrirModalCrearProductoEspecial()" 
                            style="padding: 12px 24px; background: linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%); color: white; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3); white-space: nowrap;">
                        ‚ûï Crear Nuevo Juego/Combo
                    </button>
                </div>

                <!-- Tabla de productos especiales -->
                <div style="background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); overflow: hidden;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);">
                                <th style="padding: 15px; text-align: left; font-weight: 600; color: #374151; border-bottom: 2px solid #d1d5db;">ID</th>
                                <th style="padding: 15px; text-align: left; font-weight: 600; color: #374151; border-bottom: 2px solid #d1d5db;">C√≥digo</th>
                                <th style="padding: 15px; text-align: left; font-weight: 600; color: #374151; border-bottom: 2px solid #d1d5db;">Nombre</th>
                                <th style="padding: 15px; text-align: left; font-weight: 600; color: #374151; border-bottom: 2px solid #d1d5db;">Componentes</th>
                                <th style="padding: 15px; text-align: center; font-weight: 600; color: #374151; border-bottom: 2px solid #d1d5db;">Estado</th>
                                <th style="padding: 15px; text-align: center; font-weight: 600; color: #374151; border-bottom: 2px solid #d1d5db;">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tabla-especiales-admin">
                            <tr>
                                <td colspan="6" style="padding: 40px; text-align: center; color: #9ca3af;">
                                    <div class="spinner"></div>
                                    <p>Cargando productos especiales...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- ============================================== -->
    <!-- MODAL: GESTI√ìN ADMINISTRATIVA DE SOLICITUDES ESPECIALES -->
    <!-- ============================================== -->
    <div class="modal-overlay" id="modal-gestion-solicitudes-especiales" style="display: none;">
        <div class="modal-content" style="max-width: 1400px; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column;">
            <div class="modal-header" style="background: linear-gradient(135deg, #ec4899 0%, #be185d 100%); color: white;">
                <h3>üìã Gesti√≥n de Solicitudes de Productos Especiales</h3>
                <button class="modal-close" onclick="closeModal('modal-gestion-solicitudes-especiales')" style="color: white;">‚úï</button>
            </div>
            
            <div style="padding: 25px; flex: 1; overflow-y: auto;">
                <!-- Filtros -->
                <div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
                    <div style="flex: 1; min-width: 250px; position: relative;">
                        <input type="text" id="search-solicitudes-especiales-admin" placeholder="üîç Buscar por producto o costurera..." 
                               onkeyup="filtrarSolicitudesEspecialesAdmin()"
                               style="width: 100%; padding: 12px 45px 12px 15px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 14px;">
                        <span style="position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: #9ca3af; font-size: 20px;">üîç</span>
                    </div>
                    <select id="filter-estado-solicitudes" onchange="filtrarSolicitudesEspecialesAdmin()"
                            style="padding: 12px 20px; border: 2px solid #e5e7eb; border-radius: 10px; font-size: 14px; cursor: pointer; background: white;">
                        <option value="">üìä Todos los estados</option>
                        <option value="pendiente">‚è≥ Pendientes</option>
                        <option value="proceso">üîÑ En Proceso</option>
                        <option value="completada">‚úÖ Completadas</option>
                        <option value="cancelada">‚ùå Canceladas</option>
                    </select>
                    <button onclick="exportarSolicitudesEspeciales()" 
                            style="padding: 12px 24px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);">
                        üì• Exportar
                    </button>
                </div>

                <!-- Estad√≠sticas r√°pidas -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px;">
                    <div style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); padding: 20px; border-radius: 12px; text-align: center;">
                        <div style="font-size: 32px; font-weight: bold; color: #92400e;" id="stat-total-solicitudes-esp">0</div>
                        <div style="color: #b45309; font-size: 13px; margin-top: 5px;">Total Solicitudes</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); padding: 20px; border-radius: 12px; text-align: center;">
                        <div style="font-size: 32px; font-weight: bold; color: #1e40af;" id="stat-pendientes-esp">0</div>
                        <div style="color: #2563eb; font-size: 13px; margin-top: 5px;">Pendientes</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); padding: 20px; border-radius: 12px; text-align: center;">
                        <div style="font-size: 32px; font-weight: bold; color: #065f46;" id="stat-completadas-esp">0</div>
                        <div style="color: #059669; font-size: 13px; margin-top: 5px;">Completadas</div>
                    </div>
                    <div style="background: linear-gradient(135deg, #fce7f3 0%, #fbcfe8 100%); padding: 20px; border-radius: 12px; text-align: center;">
                        <div style="font-size: 32px; font-weight: bold; color: #831843;" id="stat-etiquetas-impresas-esp">0</div>
                        <div style="color: #be185d; font-size: 13px; margin-top: 5px;">Etiquetas Impresas</div>
                    </div>
                </div>

                <!-- Tabla de solicitudes -->
                <div style="background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); overflow: hidden;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);">
                                <th style="padding: 15px; text-align: left; font-weight: 600; color: #374151; border-bottom: 2px solid #d1d5db;">ID</th>
                                <th style="padding: 15px; text-align: left; font-weight: 600; color: #374151; border-bottom: 2px solid #d1d5db;">Producto Especial</th>
                                <th style="padding: 15px; text-align: left; font-weight: 600; color: #374151; border-bottom: 2px solid #d1d5db;">Costurera</th>
                                <th style="padding: 15px; text-align: center; font-weight: 600; color: #374151; border-bottom: 2px solid #d1d5db;">Cantidad</th>
                                <th style="padding: 15px; text-align: center; font-weight: 600; color: #374151; border-bottom: 2px solid #d1d5db;">Progreso</th>
                                <th style="padding: 15px; text-align: center; font-weight: 600; color: #374151; border-bottom: 2px solid #d1d5db;">Estado</th>
                                <th style="padding: 15px; text-align: left; font-weight: 600; color: #374151; border-bottom: 2px solid #d1d5db;">Fecha</th>
                                <th style="padding: 15px; text-align: center; font-weight: 600; color: #374151; border-bottom: 2px solid #d1d5db;">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tabla-solicitudes-especiales-admin">
                            <tr>
                                <td colspan="8" style="padding: 40px; text-align: center; color: #9ca3af;">
                                    <div class="spinner"></div>
                                    <p>Cargando solicitudes especiales...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentUser = null;
        let currentCosturera = null;
        let isActingAs = false;

        // =============================================
        // SISTEMA DE COLA DE APROBACI√ìN
        // =============================================
        let approvalQueue = [];          // Cola de IDs de solicitudes para aprobar
        let currentProcessing = null;    // ID de solicitud actualmente proces√°ndose
        let queueStatus = {};           // Estado de cada bot√≥n {id_solicitud: 'processing'|'queued'|'normal'}
        let isQueueActive = false;      // Estado global de la cola

        // Agregar solicitud a la cola de aprobaci√≥n
        function addToApprovalQueue(id_solicitud) {
            console.log(`üéØ Agregando solicitud ${id_solicitud} a la cola`);
            
            if (!approvalQueue.includes(id_solicitud)) {
                approvalQueue.push(id_solicitud);
                queueStatus[id_solicitud] = currentProcessing === null ? 'processing' : 'queued';
                
                // Si no hay nada proces√°ndose, iniciar inmediatamente
                if (currentProcessing === null) {
                    processNextInQueue();
                }
                
                updateAllButtonStates();
                updateQueueIndicator();
            }
        }

        // Procesar siguiente solicitud en la cola
        async function processNextInQueue() {
            if (approvalQueue.length === 0) {
                console.log('‚úÖ Cola de aprobaci√≥n vac√≠a');
                isQueueActive = false;
                currentProcessing = null;
                updateQueueIndicator();
                return;
            }

            const nextId = approvalQueue.shift(); // Sacar el primero de la cola
            currentProcessing = nextId;
            queueStatus[nextId] = 'processing';
            isQueueActive = true;

            console.log(`‚ö° Procesando solicitud ${nextId}...`);
            
            updateAllButtonStates();
            updateQueueIndicator();

            try {
                // Llamar a la funci√≥n original de cambio de estado
                await originalChangeSolicitudState(nextId, 'proceso', 'Aprobada por supervisor');
                
                console.log(`‚úÖ Solicitud ${nextId} procesada exitosamente`);
                
                // Limpiar estado de esta solicitud
                delete queueStatus[nextId];
                currentProcessing = null;
                
                // Procesar siguiente en cola despu√©s de un peque√±o delay
                setTimeout(() => {
                    processNextInQueue();
                }, 500);
                
            } catch (error) {
                console.error(`‚ùå Error procesando solicitud ${nextId}:`, error);
                
                // En caso de error, continuar con la siguiente
                delete queueStatus[nextId];
                currentProcessing = null;
                
                setTimeout(() => {
                    processNextInQueue();
                }, 1000);
            }
        }

        // Cancelar solicitud actual
        function cancelCurrentProcessing() {
            if (currentProcessing !== null) {
                console.log(`üõë Cancelando procesamiento de solicitud ${currentProcessing}`);
                
                // Limpiar estado
                delete queueStatus[currentProcessing];
                currentProcessing = null;
                
                // Continuar con la siguiente en cola
                setTimeout(() => {
                    processNextInQueue();
                }, 500);
                
                updateAllButtonStates();
                updateQueueIndicator();
            }
        }

        // Actualizar estados de todos los botones
        function updateAllButtonStates() {
            // Buscar todas las solicitudes pendientes
            document.querySelectorAll('[data-solicitud-id]').forEach(row => {
                const id_solicitud = parseInt(row.dataset.solicitudId);
                updateButtonState(id_solicitud);
            });
        }

        // Actualizar estado de botones para una solicitud espec√≠fica
        function updateButtonState(id_solicitud) {
            const status = queueStatus[id_solicitud] || 'normal';
            const approveBtn = document.querySelector(`button[onclick*="changeSolicitudState(${id_solicitud}, 'proceso'"]`);
            const rejectBtn = document.querySelector(`button[onclick*="changeSolicitudState(${id_solicitud}, 'cancelada'"]`);
            
            if (!approveBtn || !rejectBtn) return;
            
            // Reset classes
            approveBtn.classList.remove('processing', 'queued');
            rejectBtn.classList.remove('cancel-btn');
            
            switch (status) {
                case 'processing':
                    // Solicitud actual proces√°ndose
                    approveBtn.classList.add('processing');
                    approveBtn.textContent = 'üîÑ Procesando...';
                    
                    rejectBtn.classList.add('cancel-btn');
                    rejectBtn.textContent = 'üõë CANCELAR';
                    rejectBtn.onclick = () => cancelCurrentProcessing();
                    break;
                    
                case 'queued':
                    // Solicitud en cola
                    approveBtn.classList.add('queued');
                    approveBtn.textContent = '‚è≥ En Cola';
                    
                    rejectBtn.textContent = '‚ùå Rechazar';
                    // Mantener funcionalidad de rechazar
                    break;
                    
                default:
                    // Estado normal
                    approveBtn.textContent = '‚úÖ Aprobar';
                    rejectBtn.textContent = '‚ùå Rechazar';
                    break;
            }
        }

        // Actualizar indicador visual de cola
        function updateQueueIndicator() {
            let indicator = document.getElementById('queue-indicator');
            
            if (isQueueActive || approvalQueue.length > 0) {
                if (!indicator) {
                    // Crear indicador si no existe
                    indicator = document.createElement('div');
                    indicator.id = 'queue-indicator';
                    indicator.className = 'queue-indicator';
                    
                    // Buscar donde colocarlo (al lado del t√≠tulo de solicitudes pendientes)
                    const title = document.querySelector('h2');
                    if (title && title.textContent.includes('Solicitudes Pendientes')) {
                        title.appendChild(indicator);
                    }
                }
                
                const queueCount = approvalQueue.length;
                const processingText = currentProcessing ? ' (procesando...)' : '';
                indicator.innerHTML = `üîÑ Cola activa: ${queueCount} pendientes${processingText}`;
                indicator.style.display = 'inline-flex';
                
            } else if (indicator) {
                indicator.style.display = 'none';
            }
        }

        // //DEBUG MOVIL desactivado - Sistema de debugging para m√≥viles
        function mobileLog(message, data = '') {
            console.log(`üì± MOBILE DEBUG: ${message}`, data);
            // //DEBUG MOVIL desactivado - Mostrar en la interfaz para debugging m√≥vil
            /*
            const debugDiv = document.getElementById('mobile-debug');
            if (debugDiv) {
                debugDiv.innerHTML += `<br>üì± ${new Date().toLocaleTimeString()}: ${message} ${JSON.stringify(data)}`;
                debugDiv.scrollTop = debugDiv.scrollTop;
            }
            */
        }

        // Funci√≥n helper para headers con token JWT
        function getAuthHeaders() {
            const token = localStorage.getItem('token');
            return {
                'Authorization': `Bearer ${token}`,
                'user-email': currentUser?.email || 'admin@sistema.com',
                'Content-Type': 'application/json'
            };
        }

        // Detectar si es dispositivo m√≥vil y mostrar debug
        function isMobile() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || 
                   window.innerWidth <= 768;
        }

        // //DEBUG MOVIL desactivado - Mostrar panel debug en m√≥viles
        /*
        function showMobileDebug() {
            if (isMobile()) {
                const debugPanel = document.getElementById('mobile-debug-panel');
                if (debugPanel) {
                    debugPanel.style.display = 'block';
                    debugPanel.onclick = () => {
                        debugPanel.style.display = debugPanel.style.display === 'none' ? 'block' : 'none';
                    };
                }
                mobileLog('üì± Dispositivo m√≥vil detectado');
            }
        }
        */

        // Verificar conectividad
        async function testConnectivity() {
            try {
                mobileLog('Probando conectividad...');
                const response = await fetch('/api/test-db');
                if (response.ok) {
                    const data = await response.json();
                    mobileLog('‚úÖ Conectividad OK', data);
                    return true;
                } else {
                    mobileLog('‚ùå Error conectividad', response.status);
                    return false;
                }
            } catch (error) {
                mobileLog('‚ùå Error de red', error.message);
                return false;
            }
        }

        // Cargar datos al iniciar
        window.addEventListener('load', async () => {
            // //DEBUG MOVIL desactivado - Activar debug para m√≥viles
            // showMobileDebug();
            mobileLog('üöÄ Iniciando aplicaci√≥n...');
            
            // Test de conectividad primero
            const isConnected = await testConnectivity();
            if (!isConnected) {
                alert('‚ùå Error de conectividad. Verifica que est√©s conectado a la misma red.');
                return;
            }
            
            // Verificar datos de usuario (sin token)
            const userData = localStorage.getItem('currentUser');
            
            if (!userData) {
                mobileLog('‚ùå No hay datos de usuario', {userData: !!userData});
                
                // Mostrar mensaje informativo en m√≥viles
                if (isMobile()) {
                    alert('‚ö†Ô∏è Necesitas hacer LOGIN primero.\n\n' +
                          '1. Ve a: http://' + window.location.hostname + ':3010/\n' +
                          '2. Inicia sesi√≥n con tu usuario supervisor\n' +
                          '3. Regresa a esta p√°gina\n\n' +
                          'Te redirigir√© autom√°ticamente...');
                }
                
                setTimeout(() => {
                    window.location.href = '/';
                }, 3000);
                return;
            }
            
            currentUser = JSON.parse(userData);
            mobileLog('‚úÖ Usuario cargado', {email: currentUser.email, rol: currentUser.nivel_acceso});
            
            // Verificar que sea supervisor
            if (currentUser.rol !== 'supervisor') {
                alert('Acceso denegado. Solo supervisores.');
                window.location.href = '/';
                return;
            }
            
            // Cargar nombre del supervisor
            document.getElementById('supervisor-name').textContent = currentUser.nombre;
            
            // Cargar datos del dashboard
            await loadDashboardData();
            
            // Actualizar cada 30 segundos
            setInterval(() => {
                if (!isActingAs) {
                    loadPendingSolicitudes();
                    loadStats();
                    updateSupervisorGreetingMessage(); // Actualizar mensaje personalizado
                }
            }, 30000);
            
            // Actualizar mensaje personalizado cada 30 minutos
            setInterval(() => {
                updateSupervisorGreetingMessage();
            }, 30 * 60 * 1000);
        });

        // Variables globales para solicitudes
        let todasLasSolicitudesCache = [];
        let solicitudesEspecialesCache = [];
        let estadoFiltroActual = 'todas';
        let modoActual = 'normales'; // 'normales' o 'especiales'

        // Cambiar entre modo normal y especial
        function cambiarModoSolicitudes() {
            if (modoActual === 'normales') {
                modoActual = 'especiales';
                document.getElementById('solicitudes-icon').textContent = '‚≠ê';
                document.getElementById('solicitudes-icon').style.background = 'linear-gradient(135deg, #fef3c7, #fbbf24)';
                document.getElementById('solicitudes-title').innerHTML = '<span style="color: #f59e0b;">‚≠ê</span> Solicitudes Especiales';
                cargarSolicitudesEspeciales();
            } else {
                modoActual = 'normales';
                document.getElementById('solicitudes-icon').textContent = 'üìã';
                document.getElementById('solicitudes-icon').style.background = '';
                document.getElementById('solicitudes-title').textContent = 'Solicitudes Pendientes';
                filtrarSolicitudesPorEstado(estadoFiltroActual);
            }
        }

        // Refrescar solicitudes actuales seg√∫n el modo
        function refreshSolicitudesActuales() {
            if (modoActual === 'especiales') {
                cargarSolicitudesEspeciales();
            } else {
                refreshTodasSolicitudes();
            }
        }

        // Cargar todos los datos del dashboard
        async function loadDashboardData() {
            await Promise.all([
                loadCostureras(),
                loadTodasLasSolicitudes(),
                loadStats()
            ]);
            
            // Actualizar mensaje personalizado del supervisor
            updateSupervisorGreetingMessage();
        }

        // Cargar TODAS las solicitudes recientes (√∫ltimas 24 horas)
        async function loadTodasLasSolicitudes() {
            try {
                console.log('üìã Cargando TODAS las solicitudes recientes...');
                
                const response = await fetch('/api/supervisor/solicitudes-recientes', {
                    headers: getAuthHeaders()
                });
                
                if (!response.ok) {
                    throw new Error('Error al cargar solicitudes');
                }
                
                const todasSolicitudes = await response.json();
                
                // FILTRAR: Excluir solicitudes que son productos especiales (tienen id_producto_especial)
                todasLasSolicitudesCache = todasSolicitudes.filter(s => !s.id_producto_especial);
                console.log(`‚úÖ Cargadas ${todasLasSolicitudesCache.length} solicitudes NORMALES (${todasSolicitudes.length - todasLasSolicitudesCache.length} especiales filtradas)`);
                
                // Actualizar contadores
                actualizarContadoresPorEstado();
                
                // Mostrar solicitudes seg√∫n filtro actual
                mostrarSolicitudesFiltradas();
                
            } catch (error) {
                console.error('Error cargando todas las solicitudes:', error);
                document.getElementById('todas-solicitudes-list').innerHTML = 
                    '<div class="empty-state">‚ùå Error cargando solicitudes</div>';
            }
        }

        // Actualizar contadores por estado
        function actualizarContadoresPorEstado() {
            const contadores = {
                todas: todasLasSolicitudesCache.length,
                pendiente: todasLasSolicitudesCache.filter(s => s.estado === 'pendiente').length,
                proceso: todasLasSolicitudesCache.filter(s => s.estado === 'proceso').length,
                completada: todasLasSolicitudesCache.filter(s => s.estado === 'completada').length
            };
            
            document.getElementById('count-todas').textContent = contadores.todas;
            document.getElementById('count-pendiente').textContent = contadores.pendiente;
            document.getElementById('count-proceso').textContent = contadores.proceso;
            document.getElementById('count-completada').textContent = contadores.completada;
        }

        // Cargar solicitudes especiales desde el servidor
        async function cargarSolicitudesEspeciales() {
            try {
                console.log('‚≠ê Cargando solicitudes especiales desde servidor...');
                
                const response = await fetch('/api/solicitudes-especiales', {
                    headers: getAuthHeaders()
                });
                
                if (!response.ok) {
                    throw new Error('Error al cargar solicitudes especiales');
                }
                
                solicitudesEspecialesCache = await response.json();
                console.log(`‚úÖ Cargadas ${solicitudesEspecialesCache.length} solicitudes especiales`);
                
                // Actualizar contadores
                actualizarContadoresEspeciales();
                
                // Mostrar con el filtro actual
                mostrarSolicitudesEspecialesFiltradas();
                
            } catch (error) {
                console.error('‚ùå Error cargando solicitudes especiales:', error);
                document.getElementById('todas-solicitudes-list').innerHTML = 
                    '<div class="empty-state">‚ùå Error cargando solicitudes especiales</div>';
            }
        }

        // Actualizar contadores para solicitudes especiales
        function actualizarContadoresEspeciales() {
            const todas = solicitudesEspecialesCache.length;
            const pendientes = solicitudesEspecialesCache.filter(s => s.estado === 'pendiente').length;
            const proceso = solicitudesEspecialesCache.filter(s => s.estado === 'proceso').length;
            const completadas = solicitudesEspecialesCache.filter(s => s.estado === 'completada').length;
            
            document.getElementById('count-todas').textContent = todas;
            document.getElementById('count-pendiente').textContent = pendientes;
            document.getElementById('count-proceso').textContent = proceso;
            document.getElementById('count-completada').textContent = completadas;
        }

        // Filtrar solicitudes por estado
        function filtrarSolicitudesPorEstado(estado) {
            estadoFiltroActual = estado;
            
            // Actualizar botones activos
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.estado === estado) {
                    btn.classList.add('active');
                }
            });
            
            // Mostrar solicitudes seg√∫n modo actual
            if (modoActual === 'especiales') {
                mostrarSolicitudesEspecialesFiltradas();
            } else {
                mostrarSolicitudesFiltradas();
            }
        }

        // Mostrar solicitudes ESPECIALES seg√∫n filtro actual
        function mostrarSolicitudesEspecialesFiltradas() {
            let solicitudesFiltradas = solicitudesEspecialesCache;
            
            if (estadoFiltroActual !== 'todas') {
                solicitudesFiltradas = solicitudesEspecialesCache.filter(s => s.estado === estadoFiltroActual);
            }
            
            const list = document.getElementById('todas-solicitudes-list');
            
            if (solicitudesFiltradas.length === 0) {
                const mensajes = {
                    todas: '‚≠ê No hay solicitudes especiales',
                    pendiente: '‚≠ê No hay solicitudes especiales pendientes',
                    proceso: '‚≠ê No hay solicitudes especiales en proceso',
                    completada: '‚≠ê No hay solicitudes especiales completadas'
                };
                list.innerHTML = `<div class="empty-state">${mensajes[estadoFiltroActual]}</div>`;
                return;
            }
            
            // OPCI√ìN A: AGRUPAR solicitudes por numero_solicitud_grupo
            // Si hay m√∫ltiples filas del mismo JUEGO (por componentes), las agrupamos en UNA sola tarjeta
            const solicitudesAgrupadas = new Map();
            
            solicitudesFiltradas.forEach(solicitud => {
                const key = solicitud.numero_solicitud_grupo || solicitud.numero_solicitud;
                if (!solicitudesAgrupadas.has(key)) {
                    solicitudesAgrupadas.set(key, solicitud);
                }
                // Si ya existe, ignoramos porque ya tenemos la info del JUEGO completo
            });
            
            const solicitudesUnicas = Array.from(solicitudesAgrupadas.values());
            
            list.innerHTML = solicitudesUnicas.map(solicitud => {
                const estadoBadge = getEstadoBadge(solicitud.estado);
                const autoServicesBadge = solicitud.auto_services ? '<span style="background: #10b981; color: white; padding: 3px 8px; border-radius: 5px; font-size: 11px; font-weight: 600;">ü§ñ AUTO</span>' : '';
                const especialBadge = '<span style="background: linear-gradient(135deg, #f59e0b, #d97706); color: white; padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 700;">‚≠ê ESPECIAL</span>';
                
                // Formatear tiempo transcurrido
                const fechaSolicitud = new Date(solicitud.fecha_solicitud);
                const ahora = new Date();
                const minutos = Math.floor((ahora - fechaSolicitud) / (1000 * 60));
                const tiempoTexto = minutos < 60 ? `${minutos} min` : 
                                   minutos < 1440 ? `${Math.floor(minutos/60)}h ${minutos%60}min` :
                                   `${Math.floor(minutos/1440)} d√≠as`;
                
                // Preparar datos de componentes para el popup
                const componentesData = [];
                if (solicitud.id_producto_1) {
                    componentesData.push({
                        id: solicitud.id_producto_1,
                        nombre: solicitud.nombre_producto_1,
                        cantidad_maxima: solicitud.cantidad_producto_1,
                        mostrar: true // Por defecto todos se muestran
                    });
                }
                if (solicitud.id_producto_2) {
                    componentesData.push({
                        id: solicitud.id_producto_2,
                        nombre: solicitud.nombre_producto_2,
                        cantidad_maxima: solicitud.cantidad_producto_2,
                        mostrar: true
                    });
                }
                if (solicitud.id_producto_3) {
                    componentesData.push({
                        id: solicitud.id_producto_3,
                        nombre: solicitud.nombre_producto_3,
                        cantidad_maxima: solicitud.cantidad_producto_3,
                        mostrar: true
                    });
                }
                if (solicitud.id_producto_4) {
                    componentesData.push({
                        id: solicitud.id_producto_4,
                        nombre: solicitud.nombre_producto_4,
                        cantidad_maxima: solicitud.cantidad_producto_4,
                        mostrar: true
                    });
                }
                
                const componentesJson = JSON.stringify(componentesData);
                const componentesJsonEscaped = componentesJson.replace(/"/g, '&quot;').replace(/'/g, '&#39;');
                const numComponentes = componentesData.length;
                const componentesBadge = `<span style="background: #8b5cf6; color: white; padding: 3px 8px; border-radius: 5px; font-size: 11px; font-weight: 600;">üì¶ ${numComponentes} componente${numComponentes > 1 ? 's' : ''}</span>`;
                
                // Escapar caracteres especiales en el nombre del producto
                const productoEscapado = (solicitud.producto_principal || '').replace(/'/g, '&#39;').replace(/"/g, '&quot;');
                
                return `
                    <div class="pending-item" data-solicitud-id="${solicitud.id_solicitud}" data-estado="${solicitud.estado}" 
                         data-componentes="${componentesJsonEscaped}"
                         data-producto="${productoEscapado}"
                         data-cantidad="${solicitud.cantidad_solicitada}"
                         style="border-left: 4px solid #f59e0b; background: linear-gradient(to right, rgba(254, 243, 199, 0.3), transparent);">
                        <div class="pending-header">
                            <div class="pending-info">
                                <div class="pending-title">
                                    ${solicitud.costurera || 'Sin costurera'} - <strong>${solicitud.producto_principal}</strong>
                                    ${especialBadge}
                                    ${componentesBadge}
                                    ${estadoBadge}
                                    ${autoServicesBadge}
                                    <span class="priority-badge priority-${solicitud.prioridad || 'normal'}">
                                        ${solicitud.prioridad || 'normal'}
                                    </span>
                                </div>
                                <div class="pending-details">
                                    <strong>Cantidad M√°xima por Componente:</strong> ${solicitud.cantidad_solicitada} | 
                                    Solicitud: ${solicitud.numero_solicitud} |
                                    Tipo: ${solicitud.tipo_combo} |
                                    Hace: ${tiempoTexto}
                                </div>
                            </div>
                        </div>
                        ${solicitud.observaciones ? `<p style="font-style: italic; color: #666; margin: 8px 0;">üìù ${solicitud.observaciones}</p>` : ''}
                        <div class="pending-actions" style="gap: 10px;">
                            <button class="action-btn btn-imprimir-especial" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed); flex: 1;" 
                                    data-id="${solicitud.id_solicitud}">
                                üñ®Ô∏è Imprimir Componentes
                            </button>
                            <button class="action-btn reject-btn" style="flex: 0.5;" 
                                    onclick="cancelarSolicitudEspecial(${solicitud.id_solicitud})">
                                ‚ùå Cancelar
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Mostrar solicitudes NORMALES seg√∫n filtro actual
        function mostrarSolicitudesFiltradas() {
            let solicitudesFiltradas = todasLasSolicitudesCache;
            
            if (estadoFiltroActual !== 'todas') {
                solicitudesFiltradas = todasLasSolicitudesCache.filter(s => s.estado === estadoFiltroActual);
            }
            
            const list = document.getElementById('todas-solicitudes-list');
            
            if (solicitudesFiltradas.length === 0) {
                const mensajes = {
                    todas: 'üéâ No hay solicitudes en las √∫ltimas 24 horas',
                    pendiente: 'üéâ No hay solicitudes pendientes',
                    proceso: '‚ú® No hay solicitudes en proceso',
                    completada: 'üìã No hay solicitudes completadas'
                };
                list.innerHTML = `<div class="empty-state">${mensajes[estadoFiltroActual]}</div>`;
                return;
            }
            
            list.innerHTML = solicitudesFiltradas.map(solicitud => {
                const estadoBadge = getEstadoBadge(solicitud.estado);
                const autoServicesBadge = solicitud.auto_services ? '<span style="background: #10b981; color: white; padding: 3px 8px; border-radius: 5px; font-size: 11px; font-weight: 600;">ü§ñ AUTO</span>' : '';
                const minutos = Math.floor(solicitud.minutos_desde_creacion);
                const tiempoTexto = minutos < 60 ? `${minutos} min` : `${Math.floor(minutos/60)}h ${minutos%60}min`;
                
                return `
                    <div class="pending-item" data-solicitud-id="${solicitud.id_solicitud}" data-estado="${solicitud.estado}">
                        <div class="pending-header">
                            <div class="pending-info">
                                <div class="pending-title">
                                    ${solicitud.costurera} - ${solicitud.nombre_producto}
                                    ${estadoBadge}
                                    ${autoServicesBadge}
                                    <span class="priority-badge priority-${solicitud.prioridad}">
                                        ${solicitud.prioridad}
                                    </span>
                                </div>
                                <div class="pending-details">
                                    Cantidad: ${solicitud.cantidad_productos} | 
                                    Solicitud: ${solicitud.numero_solicitud} |
                                    Hace: ${tiempoTexto}
                                </div>
                            </div>
                        </div>
                        ${solicitud.observaciones ? `<p style="font-style: italic; color: #666; margin: 8px 0;">${solicitud.observaciones}</p>` : ''}
                        ${solicitud.estado === 'pendiente' ? `
                        <div class="pending-actions">
                            <button class="action-btn approve-btn" onclick="changeSolicitudState(${solicitud.id_solicitud}, 'proceso', 'Aprobada por supervisor')">
                                ‚úÖ Aprobar
                            </button>
                            <button class="action-btn reject-btn" onclick="changeSolicitudState(${solicitud.id_solicitud}, 'cancelada')">
                                ‚ùå Rechazar
                            </button>
                        </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        // Obtener badge HTML seg√∫n estado
        function getEstadoBadge(estado) {
            const badges = {
                pendiente: '<span style="background: #fbbf24; color: #78350f; padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 700;">‚è≥ PENDIENTE</span>',
                proceso: '<span style="background: #3b82f6; color: white; padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 700;">üîÑ PROCESO</span>',
                completada: '<span style="background: #10b981; color: white; padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 700;">‚úÖ COMPLETADA</span>',
                cancelada: '<span style="background: #ef4444; color: white; padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 700;">‚ùå CANCELADA</span>'
            };
            return badges[estado] || '';
        }

        // Refrescar todas las solicitudes
        async function refreshTodasSolicitudes() {
            const btn = event.currentTarget;
            btn.classList.add('refreshing');
            btn.disabled = true;
            btn.textContent = 'üîÑ Actualizando...';
            
            try {
                await Promise.all([
                    loadTodasLasSolicitudes(),
                    loadStats()
                ]);
                
                btn.textContent = '‚úÖ Actualizado';
                setTimeout(() => {
                    btn.textContent = 'üîÑ Actualizar';
                    btn.classList.remove('refreshing');
                    btn.disabled = false;
                }, 1500);
                
            } catch (error) {
                console.error('Error refrescando:', error);
                btn.textContent = '‚ùå Error';
                setTimeout(() => {
                    btn.textContent = 'üîÑ Actualizar';
                    btn.classList.remove('refreshing');
                    btn.disabled = false;
                }, 2000);
            }
        }

        // Sistema de mensajes personalizados para supervisor basados en horario
        function updateSupervisorGreetingMessage() {
            const now = new Date();
            const hour = now.getHours();
            const userName = currentUser?.nombre || 'Supervisor';
            const firstName = userName.split(' ')[0]; // Obtener primer nombre
            
            let greeting, message, icon;
            
            // 7:00 AM - 12:30 PM (Buenos d√≠as)
            if (hour >= 7 && hour < 12 || (hour === 12 && now.getMinutes() <= 30)) {
                greeting = `Buenos d√≠as ${firstName}`;
                icon = 'üåÖ';
                const morningMessages = [
                    `¬øC√≥mo amaneci√≥ hoy? El equipo est√° listo para un d√≠a productivo bajo su liderazgo.`,
                    `Excelente d√≠a para supervisar. ¬øYa revis√≥ las solicitudes pendientes del d√≠a?`,
                    `¬øC√≥mo est√° el equipo esta ma√±ana? Es momento de coordinar las actividades del d√≠a.`
                ];
                message = morningMessages[Math.floor(Math.random() * morningMessages.length)];
            }
            // 1:00 AM - 6:59 AM (Madrugadas)
            else if (hour >= 1 && hour < 7) {
                greeting = `Buenas madrugadas ${firstName}`;
                icon = 'üåô';
                const dawnMessages = [
                    `Trabajando en horas tempranas. ¬øHay alg√∫n urgente que requiera supervisi√≥n?`,
                    `¬øTodo en orden en el turno nocturno? Su dedicaci√≥n es admirable.`,
                    `¬øC√≥mo van las operaciones en estas horas? El sistema est√° funcionando correctamente.`
                ];
                message = dawnMessages[Math.floor(Math.random() * dawnMessages.length)];
            }
            // 12:31 PM - 2:00 PM (Mediod√≠a)
            else if ((hour === 12 && now.getMinutes() > 30) || (hour >= 13 && hour < 14)) {
                greeting = `Buen mediod√≠a ${firstName}`;
                icon = '‚òÄÔ∏è';
                const noonMessages = [
                    `¬øYa almorz√≥? Es importante descansar para mantener la eficiencia en la supervisi√≥n.`,
                    `Hora del almuerzo. ¬øC√≥mo van las operaciones de la ma√±ana?`,
                    `Momento ideal para revisar los avances del d√≠a. ¬øTodo marcha seg√∫n lo planeado?`
                ];
                message = noonMessages[Math.floor(Math.random() * noonMessages.length)];
            }
            // 2:01 PM - 6:00 PM (Tarde)
            else if (hour >= 14 && hour < 18) {
                greeting = `Buenas tardes ${firstName}`;
                icon = 'üå§Ô∏è';
                const afternoonMessages = [
                    `¬øC√≥mo van las operaciones vespertinas? El equipo se ve concentrado.`,
                    `Tarde productiva. ¬øNecesita revisar alg√∫n proceso espec√≠fico?`,
                    `¬øTodo bajo control? Las estad√≠sticas se ven prometedoras.`,
                    `Hora pico de productividad. ¬øEl equipo est√° cumpliendo las metas?`
                ];
                message = afternoonMessages[Math.floor(Math.random() * afternoonMessages.length)];
            }
            // 6:01 PM - 12:59 AM (Noche)
            else {
                greeting = `Buenas noches ${firstName}`;
                icon = 'üåô';
                const nightMessages = [
                    `Excelente d√≠a de supervisi√≥n. El equipo logr√≥ grandes resultados.`,
                    `D√≠a exitoso completado. Las operaciones fluyeron perfectamente bajo su liderazgo.`,
                    `Momento de descansar. El sistema ha funcionado eficientemente hoy.`
                ];
                message = nightMessages[Math.floor(Math.random() * nightMessages.length)];
            }
            
            // Actualizar la interfaz
            document.getElementById('supervisor-greeting-icon').textContent = icon;
            document.getElementById('supervisor-greeting-title').textContent = greeting;
            document.getElementById('supervisor-greeting-message').textContent = message;
            
            // Cargar estad√≠sticas de trabajo
            updateSupervisorWorkStats();
        }

        // Actualizar estad√≠sticas de trabajo para supervisor (con estado IMPRESA)
        async function updateSupervisorWorkStats() {
            try {
                // Obtener email del usuario desde localStorage o sessionStorage
                const userData = JSON.parse(localStorage.getItem('usuario') || sessionStorage.getItem('usuario') || '{}');
                const userEmail = userData.email || 'supervisor@sistema.com';
                
                const response = await fetch('/api/estadisticas', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'user-email': userEmail
                    }
                });
                
                if (!response.ok) {
                    // Si hay error, usar datos existentes
                    updateSupervisorStatsFromExisting();
                    return;
                }
                
                const stats = await response.json();
                
                // Mapear datos del endpoint existente a la interfaz de supervisor
                // Las solicitudes completadas representan las etiquetas "impresas"
                const impresasCount = stats.solicitudes_completadas || 0;
                const procesoCount = stats.solicitudes_proceso || 0;
                const completadoCount = stats.solicitudes_completadas || 0;
                
                // Actualizar interfaz con datos del servidor
                document.getElementById('supervisor-stats-impresa').textContent = impresasCount;
                document.getElementById('supervisor-stats-completado').textContent = completadoCount;
                document.getElementById('supervisor-stats-proceso').textContent = procesoCount;
                
                // Agregar mensaje de noche con estad√≠sticas
                addNightProductivityMessage(impresasCount);
                
            } catch (error) {
                console.error('Error cargando estad√≠sticas de supervisor:', error);
                updateSupervisorStatsFromExisting();
            }
        }

        // Actualizar estad√≠sticas usando datos existentes del DOM
        function updateSupervisorStatsFromExisting() {
            try {
                // Intentar obtener estad√≠sticas de los elementos existentes
                const pendientes = document.getElementById('total-pendientes')?.textContent || '0';
                const proceso = document.getElementById('total-proceso')?.textContent || '0';
                const completadas = document.getElementById('total-completadas')?.textContent || '0';
                
                // Para "impresas", asumimos las completadas (ya que fueron impresas)
                document.getElementById('supervisor-stats-impresa').textContent = completadas;
                document.getElementById('supervisor-stats-completado').textContent = completadas;
                document.getElementById('supervisor-stats-proceso').textContent = proceso;
                
                // Agregar mensaje de noche
                addNightProductivityMessage(parseInt(completadas) || 0);
                
            } catch (error) {
                console.error('Error actualizando estad√≠sticas:', error);
                // Valores por defecto
                document.getElementById('supervisor-stats-impresa').textContent = '0';
                document.getElementById('supervisor-stats-completado').textContent = '0';
                document.getElementById('supervisor-stats-proceso').textContent = '0';
            }
        }

        // Agregar mensaje nocturno con productividad
        function addNightProductivityMessage(totalImpresas) {
            const hour = new Date().getHours();
            if (hour >= 18 || hour <= 0) {
                if (totalImpresas > 0) {
                    const currentMessage = document.getElementById('supervisor-greeting-message').textContent;
                    document.getElementById('supervisor-greeting-message').textContent = 
                        currentMessage + ` Hoy se imprimieron ${totalImpresas} etiquetas. ¬°Supervisi√≥n exitosa!`;
                }
            }
        }

        // Cargar lista de costureras
        async function loadCostureras() {
            try {
                mobileLog('üë• Cargando costureras...');
                const response = await fetch('/api/supervisor/costureras', {
                    headers: getAuthHeaders()
                });
                
                if (!response.ok) {
                    throw new Error('Error al cargar costureras');
                }
                
                const costureras = await response.json();
                const grid = document.getElementById('costureras-grid');
                
                if (costureras.length === 0) {
                    grid.innerHTML = '<div class="empty-state">No hay costureras registradas</div>';
                    return;
                }
                
                grid.innerHTML = costureras.map(costurera => `
                    <div class="costurera-card" onclick="actAsUser(${costurera.id_usuario}, '${costurera.nombre_completo}')">
                        <div class="costurera-avatar">
                            ${costurera.nombre_completo.charAt(0).toUpperCase()}
                        </div>
                        <div class="costurera-name">${costurera.nombre_completo}</div>
                        <div class="costurera-status">
                            ${costurera.ultimo_login ? 'Activa' : 'Nueva'}
                        </div>
                    </div>
                `).join('');
                
            } catch (error) {
                console.error('Error cargando costureras:', error);
                document.getElementById('costureras-grid').innerHTML = 
                    '<div class="empty-state">Error cargando costureras</div>';
            }
        }

        // Cargar solicitudes pendientes
        async function loadPendingSolicitudes() {
            try {
                mobileLog('üìã Cargando solicitudes pendientes...');
                const response = await fetch('/api/supervisor/pendientes', {
                    headers: getAuthHeaders()
                });
                
                if (!response.ok) {
                    throw new Error('Error al cargar solicitudes');
                }
                
                const solicitudes = await response.json();
                const list = document.getElementById('pending-list');
                
                if (solicitudes.length === 0) {
                    list.innerHTML = '<div class="empty-state">üéâ No hay solicitudes pendientes</div>';
                    return;
                }
                
                list.innerHTML = solicitudes.map(solicitud => `
                    <div class="pending-item" data-solicitud-id="${solicitud.id_solicitud}">
                        <div class="pending-header">
                            <div class="pending-info">
                                <div class="pending-title">
                                    ${solicitud.costurera} - ${solicitud.nombre_producto}
                                    <span class="priority-badge priority-${solicitud.prioridad}">
                                        ${solicitud.prioridad}
                                    </span>
                                </div>
                                <div class="pending-details">
                                    Cantidad: ${solicitud.cantidad_productos} | 
                                    Solicitud: ${solicitud.numero_solicitud} |
                                    ${new Date(solicitud.fecha_creacion).toLocaleDateString()}
                                </div>
                            </div>
                        </div>
                        ${solicitud.observaciones ? `<p style="font-style: italic; color: #666; margin: 8px 0;">${solicitud.observaciones}</p>` : ''}
                        <div class="pending-actions">
                            <button class="action-btn approve-btn" onclick="changeSolicitudState(${solicitud.id_solicitud}, 'proceso', 'Aprobada por supervisor')">
                                ‚úÖ Aprobar
                            </button>
                            <button class="action-btn reject-btn" onclick="changeSolicitudState(${solicitud.id_solicitud}, 'cancelada')">
                                ‚ùå Rechazar
                            </button>
                        </div>
                    </div>
                `).join('');
                
                // Actualizar estados de botones despu√©s de cargar
                setTimeout(() => {
                    updateAllButtonStates();
                }, 100);
                
            } catch (error) {
                console.error('Error cargando pendientes:', error);
                document.getElementById('pending-list').innerHTML = 
                    '<div class="empty-state">Error cargando solicitudes</div>';
            }
        }

        // Funci√≥n para refrescar solicitudes manualmente
        async function refreshSolicitudes() {
            const btn = document.querySelector('.refresh-btn');
            
            // Deshabilitar bot√≥n y mostrar animaci√≥n
            btn.classList.add('refreshing');
            btn.disabled = true;
            btn.textContent = 'üîÑ Actualizando...';
            
            try {
                // Recargar solicitudes y estad√≠sticas
                await Promise.all([
                    loadPendingSolicitudes(),
                    loadStats()
                ]);
                
                // Mostrar mensaje de √©xito
                btn.textContent = '‚úÖ Actualizado';
                
                setTimeout(() => {
                    btn.textContent = 'üîÑ Actualizar';
                    btn.classList.remove('refreshing');
                    btn.disabled = false;
                }, 1500);
                
            } catch (error) {
                console.error('Error refrescando:', error);
                btn.textContent = '‚ùå Error';
                
                setTimeout(() => {
                    btn.textContent = 'üîÑ Actualizar';
                    btn.classList.remove('refreshing');
                    btn.disabled = false;
                }, 2000);
            }
        }

        // Cargar estad√≠sticas
        async function loadStats() {
            try {
                mobileLog('üìä Cargando estad√≠sticas...');
                
                // Usar las estad√≠sticas existentes de tu sistema
                mobileLog('üìä Usando headers sin token');
                
                const response = await fetch('/api/estadisticas', {
                    headers: getAuthHeaders()
                });
                
                mobileLog('üìä Respuesta estad√≠sticas', `Status: ${response.status}`);
                
                if (response.ok) {
                    const stats = await response.json();
                    mobileLog('üìä Estad√≠sticas recibidas', stats);
                    
                    document.getElementById('total-pendientes').textContent = stats.solicitudes_pendientes || '0';
                    document.getElementById('total-proceso').textContent = stats.solicitudes_proceso || '0';
                    document.getElementById('total-completadas').textContent = stats.solicitudes_completadas || '0';
                    document.getElementById('total-hoy').textContent = stats.total_solicitudes || '0';
                    
                    mobileLog('‚úÖ Estad√≠sticas actualizadas correctamente');
                } else {
                    mobileLog('‚ùå Error al cargar estad√≠sticas', response.status);
                    // Valores por defecto si falla
                    document.getElementById('total-pendientes').textContent = '0';
                    document.getElementById('total-proceso').textContent = '0';
                    document.getElementById('total-completadas').textContent = '0';
                    document.getElementById('total-hoy').textContent = '0';
                }
                
            } catch (error) {
                mobileLog('‚ùå Error excepci√≥n estad√≠sticas', error.message);
                console.error('Error cargando estad√≠sticas:', error);
                // Valores por defecto
                document.getElementById('total-pendientes').textContent = '0';
                document.getElementById('total-proceso').textContent = '0';
                document.getElementById('total-completadas').textContent = '0';
                document.getElementById('total-hoy').textContent = '0';
            }
        }

        // Variables para el historial
        let historialVisible = false;
        let historialData = [];

        // Toggle del panel de historial
        function toggleHistorial() {
            historialVisible = !historialVisible;
            const filters = document.getElementById('historial-filters');
            const content = document.getElementById('historial-content');
            const btn = document.getElementById('historial-btn');
            
            if (historialVisible) {
                filters.style.display = 'block';
                content.style.display = 'block';
                btn.textContent = '‚ùå Ocultar Historial';
                btn.className = 'btn btn-secondary';
                
                // Cargar datos iniciales
                loadCosturerasFilter();
                applyFilters();
            } else {
                filters.style.display = 'none';
                content.style.display = 'none';
                btn.textContent = 'üìä Ver Historial';
                btn.className = 'btn btn-primary';
            }
        }

        // Cargar costureras para el filtro
        async function loadCosturerasFilter() {
            try {
                mobileLog('üë• Cargando filtro costureras...');
                const response = await fetch('/api/usuarios-lista', {
                    headers: getAuthHeaders()
                });
                
                if (response.ok) {
                    const usuarios = await response.json();
                    const select = document.getElementById('filter-costurera');
                    
                    const costureras = usuarios.filter(u => u.nivel_acceso === 'costurera');
                    select.innerHTML = '<option value="">Todas las costureras</option>' +
                        costureras.map(c => `<option value="${c.id_usuario}">${c.nombre_completo}</option>`).join('');
                }
            } catch (error) {
                console.error('Error cargando costureras:', error);
            }
        }

        // Aplicar filtros y cargar historial
        async function applyFilters() {
            try {
                const fechaDesde = document.getElementById('filter-fecha-desde').value;
                const fechaHasta = document.getElementById('filter-fecha-hasta').value;
                const costurera = document.getElementById('filter-costurera').value;
                const idSolicitud = document.getElementById('filter-id').value;
                
                const estados = [];
                if (document.getElementById('filter-pendiente').checked) estados.push('pendiente');
                if (document.getElementById('filter-proceso').checked) estados.push('proceso');
                if (document.getElementById('filter-completada').checked) estados.push('completada');
                
                const params = new URLSearchParams();
                if (fechaDesde) params.append('fecha_desde', fechaDesde);
                if (fechaHasta) params.append('fecha_hasta', fechaHasta);
                if (costurera) params.append('costurera', costurera);
                if (idSolicitud) params.append('numero_solicitud', idSolicitud);
                if (estados.length > 0) params.append('estados', estados.join(','));
                
                const response = await fetch(`/api/solicitudes/historial?${params.toString()}`, {
                    headers: getAuthHeaders()
                });
                
                if (!response.ok) throw new Error('Error cargando historial');
                
                const data = await response.json();
                historialData = data.solicitudes || [];
                renderHistorial(historialData);
                
            } catch (error) {
                console.error('Error aplicando filtros:', error);
                document.getElementById('historial-tbody').innerHTML = 
                    '<tr><td colspan="8">Error cargando historial</td></tr>';
            }
        }

        // Renderizar tabla de historial
        function renderHistorial(solicitudes) {
            const tbody = document.getElementById('historial-tbody');
            const stats = document.getElementById('historial-stats');
            
            // Actualizar estad√≠sticas
            const pendientes = solicitudes.filter(s => s.estado === 'pendiente').length;
            const proceso = solicitudes.filter(s => s.estado === 'proceso').length;
            const completadas = solicitudes.filter(s => s.estado === 'completada').length;
            
            stats.innerHTML = `
                <div class="stat-badge">Total: ${solicitudes.length}</div>
                <div class="stat-badge">Pendientes: ${pendientes}</div>
                <div class="stat-badge">En Proceso: ${proceso}</div>
                <div class="stat-badge">Completadas: ${completadas}</div>
            `;
            
            if (solicitudes.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8">No se encontraron solicitudes con los filtros aplicados</td></tr>';
                return;
            }
            
            tbody.innerHTML = solicitudes.map(solicitud => `
                <tr>
                    <td>${solicitud.id_solicitud}</td>
                    <td>${solicitud.numero_solicitud}</td>
                    <td>${solicitud.costurera || solicitud.nombre_completo}</td>
                    <td>${solicitud.nombre_producto}</td>
                    <td>${solicitud.cantidad_solicitada}</td>
                    <td>
                        <span class="status-badge status-${solicitud.estado}">
                            ${solicitud.estado.charAt(0).toUpperCase() + solicitud.estado.slice(1)}
                        </span>
                    </td>
                    <td>${new Date(solicitud.fecha_solicitud).toLocaleDateString()}</td>
                    <td>
                        ${solicitud.estado === 'pendiente' ? 
                            `<button class="action-btn approve-btn" onclick="changeSolicitudState(${solicitud.id_solicitud}, 'proceso', 'Aprobada desde historial')">‚úÖ</button>` :
                            solicitud.estado === 'proceso' ?
                            `<button class="action-btn approve-btn" onclick="changeSolicitudState(${solicitud.id_solicitud}, 'completada', 'Completada desde historial')">‚úÖ</button>` :
                            '<span style="color: #22c55e;">‚úÖ</span>'
                        }
                    </td>
                </tr>
            `).join('');
        }

        // Limpiar filtros
        function clearFilters() {
            document.getElementById('filter-fecha-desde').value = '';
            document.getElementById('filter-fecha-hasta').value = '';
            document.getElementById('filter-costurera').value = '';
            document.getElementById('filter-id').value = '';
            document.getElementById('filter-pendiente').checked = true;
            document.getElementById('filter-proceso').checked = true;
            document.getElementById('filter-completada').checked = true;
            applyFilters();
        }

        // Actuar como una costurera
        async function actAsUser(id_costurera, nombre_costurera) {
            try {
                // Cambiar a modo "actuando como"
                isActingAs = true;
                currentCosturera = { id: id_costurera, nombre: nombre_costurera };
                
                // Actualizar mensaje personalizado para mostrar modo actuando como
                document.getElementById('supervisor-greeting-title').textContent = `Actuando como: ${nombre_costurera}`;
                document.getElementById('supervisor-greeting-message').textContent = 'Puedes crear registros en nombre de esta costurera';
                document.getElementById('return-btn').style.display = 'block';
                
                // Redirigir a interfaz de costurera pero manteniendo permisos de supervisor
                window.location.href = `/costurera-dashboard.html?user=${id_costurera}&supervisor=true`;
                
            } catch (error) {
                console.error('Error actuando como costurera:', error);
                alert('Error de conexi√≥n');
            }
        }

        // Funci√≥n original de cambio de estado (para uso interno de la cola)
        async function originalChangeSolicitudState(id_solicitud, nuevo_estado, observaciones) {
            try {
                // üñ®Ô∏è Si es aprobaci√≥n (proceso), mostrar popup de impresi√≥n
                if (nuevo_estado === 'proceso') {
                    mostrarPopupImpresion(0, 'Aprobando y enviando a impresi√≥n...');
                }
                
                const response = await fetch(`/api/supervisor/cambiar-estado/${id_solicitud}`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({
                        nuevo_estado: nuevo_estado,
                        observaciones_supervisor: observaciones
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    // üñ®Ô∏è Si hubo cantidad impresa, actualizar popup
                    if (result.cantidad_impresa && nuevo_estado === 'proceso') {
                        actualizarProgresoImpresion(result.cantidad_impresa, result.cantidad_impresa);
                        
                        // Simular progreso gradual para mejor UX
                        const cantidadTotal = result.cantidad_impresa;
                        let progreso = 0;
                        const intervalo = setInterval(() => {
                            progreso += Math.ceil(cantidadTotal / 10);
                            if (progreso >= cantidadTotal) {
                                progreso = cantidadTotal;
                                clearInterval(intervalo);
                                // Ocultar popup despu√©s de 2 segundos
                                setTimeout(() => ocultarPopupImpresion(), 2000);
                            }
                            actualizarProgresoImpresion(progreso, cantidadTotal);
                        }, 200);
                    } else if (nuevo_estado === 'proceso') {
                        // Si no hay cantidad, ocultar despu√©s de 1.5 segundos
                        setTimeout(() => ocultarPopupImpresion(), 1500);
                    }
                    
                    // Recargar solicitudes pendientes y estad√≠sticas
                    await loadPendingSolicitudes();
                    await loadStats();
                    
                    // Mensaje m√°s sutil (solo consola)
                    console.log(`‚úÖ Solicitud ${id_solicitud} ${nuevo_estado}:`, result.mensaje);
                    
                    return result;
                } else {
                    // üñ®Ô∏è Ocultar popup en caso de error
                    ocultarPopupImpresion();
                    throw new Error(result.error);
                }
                
            } catch (error) {
                console.error('Error cambiando estado:', error);
                // üñ®Ô∏è Ocultar popup en caso de error
                ocultarPopupImpresion();
                throw error;
            }
        }

        // ==================== FUNCIONES PARA PRODUCTOS ESPECIALES ====================
        
        // Variable global para tracking de impresiones
        let impresionesRealizadas = {};
        
        // Abrir popup de impresi√≥n para producto especial
        async function abrirPopupImpresionEspecial(idSolicitud, nombreProducto, cantidadMaxima, componentesJson) {
            const componentes = JSON.parse(componentesJson.replace(/&quot;/g, '"'));
            
            // Obtener cantidades ya impresas desde el servidor
            try {
                const response = await fetch(`/api/solicitudes-especiales/${idSolicitud}/progreso`, {
                    headers: getAuthHeaders()
                });
                const progreso = await response.json();
                impresionesRealizadas = progreso.impresiones || {};
            } catch (error) {
                console.error('Error cargando progreso:', error);
                impresionesRealizadas = {};
            }
            
            // Calcular cu√°ntos faltan por imprimir
            const impresasJuego = impresionesRealizadas['juego'] || 0;
            const faltanJuego = cantidadMaxima - impresasJuego;
            const completadoJuego = faltanJuego === 0;
            
            // Crear HTML del popup
            const popupHTML = `
                <div class="modal-overlay" id="popup-impresion-especial" onclick="cerrarPopupImpresionEspecial(event)">
                    <div class="modal-content" style="max-width: 700px;" onclick="event.stopPropagation()">
                        <div class="modal-header" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed);">
                            <h2 style="color: white;">üñ®Ô∏è Imprimir Producto Especial</h2>
                            <button class="close-btn" onclick="cerrarPopupImpresionEspecial()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div style="background: rgba(245, 158, 11, 0.1); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                                <h3 style="margin: 0 0 5px 0; color: #92400e;">‚≠ê ${nombreProducto}</h3>
                                <p style="margin: 0; color: #78350f; font-size: 14px;">Cantidad solicitada: <strong>${cantidadMaxima}</strong></p>
                            </div>
                            
                            <p style="font-size: 14px; color: #666; margin-bottom: 15px;">
                                Selecciona cu√°ntas etiquetas imprimir de cada componente:
                            </p>
                            
                            <div id="componentes-impresion">
                                <!-- ENCABEZADO DEL JUEGO PRINCIPAL -->
                                <div class="componente-item ${completadoJuego ? 'completado' : ''}" 
                                     style="position: relative; display: flex; align-items: center; gap: 10px; padding: 12px; background: linear-gradient(135deg, #fef3c7, #fde68a); border: 2px solid #f59e0b; border-radius: 8px; margin-bottom: 15px;">
                                    ${completadoJuego ? `
                                        <div style="position: absolute; top: -12px; left: 50%; transform: translateX(-50%); background: #10b981; color: white; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; display: flex; align-items: center; gap: 5px; box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);">
                                            ‚úì COMPLETADO
                                        </div>
                                    ` : ''}
                                    <div style="flex: 1; ${completadoJuego ? 'opacity: 0.5;' : ''}">
                                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                                            <strong style="color: #92400e;">‚≠ê ${nombreProducto} (ENCABEZADO)</strong>
                                            ${!completadoJuego ? `
                                                <button onclick="abrirModalConfiguracionImpresion('${idSolicitud}', 'encabezado')" 
                                                        style="padding: 3px 8px; background: #8b5cf6; color: white; border: none; border-radius: 4px; font-size: 11px; cursor: pointer; font-weight: 600;">
                                                    ‚úèÔ∏è Editar
                                                </button>
                                            ` : ''}
                                        </div>
                                        <div style="font-size: 12px; color: #78350f;">
                                            Impresas: ${impresasJuego}/${cantidadMaxima} | Faltan: ${faltanJuego}
                                        </div>
                                    </div>
                                    <input type="number" 
                                           id="cant-comp-juego" 
                                           min="0" 
                                           max="${faltanJuego}" 
                                           value="0"
                                           ${completadoJuego ? 'disabled' : ''}
                                           data-id-producto-especial="${idSolicitud}"
                                           style="width: 80px; padding: 8px; border: 2px solid #f59e0b; border-radius: 6px; font-size: 16px; text-align: center; font-weight: bold; ${completadoJuego ? 'background: #e5e7eb; cursor: not-allowed;' : ''}"
                                           onchange="validarCantidadComponente(this, ${faltanJuego})">
                                </div>
                                
                                <div style="margin: 15px 0; border-bottom: 2px dashed #d1d5db; padding-bottom: 10px;">
                                    <strong style="color: #666;">üì¶ Componentes del ${nombreProducto}:</strong>
                                </div>
                                
                                ${componentes.map((comp, index) => {
                                    const impresasComp = impresionesRealizadas[`comp_${index}`] || 0;
                                    const faltanComp = cantidadMaxima - impresasComp;
                                    const completadoComp = faltanComp === 0;
                                    
                                    return `
                                    <div class="componente-item ${completadoComp ? 'completado' : ''}" 
                                         style="position: relative; display: flex; align-items: center; gap: 10px; padding: 12px; background: #f9fafb; border-radius: 8px; margin-bottom: 10px;">
                                        ${completadoComp ? `
                                            <div style="position: absolute; top: -10px; left: 50%; transform: translateX(-50%); background: #10b981; color: white; padding: 3px 10px; border-radius: 20px; font-size: 11px; font-weight: bold; display: flex; align-items: center; gap: 4px;">
                                                ‚úì COMPLETADO
                                            </div>
                                        ` : ''}
                                        <div style="flex: 1; ${completadoComp ? 'opacity: 0.5;' : ''}">
                                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                                                <strong>${comp.nombre}</strong>
                                                ${!completadoComp ? `
                                                    <button onclick="abrirModalConfiguracionImpresion('${comp.id}', 'componente')" 
                                                            style="padding: 3px 8px; background: #8b5cf6; color: white; border: none; border-radius: 4px; font-size: 11px; cursor: pointer; font-weight: 600;">
                                                        ‚úèÔ∏è Editar
                                                    </button>
                                                ` : ''}
                                            </div>
                                            <div style="font-size: 12px; color: #666;">
                                                Impresas: ${impresasComp}/${cantidadMaxima} | Faltan: ${faltanComp}
                                            </div>
                                        </div>
                                        <input type="number" 
                                               id="cant-comp-${index}" 
                                               min="0" 
                                               max="${faltanComp}" 
                                               value="0"
                                               ${completadoComp ? 'disabled' : ''}
                                               style="width: 80px; padding: 8px; border: 2px solid #d1d5db; border-radius: 6px; font-size: 16px; text-align: center; ${completadoComp ? 'background: #e5e7eb; cursor: not-allowed;' : ''}"
                                               onchange="validarCantidadComponente(this, ${faltanComp})">
                                    </div>
                                `}).join('')}
                            </div>
                            
                            <div style="background: #fef3c7; padding: 12px; border-radius: 8px; margin-top: 20px; border-left: 4px solid #f59e0b;">
                                <strong style="color: #92400e;">üí° Importante:</strong>
                                <p style="margin: 5px 0 0 0; font-size: 13px; color: #78350f;">
                                    Puedes imprimir 0 etiquetas de un componente si no lo necesitas en este momento. 
                                    La solicitud se completar√° cuando se impriman todos los componentes requeridos.
                                </p>
                            </div>
                        </div>
                        <div class="modal-footer" style="gap: 10px;">
                            <button class="btn-secondary" onclick="cerrarPopupImpresionEspecial()">
                                Cancelar
                            </button>
                            <button class="btn-imprimir-componentes" 
                                    style="background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white; border: none; padding: 12px 24px; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4); transition: all 0.3s;"
                                    onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(139, 92, 246, 0.5)'"
                                    onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(139, 92, 246, 0.4)'"
                                    data-id-solicitud="${idSolicitud}"
                                    data-nombre-producto="${nombreProducto}"
                                    data-cantidad-maxima="${cantidadMaxima}"
                                    data-componentes='${componentesJson.replace(/'/g, "\\'")}'>
                                üñ®Ô∏è Imprimir Seleccionados
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            // Agregar al DOM
            document.body.insertAdjacentHTML('beforeend', popupHTML);
            
            // Agregar event listener al bot√≥n de imprimir
            const btnImprimir = document.querySelector('.btn-imprimir-componentes');
            if (btnImprimir) {
                btnImprimir.addEventListener('click', function() {
                    const idSol = this.getAttribute('data-id-solicitud');
                    const nombreProd = this.getAttribute('data-nombre-producto');
                    const cantMax = this.getAttribute('data-cantidad-maxima');
                    const compsJson = this.getAttribute('data-componentes');
                    
                    imprimirComponentesEspeciales(idSol, nombreProd, cantMax, compsJson);
                });
            }
        }
        
        // Validar cantidad de componente
        function validarCantidadComponente(input, max) {
            const valor = parseInt(input.value) || 0;
            if (valor < 0) input.value = 0;
            if (valor > max) input.value = max;
        }
        
        // Cerrar popup de impresi√≥n
        function cerrarPopupImpresionEspecial(event) {
            if (event && event.target.className !== 'modal-overlay') return;
            const popup = document.getElementById('popup-impresion-especial');
            if (popup) popup.remove();
        }
        
        // Cambiar modo de impresi√≥n (Normal / Editar)
        let modoImpresionActual = 'normal';
        
        function cambiarModoImpresion(modo) {
            modoImpresionActual = modo;
            
            const btnNormal = document.getElementById('btn-modo-normal');
            const btnEditar = document.getElementById('btn-modo-editar');
            
            if (modo === 'normal') {
                btnNormal.style.background = '#8b5cf6';
                btnNormal.style.color = 'white';
                btnNormal.style.borderColor = '#8b5cf6';
                
                btnEditar.style.background = 'white';
                btnEditar.style.color = '#666';
                btnEditar.style.borderColor = '#d1d5db';
            } else {
                btnNormal.style.background = 'white';
                btnNormal.style.color = '#666';
                btnNormal.style.borderColor = '#d1d5db';
                
                btnEditar.style.background = '#8b5cf6';
                btnEditar.style.color = 'white';
                btnEditar.style.borderColor = '#8b5cf6';
                
                // Abrir modal de configuraci√≥n
                const input = document.getElementById('cant-comp-juego');
                const idProductoEspecial = input.getAttribute('data-id-producto-especial');
                if (idProductoEspecial) {
                    abrirModalConfiguracionImpresion(idProductoEspecial);
                }
            }
        }
        
        // Abrir modal de configuraci√≥n de campos para producto especial
        async function abrirModalConfiguracionImpresion(idProductoEspecial) {
            try {
                // Obtener configuraci√≥n actual
                const response = await fetch(`/api/config-impresion-especial/${idProductoEspecial}`, {
                    headers: getAuthHeaders()
                });
                const config = await response.json();
                
                // Crear modal
                const modalHTML = `
                    <div class="modal-overlay" id="modal-config-impresion" onclick="cerrarModalConfigImpresion(event)">
                        <div class="modal-content" style="max-width: 500px;" onclick="event.stopPropagation()">
                            <div class="modal-header" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed);">
                                <h2 style="color: white;">‚öôÔ∏è Configurar Campos de Impresi√≥n</h2>
                                <button class="close-btn" onclick="cerrarModalConfigImpresion()">&times;</button>
                            </div>
                            <div class="modal-body">
                                <p style="font-size: 14px; color: #666; margin-bottom: 15px;">
                                    Selecciona qu√© campos mostrar en la etiqueta del encabezado:
                                </p>
                                
                                <div style="display: flex; flex-direction: column; gap: 12px;">
                                    <!-- Nombre -->
                                    <label style="display: flex; align-items: center; gap: 10px; padding: 12px; background: #f9fafb; border: 2px solid #e5e7eb; border-radius: 8px; cursor: pointer;">
                                        <input type="checkbox" id="cfg-mostrar-nombre" ${config.mostrar_nombre ? 'checked' : ''}
                                               style="width: 20px; height: 20px; cursor: pointer;">
                                        <div>
                                            <div style="font-weight: 600; color: #1f2937;">üìù Nombre del Juego</div>
                                            <div style="font-size: 11px; color: #6b7280;">Nombre completo del producto especial</div>
                                        </div>
                                    </label>
                                    
                                    <!-- Modelo -->
                                    <label style="display: flex; align-items: center; gap: 10px; padding: 12px; background: #f9fafb; border: 2px solid #e5e7eb; border-radius: 8px; cursor: pointer;">
                                        <input type="checkbox" id="cfg-mostrar-modelo" ${config.mostrar_modelo ? 'checked' : ''}
                                               style="width: 20px; height: 20px; cursor: pointer;">
                                        <div>
                                            <div style="font-weight: 600; color: #1f2937;">üè∑Ô∏è Modelo</div>
                                            <div style="font-size: 11px; color: #6b7280;">Modelo del juego (si aplica)</div>
                                        </div>
                                    </label>
                                    
                                    <!-- Unidad -->
                                    <label style="display: flex; align-items: center; gap: 10px; padding: 12px; background: #f9fafb; border: 2px solid #e5e7eb; border-radius: 8px; cursor: pointer;">
                                        <input type="checkbox" id="cfg-mostrar-unidad" ${config.mostrar_unidad ? 'checked' : ''}
                                               style="width: 20px; height: 20px; cursor: pointer;">
                                        <div>
                                            <div style="font-weight: 600; color: #1f2937;">üìè Unidad</div>
                                            <div style="font-size: 11px; color: #6b7280;">Unidad de medida</div>
                                        </div>
                                    </label>
                                    
                                    <!-- ID -->
                                    <label style="display: flex; align-items: center; gap: 10px; padding: 12px; background: #f9fafb; border: 2px solid #e5e7eb; border-radius: 8px; cursor: pointer;">
                                        <input type="checkbox" id="cfg-mostrar-id" ${config.mostrar_id ? 'checked' : ''}
                                               style="width: 20px; height: 20px; cursor: pointer;">
                                        <div>
                                            <div style="font-weight: 600; color: #1f2937;">üî¢ ID/C√≥digo</div>
                                            <div style="font-size: 11px; color: #6b7280;">Identificador del juego</div>
                                        </div>
                                    </label>
                                    
                                    <!-- Empresa -->
                                    <label style="display: flex; align-items: center; gap: 10px; padding: 12px; background: #f9fafb; border: 2px solid #e5e7eb; border-radius: 8px; cursor: pointer;">
                                        <input type="checkbox" id="cfg-mostrar-empresa" ${config.mostrar_empresa ? 'checked' : ''}
                                               style="width: 20px; height: 20px; cursor: pointer;">
                                        <div>
                                            <div style="font-weight: 600; color: #1f2937;">üè¢ Empresa</div>
                                            <div style="font-size: 11px; color: #6b7280;">Informaci√≥n de la empresa</div>
                                        </div>
                                    </label>
                                </div>
                                
                                <div style="background: #fef3c7; padding: 12px; border-radius: 8px; margin-top: 15px; border-left: 4px solid #f59e0b;">
                                    <strong style="color: #92400e;">‚ö†Ô∏è Nota:</strong>
                                    <p style="margin: 5px 0 0 0; font-size: 12px; color: #78350f;">
                                        Debe haber al menos un campo visible. La configuraci√≥n se guardar√° para futuras impresiones.
                                    </p>
                                </div>
                            </div>
                            <div class="modal-footer" style="gap: 10px;">
                                <button class="btn-secondary" onclick="cerrarModalConfigImpresion()">
                                    Cancelar
                                </button>
                                <button class="btn-primary" onclick="guardarConfiguracionImpresion(${idProductoEspecial})">
                                    üíæ Guardar y Aplicar
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', modalHTML);
                
            } catch (error) {
                console.error('Error abriendo modal de configuraci√≥n:', error);
                alert('Error al cargar configuraci√≥n');
            }
        }
        
        // Cerrar modal de configuraci√≥n
        function cerrarModalConfigImpresion(event) {
            if (event && event.target.id !== 'modal-config-impresion') return;
            const modal = document.getElementById('modal-config-impresion');
            if (modal) modal.remove();
        }
        
        // Guardar configuraci√≥n de impresi√≥n
        async function guardarConfiguracionImpresion(idProductoEspecial) {
            try {
                const config = {
                    id_producto_especial: idProductoEspecial,
                    mostrar_nombre: document.getElementById('cfg-mostrar-nombre').checked,
                    mostrar_modelo: document.getElementById('cfg-mostrar-modelo').checked,
                    mostrar_unidad: document.getElementById('cfg-mostrar-unidad').checked,
                    mostrar_id: document.getElementById('cfg-mostrar-id').checked,
                    mostrar_empresa: document.getElementById('cfg-mostrar-empresa').checked
                };
                
                // Validar que al menos un campo est√© activo
                const algunCampoActivo = Object.values(config).slice(1).some(v => v === true);
                if (!algunCampoActivo) {
                    alert('Debe haber al menos un campo visible');
                    return;
                }
                
                const response = await fetch('/api/config-impresion-especial', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...getAuthHeaders()
                    },
                    body: JSON.stringify(config)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification('‚úÖ Configuraci√≥n guardada correctamente', 'success');
                    cerrarModalConfigImpresion();
                } else {
                    throw new Error(result.error);
                }
                
            } catch (error) {
                console.error('Error guardando configuraci√≥n:', error);
                alert('Error al guardar configuraci√≥n: ' + error.message);
            }
        }
        
        // Imprimir componentes seleccionados
        async function imprimirComponentesEspeciales(idSolicitud, nombreProducto, cantidadMaxima, componentesJson) {
            const componentes = JSON.parse(componentesJson.replace(/&quot;/g, '"'));
            
            // Recopilar cantidades seleccionadas
            const impresiones = [];
            
            // 1. NOMBRE DEL JUEGO (etiqueta principal)
            const cantidadJuego = parseInt(document.getElementById('cant-comp-juego').value) || 0;
            if (cantidadJuego > 0) {
                impresiones.push({
                    tipo: 'JUEGO',
                    nombre: nombreProducto,
                    cantidad: cantidadJuego,
                    es_principal: true
                });
            }
            
            // 2. COMPONENTES del juego
            componentes.forEach((comp, index) => {
                const cantidad = parseInt(document.getElementById(`cant-comp-${index}`).value) || 0;
                if (cantidad > 0) {
                    impresiones.push({
                        tipo: 'COMPONENTE',
                        id_producto: comp.id,
                        nombre: comp.nombre,
                        cantidad: cantidad,
                        es_principal: false
                    });
                }
            });
            
            if (impresiones.length === 0) {
                alert('Debes seleccionar al menos 1 etiqueta para imprimir (JUEGO o alg√∫n componente)');
                return;
            }
            
            try {
                console.log('üñ®Ô∏è Imprimiendo componentes especiales:', impresiones);
                
                // Enviar cada impresi√≥n al servidor (cada componente se imprime por separado)
                const resultados = [];
                
                for (const item of impresiones) {
                    console.log(`üì§ Enviando impresi√≥n de: ${item.nombre} (${item.cantidad} unidades)`);
                    
                    const response = await fetch('/api/imprimir-componente-especial', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            ...getAuthHeaders()
                        },
                        body: JSON.stringify({
                            id_solicitud: idSolicitud,
                            nombre_componente: item.nombre,
                            cantidad: item.cantidad,
                            es_principal: item.es_principal,
                            id_producto: item.id_producto || null
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        console.log(`‚úÖ Impresi√≥n exitosa: ${item.nombre}`);
                        resultados.push({ nombre: item.nombre, exito: true });
                    } else {
                        console.error(`‚ùå Error imprimiendo ${item.nombre}:`, result.error);
                        resultados.push({ nombre: item.nombre, exito: false, error: result.error });
                    }
                }
                
                cerrarPopupImpresionEspecial();
                
                // Mostrar resumen de resultados
                const exitosos = resultados.filter(r => r.exito).length;
                const fallidos = resultados.filter(r => !r.exito).length;
                
                if (fallidos === 0) {
                    const totalEtiquetas = impresiones.reduce((sum, item) => sum + item.cantidad, 0);
                    showNotification(`‚úÖ Se imprimieron ${totalEtiquetas} etiquetas correctamente (${exitosos} componentes)`, 'success');
                } else {
                    showNotification(`‚ö†Ô∏è Impresi√≥n completada: ${exitosos} exitosos, ${fallidos} fallidos`, 'warning');
                }
                
                // Recargar solicitudes para actualizar el estado
                await loadTodasLasSolicitudes();
                await cargarSolicitudesEspeciales();
                
            } catch (error) {
                console.error('Error imprimiendo componentes:', error);
                alert('Error al imprimir componentes: ' + error.message);
            }
        }
        // Cancelar solicitud especial
        async function cancelarSolicitudEspecial(idSolicitud) {
            if (!confirm('¬øEst√° seguro de cancelar esta solicitud especial?')) {
                return;
            }
            
            const motivo = prompt('¬øMotivo de cancelaci√≥n? (opcional)') || 'Cancelada por supervisor';
            
            if (!motivo) return; // Usuario cancel√≥
            
            try {
                console.log(`‚ùå Cancelando solicitud especial ${idSolicitud}`);
                
                // Usar el endpoint correcto del supervisor
                const response = await fetch(`/api/supervisor/cambiar-estado/${idSolicitud}`, {
                    method: 'POST',
                    headers: {
                        ...getAuthHeaders(),
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        nuevo_estado: 'cancelada',
                        observaciones: motivo
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Error al cancelar solicitud');
                }
                
                alert('‚úÖ Solicitud especial cancelada correctamente');
                
                // Recargar solicitudes especiales
                await cargarSolicitudesEspeciales();
                
            } catch (error) {
                console.error('Error cancelando solicitud:', error);
                alert('‚ùå Error al cancelar solicitud: ' + error.message);
            }
        }
        
        // ==================== FIN FUNCIONES PRODUCTOS ESPECIALES ====================

        // ==================== FUNCIONES ENTIDADES ====================
        
        // Cargar lista de entidades desde la API (para uso interno)
        async function cargarEntidades() {
            try {
                const response = await fetch('/api/entidades', {
                    method: 'GET',
                    headers: getAuthHeaders()
                });
                
                if (!response.ok) {
                    throw new Error('Error al cargar entidades');
                }
                
                const entidades = await response.json();
                // No mostrar tabla, solo para uso interno
                return entidades;
            } catch (error) {
                console.error('Error cargando entidades:', error);
                return [];
            }
        }
        
        // Abrir modal para nueva entidad
        function abrirModalNuevaEntidad() {
            document.getElementById('modal-nueva-entidad').style.display = 'flex';
            document.getElementById('form-nueva-entidad').reset();
        }
        
        // Cerrar modal nueva entidad
        function cerrarModalNuevaEntidad() {
            document.getElementById('modal-nueva-entidad').style.display = 'none';
        }
        
        // Crear nueva entidad
        async function crearEntidad(event) {
            event.preventDefault();
            
            const nombreEntidad = document.getElementById('nueva-entidad-nombre').value.trim();
            
            if (!nombreEntidad) {
                alert('Por favor ingrese un nombre para la entidad');
                return;
            }
            
            try {
                const response = await fetch('/api/entidades', {
                    method: 'POST',
                    headers: {
                        ...getAuthHeaders(),
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ nombre_entidad: nombreEntidad })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.mensaje || 'Error al crear entidad');
                }
                
                const result = await response.json();
                alert('‚úÖ Entidad creada exitosamente: ' + result.entidad.nombre_entidad);
                cerrarModalNuevaEntidad();
                // Recargar datos para refrescar informaci√≥n si es necesario
                console.log('‚úÖ Nueva entidad registrada, disponible para las costureras');
                
            } catch (error) {
                console.error('Error creando entidad:', error);
                alert(error.message || 'Error al crear la entidad. Por favor intente nuevamente.');
            }
        }
        

        
        // ==================== FIN FUNCIONES ENTIDADES ====================

        // Cambiar estado de solicitud - NUEVA VERSI√ìN CON SISTEMA DE COLA
        async function changeSolicitudState(id_solicitud, nuevo_estado, observaciones) {
            if (nuevo_estado === 'cancelada' && !observaciones) {
                // Solicitar confirmaci√≥n para cancelar/rechazar
                observaciones = prompt('Motivo de rechazo (opcional):') || 'Rechazada por supervisor';
                if (!observaciones) return; // Usuario cancel√≥
            }
            
            // Si es aprobaci√≥n (proceso), usar sistema de cola
            if (nuevo_estado === 'proceso') {
                console.log(`üéØ Agregando solicitud ${id_solicitud} a cola de aprobaci√≥n`);
                addToApprovalQueue(id_solicitud);
                return;
            }
            
            // Para rechazos u otros cambios, procesar inmediatamente
            try {
                await originalChangeSolicitudState(id_solicitud, nuevo_estado, observaciones);
                
                // Mostrar notificaci√≥n discreta solo para rechazos
                if (nuevo_estado === 'cancelada') {
                    showNotification(`Solicitud ${id_solicitud} rechazada`, 'info');
                }
                
            } catch (error) {
                console.error('Error cambiando estado:', error);
                showNotification('Error al procesar solicitud', 'error');
            }
        }

        // Volver al modo supervisor
        function returnToSupervisorMode() {
            isActingAs = false;
            currentCosturera = null;
            
            // Restaurar mensaje personalizado del supervisor
            updateSupervisorGreetingMessage();
            document.getElementById('return-btn').style.display = 'none';
            
            // Recargar datos
            loadDashboardData();
        }

        // Mostrar notificaci√≥n
        function showNotification(message, type = 'info') {
            // Crear notificaci√≥n discreta tipo toast
            console.log(`üì¢ ${type.toUpperCase()}: ${message}`);
            
            // Solo mostrar notificaciones cr√≠ticas como alerts
            if (type === 'error') {
                alert('‚ùå ' + message);
            }
            
            // Para el resto, solo log en consola (m√°s discreto)
            // Futuro: implementar toast notifications aqu√≠
        }

        // ==============================================
        // FUNCIONES PARA GESTI√ìN DE PRODUCTOS
        // ==============================================

        // Mostrar modal para a√±adir producto
        // Mostrar popup de selecci√≥n de tipo de producto
        function showAddProductModal() {
            document.getElementById('tipo-producto-popup').style.display = 'flex';
        }

        // Seleccionar tipo de producto y abrir modal correspondiente
        function seleccionarTipoProducto(tipo) {
            closeModal('tipo-producto-popup');
            
            if (tipo === 'normal') {
                showAddProductModalNormal();
            } else if (tipo === 'especial') {
                showCrearEspecialModal();
            }
        }

        // Abrir modal de producto normal
        async function showAddProductModalNormal() {
            document.getElementById('add-product-modal').style.display = 'flex';
            
            // Cargar datos din√°micamente desde PostgreSQL
            await loadSubcategoriasForCreate();
            await loadMarcasForCreate();
            await loadModelosForCreate();
            
            // Obtener el pr√≥ximo c√≥digo de producto
            await generateNextProductCode();
            
            // Event listeners para vista previa en tiempo real
            document.getElementById('new-nombre').oninput = updatePreview;
            document.getElementById('new-subcategoria').onchange = updatePreview;
            document.getElementById('new-marca').oninput = updatePreview;
            document.getElementById('new-modelo').oninput = updatePreview;

            // Event listener para el formulario
            document.getElementById('add-product-form').onsubmit = async (e) => {
                e.preventDefault();
                await createNewProduct();
            };
        }

        // Cargar subcategor√≠as para el modal de creaci√≥n
        async function loadSubcategoriasForCreate() {
            try {
                const response = await fetch('/api/subcategorias-terminados', {
                    headers: getAuthHeaders()
                });

                if (!response.ok) {
                    throw new Error(`Error ${response.status}`);
                }

                const subcategorias = await response.json();
                const select = document.getElementById('new-subcategoria');
                
                // Limpiar opciones existentes excepto la primera
                select.innerHTML = '<option value="">Seleccione el tipo de producto...</option>';
                
                // Agregar subcategor√≠as desde PostgreSQL
                subcategorias.forEach(subcategoria => {
                    const option = document.createElement('option');
                    option.value = subcategoria;
                    option.textContent = subcategoria;
                    select.appendChild(option);
                });

                console.log(`‚úÖ Cargadas ${subcategorias.length} subcategor√≠as para crear: ${subcategorias.join(', ')}`);
                
            } catch (error) {
                console.error('Error cargando subcategor√≠as para crear:', error);
                // Mantener subcategor√≠as por defecto como fallback
                const select = document.getElementById('new-subcategoria');
                if (select.children.length <= 1) { // Solo si no hay opciones cargadas
                    select.innerHTML = `
                        <option value="">Seleccione el tipo de producto...</option>
                        <option value="PROTECTORES">PROTECTORES</option>
                        <option value="FRAZADAS">FRAZADAS</option>
                        <option value="SABANAS">SABANAS</option>
                        <option value="DUBET">DUBET</option>
                        <option value="EDREDONES">EDREDONES</option>
                    `;
                }
            }
        }

        // Cargar marcas existentes para autocompletado
        async function loadMarcasForCreate() {
            try {
                const response = await fetch('/api/productos/lista/marcas', {
                    headers: getAuthHeaders()
                });

                if (response.ok) {
                    const marcas = await response.json();
                    const datalist = document.getElementById('new-marcas-datalist');
                    
                    // Limpiar opciones existentes
                    datalist.innerHTML = '';
                    
                    // Agregar marcas desde PostgreSQL
                    marcas.forEach(marca => {
                        const option = document.createElement('option');
                        option.value = marca;
                        datalist.appendChild(option);
                    });

                    console.log(`‚úÖ Cargadas ${marcas.length} marcas para crear`);
                }
            } catch (error) {
                console.error('Error cargando marcas:', error);
            }
        }

        // Cargar modelos existentes para autocompletado
        async function loadModelosForCreate() {
            try {
                const response = await fetch('/api/productos/lista/modelos', {
                    headers: getAuthHeaders()
                });

                if (response.ok) {
                    const modelos = await response.json();
                    const datalist = document.getElementById('new-modelos-datalist');
                    
                    // Limpiar opciones existentes
                    datalist.innerHTML = '';
                    
                    // Agregar modelos desde PostgreSQL
                    modelos.forEach(modelo => {
                        const option = document.createElement('option');
                        option.value = modelo;
                        datalist.appendChild(option);
                    });

                    console.log(`‚úÖ Cargados ${modelos.length} modelos para crear`);
                }
            } catch (error) {
                console.error('Error cargando modelos:', error);
            }
        }

        // Cargar marcas existentes para modal de edici√≥n
        async function loadMarcasForEdit() {
            try {
                const response = await fetch('/api/productos/lista/marcas', {
                    headers: getAuthHeaders()
                });

                if (response.ok) {
                    const marcas = await response.json();
                    const datalist = document.getElementById('edit-marcas-datalist');
                    
                    // Limpiar opciones existentes
                    datalist.innerHTML = '';
                    
                    // Agregar marcas desde PostgreSQL
                    marcas.forEach(marca => {
                        const option = document.createElement('option');
                        option.value = marca;
                        datalist.appendChild(option);
                    });

                    console.log(`‚úÖ Cargadas ${marcas.length} marcas para editar`);
                }
            } catch (error) {
                console.error('Error cargando marcas para edici√≥n:', error);
            }
        }

        // Cargar modelos existentes para modal de edici√≥n
        async function loadModelosForEdit() {
            try {
                const response = await fetch('/api/productos/lista/modelos', {
                    headers: getAuthHeaders()
                });

                if (response.ok) {
                    const modelos = await response.json();
                    const datalist = document.getElementById('edit-modelos-datalist');
                    
                    // Limpiar opciones existentes
                    datalist.innerHTML = '';
                    
                    // Agregar modelos desde PostgreSQL
                    modelos.forEach(modelo => {
                        const option = document.createElement('option');
                        option.value = modelo;
                        datalist.appendChild(option);
                    });

                    console.log(`‚úÖ Cargados ${modelos.length} modelos para editar`);
                }
            } catch (error) {
                console.error('Error cargando modelos para edici√≥n:', error);
            }
        }

        // Generar el pr√≥ximo c√≥digo de producto
        async function generateNextProductCode() {
            try {
                const response = await fetch('/api/admin/productos/next-code', {
                    headers: getAuthHeaders()
                });
                
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('preview-codigo').textContent = data.next_code;
                } else {
                    document.getElementById('preview-codigo').textContent = 'PROD-001 (por defecto)';
                }
            } catch (error) {
                console.error('Error generando c√≥digo:', error);
                document.getElementById('preview-codigo').textContent = 'PROD-001 (por defecto)';
            }
        }

        // Actualizar vista previa en tiempo real
        function updatePreview() {
            const nombre = document.getElementById('new-nombre').value.trim();
            const subcategoria = document.getElementById('new-subcategoria').value;
            const marca = document.getElementById('new-marca').value.trim();
            const modelo = document.getElementById('new-modelo').value.trim();

            // Actualizar descripci√≥n (igual al nombre)
            document.getElementById('preview-descripcion').textContent = 
                nombre || 'Igual al nombre del producto';

            // Generar SKU autom√°tico
            let sku = '';
            if (subcategoria) {
                sku = subcategoria.substring(0, 3).toUpperCase();
                if (marca) {
                    sku += '-' + marca.substring(0, 3).toUpperCase();
                }
                if (modelo) {
                    sku += '-' + modelo.substring(0, 3).toUpperCase();
                }
            }
            document.getElementById('preview-sku').textContent = 
                sku || 'Se generar√° autom√°ticamente';

            // Generar c√≥digo de barras autom√°tico (basado en timestamp + subcategor√≠a)
            if (subcategoria && nombre) {
                const timestamp = Date.now().toString().slice(-6);
                const subcatCode = subcategoria.substring(0, 3).toUpperCase();
                const barcode = `${subcatCode}${timestamp}`;
                document.getElementById('preview-barcode').textContent = barcode;
            } else {
                document.getElementById('preview-barcode').textContent = 'Se generar√° autom√°ticamente';
            }
        }

        // Crear nuevo producto
        async function createNewProduct() {
            const nombre = document.getElementById('new-nombre').value.trim();
            const subcategoria = document.getElementById('new-subcategoria').value.trim();
            const marca = document.getElementById('new-marca').value.trim();
            const modelo = document.getElementById('new-modelo').value.trim();

            // Validaciones b√°sicas
            if (!nombre || !subcategoria) {
                alert('El nombre del producto y la subcategor√≠a son obligatorios');
                return;
            }

            // Generar campos autom√°ticos
            const codigo_producto = document.getElementById('preview-codigo').textContent;
            const descripcion_corta = nombre; // Igual al nombre
            const categoria = 'Productos Terminados'; // Fijo
            const unidad_medida = 'UNIDAD'; // Por defecto
            
            // Generar SKU autom√°tico
            let sku = subcategoria.substring(0, 3).toUpperCase();
            if (marca) sku += '-' + marca.substring(0, 3).toUpperCase();
            if (modelo) sku += '-' + modelo.substring(0, 3).toUpperCase();
            
            // Generar c√≥digo de barras autom√°tico
            const timestamp = Date.now().toString().slice(-6);
            const subcatCode = subcategoria.substring(0, 3).toUpperCase();
            const codigo_barras = `${subcatCode}${timestamp}`;

            const formData = {
                codigo_producto,
                nombre_producto: nombre,
                descripcion_corta,
                categoria,
                subcategoria,
                marca: marca || null,
                modelo: modelo || null,
                codigo_barras,
                unidad_medida,
                sku,
                activo: true
            };

            try {
                const response = await fetch('/api/admin/productos/create', {
                    method: 'POST',
                    headers: {
                        ...getAuthHeaders(),
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });

                const result = await response.json();

                if (response.ok) {
                    showNotification('‚úÖ Producto creado exitosamente', 'success');
                    closeModal('add-product-modal');
                    // Limpiar formulario
                    document.getElementById('add-product-form').reset();
                } else {
                    alert('Error: ' + result.error);
                }

            } catch (error) {
                console.error('Error creando producto:', error);
                alert('Error de conexi√≥n al crear producto');
            }
        }

        // Mostrar modal para quitar producto
        async function showRemoveProductModal() {
            document.getElementById('remove-product-modal').style.display = 'flex';
            await loadProductsForRemoval();

            // Event listener para b√∫squeda
            document.getElementById('search-product-remove').oninput = (e) => {
                filterProductsForRemoval(e.target.value);
            };
        }

        // Cargar productos para desactivar
        async function loadProductsForRemoval() {
            const container = document.getElementById('remove-products-list');
            
            try {
                // Cargar TODOS los productos activos para desactivaci√≥n
                const response = await fetch('/api/productos?all=true&activos=true', {
                    headers: getAuthHeaders()
                });

                if (response.ok) {
                    const result = await response.json();
                    // Manejar nueva estructura de respuesta con paginaci√≥n
                    const productos = result.data || result || [];
                    
                    console.log(`üì¶ Productos para desactivar: ${productos.length}/${result.total || 'N/A'}`);
                    
                    displayProductsForRemoval(productos);
                } else {
                    container.innerHTML = '<div class="loading">Error cargando productos</div>';
                }

            } catch (error) {
                console.error('Error cargando productos:', error);
                container.innerHTML = '<div class="loading">Error de conexi√≥n</div>';
            }
        }

        // Mostrar productos para desactivar
        function displayProductsForRemoval(productos) {
            const container = document.getElementById('remove-products-list');
            
            // Verificar que productos sea un array v√°lido
            if (!Array.isArray(productos)) {
                console.error('Error: productos no es un array:', productos);
                container.innerHTML = '<div class="loading">Error: formato de datos incorrecto</div>';
                return;
            }
            
            if (productos.length === 0) {
                container.innerHTML = '<div class="loading">No hay productos activos</div>';
                return;
            }

            container.innerHTML = productos.map(producto => `
                <div class="product-item" onclick="confirmRemoveProduct(${producto.id_producto}, '${producto.nombre_producto}')">
                    <div class="product-info">
                        <h4>${producto.nombre_producto}</h4>
                        <p>${producto.codigo_producto} | ${producto.categoria || 'Sin categor√≠a'} | ${producto.subcategoria || 'Sin subcategor√≠a'}</p>
                    </div>
                    <span class="status-badge status-active">Activo</span>
                </div>
            `).join('');
        }

        // Filtrar productos para desactivar
        function filterProductsForRemoval(searchText) {
            const items = document.querySelectorAll('#remove-products-list .product-item');
            items.forEach(item => {
                const text = item.textContent.toLowerCase();
                item.style.display = text.includes(searchText.toLowerCase()) ? 'flex' : 'none';
            });
        }

        // Confirmar desactivaci√≥n de producto
        async function confirmRemoveProduct(productId, productName) {
            const confirmed = confirm(`¬øEst√° seguro de que desea desactivar el producto "${productName}"?\n\nEsto no eliminar√° el producto, solo lo marcar√° como inactivo.`);
            
            if (confirmed) {
                await deactivateProduct(productId, productName);
            }
        }

        // Desactivar producto
        async function deactivateProduct(productId, productName) {
            try {
                const response = await fetch('/api/admin/productos/deactivate', {
                    method: 'PUT',
                    headers: {
                        ...getAuthHeaders(),
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ id_producto: productId })
                });

                const result = await response.json();

                if (response.ok) {
                    showNotification(`‚úÖ Producto "${productName}" desactivado correctamente`, 'success');
                    // Recargar lista
                    await loadProductsForRemoval();
                } else {
                    alert('Error: ' + result.error);
                }

            } catch (error) {
                console.error('Error desactivando producto:', error);
                alert('Error de conexi√≥n al desactivar producto');
            }
        }

        // Mostrar modal de consulta de productos
        async function showProductsListModal() {
            document.getElementById('products-list-modal').style.display = 'flex';
            await loadAllProducts();

            // Event listeners para filtros
            document.getElementById('search-products').oninput = (e) => {
                filterProducts();
            };
            document.getElementById('filter-categoria').onchange = filterProducts;
            document.getElementById('filter-subcategoria').onchange = filterProducts;
        }

        // Cargar todos los productos
        async function loadAllProducts() {
            const tbody = document.getElementById('products-tbody');
            
            try {
                // Cargar TODOS los productos activos sin paginaci√≥n
                const response = await fetch('/api/productos?all=true&activos=true', {
                    headers: getAuthHeaders()
                });

                if (response.ok) {
                    const result = await response.json();
                    // Manejar nueva estructura de respuesta con paginaci√≥n
                    const productos = result.data || result || [];
                    
                    console.log(`üì¶ Productos cargados en modal: ${productos.length}/${result.total || 'N/A'}`);
                    console.log('üìã Respuesta completa del servidor:', result);
                    
                    if (result.all) {
                        console.log('‚úÖ Cargados TODOS los productos disponibles en modal');
                    } else {
                        console.warn('‚ö†Ô∏è Carga paginada en modal - algunos productos podr√≠an faltar');
                    }
                    
                    displayAllProducts(productos);
                    populateFilters(productos);
                } else {
                    tbody.innerHTML = '<tr><td colspan="7" class="loading">Error cargando productos</td></tr>';
                }

            } catch (error) {
                console.error('Error cargando productos:', error);
                tbody.innerHTML = '<tr><td colspan="7" class="loading">Error de conexi√≥n</td></tr>';
            }
        }

        // Mostrar todos los productos
        function displayAllProducts(productos) {
            const tbody = document.getElementById('products-tbody');
            
            // Verificar que productos sea un array v√°lido
            if (!Array.isArray(productos)) {
                console.error('Error: productos no es un array:', productos);
                tbody.innerHTML = '<tr><td colspan="7" class="loading">Error: formato de datos incorrecto</td></tr>';
                return;
            }
            
            if (productos.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="loading">No hay productos registrados</td></tr>';
                return;
            }

            tbody.innerHTML = productos.map(producto => {
                // CALCULAR SI EL NOMBRE SUPERA EL L√çMITE DEL CANVAS
                const nombreProducto = producto.nombre_producto || '';
                const MAX_CHARS_LINEA = 28; // Caracteres m√°ximos por l√≠nea en el canvas (actualizado)
                const MAX_LINEAS = 2; // M√°ximo de l√≠neas disponibles
                const MAX_CHARS_TOTAL = MAX_CHARS_LINEA * MAX_LINEAS; // 56 caracteres totales
                
                const longitudNombre = nombreProducto.length;
                const excedeCaracteres = longitudNombre > MAX_CHARS_TOTAL;
                const caracteresExceso = excedeCaracteres ? longitudNombre - MAX_CHARS_TOTAL : 0;
                
                // Generar √≠cono de advertencia si excede
                const iconoAdvertencia = excedeCaracteres ? 
                    `<span class="warning-icon" onclick="mostrarAdvertenciaNombre('${nombreProducto.replace(/'/g, "\\'")}', ${longitudNombre}, ${MAX_CHARS_TOTAL}, ${caracteresExceso})" 
                           title="‚ö†Ô∏è Este nombre supera el l√≠mite del canvas. Click para m√°s detalles."
                           style="cursor: pointer; color: #f59e0b; font-size: 18px; margin-left: 8px; font-weight: bold;">
                        ‚ö†Ô∏è
                    </span>` : '';
                
                return `
                    <tr data-categoria="${producto.categoria || ''}" data-subcategoria="${producto.subcategoria || ''}" data-search="${producto.nombre_producto} ${producto.codigo_producto} ${producto.marca || ''} ${producto.modelo || ''}">
                        <td>${producto.codigo_producto}</td>
                        <td>
                            ${producto.nombre_producto}${iconoAdvertencia}
                        </td>
                        <td>${producto.categoria || '-'}</td>
                        <td>${producto.subcategoria || '-'}</td>
                        <td>${producto.marca || '-'}</td>
                        <td>
                            <span class="status-badge ${producto.activo ? 'status-active' : 'status-inactive'}">
                                ${producto.activo ? 'Activo' : 'Inactivo'}
                            </span>
                        </td>
                        <td>
                            <button class="btn-edit" onclick="editProduct(${producto.id_producto})" title="Editar producto">
                                ‚úèÔ∏è Editar
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Poblar filtros de categor√≠as y subcategor√≠as
        function populateFilters(productos) {
            // Verificar que productos sea un array v√°lido
            if (!Array.isArray(productos)) {
                console.error('Error: productos no es un array para filtros:', productos);
                return;
            }
            
            const categorias = [...new Set(productos.map(p => p.categoria).filter(Boolean))];
            const subcategorias = [...new Set(productos.map(p => p.subcategoria).filter(Boolean))];

            const categoriaSelect = document.getElementById('filter-categoria');
            const subcategoriaSelect = document.getElementById('filter-subcategoria');

            categoriaSelect.innerHTML = '<option value="">Todas las categor√≠as</option>' +
                categorias.map(cat => `<option value="${cat}">${cat}</option>`).join('');

            subcategoriaSelect.innerHTML = '<option value="">Todas las subcategor√≠as</option>' +
                subcategorias.map(sub => `<option value="${sub}">${sub}</option>`).join('');
        }

        // Filtrar productos en la tabla
        function filterProducts() {
            const searchText = document.getElementById('search-products').value.toLowerCase();
            const categoria = document.getElementById('filter-categoria').value;
            const subcategoria = document.getElementById('filter-subcategoria').value;

            const rows = document.querySelectorAll('#products-tbody tr');
            
            rows.forEach(row => {
                const searchData = row.dataset.search ? row.dataset.search.toLowerCase() : '';
                const rowCategoria = row.dataset.categoria || '';
                const rowSubcategoria = row.dataset.subcategoria || '';

                const matchesSearch = !searchText || searchData.includes(searchText);
                const matchesCategoria = !categoria || rowCategoria === categoria;
                const matchesSubcategoria = !subcategoria || rowSubcategoria === subcategoria;

                row.style.display = matchesSearch && matchesCategoria && matchesSubcategoria ? '' : 'none';
            });
        }

        // Variable global para saber qu√© vista est√° activa
        let vistaActual = 'normales'; // 'normales' o 'especiales'

        // ===== SISTEMA DE ADVERTENCIA DE NOMBRES LARGOS =====
        
        function mostrarAdvertenciaNombre(nombreProducto, longitudActual, longitudMaxima, caracteresExceso) {
            const caracteresRecomendados = longitudMaxima;
            const mensaje = `
                <div style="text-align: center; padding: 20px;">
                    <div style="font-size: 48px; margin-bottom: 15px;">‚ö†Ô∏è</div>
                    <h3 style="color: #dc2626; margin-bottom: 20px;">Nombre de Producto Demasiado Largo</h3>
                    
                    <div style="background: #fef2f2; border-left: 4px solid #dc2626; padding: 15px; margin: 20px 0; text-align: left;">
                        <p style="margin: 8px 0;"><strong>Producto:</strong></p>
                        <p style="color: #666; font-size: 14px; word-break: break-word;">${nombreProducto}</p>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin: 25px 0;">
                        <div style="background: #fee2e2; padding: 15px; border-radius: 8px;">
                            <div style="font-size: 24px; font-weight: bold; color: #dc2626;">${longitudActual}</div>
                            <div style="font-size: 12px; color: #666; margin-top: 5px;">Caracteres Actuales</div>
                        </div>
                        <div style="background: #fef3c7; padding: 15px; border-radius: 8px;">
                            <div style="font-size: 24px; font-weight: bold; color: #f59e0b;">${caracteresExceso}</div>
                            <div style="font-size: 12px; color: #666; margin-top: 5px;">Caracteres de Exceso</div>
                        </div>
                        <div style="background: #dcfce7; padding: 15px; border-radius: 8px;">
                            <div style="font-size: 24px; font-weight: bold; color: #16a34a;">${caracteresRecomendados}</div>
                            <div style="font-size: 12px; color: #666; margin-top: 5px;">Caracteres M√°ximos</div>
                        </div>
                    </div>
                    
                    <div style="background: #fff7ed; border: 2px solid #f59e0b; padding: 15px; border-radius: 8px; text-align: left; margin-top: 20px;">
                        <p style="margin: 0; color: #92400e; font-size: 14px;">
                            <strong>üìã Recomendaci√≥n:</strong> Reduzca el nombre a <strong>${caracteresRecomendados} caracteres o menos</strong> para que se visualice correctamente en la etiqueta.
                        </p>
                        <p style="margin: 10px 0 0 0; color: #92400e; font-size: 13px;">
                            üí° <em>Sugerencia: Use abreviaturas o elimine palabras innecesarias.</em>
                        </p>
                    </div>
                    
                    <div style="margin-top: 25px;">
                        <button onclick="cerrarAdvertenciaNombre()" 
                                style="background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: white; border: none; padding: 12px 30px; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer;">
                            Entendido
                        </button>
                    </div>
                </div>
            `;
            
            // Crear modal si no existe
            let modal = document.getElementById('advertencia-nombre-modal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'advertencia-nombre-modal';
                modal.className = 'modal-overlay';
                modal.style.cssText = 'display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); z-index: 10000; justify-content: center; align-items: center;';
                document.body.appendChild(modal);
            }
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 16px; padding: 0; max-width: 600px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3); position: relative;">
                    ${mensaje}
                </div>
            `;
            
            modal.style.display = 'flex';
        }
        
        function cerrarAdvertenciaNombre() {
            const modal = document.getElementById('advertencia-nombre-modal');
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        // Cerrar modal al hacer clic fuera
        document.addEventListener('click', function(e) {
            const modal = document.getElementById('advertencia-nombre-modal');
            if (modal && e.target === modal) {
                cerrarAdvertenciaNombre();
            }
        });

        // Mostrar productos normales
        async function mostrarProductosNormales() {
            vistaActual = 'normales';
            
            // Cambiar estilos de botones
            document.getElementById('btn-productos-normales').classList.add('active');
            document.getElementById('btn-productos-especiales').classList.remove('active');
            
            // Cambiar t√≠tulo
            document.getElementById('products-modal-title').textContent = 'üîç Consultar Productos Activos';
            
            // Cargar productos normales
            await loadAllProducts();
        }

        // Mostrar productos especiales
        async function mostrarProductosEspeciales() {
            vistaActual = 'especiales';
            
            // Cambiar estilos de botones
            document.getElementById('btn-productos-normales').classList.remove('active');
            document.getElementById('btn-productos-especiales').classList.add('active');
            
            // Cambiar t√≠tulo
            document.getElementById('products-modal-title').textContent = '‚≠ê Productos Especiales (JUEGOS/COMBOS)';
            
            // Cargar productos especiales
            await loadProductosEspecialesEnModal();
        }

        // Cargar productos especiales en el modal de consulta
        async function loadProductosEspecialesEnModal() {
            const tbody = document.getElementById('products-tbody');
            
            try {
                const response = await fetch('/api/productos-especiales', {
                    headers: getAuthHeaders()
                });

                if (response.ok) {
                    const especiales = await response.json();
                    displayProductosEspecialesEnModal(especiales);
                } else {
                    tbody.innerHTML = '<tr><td colspan="7" class="loading">Error cargando productos especiales</td></tr>';
                }

            } catch (error) {
                console.error('Error cargando productos especiales:', error);
                tbody.innerHTML = '<tr><td colspan="7" class="loading">Error de conexi√≥n</td></tr>';
            }
        }

        // Mostrar productos especiales en la tabla del modal de consulta
        function displayProductosEspecialesEnModal(especiales) {
            const tbody = document.getElementById('products-tbody');
            
            if (!Array.isArray(especiales) || especiales.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="loading">No hay productos especiales registrados</td></tr>';
                return;
            }

            tbody.innerHTML = especiales.map(esp => {
                // CALCULAR SI EL NOMBRE SUPERA EL L√çMITE DEL CANVAS
                const nombreProducto = esp.nombre_producto || '';
                const MAX_CHARS_LINEA = 13; // Caracteres m√°ximos por l√≠nea en el canvas (actualizado)
                const MAX_LINEAS = 2; // M√°ximo de l√≠neas disponibles
                const MAX_CHARS_TOTAL = MAX_CHARS_LINEA * MAX_LINEAS; // 26 caracteres totales

                const longitudNombre = nombreProducto.length;
                const excedeCaracteres = longitudNombre > MAX_CHARS_TOTAL;
                const caracteresExceso = excedeCaracteres ? longitudNombre - MAX_CHARS_TOTAL : 0;
                
                // Generar √≠cono de advertencia si excede
                const iconoAdvertencia = excedeCaracteres ? 
                    `<span class="warning-icon" onclick="mostrarAdvertenciaNombre('${nombreProducto.replace(/'/g, "\\'")}', ${longitudNombre}, ${MAX_CHARS_TOTAL}, ${caracteresExceso})" 
                           title="‚ö†Ô∏è Este nombre supera el l√≠mite del canvas. Click para m√°s detalles."
                           style="cursor: pointer; color: #f59e0b; font-size: 18px; margin-left: 8px; font-weight: bold;">
                        ‚ö†Ô∏è
                    </span>` : '';
                
                // Construir lista de componentes
                const componentes = [];
                if (esp.nombre_prod_1) componentes.push(`${esp.cantidad_producto_1}x ${esp.nombre_prod_1}`);
                if (esp.nombre_prod_2) componentes.push(`${esp.cantidad_producto_2}x ${esp.nombre_prod_2}`);
                if (esp.nombre_prod_3) componentes.push(`${esp.cantidad_producto_3}x ${esp.nombre_prod_3}`);
                if (esp.nombre_prod_4) componentes.push(`${esp.cantidad_producto_4}x ${esp.nombre_prod_4}`);
                
                return `
                    <tr data-search="${esp.codigo_producto} ${esp.nombre_producto}">
                        <td><strong>${esp.codigo_producto}</strong></td>
                        <td>
                            <strong>${esp.nombre_producto}${iconoAdvertencia}</strong>
                            <br><small style="color: #f59e0b;">‚≠ê ${componentes.join(' + ')}</small>
                        </td>
                        <td>Productos Especiales</td>
                        <td>JUEGOS</td>
                        <td>-</td>
                        <td>
                            <span class="status-badge ${esp.activo ? 'status-active' : 'status-inactive'}">
                                ${esp.activo ? 'Activo' : 'Inactivo'}
                            </span>
                        </td>
                        <td>
                            <button class="btn-edit" onclick="editarProductoEspecial(${esp.id_producto_especial})" title="Editar producto especial">
                                ‚úèÔ∏è Editar
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Editar producto especial desde modal de consulta
        async function editarProductoEspecial(id) {
            try {
                const response = await fetch(`/api/productos-especiales/${id}`, {
                    headers: getAuthHeaders()
                });

                if (response.ok) {
                    const especial = await response.json();
                    
                    // Cerrar modal de consulta
                    closeModal('products-list-modal');
                    
                    // Cargar productos disponibles primero
                    await cargarProductosDisponibles();
                    
                    // Abrir modal de edici√≥n
                    document.getElementById('crear-especial-modal').style.display = 'flex';
                    document.getElementById('crear-especial-title').textContent = '‚≠ê Editar Producto Especial';
                    
                    // Llenar informaci√≥n b√°sica
                    document.getElementById('especial-id').value = especial.id_producto_especial;
                    document.getElementById('especial-codigo').value = especial.codigo_producto;
                    document.getElementById('especial-nombre').value = especial.nombre_producto;
                    
                    // Limpiar contenedor de productos
                    contadorProductos = 0;
                    document.getElementById('productos-componentes-container').innerHTML = '';
                    
                    // Agregar productos din√°micamente seg√∫n los que tenga
                    const productosExistentes = [
                        { id: especial.id_producto_1, cantidad: especial.cantidad_producto_1 },
                        { id: especial.id_producto_2, cantidad: especial.cantidad_producto_2 },
                        { id: especial.id_producto_3, cantidad: especial.cantidad_producto_3 },
                        { id: especial.id_producto_4, cantidad: especial.cantidad_producto_4 }
                    ].filter(p => p.id); // Solo los que tienen ID
                    
                    // Agregar cada producto existente
                    for (const productoData of productosExistentes) {
                        agregarProductoAlJuego();
                        const index = contadorProductos;
                        
                        // Buscar el producto completo en el cache
                        const producto = productosDisponibles.find(p => p.id_producto === productoData.id);
                        
                        if (producto) {
                            // Llenar datos
                            setTimeout(() => {
                                document.getElementById(`especial-producto-${index}`).value = producto.id_producto;
                                document.getElementById(`especial-cantidad-${index}`).value = productoData.cantidad;
                                document.getElementById(`search-producto-${index}`).value = `${producto.codigo_producto} - ${producto.nombre_producto}`;
                                document.getElementById(`producto-seleccionado-${index}`).style.display = 'block';
                                document.getElementById(`nombre-producto-${index}`).textContent = `${producto.codigo_producto} - ${producto.nombre_producto}`;
                            }, 50);
                        }
                    }
                    
                } else {
                    showNotification('‚ùå Error al cargar producto especial', 'error');
                }
            } catch (error) {
                console.error('Error cargando producto especial:', error);
                showNotification('‚ùå Error de conexi√≥n', 'error');
            }
        }

        // Funci√≥n para editar un producto
        // Funci√≥n para toggle de botones de configuraci√≥n de etiquetas
        function toggleLabelFieldBtn(button, field) {
            // Obtener estado que TENDR√çA despu√©s del toggle
            const willBeActive = !button.classList.contains('active');
            
            // üî• REGLA CR√çTICA: QR NO PUEDE ESTAR SOLO (siempre necesita texto)
            if (field === 'qr') {
                // Si va a ACTIVAR QR, verificar que haya al menos un texto activo
                if (willBeActive) {
                    const hasTextFields = validateTextFields();
                    if (!hasTextFields) {
                        showNotification('‚ö†Ô∏è No puedes activar solo el QR. Debe ir acompa√±ado de texto', 'error');
                        return; // NO hacer el toggle
                    }
                }
                // Si va a DESACTIVAR QR, permitirlo siempre (modo TEXTO GRANDE)
                if (!willBeActive) {
                    console.log('‚úÖ QR desactivado ‚Üí Modo TEXTO GRANDE activado');
                }
            }
            
            // üî• REGLA 2: Si QR est√° activo, no se pueden desactivar TODOS los textos
            if (field !== 'qr' && !willBeActive) {
                const qrActive = document.getElementById('edit-product-mostrar-qr').value === 'true';
                if (qrActive) {
                    // QR est√° activo, verificar que quede al menos un texto
                    const remainingTextFields = validateTextFields(field, willBeActive);
                    if (!remainingTextFields) {
                        showNotification('‚ö†Ô∏è El QR debe ir acompa√±ado de texto. Desactiva el QR primero para modo TEXTO SOLO', 'warning');
                        return; // NO hacer el toggle
                    }
                }
            }
            
            // üî• REGLA 3: Si QR est√° inactivo, debe haber al menos un texto (modo TEXTO SOLO)
            if (field !== 'qr' && !willBeActive) {
                const qrActive = document.getElementById('edit-product-mostrar-qr').value === 'true';
                if (!qrActive) {
                    // Modo TEXTO SOLO, verificar que quede al menos un texto
                    const remainingTextFields = validateTextFields(field, willBeActive);
                    if (!remainingTextFields) {
                        showNotification('‚ö†Ô∏è Debe haber al menos un campo de texto activo', 'warning');
                        return; // NO hacer el toggle
                    }
                }
            }
            
            // ‚úÖ VALIDACI√ìN PAS√ì - Hacer el toggle
            button.classList.toggle('active');
            const isActive = button.classList.contains('active');
            
            // Actualizar √≠cono de check/X
            const checkIcon = button.querySelector('.field-check');
            if (checkIcon) {
                checkIcon.textContent = isActive ? '‚úì' : '‚úó';
            }
            
            // Actualizar campo hidden
            const hiddenInput = document.getElementById(`edit-product-mostrar-${field}`);
            if (hiddenInput) {
                hiddenInput.value = isActive ? 'true' : 'false';
            }
            
            console.log(`Campo "${field}" ${isActive ? '‚úì ACTIVADO' : '‚úó DESACTIVADO'}`);
        }

        // üÜï Funci√≥n para validar que haya al menos un campo de texto activo
        // fieldChanging: campo que est√° siendo modificado
        // futureState: estado que tendr√° ese campo despu√©s del cambio
        function validateTextFields(fieldChanging = null, futureState = null) {
            // Obtener estado actual de todos los campos (6 campos)
            let nombre = document.getElementById('edit-product-mostrar-nombre').value === 'true';
            let modelo = document.getElementById('edit-product-mostrar-modelo').value === 'true';
            let unidad = document.getElementById('edit-product-mostrar-unidad').value === 'true';
            let id = document.getElementById('edit-product-mostrar-id').value === 'true';
            let empresa = document.getElementById('edit-product-mostrar-empresa').value === 'true';
            
            // Si estamos validando un cambio futuro, aplicar ese estado
            if (fieldChanging) {
                if (fieldChanging === 'nombre') nombre = futureState;
                if (fieldChanging === 'modelo') modelo = futureState;
                if (fieldChanging === 'unidad') unidad = futureState;
                if (fieldChanging === 'id') id = futureState;
                if (fieldChanging === 'empresa') empresa = futureState;
            }
            
            return nombre || modelo || unidad || id || empresa;
        }

        async function editProduct(productId) {
            try {
                // Cargar datos din√°micamente desde PostgreSQL
                await loadSubcategoriasForEdit();
                await loadMarcasForEdit();
                await loadModelosForEdit();

                // Cargar datos del producto
                const response = await fetch(`/api/productos/${productId}`, {
                    method: 'GET',
                    headers: getAuthHeaders()
                });

                if (!response.ok) {
                    throw new Error(`Error ${response.status}: ${response.statusText}`);
                }

                const producto = await response.json();
                
                console.log('üì¶ Producto recibido del servidor:', producto);
                console.log('üîç Campos mostrar_* (6 CAMPOS):', {
                    mostrar_qr: producto.mostrar_qr,
                    mostrar_nombre: producto.mostrar_nombre,
                    mostrar_id: producto.mostrar_id,
                    mostrar_unidad: producto.mostrar_unidad,
                    mostrar_modelo: producto.mostrar_modelo,
                    mostrar_empresa: producto.mostrar_empresa
                });
                
                // Rellenar el formulario con los datos actuales
                document.getElementById('edit-product-id').value = producto.id_producto;
                document.getElementById('edit-product-name').value = producto.nombre_producto || '';
                document.getElementById('edit-product-brand').value = producto.marca || '';
                document.getElementById('edit-product-model').value = producto.modelo || '';
                
                // Categor√≠a siempre es "Productos Terminados"
                document.getElementById('edit-product-categoria').value = 'Productos Terminados';
                
                // Establecer subcategor√≠a
                const subcategoriaSelect = document.getElementById('edit-product-subcategoria');
                subcategoriaSelect.value = producto.subcategoria || '';
                
                document.getElementById('edit-product-status').value = producto.activo ? 'true' : 'false';

                // ‚úÖ CARGAR CONFIGURACI√ìN DE ETIQUETA (6 CAMPOS)
                const configFields = ['qr', 'nombre', 'id', 'unidad', 'modelo', 'empresa'];
                configFields.forEach(field => {
                    const dbValue = producto[`mostrar_${field}`];
                    
                    // üîß Defaults: TODOS = true
                    let value;
                    if (dbValue === undefined || dbValue === null) {
                        // Campo no existe en BD o es NULL ‚Üí usar default
                        value = true;
                        console.warn(`‚ö†Ô∏è Campo "mostrar_${field}" no existe en BD, usando default: ${value}`);
                    } else {
                        // Valor existe en BD ‚Üí usar ese valor
                        value = dbValue === true;
                    }
                    
                    const button = document.querySelector(`.label-field-btn[data-field="${field}"]`);
                    const hiddenInput = document.getElementById(`edit-product-mostrar-${field}`);
                    const checkIcon = button?.querySelector('.field-check');
                    
                    console.log(`üé® Configurando "${field}": DB=${dbValue}, Final=${value}`);
                    
                    if (button) {
                        if (value) {
                            button.classList.add('active');
                            if (checkIcon) checkIcon.textContent = '‚úì';
                        } else {
                            button.classList.remove('active');
                            if (checkIcon) checkIcon.textContent = '‚úó';
                        }
                    }
                    
                    if (hiddenInput) {
                        hiddenInput.value = value ? 'true' : 'false';
                    }
                });

                console.log('‚úÖ Configuraci√≥n de etiqueta aplicada al formulario');

                // Mostrar el modal
                document.getElementById('edit-product-modal').style.display = 'flex';

            } catch (error) {
                console.error('Error cargando producto para editar:', error);
                alert('Error al cargar los datos del producto: ' + error.message);
            }
        }

        // Cargar subcategor√≠as para el modal de edici√≥n
        async function loadSubcategoriasForEdit() {
            try {
                const response = await fetch('/api/subcategorias-terminados', {
                    headers: getAuthHeaders()
                });

                if (!response.ok) {
                    throw new Error(`Error ${response.status}`);
                }

                const subcategorias = await response.json();
                const select = document.getElementById('edit-product-subcategoria');
                
                // Limpiar opciones existentes excepto la primera
                select.innerHTML = '<option value="">Seleccionar subcategor√≠a...</option>';
                
                // Agregar subcategor√≠as desde PostgreSQL
                subcategorias.forEach(subcategoria => {
                    const option = document.createElement('option');
                    option.value = subcategoria;
                    option.textContent = subcategoria;
                    select.appendChild(option);
                });

                console.log(`‚úÖ Cargadas ${subcategorias.length} subcategor√≠as: ${subcategorias.join(', ')}`);
                
            } catch (error) {
                console.error('Error cargando subcategor√≠as:', error);
                // Agregar subcategor√≠as por defecto como fallback
                const select = document.getElementById('edit-product-subcategoria');
                select.innerHTML = `
                    <option value="">Seleccionar subcategor√≠a...</option>
                    <option value="PROTECTORES">PROTECTORES</option>
                    <option value="FRAZADAS">FRAZADAS</option>
                    <option value="SABANAS">SABANAS</option>
                    <option value="DUBET">DUBET</option>
                    <option value="EDREDONES">EDREDONES</option>
                `;
            }
        }

        // Manejar env√≠o del formulario de edici√≥n
        document.getElementById('edit-product-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const productId = document.getElementById('edit-product-id').value;
            const formData = {
                nombre_producto: document.getElementById('edit-product-name').value.trim(),
                marca: document.getElementById('edit-product-brand').value.trim(),
                modelo: document.getElementById('edit-product-model').value.trim(),
                categoria: 'Productos Terminados', // Siempre es Productos Terminados
                subcategoria: document.getElementById('edit-product-subcategoria').value,
                activo: document.getElementById('edit-product-status').value === 'true',
                // ‚úÖ NUEVO: Configuraci√≥n de campos de etiqueta (6 campos)
                mostrar_qr: document.getElementById('edit-product-mostrar-qr').value === 'true',
                mostrar_nombre: document.getElementById('edit-product-mostrar-nombre').value === 'true',
                mostrar_id: document.getElementById('edit-product-mostrar-id').value === 'true',
                mostrar_unidad: document.getElementById('edit-product-mostrar-unidad').value === 'true',
                mostrar_modelo: document.getElementById('edit-product-mostrar-modelo').value === 'true',
                mostrar_empresa: document.getElementById('edit-product-mostrar-empresa').value === 'true'
            };

            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            console.log('ÔøΩ GUARDANDO PRODUCTO');
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            console.log('üì¶ Datos completos:', formData);
            console.log('üé® Configuraci√≥n etiquetas (6 CAMPOS):', {
                QR: formData.mostrar_qr,
                NOMBRE: formData.mostrar_nombre,
                ID: formData.mostrar_id,
                UNIDAD: formData.mostrar_unidad,
                MODELO: formData.mostrar_modelo,
                EMPRESA: formData.mostrar_empresa
            });

            // Validaciones b√°sicas
            if (!formData.nombre_producto) {
                showNotification('‚ùå El nombre del producto es requerido', 'error');
                return;
            }
            if (!formData.subcategoria) {
                showNotification('‚ùå La subcategor√≠a es requerida', 'error');
                return;
            }

            console.log('‚úÖ Validaciones pasadas, enviando al servidor...');

            try {
                const response = await fetch(`/api/productos/${productId}`, {
                    method: 'PUT',
                    headers: getAuthHeaders(),
                    body: JSON.stringify(formData)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `Error ${response.status}`);
                }

                const result = await response.json();
                
                // Mostrar mensaje de √©xito
                showNotification('‚úÖ Producto actualizado exitosamente', 'success');
                console.log('üì¶ Producto actualizado:', result);
                
                // Cerrar modal
                closeModal('edit-product-modal');
                
                // Recargar la lista de productos si existe
                if (typeof loadAllProducts === 'function') {
                    loadAllProducts();
                }

            } catch (error) {
                console.error('‚ùå Error actualizando producto:', error);
                showNotification('‚ùå Error al actualizar: ' + error.message, 'error');
            }
        });

        // Cerrar modal
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // Cerrar modal al hacer clic fuera
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('modal-overlay')) {
                e.target.style.display = 'none';
            }
        });

        // ==============================================
        // FUNCIONES PARA PRODUCTOS ESPECIALES
        // ==============================================

        // Mostrar modal de productos especiales
        async function showProductosEspecialesModal() {
            document.getElementById('productos-especiales-modal').style.display = 'flex';
            await loadProductosEspeciales();
            
            // Event listener para b√∫squeda
            document.getElementById('search-especiales').oninput = filterEspeciales;
        }

        // Cargar productos especiales
        async function loadProductosEspeciales() {
            const tbody = document.getElementById('especiales-tbody');
            
            try {
                const response = await fetch('/api/productos-especiales', {
                    headers: getAuthHeaders()
                });

                if (response.ok) {
                    const especiales = await response.json();
                    displayProductosEspeciales(especiales);
                } else {
                    tbody.innerHTML = '<tr><td colspan="6" class="loading">Error cargando productos especiales</td></tr>';
                }

            } catch (error) {
                console.error('Error cargando productos especiales:', error);
                tbody.innerHTML = '<tr><td colspan="6" class="loading">‚ö†Ô∏è Backend no disponible - Necesitas implementar los endpoints primero</td></tr>';
            }
        }

        // Mostrar productos especiales en la tabla
        function displayProductosEspeciales(especiales) {
            const tbody = document.getElementById('especiales-tbody');
            
            if (!Array.isArray(especiales) || especiales.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="loading">No hay productos especiales registrados</td></tr>';
                return;
            }

            tbody.innerHTML = especiales.map(esp => {
                // Construir lista de componentes
                const componentes = [];
                if (esp.nombre_prod_1) componentes.push(`${esp.cantidad_producto_1}x ${esp.nombre_prod_1}`);
                if (esp.nombre_prod_2) componentes.push(`${esp.cantidad_producto_2}x ${esp.nombre_prod_2}`);
                if (esp.nombre_prod_3) componentes.push(`${esp.cantidad_producto_3}x ${esp.nombre_prod_3}`);
                if (esp.nombre_prod_4) componentes.push(`${esp.cantidad_producto_4}x ${esp.nombre_prod_4}`);
                
                const totalItems = (esp.cantidad_producto_1 || 0) + 
                                  (esp.cantidad_producto_2 || 0) + 
                                  (esp.cantidad_producto_3 || 0) + 
                                  (esp.cantidad_producto_4 || 0);

                return `
                    <tr data-search="${esp.codigo_producto} ${esp.nombre_producto}">
                        <td><strong>${esp.codigo_producto}</strong></td>
                        <td>${esp.nombre_producto}</td>
                        <td style="font-size: 12px;">${componentes.join(' + ')}</td>
                        <td><span style="background: #fbbf24; padding: 4px 8px; border-radius: 4px; font-weight: bold;">${totalItems}</span></td>
                        <td>
                            <span class="status-badge ${esp.activo ? 'status-active' : 'status-inactive'}">
                                ${esp.activo ? 'Activo' : 'Inactivo'}
                            </span>
                        </td>
                        <td>
                            <button class="btn-edit" onclick="editarEspecial(${esp.id_producto_especial})" title="Editar">
                                ‚úèÔ∏è Editar
                            </button>
                            <button class="btn-primary" onclick="crearSolicitudEspecial(${esp.id_producto_especial})" 
                                    style="background: linear-gradient(135deg, #3b82f6, #1d4ed8); margin-left: 5px;" 
                                    title="Crear solicitud de producci√≥n">
                                üìù Solicitar
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Filtrar productos especiales
        function filterEspeciales() {
            const searchText = document.getElementById('search-especiales').value.toLowerCase();
            const rows = document.querySelectorAll('#especiales-tbody tr');
            
            rows.forEach(row => {
                const searchData = row.dataset.search ? row.dataset.search.toLowerCase() : '';
                row.style.display = searchData.includes(searchText) ? '' : 'none';
            });
        }

        // =============================================
        // SISTEMA DIN√ÅMICO DE PRODUCTOS ESPECIALES
        // =============================================

        let productosDisponibles = []; // Cache de productos
        let contadorProductos = 0; // Contador de productos en el juego

        // Mostrar modal para crear producto especial
        async function showCrearEspecialModal() {
            document.getElementById('crear-especial-modal').style.display = 'flex';
            document.getElementById('crear-especial-title').textContent = '‚≠ê Crear Producto Especial';
            document.getElementById('especial-id').value = '';
            document.getElementById('crear-especial-form').reset();
            
            // Cargar productos disponibles
            await cargarProductosDisponibles();
            
            // Inicializar con 1 producto
            contadorProductos = 0;
            document.getElementById('productos-componentes-container').innerHTML = '';
            agregarProductoAlJuego(); // Agregar el primer producto
        }

        // Cargar productos disponibles una sola vez
        async function cargarProductosDisponibles() {
            try {
                const response = await fetch('/api/productos?all=true&activos=true', {
                    headers: getAuthHeaders()
                });

                if (response.ok) {
                    const result = await response.json();
                    productosDisponibles = result.data || result || [];
                    console.log(`‚úÖ Cargados ${productosDisponibles.length} productos disponibles`);
                }
            } catch (error) {
                console.error('Error cargando productos:', error);
                showNotification('‚ö†Ô∏è Error cargando productos', 'warning');
            }
        }

        // Agregar un nuevo producto al juego
        function agregarProductoAlJuego() {
            if (contadorProductos >= 4) {
                showNotification('‚ö†Ô∏è M√°ximo 4 productos por JUEGO', 'warning');
                return;
            }

            contadorProductos++;
            const index = contadorProductos;
            const esObligatorio = index === 1;

            const container = document.getElementById('productos-componentes-container');
            const productoDiv = document.createElement('div');
            productoDiv.id = `producto-${index}`;
            productoDiv.className = 'producto-componente';
            productoDiv.style.cssText = 'background: white; padding: 15px; border-radius: 8px; margin-bottom: 12px; border: 2px solid #f59e0b; position: relative;';

            productoDiv.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <strong style="color: #92400e;">Producto ${index}${esObligatorio ? ' *' : ''}</strong>
                    ${!esObligatorio ? `<button type="button" onclick="eliminarProductoDelJuego(${index})" 
                            style="background: #ef4444; color: white; border: none; border-radius: 6px; padding: 6px 12px; cursor: pointer; font-size: 12px; font-weight: bold;">
                        ‚ùå Quitar
                    </button>` : ''}
                </div>
                
                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 12px;">
                    <div>
                        <label style="display: block; margin-bottom: 6px; font-size: 13px; color: #6b7280;">
                            üîç Buscar producto ${esObligatorio ? '*' : ''}
                        </label>
                        <input type="text" 
                               id="search-producto-${index}" 
                               placeholder="Buscar por c√≥digo o nombre..."
                               ${esObligatorio ? 'required' : ''}
                               oninput="buscarProducto(${index})"
                               style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 6px; font-size: 14px;">
                        <input type="hidden" id="especial-producto-${index}">
                        <div id="resultados-${index}" style="max-height: 150px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 6px; margin-top: 5px; display: none;"></div>
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 6px; font-size: 13px; color: #6b7280;">
                            üì¶ Cantidad ${esObligatorio ? '*' : ''}
                        </label>
                        <input type="number" 
                               id="especial-cantidad-${index}" 
                               min="1" 
                               value="1" 
                               ${esObligatorio ? 'required' : ''}
                               style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 6px; font-size: 14px;">
                    </div>
                </div>
                
                <div id="producto-seleccionado-${index}" style="margin-top: 10px; padding: 10px; background: #f0fdf4; border-radius: 6px; display: none;">
                    <span style="font-size: 12px; color: #065f46;">‚úì Producto seleccionado:</span>
                    <strong id="nombre-producto-${index}" style="display: block; color: #047857; font-size: 14px; margin-bottom: 8px;"></strong>
                    
                    <div style="display: flex; align-items: center; gap: 10px; margin-top: 8px; padding-top: 8px; border-top: 1px solid #d1fae5;">
                        <span style="font-size: 12px; color: #065f46;">‚öôÔ∏è Configuraci√≥n de etiqueta:</span>
                        <button type="button" 
                                onclick="abrirConfiguracionEtiqueta(${index})"
                                style="padding: 6px 12px; background: #10b981; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; display: flex; align-items: center; gap: 4px; transition: background 0.2s;"
                                onmouseover="this.style.background='#059669'"
                                onmouseout="this.style.background='#10b981'">
                            <span>‚úèÔ∏è</span>
                            <span>Personalizar</span>
                        </button>
                        <span id="config-status-${index}" style="font-size: 11px; color: #6b7280; font-style: italic;">Usando configuraci√≥n nativa</span>
                    </div>
                </div>
            `;

            container.appendChild(productoDiv);

            // Actualizar bot√≥n de agregar
            actualizarBotonAgregar();
        }

        // Buscar producto por texto
        function buscarProducto(index) {
            const searchInput = document.getElementById(`search-producto-${index}`);
            const resultadosDiv = document.getElementById(`resultados-${index}`);
            const searchText = searchInput.value.toLowerCase().trim();

            if (searchText.length < 2) {
                resultadosDiv.style.display = 'none';
                return;
            }

            // Filtrar productos
            const resultados = productosDisponibles.filter(p => 
                p.codigo_producto.toLowerCase().includes(searchText) ||
                p.nombre_producto.toLowerCase().includes(searchText)
            ).slice(0, 10); // M√°ximo 10 resultados

            if (resultados.length === 0) {
                resultadosDiv.innerHTML = '<div style="padding: 10px; text-align: center; color: #9ca3af;">No se encontraron productos</div>';
                resultadosDiv.style.display = 'block';
                return;
            }

            resultadosDiv.innerHTML = resultados.map(p => `
                <div onclick="seleccionarProducto(${index}, ${p.id_producto}, '${p.codigo_producto}', '${p.nombre_producto.replace(/'/g, "\\'")}')"
                     style="padding: 10px; cursor: pointer; border-bottom: 1px solid #e5e7eb; transition: background 0.2s;"
                     onmouseover="this.style.background='#f9fafb'" onmouseout="this.style.background='white'">
                    <strong style="color: #1f2937;">${p.codigo_producto}</strong>
                    <div style="font-size: 12px; color: #6b7280;">${p.nombre_producto}</div>
                </div>
            `).join('');

            resultadosDiv.style.display = 'block';
        }

        // Seleccionar un producto
        function seleccionarProducto(index, id, codigo, nombre) {
            document.getElementById(`especial-producto-${index}`).value = id;
            document.getElementById(`search-producto-${index}`).value = `${codigo} - ${nombre}`;
            document.getElementById(`resultados-${index}`).style.display = 'none';
            
            // Mostrar confirmaci√≥n
            document.getElementById(`producto-seleccionado-${index}`).style.display = 'block';
            document.getElementById(`nombre-producto-${index}`).textContent = `${codigo} - ${nombre}`;
        }

        // Eliminar producto del juego
        function eliminarProductoDelJuego(index) {
            const productoDiv = document.getElementById(`producto-${index}`);
            if (productoDiv) {
                productoDiv.remove();
                contadorProductos--;
                actualizarBotonAgregar();
            }
        }

        // Actualizar estado del bot√≥n de agregar
        function actualizarBotonAgregar() {
            const btn = document.getElementById('btn-agregar-producto');
            if (contadorProductos >= 4) {
                btn.disabled = true;
                btn.style.opacity = '0.5';
                btn.style.cursor = 'not-allowed';
                btn.textContent = '‚úì M√°ximo alcanzado (4 productos)';
            } else {
                btn.disabled = false;
                btn.style.opacity = '1';
                btn.style.cursor = 'pointer';
                btn.textContent = `‚ûï A√±adir al juego (${contadorProductos}/4)`;
            }
        }

        // ===== CONFIGURACI√ìN DE ETIQUETAS =====
        
        // Abrir modal de configuraci√≥n de etiqueta
        async function abrirConfiguracionEtiqueta(index) {
            const productoInput = document.getElementById(`especial-producto-${index}`);
            const nombreProducto = document.getElementById(`nombre-producto-${index}`);
            
            if (!productoInput || !productoInput.value) {
                showError('No hay producto seleccionado');
                return;
            }
            
            const productoId = parseInt(productoInput.value);
            const producto = productosDisponibles.find(p => p.id_producto === productoId);
            
            if (!producto) {
                showError('Producto no encontrado');
                return;
            }
            
            // Llenar informaci√≥n del modal
            document.getElementById('config-producto-index').value = index;
            document.getElementById('config-producto-id').value = productoId;
            document.getElementById('config-producto-nombre').textContent = producto.nombre_producto;
            
            // Cargar configuraci√≥n actual del producto
            document.getElementById('config-mostrar-qr').checked = producto.mostrar_qr !== false;
            document.getElementById('config-mostrar-nombre').checked = producto.mostrar_nombre !== false;
            document.getElementById('config-mostrar-id').checked = producto.mostrar_id !== false;
            document.getElementById('config-mostrar-unidad').checked = producto.mostrar_unidad !== false;
            document.getElementById('config-mostrar-modelo').checked = producto.mostrar_modelo !== false;
            document.getElementById('config-mostrar-empresa').checked = producto.mostrar_empresa !== false;
            
            // Mostrar modal
            document.getElementById('modal-config-etiqueta').style.display = 'flex';
        }
        
        // Cerrar modal de configuraci√≥n
        function cerrarModalConfigEtiqueta() {
            document.getElementById('modal-config-etiqueta').style.display = 'none';
        }
        
        // Guardar configuraci√≥n de etiqueta
        document.getElementById('form-config-etiqueta').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const productoId = document.getElementById('config-producto-id').value;
            const index = document.getElementById('config-producto-index').value;
            
            const configuracion = {
                mostrar_qr: document.getElementById('config-mostrar-qr').checked,
                mostrar_nombre: document.getElementById('config-mostrar-nombre').checked,
                mostrar_id: document.getElementById('config-mostrar-id').checked,
                mostrar_unidad: document.getElementById('config-mostrar-unidad').checked,
                mostrar_modelo: document.getElementById('config-mostrar-modelo').checked,
                mostrar_empresa: document.getElementById('config-mostrar-empresa').checked
            };
            
            try {
                const response = await fetch(`/api/productos/${productoId}/configuracion-etiqueta`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        ...getAuthHeaders()
                    },
                    body: JSON.stringify(configuracion)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showSuccess('‚úÖ Configuraci√≥n de etiqueta actualizada correctamente');
                    
                    // Actualizar el producto en la lista local
                    const producto = productosDisponibles.find(p => p.id_producto == productoId);
                    if (producto) {
                        Object.assign(producto, configuracion);
                    }
                    
                    // Actualizar indicador de estado
                    const statusSpan = document.getElementById(`config-status-${index}`);
                    if (statusSpan) {
                        statusSpan.textContent = 'Configuraci√≥n personalizada guardada';
                        statusSpan.style.color = '#10b981';
                        statusSpan.style.fontWeight = '600';
                    }
                    
                    // Cerrar modal
                    cerrarModalConfigEtiqueta();
                } else {
                    showError(result.error || 'Error al actualizar configuraci√≥n');
                }
            } catch (error) {
                console.error('Error:', error);
                showError('Error de conexi√≥n al guardar configuraci√≥n');
            }
        });

        // Manejar env√≠o del formulario de productos especiales
        document.getElementById('crear-especial-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const especialId = document.getElementById('especial-id').value;
            
            // Recopilar datos de productos din√°micamente
            const codigoValue = document.getElementById('especial-codigo').value.trim();
            const formData = {
                nombre_producto_especial: document.getElementById('especial-nombre').value.trim()
            };
            
            // Solo incluir codigo_producto si tiene valor (campo oculto, opcional)
            if (codigoValue) {
                formData.codigo_producto = codigoValue;
            }

            // Agregar productos din√°micamente
            for (let i = 1; i <= 4; i++) {
                const productoInput = document.getElementById(`especial-producto-${i}`);
                const cantidadInput = document.getElementById(`especial-cantidad-${i}`);
                
                if (productoInput && productoInput.value) {
                    formData[`id_producto_${i}`] = parseInt(productoInput.value);
                    formData[`cantidad_producto_${i}`] = parseInt(cantidadInput.value);
                } else {
                    formData[`id_producto_${i}`] = null;
                    formData[`cantidad_producto_${i}`] = null;
                }
            }

            console.log('üì¶ [crear-especial] Datos a enviar:', formData);

            // Validaciones (solo nombre es requerido ahora, c√≥digo se genera autom√°ticamente)
            if (!formData.nombre_producto_especial) {
                showNotification('‚ùå El nombre del producto especial es requerido', 'error');
                return;
            }

            if (!formData.id_producto_1) {
                showNotification('‚ùå Debes seleccionar al menos el Producto 1', 'error');
                return;
            }

            try {
                const url = especialId ? `/api/productos-especiales/${especialId}` : '/api/productos-especiales';
                const method = especialId ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: getAuthHeaders(),
                    body: JSON.stringify(formData)
                });

                if (response.ok) {
                    showNotification(`‚úÖ Producto especial ${especialId ? 'actualizado' : 'creado'} exitosamente`, 'success');
                    closeModal('crear-especial-modal');
                    await loadProductosEspeciales();
                } else {
                    const error = await response.json();
                    const errorMsg = error.error || error.message || error.details || 'Error desconocido';
                    console.error('‚ùå Error del servidor:', error);
                    showNotification(`‚ùå Error: ${errorMsg}`, 'error');
                }

            } catch (error) {
                console.error('Error guardando producto especial:', error);
                showNotification('‚ö†Ô∏è Error de conexi√≥n: ' + error.message, 'warning');
            }
        });

        // ==============================================
        // GESTI√ìN ADMINISTRATIVA - PRODUCTOS ESPECIALES
        // ==============================================

        // Abrir modal de gesti√≥n de productos especiales
        async function showGestionProductosEspecialesModal() {
            document.getElementById('modal-gestion-productos-especiales').style.display = 'flex';
            await cargarProductosEspecialesAdmin();
        }

        // Cargar productos especiales en tabla administrativa
        async function cargarProductosEspecialesAdmin() {
            try {
                const response = await fetch('/api/productos-especiales', {
                    headers: getAuthHeaders()
                });

                if (!response.ok) throw new Error('Error al cargar productos especiales');

                const productos = await response.json();
                const tbody = document.getElementById('tabla-especiales-admin');

                if (productos.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" style="padding: 40px; text-align: center; color: #9ca3af;">
                                <div style="font-size: 48px; margin-bottom: 10px;">üì¶</div>
                                <p style="font-size: 16px; margin: 0;">No hay productos especiales registrados</p>
                                <button onclick="abrirModalCrearProductoEspecial()" style="margin-top: 15px; padding: 10px 20px; background: linear-gradient(135deg, #8b5cf6 0%, #6d28d9 100%); color: white; border: none; border-radius: 8px; cursor: pointer;">
                                    ‚ûï Crear Primer Producto Especial
                                </button>
                            </td>
                        </tr>
                    `;
                    return;
                }

                tbody.innerHTML = productos.map(prod => {
                    const componentes = [];
                    if (prod.nombre_producto_1) componentes.push(prod.nombre_producto_1);
                    if (prod.nombre_producto_2) componentes.push(prod.nombre_producto_2);
                    if (prod.nombre_producto_3) componentes.push(prod.nombre_producto_3);
                    if (prod.nombre_producto_4) componentes.push(prod.nombre_producto_4);

                    const componentesHTML = componentes.map(c => 
                        `<span style="display: inline-block; background: #f3f4f6; padding: 4px 8px; border-radius: 6px; font-size: 12px; margin: 2px;">${c}</span>`
                    ).join('');

                    const estadoBadge = prod.activo 
                        ? '<span style="background: #d1fae5; color: #065f46; padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600;">‚úÖ Activo</span>'
                        : '<span style="background: #fee2e2; color: #991b1b; padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600;">‚ùå Inactivo</span>';

                    return `
                        <tr style="border-bottom: 1px solid #e5e7eb;" data-nombre="${prod.nombre_producto_especial}" data-codigo="${prod.codigo_producto_especial}">
                            <td style="padding: 15px; color: #6b7280; font-size: 13px;">${prod.id_producto_especial}</td>
                            <td style="padding: 15px; font-family: 'Courier New', monospace; color: #374151; font-weight: 600; font-size: 13px;">${prod.codigo_producto_especial}</td>
                            <td style="padding: 15px; color: #1f2937; font-weight: 500; font-size: 14px;">${prod.nombre_producto_especial}</td>
                            <td style="padding: 15px; font-size: 13px;">${componentesHTML}</td>
                            <td style="padding: 15px; text-align: center;">${estadoBadge}</td>
                            <td style="padding: 15px; text-align: center;">
                                <div style="display: flex; gap: 8px; justify-content: center;">
                                    <button onclick="verDetalleProductoEspecial(${prod.id_producto_especial})" 
                                            style="padding: 8px 12px; background: #dbeafe; color: #1e40af; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;"
                                            title="Ver detalle">
                                        üëÅÔ∏è Ver
                                    </button>
                                    <button onclick="editarProductoEspecialAdmin(${prod.id_producto_especial})" 
                                            style="padding: 8px 12px; background: #fef3c7; color: #92400e; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;"
                                            title="Editar">
                                        ‚úèÔ∏è Editar
                                    </button>
                                    <button onclick="toggleEstadoProductoEspecial(${prod.id_producto_especial}, ${!prod.activo})" 
                                            style="padding: 8px 12px; background: ${prod.activo ? '#fee2e2' : '#d1fae5'}; color: ${prod.activo ? '#991b1b' : '#065f46'}; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;"
                                            title="${prod.activo ? 'Desactivar' : 'Activar'}">
                                        ${prod.activo ? 'üîí Desactivar' : 'üîì Activar'}
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');

            } catch (error) {
                console.error('Error cargando productos especiales:', error);
                document.getElementById('tabla-especiales-admin').innerHTML = `
                    <tr>
                        <td colspan="6" style="padding: 40px; text-align: center; color: #ef4444;">
                            <div style="font-size: 48px; margin-bottom: 10px;">‚ùå</div>
                            <p>Error al cargar productos especiales: ${error.message}</p>
                        </td>
                    </tr>
                `;
            }
        }

        // Filtrar productos especiales en tabla admin
        function filtrarProductosEspecialesAdmin() {
            const searchValue = document.getElementById('search-especiales-admin').value.toLowerCase();
            const rows = document.querySelectorAll('#tabla-especiales-admin tr');

            rows.forEach(row => {
                const nombre = row.dataset.nombre?.toLowerCase() || '';
                const codigo = row.dataset.codigo?.toLowerCase() || '';
                
                if (nombre.includes(searchValue) || codigo.includes(searchValue)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        // Ver detalle de producto especial
        async function verDetalleProductoEspecial(id) {
            try {
                const response = await fetch(`/api/productos-especiales/${id}`, {
                    headers: getAuthHeaders()
                });

                if (!response.ok) throw new Error('Error al cargar detalle');

                const prod = await response.json();
                
                const componentes = [];
                if (prod.nombre_producto_1) componentes.push(`1. ${prod.nombre_producto_1} (ID: ${prod.id_producto_1})`);
                if (prod.nombre_producto_2) componentes.push(`2. ${prod.nombre_producto_2} (ID: ${prod.id_producto_2})`);
                if (prod.nombre_producto_3) componentes.push(`3. ${prod.nombre_producto_3} (ID: ${prod.id_producto_3})`);
                if (prod.nombre_producto_4) componentes.push(`4. ${prod.nombre_producto_4} (ID: ${prod.id_producto_4})`);

                const componentesTexto = componentes.join('\n');

                alert(`
üéÅ PRODUCTO ESPECIAL - DETALLE

üìã ID: ${prod.id_producto_especial}
üîñ C√≥digo: ${prod.codigo_producto_especial}
üìù Nombre: ${prod.nombre_producto_especial}
üè∑Ô∏è Estado: ${prod.activo ? '‚úÖ Activo' : '‚ùå Inactivo'}
üìÖ Creado: ${new Date(prod.created_at).toLocaleString()}

üß© COMPONENTES:
${componentesTexto}
                `.trim());

            } catch (error) {
                console.error('Error:', error);
                showNotification('‚ùå Error al cargar detalle', 'error');
            }
        }

        // Editar producto especial (admin)
        async function editarProductoEspecialAdmin(id) {
            // TODO: Implementar edici√≥n completa
            showNotification('‚öôÔ∏è Funci√≥n de edici√≥n en desarrollo', 'info');
        }

        // Toggle estado de producto especial (activar/desactivar)
        async function toggleEstadoProductoEspecial(id, nuevoEstado) {
            if (!confirm(`¬øEst√° seguro de ${nuevoEstado ? 'ACTIVAR' : 'DESACTIVAR'} este producto especial?`)) {
                return;
            }

            try {
                const response = await fetch(`/api/productos-especiales/${id}`, {
                    method: 'PUT',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({ activo: nuevoEstado })
                });

                if (!response.ok) throw new Error('Error al cambiar estado');

                showNotification(`‚úÖ Producto ${nuevoEstado ? 'activado' : 'desactivado'} exitosamente`, 'success');
                await cargarProductosEspecialesAdmin();

            } catch (error) {
                console.error('Error:', error);
                showNotification('‚ùå Error al cambiar estado', 'error');
            }
        }

        // Abrir modal crear producto especial desde admin
        function abrirModalCrearProductoEspecial() {
            closeModal('modal-gestion-productos-especiales');
            showAddProductModal();
        }

        // ==============================================
        // GESTI√ìN ADMINISTRATIVA - SOLICITUDES ESPECIALES
        // ==============================================

        // Abrir modal de gesti√≥n de solicitudes especiales
        async function showGestionSolicitudesEspecialesModal() {
            document.getElementById('modal-gestion-solicitudes-especiales').style.display = 'flex';
            await cargarSolicitudesEspecialesAdmin();
        }

        // Cargar solicitudes especiales en tabla administrativa
        async function cargarSolicitudesEspecialesAdmin() {
            try {
                const response = await fetch('/api/solicitudes-etiquetas-especiales', {
                    headers: getAuthHeaders()
                });

                if (!response.ok) throw new Error('Error al cargar solicitudes');

                const solicitudes = await response.json();
                const tbody = document.getElementById('tabla-solicitudes-especiales-admin');

                // Actualizar estad√≠sticas
                const stats = calcularEstadisticasSolicitudes(solicitudes);
                document.getElementById('stat-total-solicitudes-esp').textContent = stats.total;
                document.getElementById('stat-pendientes-esp').textContent = stats.pendientes;
                document.getElementById('stat-completadas-esp').textContent = stats.completadas;
                document.getElementById('stat-etiquetas-impresas-esp').textContent = stats.etiquetasImpresas;

                if (solicitudes.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="8" style="padding: 40px; text-align: center; color: #9ca3af;">
                                <div style="font-size: 48px; margin-bottom: 10px;">üìã</div>
                                <p style="font-size: 16px; margin: 0;">No hay solicitudes especiales registradas</p>
                            </td>
                        </tr>
                    `;
                    return;
                }

                tbody.innerHTML = solicitudes.map(sol => {
                    const estadoBadge = getEstadoBadge(sol.estado_solicitud);
                    const progreso = calcularProgresoSolicitud(sol);

                    return `
                        <tr style="border-bottom: 1px solid #e5e7eb;" 
                            data-producto="${sol.nombre_producto_especial?.toLowerCase() || ''}" 
                            data-costurera="${sol.nombre_costurera?.toLowerCase() || ''}"
                            data-estado="${sol.estado_solicitud}">
                            <td style="padding: 15px; color: #6b7280; font-size: 13px; font-weight: 600;">#${sol.id_solicitud}</td>
                            <td style="padding: 15px; color: #1f2937; font-weight: 500; font-size: 14px;">${sol.nombre_producto_especial || 'N/A'}</td>
                            <td style="padding: 15px; color: #374151; font-size: 13px;">${sol.nombre_costurera || 'N/A'}</td>
                            <td style="padding: 15px; text-align: center; font-weight: 600; color: #6d28d9; font-size: 14px;">${sol.cantidad_solicitada}</td>
                            <td style="padding: 15px; text-align: center;">
                                <div style="background: #f3f4f6; padding: 8px 12px; border-radius: 8px; font-size: 12px;">
                                    ${progreso}
                                </div>
                            </td>
                            <td style="padding: 15px; text-align: center;">${estadoBadge}</td>
                            <td style="padding: 15px; color: #6b7280; font-size: 13px;">${new Date(sol.fecha_solicitud).toLocaleString()}</td>
                            <td style="padding: 15px; text-align: center;">
                                <div style="display: flex; gap: 6px; justify-content: center; flex-wrap: wrap;">
                                    <button onclick="verDetalleSolicitudEspecial(${sol.id_solicitud})" 
                                            style="padding: 6px 10px; background: #dbeafe; color: #1e40af; border: none; border-radius: 6px; cursor: pointer; font-size: 11px; font-weight: 600;">
                                        üëÅÔ∏è Ver
                                    </button>
                                    ${sol.estado_solicitud === 'pendiente' ? `
                                        <button onclick="cambiarEstadoSolicitudEspecial(${sol.id_solicitud}, 'proceso')" 
                                                style="padding: 6px 10px; background: #d1fae5; color: #065f46; border: none; border-radius: 6px; cursor: pointer; font-size: 11px; font-weight: 600;">
                                            ‚úÖ Aprobar
                                        </button>
                                    ` : ''}
                                    ${sol.estado_solicitud !== 'cancelada' && sol.estado_solicitud !== 'completada' ? `
                                        <button onclick="cambiarEstadoSolicitudEspecial(${sol.id_solicitud}, 'cancelada')" 
                                                style="padding: 6px 10px; background: #fee2e2; color: #991b1b; border: none; border-radius: 6px; cursor: pointer; font-size: 11px; font-weight: 600;">
                                            ‚ùå Cancelar
                                        </button>
                                    ` : ''}
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');

            } catch (error) {
                console.error('Error cargando solicitudes especiales:', error);
                document.getElementById('tabla-solicitudes-especiales-admin').innerHTML = `
                    <tr>
                        <td colspan="8" style="padding: 40px; text-align: center; color: #ef4444;">
                            <div style="font-size: 48px; margin-bottom: 10px;">‚ùå</div>
                            <p>Error al cargar solicitudes: ${error.message}</p>
                        </td>
                    </tr>
                `;
            }
        }

        // Calcular estad√≠sticas de solicitudes
        function calcularEstadisticasSolicitudes(solicitudes) {
            return {
                total: solicitudes.length,
                pendientes: solicitudes.filter(s => s.estado_solicitud === 'pendiente').length,
                completadas: solicitudes.filter(s => s.estado_solicitud === 'completada').length,
                etiquetasImpresas: solicitudes.reduce((sum, s) => sum + (parseInt(s.cantidad_solicitada) || 0), 0)
            };
        }

        // Obtener badge de estado
        function getEstadoBadge(estado) {
            const badges = {
                'pendiente': '<span style="background: #fef3c7; color: #92400e; padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600;">‚è≥ Pendiente</span>',
                'proceso': '<span style="background: #dbeafe; color: #1e40af; padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600;">üîÑ En Proceso</span>',
                'completada': '<span style="background: #d1fae5; color: #065f46; padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600;">‚úÖ Completada</span>',
                'cancelada': '<span style="background: #fee2e2; color: #991b1b; padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600;">‚ùå Cancelada</span>'
            };
            return badges[estado] || estado;
        }

        // Calcular progreso de solicitud
        function calcularProgresoSolicitud(solicitud) {
            // TODO: Obtener progreso real desde el servidor
            return '0/0 impresas';
        }

        // Filtrar solicitudes especiales en tabla admin
        function filtrarSolicitudesEspecialesAdmin() {
            const searchValue = document.getElementById('search-solicitudes-especiales-admin').value.toLowerCase();
            const estadoFilter = document.getElementById('filter-estado-solicitudes').value;
            const rows = document.querySelectorAll('#tabla-solicitudes-especiales-admin tr');

            rows.forEach(row => {
                const producto = row.dataset.producto || '';
                const costurera = row.dataset.costurera || '';
                const estado = row.dataset.estado || '';
                
                const matchSearch = producto.includes(searchValue) || costurera.includes(searchValue);
                const matchEstado = !estadoFilter || estado === estadoFilter;
                
                if (matchSearch && matchEstado) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        // Ver detalle de solicitud especial
        async function verDetalleSolicitudEspecial(id) {
            try {
                const response = await fetch(`/api/solicitudes-etiquetas/${id}`, {
                    headers: getAuthHeaders()
                });

                if (!response.ok) throw new Error('Error al cargar detalle');

                const sol = await response.json();
                
                alert(`
üìã SOLICITUD ESPECIAL - DETALLE

üÜî ID Solicitud: ${sol.id_solicitud}
üéÅ Producto Especial: ${sol.nombre_producto_especial || 'N/A'}
üë§ Costurera: ${sol.nombre_costurera || 'N/A'}
üìä Cantidad Solicitada: ${sol.cantidad_solicitada}
üè∑Ô∏è Estado: ${sol.estado_solicitud}
üìÖ Fecha: ${new Date(sol.fecha_solicitud).toLocaleString()}
${sol.observaciones_supervisor ? `\nüí¨ Observaciones: ${sol.observaciones_supervisor}` : ''}
                `.trim());

            } catch (error) {
                console.error('Error:', error);
                showNotification('‚ùå Error al cargar detalle', 'error');
            }
        }

        // Cambiar estado de solicitud especial
        async function cambiarEstadoSolicitudEspecial(id, nuevoEstado) {
            const mensajes = {
                'proceso': '¬øAprobar esta solicitud especial?',
                'completada': '¬øMarcar como completada?',
                'cancelada': '¬øCancelar esta solicitud especial?'
            };

            if (!confirm(mensajes[nuevoEstado] || '¬øConfirmar cambio de estado?')) {
                return;
            }

            try {
                const response = await fetch(`/api/supervisor/cambiar-estado/${id}`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({
                        nuevo_estado: nuevoEstado,
                        observaciones_supervisor: `Estado cambiado a ${nuevoEstado} desde panel administrativo`
                    })
                });

                if (!response.ok) throw new Error('Error al cambiar estado');

                showNotification(`‚úÖ Estado cambiado a: ${nuevoEstado}`, 'success');
                await cargarSolicitudesEspecialesAdmin();

            } catch (error) {
                console.error('Error:', error);
                showNotification('‚ùå Error al cambiar estado', 'error');
            }
        }

        // Exportar solicitudes especiales
        function exportarSolicitudesEspeciales() {
            showNotification('üì• Funci√≥n de exportaci√≥n en desarrollo', 'info');
            // TODO: Implementar exportaci√≥n a Excel/CSV
        }

        // Funci√≥n para editar producto especial (placeholder)
        async function editarEspecial(id) {
            showNotification('‚öôÔ∏è Funci√≥n editar en desarrollo...', 'info');
            // TODO: Implementar edici√≥n
        }

        // Funci√≥n para crear solicitud especial (placeholder)
        async function crearSolicitudEspecial(id) {
            showNotification('‚öôÔ∏è Funci√≥n crear solicitud en desarrollo...', 'info');
            // TODO: Implementar creaci√≥n de solicitud
        }

        // Funci√≥n para ver solicitudes especiales (placeholder)
        async function showSolicitudesEspecialesModal() {
            showNotification('‚öôÔ∏è Funci√≥n ver solicitudes en desarrollo...', 'info');
            // TODO: Implementar vista de solicitudes
        }

        // ==============================================
        // FUNCIONES PARA COLA DE IMPRESI√ìN
        // ==============================================

        // Verificar estado de la impresora
        async function checkPrinterStatus() {
            try {
                const response = await fetch('/api/admin/printer-status', {
                    headers: getAuthHeaders()
                });

                if (response.ok) {
                    const status = await response.json();
                    updatePrinterStatus(status.connected);
                    
                    document.getElementById('last-check').textContent = 
                        new Date(status.last_check).toLocaleTimeString();
                    
                    // Mostrar/ocultar bot√≥n de reanudar
                    const resumeBtn = document.getElementById('resume-btn');
                    if (!status.connected && status.queue_length > 0) {
                        resumeBtn.style.display = 'inline-block';
                    } else {
                        resumeBtn.style.display = 'none';
                    }
                    
                } else {
                    updatePrinterStatus(false);
                }
                
            } catch (error) {
                console.error('Error verificando impresora:', error);
                updatePrinterStatus(false);
            }
        }

        // Actualizar indicador visual del estado de la impresora
        function updatePrinterStatus(connected) {
            const indicator = document.getElementById('printer-indicator');
            const text = document.getElementById('printer-text');
            const status = document.getElementById('printer-status');

            if (connected) {
                indicator.textContent = 'üü¢';
                text.textContent = 'Conectada';
                status.className = 'printer-status status-connected';
            } else {
                indicator.textContent = 'üî¥';
                text.textContent = 'Desconectada';
                status.className = 'printer-status status-disconnected';
            }
        }

        // Cargar y mostrar cola de impresi√≥n
        async function refreshPrintQueue() {
            try {
                const response = await fetch('/api/admin/print-queue', {
                    headers: getAuthHeaders()
                });

                if (response.ok) {
                    const data = await response.json();
                    displayPrintQueue(data.queue);
                    
                    // Actualizar resumen
                    document.getElementById('queue-count').textContent = data.queue.length;
                    document.getElementById('processing-status').textContent = 
                        data.processing ? 'S√≠' : 'No';
                    
                    // Actualizar estado de la impresora
                    updatePrinterStatus(data.printer_connected);
                    
                    // Mostrar notificaci√≥n si hay trabajos pendientes y la impresora est√° desconectada
                    if (data.queue.length > 0 && !data.printer_connected) {
                        showQueueNotification('‚ö†Ô∏è Hay trabajos pendientes. Impresora desconectada.');
                    }
                    
                } else {
                    document.getElementById('queue-tbody').innerHTML = 
                        '<tr><td colspan="8" class="loading">Error cargando cola</td></tr>';
                }
                
            } catch (error) {
                console.error('Error cargando cola:', error);
                document.getElementById('queue-tbody').innerHTML = 
                    '<tr><td colspan="8" class="loading">Error de conexi√≥n</td></tr>';
            }
        }

        // Mostrar trabajos en la tabla
        function displayPrintQueue(queue) {
            const tbody = document.getElementById('queue-tbody');
            
            if (queue.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="loading">No hay trabajos en cola</td></tr>';
                return;
            }

            tbody.innerHTML = queue.map(job => `
                <tr>
                    <td><strong>${job.numero_solicitud}</strong></td>
                    <td>
                        <div>${job.nombre_producto}</div>
                        <small style="color: #6b7280;">${job.descripcion_adicional || ''}</small>
                    </td>
                    <td>${job.costurera_nombre}</td>
                    <td>
                        <span title="Original: ${job.cantidad_solicitada}">
                            ${job.cantidad_a_imprimir}
                        </span>
                        ${job.cantidad_solicitada !== job.cantidad_a_imprimir ? 
                            `<small style="color: #6b7280;">(+${job.cantidad_a_imprimir - job.cantidad_solicitada})</small>` : ''}
                    </td>
                    <td>
                        <div class="qr-code-display" title="${job.qr_code}">
                            ${job.qr_code}
                        </div>
                    </td>
                    <td>
                        <span class="queue-status status-${job.estado}">
                            ${job.estado}
                        </span>
                        ${job.error_mensaje ? 
                            `<div style="color: #ef4444; font-size: 11px; margin-top: 2px;">${job.error_mensaje}</div>` : ''}
                    </td>
                    <td style="font-size: 11px;">
                        ${new Date(job.fecha_creacion).toLocaleString()}
                        ${job.fecha_impresion ? 
                            `<br><small>Impresa: ${new Date(job.fecha_impresion).toLocaleString()}</small>` : ''}
                    </td>
                    <td>
                        <div class="queue-actions">
                            ${job.estado === 'error' ? 
                                `<button class="action-btn action-btn-retry" onclick="retryPrintJob(${job.id})">
                                    üîÑ Reintentar
                                </button>` : ''}
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        // Reanudar impresi√≥n
        async function resumePrinting() {
            try {
                const response = await fetch('/api/admin/resume-printing', {
                    method: 'POST',
                    headers: getAuthHeaders()
                });

                const result = await response.json();

                if (response.ok) {
                    showQueueNotification(`‚úÖ ${result.mensaje}. ${result.queue_length} trabajos en cola.`);
                    document.getElementById('resume-btn').style.display = 'none';
                    await refreshPrintQueue();
                } else {
                    showQueueNotification(`‚ùå ${result.error}`);
                }
                
            } catch (error) {
                console.error('Error reanudando impresi√≥n:', error);
                showQueueNotification('‚ùå Error de conexi√≥n al reanudar impresi√≥n');
            }
        }

        // Limpiar trabajos con error
        async function clearErrorJobs() {
            if (!confirm('¬øEliminar todos los trabajos con error de m√°s de 1 d√≠a?')) {
                return;
            }
            
            try {
                const response = await fetch('/api/admin/clear-error-jobs', {
                    method: 'POST',
                    headers: getAuthHeaders()
                });

                const result = await response.json();

                if (response.ok) {
                    showQueueNotification(`‚úÖ ${result.mensaje}`);
                    await refreshPrintQueue();
                } else {
                    showQueueNotification(`‚ùå Error: ${result.error}`);
                }
                
            } catch (error) {
                console.error('Error limpiando cola:', error);
                showQueueNotification('‚ùå Error de conexi√≥n');
            }
        }

        // Resetear impresora Zebra
        // Funci√≥n resetPrinter() eliminada por seguridad - solo disponible para administradores

        // Reintentar trabajo espec√≠fico
        async function retryPrintJob(jobId) {
            try {
                const response = await fetch(`/api/admin/retry-print-job/${jobId}`, {
                    method: 'POST',
                    headers: getAuthHeaders()
                });

                const result = await response.json();

                if (response.ok) {
                    showQueueNotification(`‚úÖ ${result.mensaje}`);
                    await refreshPrintQueue();
                } else {
                    showQueueNotification(`‚ùå Error: ${result.error}`);
                }
                
            } catch (error) {
                console.error('Error reintentando trabajo:', error);
                showQueueNotification('‚ùå Error de conexi√≥n');
            }
        }

        // Mostrar notificaci√≥n de la cola
        function showQueueNotification(message) {
            const notifications = document.getElementById('queue-notifications');
            const text = document.getElementById('notification-text');
            
            text.textContent = message;
            notifications.style.display = 'block';
            
            // Auto-ocultar despu√©s de 5 segundos
            setTimeout(() => {
                hideQueueNotification();
            }, 5000);
        }

        // Ocultar notificaci√≥n de la cola
        function hideQueueNotification() {
            document.getElementById('queue-notifications').style.display = 'none';
        }

        // Inicializar monitoreo de la cola de impresi√≥n
        function initializePrintQueue() {
            // Verificar estado inicial
            checkPrinterStatus();
            refreshPrintQueue();
            
            // Actualizar autom√°ticamente cada 30 segundos
            setInterval(() => {
                refreshPrintQueue();
            }, 30000);
            
            // Verificar impresora cada 2 minutos
            setInterval(() => {
                checkPrinterStatus();
            }, 120000);
        }

        // Logout
        function logout() {
            localStorage.removeItem('currentUser');
            window.location.href = '/';
        }

        // =============================================
        // SISTEMA DE AUTO-APROBACI√ìN
        // =============================================
        let autoApprovalTimers = new Map(); // Para almacenar los timers activos
        let autoApprovalSettings = {
            enabled: false,
            timeMinutes: 30
        };

        // //automatizador en pruebas - Toggle de la secci√≥n de auto-aprobaci√≥n
        /*
        function toggleAutoApprovalSection() {
            const configSection = document.getElementById('auto-approval-config');
            const currentDisplay = configSection.style.display;
            configSection.style.display = currentDisplay === 'none' ? 'block' : 'none';
        }
        */

        // //automatizador en pruebas - Activar/desactivar auto-aprobaci√≥n
        /*
        function toggleAutoApproval() {
            const checkbox = document.getElementById('autoApprovalEnabled');
            const options = document.getElementById('auto-approval-options');
            const status = document.getElementById('auto-approval-status');
            
            autoApprovalSettings.enabled = checkbox.checked;
            
            if (checkbox.checked) {
                options.style.display = 'block';
                status.style.display = 'block';
                updateAutoApprovalSettings();
                startAutoApprovalMonitoring();
                
                showQueueNotification('‚úÖ Auto-aprobaci√≥n activada');
                updateAutoApprovalStatus('Activo - Monitoreando solicitudes');
            } else {
                options.style.display = 'none';
                status.style.display = 'none';
                stopAutoApprovalMonitoring();
                
                showQueueNotification('‚èπÔ∏è Auto-aprobaci√≥n desactivada');
                updateAutoApprovalStatus('Inactivo');
            }
            
            // Guardar configuraci√≥n
            localStorage.setItem('autoApprovalSettings', JSON.stringify(autoApprovalSettings));
        }

        // Actualizar configuraci√≥n de tiempo
        function updateAutoApprovalSettings() {
            const timeSelect = document.getElementById('autoApprovalTime');
            autoApprovalSettings.timeMinutes = parseInt(timeSelect.value);
            
            // Guardar configuraci√≥n
            localStorage.setItem('autoApprovalSettings', JSON.stringify(autoApprovalSettings));
            
            // Reiniciar timers con nueva configuraci√≥n
            if (autoApprovalSettings.enabled) {
                resetAutoApprovalTimers();
                scheduleAutoApprovals();
            }
        }

        // Iniciar monitoreo de auto-aprobaci√≥n
        function startAutoApprovalMonitoring() {
            // Verificar solicitudes pendientes cada minuto
            autoApprovalSettings.monitorInterval = setInterval(() => {
                scheduleAutoApprovals();
                updatePendingAutoApprovalsCount();
            }, 60000); // Cada minuto
            
            // Programar aprobaciones inmediatamente
            scheduleAutoApprovals();
        }

        // Detener monitoreo
        function stopAutoApprovalMonitoring() {
            if (autoApprovalSettings.monitorInterval) {
                clearInterval(autoApprovalSettings.monitorInterval);
            }
            
            // Cancelar todos los timers pendientes
            autoApprovalTimers.forEach(timer => clearTimeout(timer));
            autoApprovalTimers.clear();
        }

        // Programar aprobaciones autom√°ticas
        async function scheduleAutoApprovals() {
            try {
                const response = await fetch('/api/solicitudes-pendientes');
                const solicitudes = await response.json();
                
                solicitudes.forEach(solicitud => {
                    const solicitudId = solicitud.id_solicitud;
                    
                    // Si ya tiene un timer programado, no crear otro
                    if (autoApprovalTimers.has(solicitudId)) {
                        return;
                    }
                    
                    const fechaSolicitud = new Date(solicitud.fecha_creacion);
                    const ahora = new Date();
                    const tiempoEspera = autoApprovalSettings.timeMinutes * 60 * 1000; // en milisegundos
                    const tiempoTranscurrido = ahora - fechaSolicitud;
                    const tiempoRestante = tiempoEspera - tiempoTranscurrido;
                    
                    if (tiempoRestante > 0) {
                        // Programar aprobaci√≥n
                        const timer = setTimeout(() => {
                            autoApproveSolicitud(solicitudId, solicitud.numero_solicitud);
                            autoApprovalTimers.delete(solicitudId);
                        }, tiempoRestante);
                        
                        autoApprovalTimers.set(solicitudId, timer);
                    } else {
                        // Ya pas√≥ el tiempo, aprobar inmediatamente
                        autoApproveSolicitud(solicitudId, solicitud.numero_solicitud);
                    }
                });
                
            } catch (error) {
                console.error('Error programando auto-aprobaciones:', error);
            }
        }

        // Aprobar solicitud autom√°ticamente
        async function autoApproveSolicitud(solicitudId, numeroSolicitud) {
            try {
                const response = await fetch('/api/cambiar-estado-solicitud', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        id_solicitud: solicitudId,
                        nuevo_estado: 'proceso',
                        observaciones: `Auto-aprobada despu√©s de ${autoApprovalSettings.timeMinutes} minutos`
                    })
                });
                
                if (response.ok) {
                    showQueueNotification(`ü§ñ Auto-aprobada: ${numeroSolicitud}`);
                    
                    // Recargar datos del dashboard
                    loadPendingSolicitudes();
                    if (historialVisible) {
                        applyFilters(); // Recargar historial si est√° visible
                    }
                    
                    // Actualizar contador
                    updatePendingAutoApprovalsCount();
                } else {
                    console.error('Error en auto-aprobaci√≥n:', await response.text());
                }
                
            } catch (error) {
                console.error('Error ejecutando auto-aprobaci√≥n:', error);
            }
        }

        // Probar sistema de auto-aprobaci√≥n
        function testAutoApproval() {
            if (!autoApprovalSettings.enabled) {
                showQueueNotification('‚ùå Sistema desactivado');
                return;
            }
            
            showQueueNotification(`üß™ Sistema funcionando - Tiempo: ${autoApprovalSettings.timeMinutes}min`);
            updateAutoApprovalStatus(`Prueba exitosa - Configurado para ${autoApprovalSettings.timeMinutes} minutos`);
        }

        // Reiniciar todos los timers
        function resetAutoApprovalTimers() {
            autoApprovalTimers.forEach(timer => clearTimeout(timer));
            autoApprovalTimers.clear();
            
            if (autoApprovalSettings.enabled) {
                scheduleAutoApprovals();
                showQueueNotification('üîÑ Temporizadores reiniciados');
            }
        }

        // Actualizar estado del sistema
        function updateAutoApprovalStatus(statusText) {
            const statusElement = document.getElementById('auto-approval-status-text');
            if (statusElement) {
                statusElement.textContent = statusText;
            }
        }

        // Actualizar contador de aprobaciones pendientes
        function updatePendingAutoApprovalsCount() {
            const countElement = document.getElementById('pending-auto-approvals');
            if (countElement) {
                countElement.textContent = autoApprovalTimers.size;
            }
        }

        // Cargar configuraci√≥n guardada
        function loadAutoApprovalSettings() {
            const saved = localStorage.getItem('autoApprovalSettings');
            if (saved) {
                autoApprovalSettings = { ...autoApprovalSettings, ...JSON.parse(saved) };
                
                // Aplicar configuraci√≥n a la interfaz
                document.getElementById('autoApprovalEnabled').checked = autoApprovalSettings.enabled;
                document.getElementById('autoApprovalTime').value = autoApprovalSettings.timeMinutes;
                
                if (autoApprovalSettings.enabled) {
                    document.getElementById('auto-approval-options').style.display = 'block';
                    document.getElementById('auto-approval-status').style.display = 'block';
                    startAutoApprovalMonitoring();
                    updateAutoApprovalStatus('Activo - Configuraci√≥n cargada');
                }
            }
        }
        */

        // Inicializar cola de impresi√≥n cuando se carga la p√°gina
        document.addEventListener('DOMContentLoaded', () => {
            // //automatizador en pruebas - Cargar configuraci√≥n de auto-aprobaci√≥n
            // loadAutoApprovalSettings();
            
            // Inicializar despu√©s de un breve delay para que cargue el dashboard principal
            setTimeout(initializePrintQueue, 2000);
        });
    </script>

    <!-- Chat Flotante -->
    <div id="chat-widget" class="chat-widget">
        <div class="chat-button" onclick="toggleChat()">
            üí¨
            <span id="chat-notification" class="chat-notification" style="display: none;">0</span>
        </div>
        
        <div id="chat-panel" class="chat-panel" style="display: none;">
            <div class="chat-panel-header">
                <h3>üí¨ Chat del Equipo</h3>
                <button class="close-chat" onclick="toggleChat()">√ó</button>
            </div>
            
            <div class="chat-panel-content">
                <div class="chat-channels-mini">
                    <div id="chat-channels-mini" class="channels-mini">
                        <!-- Canales se cargan aqu√≠ -->
                    </div>
                </div>
                
                <div class="chat-messages-mini" id="chat-messages-mini">
                    <div class="welcome-mini">Selecciona un canal para chatear</div>
                </div>
                
                <div class="chat-input-mini" id="chat-input-mini" style="display: none;">
                    <input type="text" id="message-input-mini" placeholder="Escribe tu mensaje..." 
                           onkeypress="handleChatKeypress(event)">
                    <button onclick="sendChatMessage()">üì§</button>
                </div>
            </div>
        </div>
    </div>

    <style>
        /* Chat Widget Styles */
        .chat-widget {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }

        .chat-button {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            font-size: 24px;
            color: white;
            transition: all 0.3s ease;
            position: relative;
        }

        .chat-button:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 25px rgba(0,0,0,0.3);
        }

        .chat-notification {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #dc3545;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .chat-panel {
            position: absolute;
            bottom: 70px;
            right: 0;
            width: 350px;
            height: 400px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-panel-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-panel-header h3 {
            margin: 0;
            font-size: 16px;
        }

        .close-chat {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            padding: 0;
            width: 24px;
            height: 24px;
        }

        .chat-panel-content {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .chat-channels-mini {
            background: #f8f9fa;
            padding: 10px;
            border-bottom: 1px solid #dee2e6;
            max-height: 100px;
            overflow-y: auto;
        }

        .channels-mini {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .channel-mini {
            background: white;
            border: 1px solid #dee2e6;
            padding: 5px 10px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }

        .channel-mini:hover {
            background: #667eea;
            color: white;
        }

        .channel-mini.active {
            background: #667eea;
            color: white;
        }

        .chat-messages-mini {
            flex: 1;
            padding: 10px;
            overflow-y: auto;
            font-size: 13px;
        }

        .welcome-mini {
            text-align: center;
            color: #6c757d;
            padding: 20px;
        }

        .message-mini {
            margin-bottom: 8px;
            padding: 6px 8px;
            background: #f8f9fa;
            border-radius: 6px;
            font-size: 12px;
        }

        .message-mini.own {
            background: #667eea;
            color: white;
            margin-left: 20%;
        }

        .message-author-mini {
            font-weight: bold;
            font-size: 11px;
        }

        .chat-input-mini {
            padding: 10px;
            display: flex;
            gap: 8px;
            border-top: 1px solid #dee2e6;
        }

        .chat-input-mini input {
            flex: 1;
            padding: 8px;
            border: 1px solid #dee2e6;
            border-radius: 15px;
            font-size: 12px;
        }

        .chat-input-mini button {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px;
            border-radius: 50%;
            cursor: pointer;
            width: 32px;
            height: 32px;
        }

        /* ============================================
           ESTILOS MODO OSCURO PARA CHAT
           ============================================ */

        body.dark-mode .chat-panel {
            background: #1f2937;
            color: #e5e7eb;
        }

        body.dark-mode .chat-panel-header {
            background: linear-gradient(135deg, #4c1d95 0%, #5b21b6 100%);
        }

        body.dark-mode .chat-channels-mini {
            background: #111827;
            border-bottom-color: #374151;
        }

        body.dark-mode .channel-mini {
            background: #374151;
            border-color: #4b5563;
            color: #e5e7eb;
        }

        body.dark-mode .channel-mini:hover,
        body.dark-mode .channel-mini.active {
            background: #4c1d95;
            border-color: #7c3aed;
            color: white;
        }

        body.dark-mode .chat-messages-mini {
            background: #1f2937;
        }

        body.dark-mode .message-mini {
            background: #374151;
            color: #e5e7eb;
        }

        body.dark-mode .message-mini.own {
            background: #4c1d95;
            color: white;
        }

        body.dark-mode .message-mini strong {
            color: #a78bfa;
        }

        body.dark-mode .chat-input-mini {
            background: #111827;
            border-top-color: #374151;
        }

        body.dark-mode .chat-input-mini input {
            background: #374151;
            border-color: #4b5563;
            color: #e5e7eb;
        }

        body.dark-mode .chat-input-mini input::placeholder {
            color: #9ca3af;
        }

        body.dark-mode .chat-input-mini button {
            background: #7c3aed;
        }

        body.dark-mode .chat-input-mini button:hover {
            background: #6d28d9;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .chat-panel {
                width: 280px;
                height: 350px;
            }
        }
    </style>

    <script>
        // Chat Widget Variables
        let chatWidget = {
            isOpen: false,
            currentChannel: null,
            channels: [],
            messages: []
        };

        // Toggle chat panel
        function toggleChat() {
            const panel = document.getElementById('chat-panel');
            chatWidget.isOpen = !chatWidget.isOpen;
            
            if (chatWidget.isOpen) {
                panel.style.display = 'flex';
                loadMiniChatChannels();
                startMiniChatUpdates();
            } else {
                panel.style.display = 'none';
                stopMiniChatUpdates();
            }
        }

        // Load channels for mini chat
        async function loadMiniChatChannels() {
            try {
                const response = await fetch('/api/chat/canales', {
                    headers: getAuthHeaders()
                });

                if (response.ok) {
                    chatWidget.channels = await response.json();
                    displayMiniChannels();
                }
            } catch (error) {
                console.error('Error loading mini chat channels:', error);
            }
        }

        // Display channels in mini chat
        function displayMiniChannels() {
            const container = document.getElementById('chat-channels-mini');
            container.innerHTML = chatWidget.channels.map(canal => `
                <div class="channel-mini" onclick="selectMiniChannel(${canal.id_canal}, '${canal.nombre_canal}')" 
                     data-channel="${canal.id_canal}">
                    ${canal.nombre_canal}
                </div>
            `).join('');
        }

        // Select channel in mini chat
        function selectMiniChannel(channelId, channelName) {
            // Update active state
            document.querySelectorAll('.channel-mini').forEach(ch => ch.classList.remove('active'));
            document.querySelector(`[data-channel="${channelId}"]`).classList.add('active');
            
            chatWidget.currentChannel = channelId;
            document.getElementById('chat-input-mini').style.display = 'flex';
            
            loadMiniChatMessages();
        }

        // Load messages for mini chat
        async function loadMiniChatMessages() {
            if (!chatWidget.currentChannel) return;
            
            try {
                const response = await fetch(`/api/chat/canales/${chatWidget.currentChannel}/mensajes?limit=20`, {
                    headers: getAuthHeaders()
                });

                if (response.ok) {
                    const data = await response.json();
                    chatWidget.messages = data.mensajes;
                    displayMiniMessages();
                }
            } catch (error) {
                console.error('Error loading mini chat messages:', error);
            }
        }

        // Display messages in mini chat
        function displayMiniMessages() {
            const container = document.getElementById('chat-messages-mini');
            const currentUserId = JSON.parse(localStorage.getItem('userData') || '{}').id_usuario;
            
            if (chatWidget.messages.length === 0) {
                container.innerHTML = '<div class="welcome-mini">No hay mensajes en este canal</div>';
                return;
            }

            container.innerHTML = chatWidget.messages.map(mensaje => {
                const isOwn = mensaje.id_usuario === currentUserId;
                return `
                    <div class="message-mini ${isOwn ? 'own' : ''}">
                        ${!isOwn ? `<div class="message-author-mini">${mensaje.nombre_completo}:</div>` : ''}
                        <div>${mensaje.mensaje}</div>
                    </div>
                `;
            }).join('');
            
            container.scrollTop = container.scrollHeight;
        }

        // Send message in mini chat
        async function sendChatMessage() {
            if (!chatWidget.currentChannel) return;
            
            const input = document.getElementById('message-input-mini');
            const message = input.value.trim();
            
            if (!message) return;
            
            try {
                const response = await fetch(`/api/chat/canales/${chatWidget.currentChannel}/mensajes`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...getAuthHeaders()
                    },
                    body: JSON.stringify({ mensaje: message })
                });

                if (response.ok) {
                    input.value = '';
                    loadMiniChatMessages();
                }
            } catch (error) {
                console.error('Error sending message:', error);
            }
        }

        // Handle keypress in mini chat
        function handleChatKeypress(event) {
            if (event.key === 'Enter') {
                sendChatMessage();
            }
        }

        // Update notification badge
        async function updateChatNotification() {
            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    // No hay token, no intentar actualizar notificaciones
                    return;
                }

                const response = await fetch('/api/chat/no-leidos', {
                    headers: getAuthHeaders()
                });

                if (response.ok) {
                    const noLeidos = await response.json();
                    const total = noLeidos.reduce((sum, canal) => sum + canal.mensajes_no_leidos, 0);
                    
                    const badge = document.getElementById('chat-notification');
                    if (total > 0) {
                        badge.textContent = total;
                        badge.style.display = 'flex';
                    } else {
                        badge.style.display = 'none';
                    }
                } else if (response.status === 401) {
                    // Token inv√°lido o expirado, no loguear como error
                    console.log('Token no v√°lido para notificaciones de chat');
                }
            } catch (error) {
                console.error('Error updating chat notification:', error);
            }
        }

        // Start/stop mini chat updates
        let miniChatInterval = null;

        function startMiniChatUpdates() {
            updateChatNotification();
            miniChatInterval = setInterval(() => {
                if (chatWidget.currentChannel) {
                    loadMiniChatMessages();
                }
                updateChatNotification();
            }, 15000);
        }

        function stopMiniChatUpdates() {
            if (miniChatInterval) {
                clearInterval(miniChatInterval);
                miniChatInterval = null;
            }
        }

        // Initialize chat notifications
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                updateChatNotification();
                setInterval(updateChatNotification, 30000); // Check every 30 seconds
            }, 2000);
            
            // üñ®Ô∏è Event delegation para botones de imprimir productos especiales
            document.addEventListener('click', (e) => {
                // Abrir popup de impresi√≥n
                if (e.target.closest('.btn-imprimir-especial')) {
                    const btn = e.target.closest('.btn-imprimir-especial');
                    const pendingItem = btn.closest('.pending-item');
                    
                    const idSolicitud = parseInt(btn.dataset.id);
                    const nombreProducto = pendingItem.dataset.producto.replace(/&quot;/g, '"').replace(/&#39;/g, "'");
                    const cantidad = parseInt(pendingItem.dataset.cantidad);
                    const componentesJson = pendingItem.dataset.componentes.replace(/&quot;/g, '"').replace(/&#39;/g, "'");
                    
                    console.log('üñ®Ô∏è Abriendo popup de impresi√≥n especial:', { idSolicitud, nombreProducto, cantidad, componentesJson });
                    abrirPopupImpresionEspecial(idSolicitud, nombreProducto, cantidad, componentesJson);
                }
                
                // Ejecutar impresi√≥n de componentes seleccionados
                if (e.target.closest('.btn-imprimir-componentes')) {
                    const btn = e.target.closest('.btn-imprimir-componentes');
                    
                    const idSolicitud = parseInt(btn.dataset.idSolicitud);
                    const nombreProducto = btn.dataset.nombreProducto;
                    const cantidadMaxima = parseInt(btn.dataset.cantidadMaxima);
                    const componentesJson = btn.dataset.componentes;
                    
                    console.log('üñ®Ô∏è Imprimiendo componentes seleccionados:', { idSolicitud, nombreProducto, cantidadMaxima, componentesJson });
                    imprimirComponentesEspeciales(idSolicitud, nombreProducto, cantidadMaxima, componentesJson);
                }
            });
        });

        // ============================================
        // ============================================
        // CYCLICAL THEME SWITCHER (DESHABILITADO)
        // ============================================
        // Bot√≥n eliminado del header - Solo usar bot√≥n flotante

        // Cargar tema guardado al iniciar
        window.addEventListener('DOMContentLoaded', () => {
            // Remover clase dark-mode para no interferir con nuevo sistema
            document.body.classList.remove('dark-mode');
            
            // üîÑ Iniciar sistema de auto-reload
            iniciarAutoReloadSupervisor();
        });

        // ============================================
        // üîÑ SISTEMA DE AUTO-RELOAD SUPERVISOR (POLLING)
        // ============================================
        let lastStatsSupervisor = null;
        let autoReloadIntervalSupervisor = null;

        async function verificarCambiosSupervisor() {
            try {
                const response = await fetch('/api/stats-rapidas', {
                    method: 'GET',
                    headers: getAuthHeaders()
                });
                
                if (!response.ok) return;
                
                const stats = await response.json();
                
                // Si es la primera vez, solo guardar
                if (lastStatsSupervisor === null) {
                    lastStatsSupervisor = stats;
                    console.log('üìä Stats iniciales supervisor:', stats);
                    return;
                }
                
                // Verificar si hay cambios
                const cambiosDetectados = 
                    stats.pendientes !== lastStatsSupervisor.pendientes ||
                    stats.en_proceso !== lastStatsSupervisor.en_proceso ||
                    stats.completadas !== lastStatsSupervisor.completadas;
                
                if (cambiosDetectados) {
                    console.log('üîÑ Cambios detectados en solicitudes! Recargando...');
                    console.log('Anterior:', lastStatsSupervisor);
                    console.log('Nuevo:', stats);
                    
                    // Recargar TODAS las solicitudes recientes (incluye pendientes, proceso y completadas)
                    await loadTodasLasSolicitudes();
                    await loadStats();
                    
                    // Actualizar last check
                    lastStatsSupervisor = stats;
                    
                    // Mostrar notificaci√≥n visual
                    mostrarNotificacionSupervisor('Solicitudes actualizadas');
                }
                
                // Si hay solicitudes pendientes de impresi√≥n, reintentar
                if (stats.pendientes_impresion > 0) {
                    console.log(`üñ®Ô∏è Hay ${stats.pendientes_impresion} solicitud(es) pendientes de impresi√≥n. Reintentando...`);
                    await reintentarImpresionesSupervisor();
                }
                
            } catch (error) {
                console.error('Error en verificarCambiosSupervisor:', error);
            }
        }

        async function reintentarImpresionesSupervisor() {
            try {
                const response = await fetch('/api/reintentar-impresiones-pendientes', {
                    method: 'POST',
                    headers: getAuthHeaders()
                });
                
                if (!response.ok) return;
                
                const result = await response.json();
                if (result.exitosas > 0) {
                    console.log(`‚úÖ Impresiones reintentadas: ${result.exitosas} exitosas, ${result.fallidas} fallidas`);
                    mostrarNotificacionSupervisor(`${result.exitosas} etiquetas impresas autom√°ticamente`);
                    // Recargar TODAS las solicitudes
                    await loadTodasLasSolicitudes();
                }
            } catch (error) {
                console.error('Error reintentando impresiones:', error);
            }
        }

        function mostrarNotificacionSupervisor(mensaje) {
            const notif = document.createElement('div');
            notif.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                background: linear-gradient(135deg, #10b981, #059669);
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
                z-index: 9999;
                font-size: 14px;
                font-weight: 600;
                display: flex;
                align-items: center;
                gap: 8px;
                animation: slideInRight 0.3s ease;
            `;
            notif.innerHTML = `üîÑ <span>${mensaje}</span>`;
            document.body.appendChild(notif);
            
            setTimeout(() => {
                notif.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => notif.remove(), 300);
            }, 3000);
        }

        function iniciarAutoReloadSupervisor() {
            console.log('üöÄ Sistema de auto-reload supervisor iniciado (cada 10 segundos)');
            
            // Verificar cambios cada 10 segundos
            autoReloadIntervalSupervisor = setInterval(verificarCambiosSupervisor, 10000);
            
            // Primera verificaci√≥n inmediata
            verificarCambiosSupervisor();
        }

        function detenerAutoReloadSupervisor() {
            if (autoReloadIntervalSupervisor) {
                clearInterval(autoReloadIntervalSupervisor);
                console.log('‚èπÔ∏è Sistema de auto-reload supervisor detenido');
            }
        }

        // Agregar estilos para animaciones
        const styleSupervisor = document.createElement('style');
        styleSupervisor.textContent = `
            @keyframes slideInRight {
                from {
                    transform: translateX(400px);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }
            
            @keyframes slideOutRight {
                from {
                    transform: translateX(0);
                    opacity: 1;
                }
                to {
                    transform: translateX(400px);
                    opacity: 0;
                }
            }
        `;
        document.head.appendChild(styleSupervisor);
    </script>

    <!-- Modal de Gesti√≥n de Usuarios -->
    <div class="gestion-modal-overlay" id="gestionModalOverlay" onclick="cerrarGestionUsuarios(event)">
        <div class="gestion-modal" onclick="event.stopPropagation()">
            <div class="gestion-modal-header">
                <h2 class="gestion-modal-title">
                    <span>üë•</span>
                    Gesti√≥n de Costureras
                </h2>
                <button class="gestion-modal-close" onclick="cerrarGestionUsuarios()">&times;</button>
            </div>
            <div class="gestion-modal-body">
                <div class="gestion-loading" id="gestionLoading">
                    <div class="spinner"></div>
                    <p>Cargando usuarios...</p>
                </div>
                <div id="gestionTableContainer" style="display: none;">
                    <table class="gestion-table">
                        <thead>
                            <tr>
                                <th style="width: 80px;">ID</th>
                                <th>NOMBRE COMPLETO</th>
                                <th style="width: 150px;">ROL</th>
                                <th style="width: 120px;">ESTADO</th>
                                <th style="width: 200px;">AUTO QR</th>
                                <th style="width: 200px;">AUTO ROTULADO</th>
                            </tr>
                        </thead>
                        <tbody id="gestionTableBody">
                            <!-- Se llenar√° din√°micamente -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // GESTI√ìN DE USUARIOS - FUNCIONES
        // ============================================

        // Abrir modal de gesti√≥n
        function abrirGestionUsuarios() {
            const modal = document.getElementById('gestionModalOverlay');
            modal.classList.add('show');
            cargarCostureras();
        }

        // Cerrar modal
        function cerrarGestionUsuarios(event) {
            if (event && event.target !== document.getElementById('gestionModalOverlay')) {
                return;
            }
            const modal = document.getElementById('gestionModalOverlay');
            modal.classList.remove('show');
        }

        // Cargar lista de costureras
        async function cargarCostureras() {
            const loading = document.getElementById('gestionLoading');
            const tableContainer = document.getElementById('gestionTableContainer');
            const tbody = document.getElementById('gestionTableBody');

            loading.style.display = 'block';
            tableContainer.style.display = 'none';

            try {
                const response = await fetch('/api/usuarios');
                const usuarios = await response.json();

                // Filtrar solo costureras y supervisores
                const costureras = usuarios.filter(u => 
                    u.nivel_acceso === 'costurera' || u.nivel_acceso === 'supervisor_embalaje'
                );

                // Ordenar por nombre
                costureras.sort((a, b) => a.nombre_completo.localeCompare(b.nombre_completo));

                tbody.innerHTML = '';

                costureras.forEach(usuario => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${usuario.id_usuario}</td>
                        <td>
                            <input 
                                type="text" 
                                class="gestion-input" 
                                value="${usuario.nombre_completo}"
                                onchange="actualizarNombre(${usuario.id_usuario}, this.value)"
                            />
                        </td>
                        <td>
                            <select 
                                class="gestion-select"
                                onchange="actualizarRol(${usuario.id_usuario}, this.value)"
                            >
                                <option value="costurera" ${usuario.nivel_acceso === 'costurera' ? 'selected' : ''}>Costurera</option>
                                <option value="supervisor_embalaje" ${usuario.nivel_acceso === 'supervisor_embalaje' ? 'selected' : ''}>Supervisor</option>
                            </select>
                        </td>
                        <td>
                            <span class="gestion-badge ${usuario.activo ? 'activo' : 'inactivo'}">
                                ${usuario.activo ? '‚úì Activo' : '‚úó Inactivo'}
                            </span>
                        </td>
                        <td>
                            <div class="auto-service-toggle">
                                <button 
                                    class="toggle-btn automatico ${usuario.auto_services ? 'active' : ''}"
                                    onclick="toggleAutoService(${usuario.id_usuario}, true)"
                                    title="Aprobar e imprimir autom√°ticamente QR"
                                >
                                    ü§ñ Auto
                                </button>
                                <button 
                                    class="toggle-btn manual ${!usuario.auto_services ? 'active' : ''}"
                                    onclick="toggleAutoService(${usuario.id_usuario}, false)"
                                    title="Requiere aprobaci√≥n manual"
                                >
                                    üë§ Manual
                                </button>
                            </div>
                        </td>
                        <td>
                            <div class="auto-service-toggle">
                                <button 
                                    class="toggle-btn automatico ${usuario.auto_servicesgd ? 'active' : ''}"
                                    onclick="toggleAutoRotulado(${usuario.id_usuario}, true)"
                                    title="Imprimir rotulado Godex autom√°ticamente"
                                >
                                    üè∑Ô∏è Auto
                                </button>
                                <button 
                                    class="toggle-btn manual ${!usuario.auto_servicesgd ? 'active' : ''}"
                                    onclick="toggleAutoRotulado(${usuario.id_usuario}, false)"
                                    title="Imprimir rotulado manualmente"
                                >
                                    üë§ Manual
                                </button>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });

                loading.style.display = 'none';
                tableContainer.style.display = 'block';

            } catch (error) {
                console.error('Error cargando costureras:', error);
                loading.innerHTML = `
                    <div style="color: #ef4444;">
                        <p>‚ùå Error al cargar usuarios</p>
                        <p style="font-size: 12px;">${error.message}</p>
                        <button onclick="cargarCostureras()" style="margin-top: 15px; padding: 8px 16px; background: #ec4899; color: white; border: none; border-radius: 8px; cursor: pointer;">
                            Reintentar
                        </button>
                    </div>
                `;
            }
        }

        // Actualizar nombre del usuario
        async function actualizarNombre(idUsuario, nuevoNombre) {
            if (!nuevoNombre.trim()) {
                alert('El nombre no puede estar vac√≠o');
                cargarCostureras();
                return;
            }

            try {
                const response = await fetch(`/api/admin/users/${idUsuario}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        nombre_completo: nuevoNombre.trim()
                    })
                });

                if (response.ok) {
                    mostrarNotificacion('‚úì Nombre actualizado correctamente', 'success');
                } else {
                    throw new Error('Error al actualizar nombre');
                }
            } catch (error) {
                console.error('Error:', error);
                mostrarNotificacion('‚úó Error al actualizar nombre', 'error');
                cargarCostureras();
            }
        }

        // Actualizar rol del usuario
        async function actualizarRol(idUsuario, nuevoRol) {
            if (!confirm(`¬øCambiar el rol de este usuario a ${nuevoRol === 'costurera' ? 'Costurera' : 'Supervisor'}?`)) {
                cargarCostureras();
                return;
            }

            try {
                const response = await fetch(`/api/admin/users/${idUsuario}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        nivel_acceso: nuevoRol
                    })
                });

                if (response.ok) {
                    mostrarNotificacion('‚úì Rol actualizado correctamente', 'success');
                    // Si cambi√≥ a supervisor, recargar para quitarlo de la lista
                    if (nuevoRol === 'supervisor_embalaje') {
                        setTimeout(() => cargarCostureras(), 1000);
                    }
                } else {
                    throw new Error('Error al actualizar rol');
                }
            } catch (error) {
                console.error('Error:', error);
                mostrarNotificacion('‚úó Error al actualizar rol', 'error');
                cargarCostureras();
            }
        }

        // Toggle auto_services
        async function toggleAutoService(idUsuario, activar) {
            try {
                const response = await fetch(`/api/admin/users/${idUsuario}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        auto_services: activar
                    })
                });

                if (response.ok) {
                    const modo = activar ? 'AUTOM√ÅTICO' : 'MANUAL';
                    mostrarNotificacion(`‚úì Modo QR cambiado a ${modo}`, 'success');
                    cargarCostureras();
                } else {
                    throw new Error('Error al cambiar modo');
                }
            } catch (error) {
                console.error('Error:', error);
                mostrarNotificacion('‚úó Error al cambiar modo', 'error');
            }
        }

        // Toggle auto_servicesgd (Rotulado Godex)
        async function toggleAutoRotulado(idUsuario, activar) {
            try {
                const response = await fetch(`/api/admin/users/${idUsuario}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        auto_servicesgd: activar
                    })
                });

                if (response.ok) {
                    const modo = activar ? 'AUTOM√ÅTICO' : 'MANUAL';
                    mostrarNotificacion(`üè∑Ô∏è Rotulado cambiado a ${modo}`, 'success');
                    cargarCostureras();
                } else {
                    throw new Error('Error al cambiar modo rotulado');
                }
            } catch (error) {
                console.error('Error:', error);
                mostrarNotificacion('‚úó Error al cambiar modo rotulado', 'error');
            }
        }

        // Mostrar notificaci√≥n
        function mostrarNotificacion(mensaje, tipo) {
            const notif = document.createElement('div');
            notif.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                background: ${tipo === 'success' ? '#10b981' : '#ef4444'};
                color: white;
                border-radius: 10px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                z-index: 10000;
                font-weight: 600;
                animation: slideInRight 0.3s ease;
            `;
            notif.textContent = mensaje;
            document.body.appendChild(notif);

            setTimeout(() => {
                notif.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => notif.remove(), 300);
            }, 3000);
        }

        // Cerrar modal con tecla ESC
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                cerrarGestionUsuarios();
            }
        });

        // ‚≠ê SISTEMA DE MONITOREO DE IMPRESORAS
        let printerStatusInterval = null;
        
        async function verificarEstadoImpresoras() {
            try {
                const response = await fetch('/api/printer-status-all', {
                    headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') }
                });
                
                if (!response.ok) throw new Error('Error al verificar impresoras');
                
                const data = await response.json();
                
                // Actualizar Godex (indicador en greeting-card)
                const godexConnected = data.godex.connected;
                const godexIndicator = document.getElementById('godex-indicator');
                const godexBadge = document.getElementById('godex-badge');
                
                if (godexConnected) {
                    godexIndicator.textContent = 'üü¢'; // Verde
                    godexBadge.title = `Godex G530 - Conectada (${data.godex.ip})`;
                    godexBadge.style.borderColor = '#10b981';
                    godexBadge.style.color = '#10b981';
                    godexBadge.style.background = 'rgba(16, 185, 129, 0.15)';
                } else {
                    godexIndicator.textContent = 'üî¥'; // Rojo
                    godexBadge.title = 'Godex G530 - Desconectada';
                    godexBadge.style.borderColor = '#ef4444';
                    godexBadge.style.color = '#ef4444';
                    godexBadge.style.background = 'rgba(239, 68, 68, 0.15)';
                }
                
                // Actualizar Zebra (indicador en greeting-card)
                const zebraConnected = data.zebra.connected;
                const zebraIndicator = document.getElementById('zebra-indicator');
                const zebraBadge = document.getElementById('zebra-badge');
                
                if (zebraConnected) {
                    zebraIndicator.textContent = 'üü¢'; // Verde
                    zebraBadge.title = `Zebra ZD230 - Conectada (${data.zebra.ip})`;
                    zebraBadge.style.borderColor = '#10b981';
                    zebraBadge.style.color = '#10b981';
                    zebraBadge.style.background = 'rgba(16, 185, 129, 0.15)';
                } else {
                    zebraIndicator.textContent = 'üî¥'; // Rojo
                    zebraBadge.title = 'Zebra ZD230 - Desconectada';
                    zebraBadge.style.borderColor = '#ef4444';
                    zebraBadge.style.color = '#ef4444';
                    zebraBadge.style.background = 'rgba(239, 68, 68, 0.15)';
                }
                
                console.log(`üîç Estado impresoras: Godex ${godexConnected ? 'üü¢' : 'üî¥'} | Zebra ${zebraConnected ? 'üü¢' : 'üî¥'}`);
                
            } catch (error) {
                console.error('‚ùå Error verificando estado de impresoras:', error);
                // Mostrar estado de error (amarillo)
                const godexIndicator = document.getElementById('godex-indicator');
                const zebraIndicator = document.getElementById('zebra-indicator');
                const godexBadge = document.getElementById('godex-badge');
                const zebraBadge = document.getElementById('zebra-badge');
                
                if (godexIndicator) {
                    godexIndicator.textContent = 'üü°';
                    godexBadge.title = 'Godex G530 - Error al verificar';
                    godexBadge.style.borderColor = '#f59e0b';
                    godexBadge.style.color = '#f59e0b';
                    godexBadge.style.background = 'rgba(245, 158, 11, 0.15)';
                }
                if (zebraIndicator) {
                    zebraIndicator.textContent = 'üü°';
                    zebraBadge.title = 'Zebra ZD230 - Error al verificar';
                    zebraBadge.style.borderColor = '#f59e0b';
                    zebraBadge.style.color = '#f59e0b';
                    zebraBadge.style.background = 'rgba(245, 158, 11, 0.15)';
                }
            }
        }
        
        function iniciarMonitoreoImpresoras() {
            console.log('üñ®Ô∏è Iniciando monitoreo de impresoras (cada 30 segundos)');
            verificarEstadoImpresoras();
            printerStatusInterval = setInterval(verificarEstadoImpresoras, 30000);
        }
        
        function detenerMonitoreoImpresoras() {
            if (printerStatusInterval) {
                clearInterval(printerStatusInterval);
                console.log('‚èπÔ∏è Monitoreo de impresoras detenido');
            }
        }
        
        // üñ®Ô∏è FUNCIONES PARA POPUP DE IMPRESI√ìN
        function mostrarPopupImpresion(cantidad, mensaje = 'Procesando solicitud') {
            const popup = document.getElementById('printing-popup');
            const statusText = document.getElementById('printing-status');
            const progressEl = document.getElementById('printing-progress');
            const totalEl = document.getElementById('printing-total');
            const video = document.getElementById('print-animation');
            
            // Configurar datos
            statusText.textContent = mensaje;
            progressEl.textContent = '0';
            totalEl.textContent = cantidad;
            
            // Reiniciar video desde el inicio
            video.currentTime = 0;
            video.play();
            
            // Mostrar popup
            popup.style.display = 'block';
            popup.style.animation = 'slideInUp 0.5s ease';
            
            console.log(`üñ®Ô∏è Popup de impresi√≥n mostrado: ${cantidad} etiquetas`);
        }
        
        function actualizarProgresoImpresion(actual, total) {
            const progressEl = document.getElementById('printing-progress');
            if (progressEl) {
                progressEl.textContent = actual;
            }
        }
        
        function ocultarPopupImpresion() {
            const popup = document.getElementById('printing-popup');
            if (popup) {
                popup.style.animation = 'slideOutDown 0.5s ease';
                setTimeout(() => {
                    popup.style.display = 'none';
                }, 500);
            }
            console.log(`‚úÖ Popup de impresi√≥n ocultado`);
        }

        // Iniciar monitoreo al cargar la p√°gina
        document.addEventListener('DOMContentLoaded', () => {
            iniciarMonitoreoImpresoras();
        });
        
        // Detener monitoreo al cerrar p√°gina
        window.addEventListener('beforeunload', () => {
            detenerMonitoreoImpresoras();
        });
    </script>

    <!-- üñ®Ô∏è POPUP DE IMPRESI√ìN CON ANIMACI√ìN -->
    <div id="printing-popup" style="
        display: none;
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: linear-gradient(135deg, #ec4899 0%, #8b5cf6 100%);
        padding: 20px;
        border-radius: 15px;
        box-shadow: 0 8px 24px rgba(0,0,0,0.3);
        z-index: 10000;
        min-width: 280px;
        animation: slideInUp 0.5s ease;
    ">
        <div style="text-align: center; color: white;">
            <div style="background: white; border-radius: 12px; padding: 10px; display: inline-block; margin-bottom: 15px;">
                <video id="print-animation" 
                       src="/founds/animations/Print.webm" 
                       autoplay 
                       loop 
                       muted 
                       playsinline
                       style="width: 120px; height: 120px; display: block;">
                </video>
            </div>
            <h3 style="margin: 0 0 8px 0; font-size: 18px; font-weight: 700;">
                üñ®Ô∏è Imprimiendo...
            </h3>
            <p id="printing-status" style="margin: 0 0 12px 0; font-size: 14px; opacity: 0.95;">
                Procesando solicitud
            </p>
            <div style="background: rgba(255,255,255,0.2); padding: 8px 12px; border-radius: 8px; font-size: 12px;">
                <span id="printing-progress">0</span> de <span id="printing-total">0</span> etiquetas
            </div>
        </div>
    </div>

    <style>
        @keyframes slideInUp {
            from {
                transform: translateY(100px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOutDown {
            from {
                transform: translateY(0);
                opacity: 1;
            }
            to {
                transform: translateY(100px);
                opacity: 0;
            }
        }
    </style>

    <!-- Bot√≥n de Ayuda Flotante -->
    <a href="manual-ayuda.html" class="help-button" target="_blank">
        <span class="icon">?</span>
        <span class="tooltip">Ayuda</span>
    </a>
</body>
</html>